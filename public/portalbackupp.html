<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Family Portal - Studio Sync</title>
    <!-- Favicon -->
    <link rel="icon" href="assets/ssdancerblue.svg" type="image/svg+xml">
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #3DCED7;
            --primary-hover: #36B8C0;
            --secondary-color: #3A506B;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
        }

        .portal-header {
            background-color: var(--primary-color);
            color: white;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .family-info-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: box-shadow 0.3s ease;
        }

        .family-info-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .family-info-card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .nav-tabs {
            border-bottom: none;
            margin-bottom: 2rem;
            gap: 0.5rem;
        }

        .nav-tabs .nav-link {
            color: #525f7f;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
            position: relative;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        /* Add modern hover effect */
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(61, 206, 215, 0.15);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background: none;
            border: none;
            background-color: rgba(61, 206, 215, 0.1);
        }

        /* Add an underline animation on hover */
        .nav-tabs .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-tabs .nav-link:hover::after,
        .nav-tabs .nav-link.active::after {
            width: 80%;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
            transition: box-shadow 0.3s ease;
        }

        .tab-content:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .student-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .student-image-container {
            width: 100px;  /* Reduced from 150px */
            height: 100px; /* Reduced from 150px */
            margin: 0 auto;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5;
        }

        .student-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .student-image-placeholder {
            color: var(--primary-color);
            font-size: 3.5rem;  /* Increased from 2.5rem */
            opacity: 0.8;
            background: rgba(var(--primary-color-rgb), 0.1);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .student-image-placeholder i {
            transform: translateY(2px);  /* Slight adjustment for visual centering */
        }

        .student-info {
            height: 100%;
        }

        .student-name {
            color: var(--primary-color);
            font-weight: 600;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 10px;
            transition: background-color 0.3s ease;
        }

        .info-item:hover {
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }

        .info-item i {
            color: var(--primary-color);
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .info-item small {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item p {
            color: #2d3748;
            font-weight: 500;
        }

        .student-actions {
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-top: 1rem;
        }

        .btn-outline-primary, .btn-outline-success {
            border-width: 2px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover, .btn-outline-success:hover {
            transform: translateY(-2px);
        }

        .class-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .class-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }

        .class-card.selected .detail-item {
            background: white;
            color: var(--text-color);
        }

        .class-card.selected .detail-item i {
            color: var(--primary-color);
        }

        .class-details {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .detail-item:hover {
            background: rgba(var(--primary-color-rgb), 0.05);
        }

        .detail-item i {
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }

        .class-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            flex: 1 1 200px; /* Allow growing but set min width */
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: white;
        }

        /* Add responsive styles for smaller screens */
        @media (max-width: 768px) {
            .class-filters {
                padding: 10px;
                gap: 8px;
            }
            
            .filter-group {
                flex: 1 1 150px; /* Smaller min-width on mobile */
            }
            
            .filter-group select {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .class-filters {
                padding: 8px;
                gap: 6px;
            }
            
            .filter-group {
                flex: 1 1 100%; /* Full width on very small screens */
            }
        }

        .payment-history {
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .payment-item {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .payment-item:last-child {
            border-bottom: none;
        }

        .balance-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .balance-card:hover {
            transform: translateY(-5px);
        }

        .balance-icon {
            color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.1);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        .payment-history {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .payment-item {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background-color 0.3s ease;
        }

        .payment-item:hover {
            background-color: rgba(0,0,0,0.02);
        }

        .no-charges {
            padding: 3rem;
            text-align: center;
            color: #6c757d;
        }

        .no-charges i {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .notification {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .fa-user-circle {
            font-size: 2.2em;
        }

        .message-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .badge {
            padding: 0.5em 1em;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }

        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Shimmer effect */
        .shimmer {
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.05) 0%, 
                rgba(255,255,255,0.2) 50%, 
                rgba(255,255,255,0.05) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            color: rgba(0,0,0,0.1);
            border-radius: 4px;
            display: inline-block;
            min-width: 100px;
            min-height: 1em;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .shimmer-bg {
            background-color: rgba(0,0,0,0.03);
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-card {
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .class-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .class-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
            box-shadow: 0 5px 15px rgba(61, 206, 215, 0.2);
        }

        .class-card.enrolled {
            position: relative;
        }
        
        .class-card.enrolled::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background-color: #28a745;
        }

        .class-name {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }
        
        .class-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .class-level {
            background-color: #f0f7ff;
            color: #0066cc;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        .class-style {
            background-color: #fff0f7;
            color: #cc0066;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        .class-capacity {
            color: #666;
            font-size: 0.8rem;
        }

        .enrollment-badge {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 10px;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .student-class-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .classes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .class-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .class-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        /* Update the modal styles in your CSS section */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1050;
        }

        .modal.show {
            display: block;
        }

        .modal-dialog {
            position: relative;
            width: auto;
            margin: 1.75rem auto;
            max-width: 800px;
        }

        /* Make enrollment modal extra wide */
        #enrollmentModal .modal-dialog {
            max-width: 90%;
            width: 1400px;
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .photo-upload-container {
            margin-top: 10px;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-top: 10px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        body.modal-open {
            overflow: hidden;
        }

        .class-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            width: 100%;
        }

        .class-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .class-filters select {
            flex: 1;
        }

        #classSelectionArea {
            margin-top: 2rem;
        }

        .modal-content {
            max-width: 800px;
            width: 90%;
            margin: 20px auto;
            padding: 2rem;
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .student-class-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .student-name {
            color: #444;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .student-name i {
            color: var(--primary-color);
            margin-right: 10px;
        }

        .student-name .badge {
            background: var(--secondary-color) !important;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .class-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .class-name {
            color: #444;
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 600;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .detail-item:hover {
            background: rgba(var(--primary-color-rgb), 0.05);
        }

        .detail-item i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: white;
            border-radius: 6px;
            margin-right: 12px;
            font-size: 0.9rem;
        }

        .detail-item span {
            color: #444;
            font-weight: 500;
        }

        .alert-info {
            background: rgba(var(--primary-color-rgb), 0.1);
            border: none;
            color: var(--primary-color);
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
        }

        .alert-info i {
            font-size: 1.2rem;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .class-grid {
                grid-template-columns: 1fr;
            }
            
            .student-name {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .student-classes {
            background: rgba(var(--primary-color-rgb), 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .class-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .class-tag {
            background: white;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .class-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .class-tag strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 2px;
        }

        .class-tag small {
            color: #666;
            font-size: 0.8em;
        }

        .btn-frost {
            background: rgba(240, 242, 245, 0.9);  /* Darker background */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);  /* Darker border */
            color: #2d3748;  /* Darker text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .btn-frost:hover {
            background: rgba(230, 232, 235, 1);  /* Even darker on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
            color: #1a202c;
        }

        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .payment-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .amount-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .amount-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .amount-option.selected {
            border-color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.05);
        }

        .custom-amount-input {
            display: none;
            margin-top: 1rem;
        }

        .custom-amount-input.show {
            display: block;
        }

        .billing-info {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .profile-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        #userFullName {
            font-weight: 500;
            font-size: 16px;
            color: var(--text-color);
        }

        .btn-link.dropdown-toggle::after {
            display: none;
        }

        .user-profile-container {
            position: relative;
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile-container:hover {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 25px;
        }

        #userFullName {
            font-weight: 500;
            font-size: 18px;
            color: var(--text-color);
            margin-right: 12px;
        }

        .profile-circle {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .user-profile-container:hover .profile-circle {
            transform: scale(1.05);
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 150px;
            display: none;
            z-index: 1000;
        }

        .user-profile-container:hover .profile-dropdown {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .profile-dropdown li a {
            display: block;
            padding: 12px 20px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .profile-dropdown li a:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Remove the old dropdown toggle styles */
        .btn-link.dropdown-toggle::after {
            display: none;
        }

        .student-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .student-selection-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .student-selection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .student-selection-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }

        .enrollment-step {
            padding: 1rem;
        }

        /* Communication chat styles */
        .chat-sidebar {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            height: 600px;
            overflow-y: auto;
        }
        
        .chat-section-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .groups-list, .dm-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .group-item, .dm-item {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .group-item:hover, .dm-item:hover {
            background-color: rgba(61, 206, 215, 0.1);
        }
        
        .group-item.active, .dm-item.active {
            background-color: rgba(61, 206, 215, 0.2);
            font-weight: 500;
        }
        
        .group-prefix {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.25rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .btn-icon:hover {
            color: var(--primary-hover);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-bubble {
            position: relative;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 12px;
            max-width: 75%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-break: break-word;
        }
        
        .message-sent {
            background-color: #0b93f6; /* iMessage-like blue */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message-received {
            background-color: #f1f1f1;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .message-content {
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #777;
            margin-top: 2px;
        }
        
        .message-time {
            margin-left: auto;
        }
        
        .message-sender {
            font-weight: 500;
            margin-right: 5px;
        }
        
        .message-input-container {
            padding: 15px;
            border-top: 1px solid #eaeaea;
        }
        
        .shimmer-loading {
            color: #ccc;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 5px;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .message-options {
            position: absolute;
            top: 5px;
            right: 8px; /* Slightly adjusted from 5px */
        }

        /* Remove the hover rule that was previously controlling visibility */
        .message-sent:hover .message-options {
            display: block;
        }

        .message-options-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.9); /* Brighter white for better visibility */
            font-size: 0.8rem;
            cursor: pointer;
            padding: 2px 5px;
        }

        .message-options-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 10;
            min-width: 120px;
        }

        .message-options-dropdown.show {
            display: block;
        }

        .message-option {
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            color: #333;
            display: flex;
            align-items: center;
        }

        .message-option:hover {
            background-color: #f8f9fa;
        }

        .message-option i {
            margin-right: 8px;
            font-size: 0.8rem;
        }

        .edit-message {
            color: #007bff;
        }

        .delete-message {
            color: #dc3545;
        }

      
        .message-sent .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Add this CSS to style the sender name to match the timestamp color in sent messages */
        .message-sent .message-sender {
            color: rgba(255, 255, 255, 0.8);
        }

        .edited-indicator {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            margin-left: 0.3em;
        }

        .message-received .edited-indicator {
            color: #999;
        }

        /* Member list styling */
        .members-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .member-item {
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .member-item:hover {
            background-color: #f8f9fa;
        }
        
        .member-name {
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Message Info Modal styles */
        .members-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .member-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .member-item:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }
        
        .member-name {
            font-weight: 500;
            color: #333;
        }
        
        /* Prevent multiple backdrops */
        body > .modal-backdrop:not(:first-of-type) {
            display: none !important;
        }

        /* Add this to your existing CSS */
        .message-sent .message-content {
            padding-right: 25px; /* Add padding on the right side to create space between content and ellipsis */
        }

        /* Add to your existing styles */
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .class-card {
            background-color: #fff;
            border-radius: 8px;
            border: 2px solid #eee;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .class-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .class-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }

        .class-card.enrolled {
            border-left: 5px solid #28a745;
        }

        .class-name {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .enrollment-badge {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        .student-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .student-selection-card {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .student-selection-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .student-selection-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }
        
        .detail-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .detail-item i {
            width: 20px;
            margin-right: 8px;
            color: var(--primary-color);
        }

        /* Billing details styles */
        .billing-details-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .card-info {
            display: flex;
            align-items: center;
            margin: 1rem 0;
        }

        .card-icon {
            font-size: 2rem;
            margin-right: 1rem;
            color: #3a3a3a;
        }

        .card-details {
            flex: 1;
        }

        .card-number {
            font-family: monospace;
            letter-spacing: 1px;
        }

        .edit-card-btn {
            border-radius: 6px;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        /* Card input form styles */
        .card-form-group {
            margin-bottom: 1.5rem;
        }
        
        .card-form-row {
            display: flex;
            gap: 1rem;
        }
        
        .card-input {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            width: 100%;
            font-size: 1rem;
        }

        /* Payment modal styles */
        .payment-item {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .line-items-container {
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        .line-item {
            font-size: 0.9rem;
        }

        .line-item.header {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .payment-item button {
            transition: transform 0.2s ease;
        }

        .payment-item button[aria-expanded="true"] {
            transform: rotate(45deg);
        }

        .line-items-toggle-btn {
            font-size: 1.3rem;
            color: white;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            padding: 0;
            margin-right: 12px;
            transition: all 0.2s ease;
        }

        .line-items-toggle-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .line-items-toggle-btn[aria-expanded="true"] {
            transform: rotate(45deg);
            background: rgba(61, 206, 215, 0.15);
        }

        .line-items-container {
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Portal...</div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="assets/ssdancerblue.svg" alt="Studio Logo" height="120">
            </a>
            <div class="ms-auto d-flex align-items-center">
                <div class="user-profile-container">
                    <span id="userFullName" class="me-3"></span>
                    <div class="profile-circle" style="background-color: var(--primary-color);">
                        <span id="userInitials"></span>
                    </div>
                    <ul class="profile-dropdown">
                        <li><a href="#" id="logoutButton">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Portal Header -->
    <header class="portal-header">
        <div class="container">
            <h1>Family Portal</h1>
            <p class="mb-0">Welcome back, <span id="familyName" class="shimmer shimmer-bg">Loading...</span></p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mb-5">
        <!-- Family Information Card -->
        <div class="family-info-card">
            <h3>Family Information</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Primary Contact:</strong> <span id="primaryContact" class="shimmer shimmer-bg">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="primaryEmail" class="shimmer shimmer-bg">Loading...</span></p>
                    <p><strong>Phone:</strong> <span id="primaryPhone" class="shimmer shimmer-bg">Loading...</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Secondary Contact:</strong> <span id="secondaryContact" class="shimmer shimmer-bg">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="secondaryEmail" class="shimmer shimmer-bg">Loading...</span></p>
                    <p><strong>Phone:</strong> <span id="secondaryPhone" class="shimmer shimmer-bg">Loading...</span></p>
                </div>
            </div>
        </div>

        <!-- Portal Tabs -->
        <ul class="nav nav-tabs" id="portalTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="account-tab" data-bs-toggle="tab" href="#account" role="tab">Account</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="students-tab" data-bs-toggle="tab" href="#students" role="tab">Students</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="classes-tab" data-bs-toggle="tab" href="#classes" role="tab">Classes</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="finance-tab" data-bs-toggle="tab" href="#finance" role="tab">Finance</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="communication-tab" data-bs-toggle="tab" href="#communication" role="tab">Communication</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="portalTabContent">
            <!-- Account Tab -->
            <div class="tab-pane fade show active" id="account" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Contact Information</h5>
                                <div class="mb-3">
                                    <label class="form-label">Street Address</label>
                                    <input type="text" class="form-control" id="streetAddress">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="addressLine2">
                                </div>
                                <div class="row">
                                    <div class="col-md-5 mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" id="city">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">State</label>
                                        <input type="text" class="form-control" id="state">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">ZIP Code</label>
                                        <input type="text" class="form-control" id="zipCode">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Emergency Contact Name</label>
                                    <input type="text" class="form-control" id="emergencyContactName">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Emergency Contact Phone</label>
                                    <input type="text" class="form-control" id="emergencyContactPhone">
                                </div>
                                <button type="button" class="btn btn-primary" id="updateContactInfoButton">
                                    Update Information
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Notifications</h5>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications">
                                    <label class="form-check-label">Email Notifications</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="smsNotifications">
                                    <label class="form-check-label">SMS Notifications</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Billing Details Card -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">Billing Details</h5>
                                    <button type="button" class="btn btn-outline-primary btn-sm edit-card-btn" onclick="showCardEditForm()">
                                        <i class="fas fa-edit me-1"></i> Edit
                                    </button>
                                </div>
                                
                                <!-- Card info display section -->
                                <div id="cardInfoDisplay">
                                    <div class="card-info">
                                        <div class="card-icon">
                                            <i class="far fa-credit-card"></i>
                                        </div>
                                        <div class="card-details">
                                            <div class="card-number" id="displayCardNumber">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 0000</div>
                                            <div class="text-muted">
                                                <span id="displayCardExpiry">MM/YY</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Card edit form (initially hidden) -->
                                <div id="cardEditForm" style="display: none;">
                                    <div class="card-form-group">
                                        <label class="form-label">Card Number</label>
                                        <input type="text" class="card-input" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                                    </div>
                                    <div class="card-form-row">
                                        <div class="card-form-group" style="flex: 1;">
                                            <label class="form-label">Expiration Date</label>
                                            <div class="d-flex gap-2">
                                                <select class="card-input" id="expirationMonth">
                                                    <option value="">MM</option>
                                                    <option value="01">01</option>
                                                    <option value="02">02</option>
                                                    <option value="03">03</option>
                                                    <option value="04">04</option>
                                                    <option value="05">05</option>
                                                    <option value="06">06</option>
                                                    <option value="07">07</option>
                                                    <option value="08">08</option>
                                                    <option value="09">09</option>
                                                    <option value="10">10</option>
                                                    <option value="11">11</option>
                                                    <option value="12">12</option>
                                                </select>
                                                <select class="card-input" id="expirationYear">
                                                    <option value="">YY</option>
                                                    <!-- Years will be populated via JavaScript -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="card-form-group" style="width: 100px;">
                                            <label class="form-label">CVC</label>
                                            <input type="text" class="card-input" id="cardCVC" placeholder="123" maxlength="4">
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2 mt-3">
                                        <button type="button" class="btn btn-primary" onclick="saveCardInfo()">
                                            Save Card
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="cancelCardEdit()">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Tab -->
            <div class="tab-pane fade" id="students" role="tabpanel">
                <!-- Add this button in the Students tab header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Enrolled Students</h4>
                    <button class="btn btn-primary" onclick="showAddStudentModal()">
                        <i class="fas fa-plus me-2"></i>Add New Student
                    </button>
                </div>

                <div id="studentsContainer">
                    <!-- Students will be loaded dynamically -->
                    <div class="student-card">
                        <div class="student-card-content">
                            <div class="col-md-3">
                                <img src="${studentData.PhotoURL || 'assets/placeholder.jpg'}" 
                                    alt="${studentData.FirstName}'s Photo" 
                                    class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h5 class="mb-3">${studentData.FirstName} ${studentData.LastName}</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Age:</strong> ${studentData.Age || 'Not provided'}</p>
                                        <p><strong>Date of Birth:</strong> ${studentData.DateOfBirth || 'Not provided'}</p>
                                        <p><strong>Skill Level:</strong> ${studentData.SkillLevel ? 
                                            studentData.SkillLevel.charAt(0).toUpperCase() + 
                                            studentData.SkillLevel.slice(1) : 'Not specified'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Medical Conditions:</strong> ${studentData.MedicalConditions || 'None'}</p>
                                        <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                                    </div>
                                </div>
                                <div class="student-actions mt-4">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editStudent('${studentDoc.id}')">
                                        <i class="fas fa-edit me-2"></i>Edit Student
                                    </button>
                                    <button class="btn btn-outline-success btn-sm ms-2" onclick="showEnrollmentModal('${studentDoc.id}')">
                                        <i class="fas fa-plus me-2"></i>Enroll in Classes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classes Tab -->
            <div class="tab-pane fade" id="classes" role="tabpanel">
                <div id="classesContainer">
                    <div class="classes-header">
                        <h4>Enrolled Classes</h4>
                        <button class="btn btn-primary mb-4" onclick="showEnrollmentModal()">
                            <i class="fas fa-plus-circle me-2"></i>Enroll in New Class
                        </button>
                    </div>
                    
                    <div class="student-classes-list">
                        <!-- Classes grouped by student will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Finance Tab -->
            <div class="tab-pane fade" id="finance" role="tabpanel">
                <h4 class="mb-4 text-center">Financial Information</h4>
                <div class="row justify-content-center mb-5">
                    <div class="col-md-6 col-lg-4">
                        <div class="balance-card">
                            <div class="balance-icon mb-3">
                                <i class="fas fa-wallet fa-2x"></i>
                            </div>
                            <h5 class="text-muted mb-3">Current Balance</h5>
                            <h2 class="balance-amount mb-3" id="currentBalance">
                                <span class="shimmer shimmer-bg">Loading...</span>
                            </h2>
                            <button class="btn btn-frost btn-lg w-100" onclick="showPaymentModal()">
                                <i class="fas fa-credit-card me-2"></i>Make Payment
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h5 class="mb-3">Payment History</h5>
                        <div class="payment-history card">
                            <div id="paymentHistoryContainer" class="card-body p-0">
                                <div class="shimmer-loading p-4">Loading payment history...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Tab -->
            <div class="tab-pane fade" id="communication" role="tabpanel">
                <!-- Chat Layout -->
                <div class="row">
                    <div class="col-md-4 col-lg-3">
                        <div class="chat-sidebar">
                            <!-- Groups Section -->
                            <div class="chat-section mb-4">
                                <h5 class="chat-section-header">
                                    <i class="fas fa-users me-2"></i>Groups
                                </h5>
                                <div id="groupsList" class="groups-list">
                                    <!-- Groups will be loaded here -->
                                    <div class="shimmer-loading px-3 py-2">Loading groups...</div>
                                </div>
                            </div>
                            
                            <!-- Direct Messages Section -->
                            <div class="chat-section">
                                <h5 class="chat-section-header">
                                    <i class="fas fa-comment-dots me-2"></i>Direct Messages
                                </h5>
                                <div id="dmList" class="dm-list">
                                    <!-- DMs will be loaded here -->
                                    <div class="shimmer-loading px-3 py-2">Loading messages...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8 col-lg-9">
                        <div class="chat-container">
                            <!-- Chat Header -->
                            <div class="chat-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 id="currentChatName">Select a conversation</h4>
                                        <span id="memberCount" class="text-muted"></span>
                                    </div>
                                    <button class="btn-icon" data-bs-toggle="tooltip" title="Conversation Options">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Messages Container -->
                            <div id="messagesContainer" class="messages-container">
                                <div class="text-center p-5">
                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                    <p>Select a conversation to start chatting</p>
                                </div>
                            </div>
                            
                            <!-- Message Input -->
                            <div class="message-input-container">
                                <div class="input-group">
                                    <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." disabled>
                                    <button id="sendMessageBtn" class="btn btn-primary" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Update the Firebase Storage SDK to match the version of other Firebase modules -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Initialize Firebase (Add your Firebase config here)
        const firebaseConfig = {
            apiKey: "AIzaSyDRSW3u6gJSs98Z2Mkp5DYSC__ibDXXHAE",
            authDomain: "studiosync-af73d.firebaseapp.com",
            projectId: "studiosync-af73d",
            storageBucket: "studiosync-af73d.appspot.com",
            messagingSenderId: "172555302276",
            appId: "1:172555302276:web:55b661f9849441e2de59d1",
            measurementId: "G-EK7EFQGMSG"
        };

        firebase.initializeApp(firebaseConfig);

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', function() {
            firebase.auth().signOut().then(() => {
                localStorage.clear();
                window.location.href = '/portallogin.html';
            }).catch((error) => {
                console.error('Logout Error:', error);
            });
        });

        // Add more Firebase functionality as needed

        // Function to remove loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('fade-out');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300); // Match the transition duration
        }

        // Global variables
        let currentStudioId;
        let currentFamilyId;
        let familyData;
        let currentBalance = 0;
        let selectedAmount = 'full';
        let currentStudentIndex = -1;
        let studioClasses = [];
        let ratePlans = {};
        let currentEnrollmentStep = 1;
        let selectedStudentId = null;
        let selectedClasses = [];
        let existingClasses = []; // To keep track of classes the student is already enrolled in

        // Rest of your code...

        // Update the loadStudioAndBranding function
        async function loadStudioAndBranding() {
            try {
                // Wait for Firebase Auth to initialize
                await new Promise((resolve, reject) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged(user => {
                        unsubscribe();
                        if (user) {
                            resolve(user);
                        } else {
                            reject(new Error('User not authenticated'));
                        }
                    });
                });

                // Get IDs from URL query parameters
                const urlParams = new URLSearchParams(window.location.search);
                currentStudioId = urlParams.get('sid');
                currentFamilyId = urlParams.get('fid');
                
                console.log('=== Portal Initialization ===');
                console.log('Studio ID:', currentStudioId);
                console.log('Family ID:', currentFamilyId);
                console.log('URL:', window.location.href);
                console.log('========================');
                
                if (!currentStudioId || !currentFamilyId) {
                    console.error('Missing studio ID or family ID in URL');
                    window.location.href = '/portallogin.html';
                    return;
                }

                // Load studio data
                const studioDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .get();

                if (!studioDoc.exists) {
                    throw new Error('Studio not found');
                }

                const studioData = studioDoc.data();

                // Load family data
                const familyDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .get();

                if (!familyDoc.exists) {
                    throw new Error('Family not found');
                }

                const familyData = familyDoc.data();

                // Store data in localStorage
                localStorage.setItem('currentStudioId', currentStudioId);
                localStorage.setItem('currentStudioData', JSON.stringify(studioData));
                localStorage.setItem('currentFamilyId', currentFamilyId);
                localStorage.setItem('currentFamilyData', JSON.stringify(familyData));

                // Apply studio branding
                await applyStudioBranding(studioData);

                // Load family data into UI
                loadFamilyData(familyData);

                // After everything is loaded successfully
                hideLoadingOverlay();

                // Load initial data for classes tab
                await loadClassesDetails();

                // After loading family data, also load financial information
                console.log('=== Loading Financial Information ===');
                await loadFinancialInformation();

            } catch (error) {
                console.error('Error loading portal:', error);
                hideLoadingOverlay();
                window.location.href = '/portallogin.html';
            }
        }

        // Function to apply studio branding
        function applyStudioBranding(studioData) {
            // Update colors
            if (studioData.PrimaryColor) {
                document.documentElement.style.setProperty('--primary-color', studioData.PrimaryColor);
                document.documentElement.style.setProperty('--primary-hover', adjustColor(studioData.PrimaryColor, -10));
            }
            if (studioData.SecondaryColor) {
                document.documentElement.style.setProperty('--secondary-color', studioData.SecondaryColor);
            }

            // Update logo
            const headerLogo = document.querySelector('.navbar-brand img');
            if (studioData.LogoUrl) {
                headerLogo.src = studioData.LogoUrl;
            }

            // Update page title
            document.title = `${studioData.StudioName} - Family Portal`;
        }

        // Function to verify user access
        async function verifyUserAccess(studioId) {
            const user = firebase.auth().currentUser;
            if (!user) {
                const studioData = JSON.parse(localStorage.getItem('currentStudioData'));
                const encodedStudioName = encodeURIComponent(studioData.StudioName.trim());
                window.location.href = `/portallogin?studio=${encodedStudioName}&sid=${studioId}`;
                return;
            }

            try {
                // Check if user has access to this studio
                const userDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(localStorage.getItem('userDocId'))
                    .get();

                if (!userDoc.exists) {
                    throw new Error('User does not have access to this studio');
                }

                // Load user data
                loadUserData(userDoc.data());

            } catch (error) {
                console.error('Access verification failed:', error);
                window.location.href = '/portallogin.html';
            }
        }

        // Helper function to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }

        // Function to load user data
        function loadUserData(userData) {
            // Update family name
            document.getElementById('familyName').textContent = `${userData.FirstName} ${userData.LastName}`;
            
            // Update contact information
            document.getElementById('primaryContact').textContent = `${userData.FirstName} ${userData.LastName}`;
            document.getElementById('primaryEmail').textContent = userData.Email;
            document.getElementById('primaryPhone').textContent = userData.Phone || 'Not provided';
            
            // Load additional user data as needed
        }

        // Update the loadFamilyData function
        async function loadFamilyData(familyData) {
            console.log('Loading family data:', familyData);

            // Update family name in header
            const familyNameElements = document.querySelectorAll('#familyName');
            familyNameElements.forEach(element => {
                element.classList.remove('shimmer', 'shimmer-bg');
                let familyName = familyData.FamilyName || familyData.LastName || familyData.FirstName;
                familyName = familyName.replace(/\s*Family\s*$/i, '').trim();
                element.textContent = `${familyName} Family`;
            });

            // Add user full name and initials
            const userFullName = document.getElementById('userFullName');
            const userInitials = document.getElementById('userInitials');
            
            if (familyData.FirstName && familyData.LastName) {
                const firstName = familyData.FirstName;
                const lastName = familyData.LastName;
                userFullName.textContent = `${firstName} ${lastName}`;
                userInitials.textContent = `${firstName.charAt(0)}${lastName.charAt(0)}`;
            }

            // Update primary contact information
            if (familyData.FirstName && familyData.LastName) {
                document.getElementById('primaryContact').classList.remove('shimmer', 'shimmer-bg');
                document.getElementById('primaryContact').textContent = 
                    `${familyData.FirstName} ${familyData.LastName}`;
            }
            
            if (familyData.Email) {
                document.getElementById('primaryEmail').classList.remove('shimmer', 'shimmer-bg');
                document.getElementById('primaryEmail').textContent = familyData.Email;
            }
            
            if (familyData.Phone) {
                document.getElementById('primaryPhone').classList.remove('shimmer', 'shimmer-bg');
                document.getElementById('primaryPhone').textContent = familyData.Phone;
            }

            // Update address information if it exists
            if (familyData.Address1) {
                document.getElementById('streetAddress').value = familyData.Address1;
            }
            if (familyData.Address2) {
                document.getElementById('addressLine2').value = familyData.Address2;
            }
            if (familyData.City) {
                document.getElementById('city').value = familyData.City;
            }
            if (familyData.State) {
                document.getElementById('state').value = familyData.State;
            }
            if (familyData.ZipCode) {
                document.getElementById('zipCode').value = familyData.ZipCode;
            }

            // Update emergency contact if it exists
            if (familyData.EmergencyContacts && familyData.EmergencyContacts.length > 0) {
                const emergencyContact = familyData.EmergencyContacts[0];
                document.getElementById('emergencyContactName').value = emergencyContact.Name || '';
                document.getElementById('emergencyContactPhone').value = emergencyContact.Phone || '';
            }

            // Update secondary contact information if it exists
            if (familyData.SecondaryContact) {
                const secondaryElements = ['secondaryContact', 'secondaryEmail', 'secondaryPhone'];
                secondaryElements.forEach(id => {
                    document.getElementById(id).classList.remove('shimmer', 'shimmer-bg');
                });

                document.getElementById('secondaryContact').textContent = 
                    `${familyData.SecondaryContact.FirstName} ${familyData.SecondaryContact.LastName}`;
                document.getElementById('secondaryEmail').textContent = 
                    familyData.SecondaryContact.Email || 'Not provided';
                document.getElementById('secondaryPhone').textContent = 
                    familyData.SecondaryContact.Phone || 'Not provided';
            } else {
                // Hide secondary contact section if no data
                const secondaryContactSection = document.getElementById('secondaryContact').closest('.col-md-6');
                if (secondaryContactSection) {
                    secondaryContactSection.style.display = 'none';
                }
            }

            // Load and log students information
            if (familyData.Students && familyData.Students.length > 0) {
                console.log('Found students:', familyData.Students);
                await loadStudentsDetails(familyData.Students);
            } else {
                console.log('No students found for this family');
            }

            // Fix CardDetails format in loadFamilyData
            if (familyData.CardDetails) {
                // Get card info regardless of whether it's an array or object
                const cardInfo = Array.isArray(familyData.CardDetails) ? 
                    familyData.CardDetails[0] : familyData.CardDetails;
                
                if (cardInfo && cardInfo.LastFour) {
                    const displayCardNumber = document.getElementById('displayCardNumber');
                    if (displayCardNumber) {
                        // Clear any existing content first
                        displayCardNumber.innerHTML = '';
                        displayCardNumber.textContent = `â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${cardInfo.LastFour || '0000'}`;
                        
                        // Add card type icon if available
                        if (cardInfo.CardType) {
                            const cardIconClass = getCardTypeIconClass(cardInfo.CardType);
                            const iconElement = document.createElement('i');
                            iconElement.className = `${cardIconClass} me-2`;
                            displayCardNumber.prepend(iconElement);
                        }
                    }
                    
                    const displayCardExpiry = document.getElementById('displayCardExpiry');
                    if (displayCardExpiry) {
                        displayCardExpiry.textContent = `${cardInfo.ExpirationMonth || 'MM'}/${cardInfo.ExpirationYear || 'YY'}`;
                    }
                    
                    console.log('Updated card display with:', cardInfo);
                }
            }
        }

        // Update the loadStudentsDetails function to include class information
        async function loadStudentsDetails() {
            try {
                const familyDoc = await getFamilyDoc();
                if (!familyDoc || !familyDoc.exists) {
                    console.error('Family document not found');
                    return;
                }

                const familyData = familyDoc.data();
                const studentIds = familyData.Students || [];
                console.log('Found students:', studentIds);

                let studentsHTML = '';

                for (const studentId of studentIds) {
                    const studentDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Students')
                        .doc(studentId)
                        .get();

                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        
                        // Fetch class details for each student
                        let classesHTML = '';
                        if (studentData.Classes && studentData.Classes.length > 0) {
                            const classPromises = studentData.Classes.map(classId =>
                                firebase.firestore()
                                    .collection('Studios')
                                    .doc(currentStudioId)
                                    .collection('Classes')
                                    .doc(classId)
                                    .get()
                            );

                            const classResults = await Promise.all(classPromises);
                            const classes = classResults
                                .filter(doc => doc.exists)
                                .map(doc => ({ id: doc.id, ...doc.data() }));

                            classesHTML = `
                                <div class="student-classes mt-3">
                                    <h6 class="mb-2">Enrolled Classes:</h6>
                                    <div class="class-tags">
                                        ${classes.map(classInfo => `
                                            <div class="class-tag p-2 mb-2 me-2 bg-light border rounded">
                                                <strong>${classInfo.ClassName}</strong><br>
                                                <small>
                                                    ${classInfo.Days ? classInfo.Days.join(', ').toUpperCase() : ''} 
                                                    ${classInfo.StartTime || ''}-${classInfo.EndTime || ''}
                                                </small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        studentsHTML += `
                            <div class="student-card">
                                <div class="student-card-content">
                                    <div class="row g-0 align-items-center">
                                        <div class="col-md-3 text-center">
                                            <div class="student-image-container mb-3 mb-md-0">
                                                ${studentData.PhotoURL ? 
                                                    `<img src="${studentData.PhotoURL}" 
                                                        alt="${studentData.FirstName}'s Photo" 
                                                        class="student-image">` :
                                                    `<i class="fas fa-user-circle student-image-placeholder"></i>`
                                                }
                                            </div>
                                        </div>
                                        <div class="col-md-9">
                                            <div class="student-info p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h5 class="student-name mb-0">${studentData.FirstName} ${studentData.LastName}</h5>
                                                    <span class="badge bg-success">Active</span>
                                                </div>
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="info-item">
                                                            <i class="fas fa-birthday-cake"></i>
                                                            <div>
                                                                <small class="text-muted">Age</small>
                                                                <p class="mb-0">${studentData.Age || 'Not provided'}</p>
                                                            </div>
                                                        </div>
                                                        <div class="info-item">
                                                            <i class="fas fa-calendar"></i>
                                                            <div>
                                                                <small class="text-muted">Date of Birth</small>
                                                                <p class="mb-0">${studentData.DateOfBirth || 'Not provided'}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="info-item">
                                                            <i class="fas fa-star"></i>
                                                            <div>
                                                                <small class="text-muted">Skill Level</small>
                                                                <p class="mb-0">${studentData.SkillLevel ? 
                                                                    studentData.SkillLevel.charAt(0).toUpperCase() + 
                                                                    studentData.SkillLevel.slice(1) : 'Not specified'}</p>
                                                            </div>
                                                        </div>
                                                        <div class="info-item">
                                                            <i class="fas fa-notes-medical"></i>
                                                            <div>
                                                                <small class="text-muted">Medical Notes</small>
                                                                <p class="mb-0">${studentData.MedicalConditions || 'None'}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="student-actions mt-4">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="editStudent('${studentDoc.id}')">
                                                        <i class="fas fa-edit me-2"></i>Edit Student
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm ms-2" onclick="showEnrollmentModal('${studentDoc.id}')">
                                                        <i class="fas fa-plus me-2"></i>Enroll in Classes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                const container = document.getElementById('studentsContainer');
                if (container) {
                    container.innerHTML = studentsHTML || '<p>No students found</p>';
                }

            } catch (error) {
                console.error('Error loading students details:', error);
                const container = document.getElementById('studentsContainer');
                if (container) {
                    container.innerHTML = '<div class="alert alert-danger">Error loading student information</div>';
                }
            }
        }

        // Add new function to load student classes
        async function loadStudentClasses(studentId, studentData) {
            const studioId = localStorage.getItem('currentStudioId');
            
            try {
                if (studentData.classes && studentData.classes.length > 0) {
                    const classPromises = studentData.classes.map(classId => 
                        firebase.firestore()
                            .collection('Studios')
                            .doc(studioId)
                            .collection('Classes')
                            .doc(classId)
                            .get()
                    );

                    const classResults = await Promise.all(classPromises);
                    const classes = classResults
                        .filter(doc => doc.exists)
                        .map(doc => ({ id: doc.id, ...doc.data() }));

                    console.log(`Classes for student ${studentId}:`, classes);
                } else {
                    console.log(`No classes found for student ${studentId}`);
                }
            } catch (error) {
                console.error('Error loading student classes:', error);
            }
        }

        // Helper function to create student cards
        function createStudentCard(studentData, studentId) {
            const card = document.createElement('div');
            card.className = 'student-card mb-3';
            card.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <img src="${studentData.photoUrl || 'assets/placeholder.jpg'}" 
                             alt="${studentData.FirstName}'s Photo" 
                             class="img-fluid rounded">
                    </div>
                    <div class="col-md-9">
                        <h5 class="mb-3">${studentData.FirstName} ${studentData.LastName}</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Age:</strong> ${studentData.Age || 'Not provided'}</p>
                                <p><strong>Level:</strong> ${studentData.Level || 'Not specified'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Active Classes:</strong> ${studentData.Classes?.length || 0}</p>
                                <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm mt-2" 
                                onclick="viewStudentDetails('${studentId}')">
                            View Details
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        // Function to view student details (implement as needed)
        function viewStudentDetails(studentId) {
            console.log('Viewing details for student:', studentId);
            // Implement student details view
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStudioAndBranding();
            
            // Add event listeners for modal
            const modal = document.querySelector('#classEnrollmentModal .close');
            if (modal) {
                modal.addEventListener('click', closeEnrollmentModal);
            }

            window.addEventListener('click', function(event) {
                const modal = document.getElementById('classEnrollmentModal');
                if (event.target === modal) {
                    closeEnrollmentModal();
                }
            });
        });

        // Function to show enrollment modal
        async function showEnrollmentModal(studentId) {
            currentStudentId = studentId;
            const modal = document.getElementById('classEnrollmentModal');
            const student = await getStudentData(studentId);
            
            document.getElementById('enrollmentStudentName').textContent = 
                `Select Classes for ${student.FirstName} ${student.LastName}`;
            
            // Fetch available classes
            await loadAvailableClasses();
            populateModalClassGrid();
            
            modal.classList.add('show');
        }

        // Function to load available classes
        async function loadAvailableClasses() {
            try {
                const classesRef = firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Classes')
                    .where('IsActive', '==', true);
                    
                const snapshot = await classesRef.get();
                
                studioClasses = [];
                const classStylesMap = new Map();

                // Get class styles
                const stylesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('ClassStyles')
                    .get();
                    
                stylesSnapshot.forEach(doc => {
                    classStylesMap.set(doc.id, doc.data().Name);
                });

                // Process classes
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    studioClasses.push({
                        id: doc.id,
                        ...classData,
                        StyleName: classStylesMap.get(classData.ClassStyleId) || 'Unknown Style'
                    });
                });

                // Update filters
                updateFilters();
                populateClassGrid();
                
            } catch (error) {
                console.error('Error loading classes:', error);
                document.getElementById('availableClassesGrid').innerHTML = 
                    '<div class="alert alert-danger">Error loading classes</div>';
            }
        }

        function updateFilters() {
            // Style Filter
            const styleFilter = document.getElementById('styleFilter');
            const uniqueStyles = new Set(studioClasses.map(c => c.StyleName));
            styleFilter.innerHTML = '<option value="all">All Styles</option>' + 
                Array.from(uniqueStyles).map(style => 
                    `<option value="${style}">${style}</option>`
                ).join('');

            // Level Filter - already in HTML, but could be dynamic if needed
            const levelFilter = document.getElementById('levelFilter');
            levelFilter.innerHTML = `
                <option value="all">All Levels</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            `;

            // Type Filter
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = `
                <option value="all">All Types</option>
                <option value="Recreational">Recreational</option>
                <option value="Team">Team</option>
                <option value="Solo">Solo</option>
                <option value="Duo">Duo</option>
                <option value="Trio">Trio</option>
            `;

            // Day Filter
            const dayFilter = document.getElementById('dayFilter');
            dayFilter.innerHTML = `
                <option value="all">All Days</option>
                <option value="mon">Monday</option>
                <option value="tue">Tuesday</option>
                <option value="wed">Wednesday</option>
                <option value="thu">Thursday</option>
                <option value="fri">Friday</option>
                <option value="sat">Saturday</option>
            `;
        }

        function populateClassGrid() {
            const grid = document.getElementById('availableClassesGrid');
            const levelFilter = document.getElementById('levelFilter').value;
            const styleFilter = document.getElementById('styleFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dayFilter = document.getElementById('dayFilter').value;
            
            const filteredClasses = studioClasses.filter(classInfo => {
                const levelMatch = levelFilter === 'all' || 
                    classInfo.SkillLevel?.toLowerCase() === levelFilter.toLowerCase();
                const styleMatch = styleFilter === 'all' || 
                    classInfo.StyleName === styleFilter;
                const typeMatch = typeFilter === 'all' || 
                    classInfo.ClassType === typeFilter;
                const dayMatch = dayFilter === 'all' || 
                    classInfo.Days?.some(day => day.toLowerCase() === dayFilter.toLowerCase());
                
                return levelMatch && styleMatch && typeMatch && dayMatch;
            });
            
            if (filteredClasses.length === 0) {
                grid.innerHTML = '<div class="alert alert-info">No classes found matching the selected filters.</div>';
                return;
            }
            
            const classesHTML = filteredClasses.map(classInfo => {
                const isSelected = selectedClasses.includes(classInfo.id);
                const formattedDays = classInfo.Days?.map(day => 
                    day.charAt(0).toUpperCase() + day.slice(1)).join(', ') || 'N/A';
                    
                return `
                    <div class="class-card ${isSelected ? 'selected' : ''}" 
                         onclick="toggleClass('${classInfo.id}')"
                         data-level="${classInfo.SkillLevel?.toLowerCase() || ''}"
                         data-style="${classInfo.StyleName || ''}"
                         data-type="${classInfo.ClassType || ''}">
                        <h4 class="class-name">${classInfo.ClassName}</h4>
                        <div class="class-details">
                            <div class="detail-item">
                                <i class="fas fa-music"></i>
                                <span>${classInfo.StyleName || 'Style not specified'}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-calendar-day"></i>
                                <span>${formattedDays}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-clock"></i>
                                <span>${classInfo.StartTime || ''} - ${classInfo.EndTime || ''}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-hourglass-half"></i>
                                <span>${classInfo.Duration || 0} minutes</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-star"></i>
                                <span>${classInfo.SkillLevel || 'Not specified'}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-users"></i>
                                <span>${classInfo.ClassType || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = classesHTML;
        }

        function toggleClass(classId) {
            const index = selectedClasses.indexOf(classId);
            if (index === -1) {
                selectedClasses.push(classId);
            } else {
                selectedClasses.splice(index, 1);
            }
            populateClassGrid();
        }

        function filterClasses() {
            populateClassGrid();
        }

        // Update the setupClassFilters function
        function setupClassFilters(classes, styles) {
            const styleFilter = document.getElementById('styleFilter');
            const dayFilter = document.getElementById('dayFilter');
            const levelFilter = document.getElementById('levelFilter');
            const typeFilter = document.getElementById('typeFilter');

            // Event listeners for filters
            styleFilter.addEventListener('change', () => filterClasses(classes));
            dayFilter.addEventListener('change', () => filterClasses(classes));
            levelFilter.addEventListener('change', () => filterClasses(classes));
            typeFilter.addEventListener('change', () => filterClasses(classes));
        }

        // Update the filterClasses function
        function filterClasses(classes) {
            const styleFilter = document.getElementById('styleFilter').value;
            const dayFilter = document.getElementById('dayFilter').value.toLowerCase();
            const levelFilter = document.getElementById('levelFilter').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;

            const filteredClasses = classes.filter(classInfo => {
                const matchesStyle = !styleFilter || classInfo.ClassStyleId === styleFilter;
                const matchesDay = !dayFilter || 
                    (classInfo.Days && classInfo.Days.some(day => day.toLowerCase().includes(dayFilter)));
                const matchesLevel = !levelFilter || 
                    (classInfo.Level && classInfo.Level.toLowerCase().includes(levelFilter));
                const matchesType = !typeFilter || 
                    (classInfo.ClassType && classInfo.ClassType === typeFilter);

                return matchesStyle && matchesDay && matchesLevel && matchesType;
            });

            displayFilteredClasses(filteredClasses);
        }

        // Update the class card display to include style
        function displayFilteredClasses(classes) {
            const classGrid = document.getElementById('availableClasses');
            if (classes.length === 0) {
                classGrid.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No classes found matching your filters
                    </div>
                `;
                return;
            }

            classGrid.innerHTML = classes.map(classInfo => `
                <div class="class-card" onclick="toggleClassSelection(this, '${classInfo.id}')">
                    <h5 class="class-name">${classInfo.ClassName}</h5>
                    <div class="class-details">
                        <div class="detail-item">
                            <i class="fas fa-music"></i>
                            <span>${classInfo.StyleName || 'Style not specified'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar-day"></i>
                            <span>${classInfo.Days ? classInfo.Days.map(day => 
                                day.charAt(0).toUpperCase() + day.slice(1)).join(', ') : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-clock"></i>
                            <span>${classInfo.StartTime} - ${classInfo.EndTime}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-users"></i>
                            <span>${classInfo.ClassType}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-hourglass-half"></i>
                            <span>${classInfo.Duration} minutes</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-child"></i>
                            <span>Ages ${classInfo.MinAge}-${classInfo.MaxAge}</span>
                        </div>
                        ${classInfo.Description ? `
                            <div class="detail-item">
                                <i class="fas fa-info-circle"></i>
                                <span>${classInfo.Description}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function toggleClassSelection(element, classId) {
            element.classList.toggle('selected');
            if (element.classList.contains('selected')) {
                selectedClasses.push(classId);
            } else {
                selectedClasses = selectedClasses.filter(id => id !== classId);
            }
        }

        function validateClassSelection() {
            if (selectedClasses.length === 0) {
                alert('Please select at least one class');
                return false;
            }
            return true;
        }

        // Add the registration summary function
        async function updateRegistrationSummary() {
            try {
                console.log('=== Starting Registration Summary ===');
                console.log('Student:', newStudentData);
                
                let totalFees = 0;
                let totalHours = 0;
                let ratePlanHours = {};  // Track hours per rate plan
                let seasonFees = [];     // Track all season fees

                // Fetch all selected classes with their details
                const classPromises = selectedClasses.map(async classId => {
                    console.log(`Fetching details for class: ${classId}`);
                    
                    const classDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Classes')
                        .doc(classId)
                        .get();

                    if (!classDoc.exists) {
                        console.log(`Class ${classId} not found`);
                        return null;
                    }

                    const classData = classDoc.data();
                    console.log('Class Data:', classData);
                    
                    // Fetch season information and fees
                    const seasonDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Seasons')
                        .doc(classData.SeasonId)
                        .get();

                    const seasonData = seasonDoc.exists ? seasonDoc.data() : null;
                    console.log('Season Data:', seasonData);

                    // Fetch fees from Fees subcollection if season has fees
                    if (seasonData && seasonData.Fees) {
                        const feePromises = seasonData.Fees.map(feeId => 
                            firebase.firestore()
                                .collection('Studios')
                                .doc(currentStudioId)
                                .collection('Fees')
                                .doc(feeId)
                                .get()
                        );
                        
                        const feeDocs = await Promise.all(feePromises);
                        const fees = feeDocs
                            .filter(doc => doc.exists)
                            .map(doc => {
                                const feeData = doc.data();
                                totalFees += feeData.Amount || 0;
                                return {
                                    id: doc.id,
                                    ...feeData
                                };
                            });
                        
                        console.log('Season Fees:', fees);
                        seasonFees.push(...fees);
                    }
                    
                    // Fetch rate plan
                    const ratePlanDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('RatePlans')
                        .doc(classData.RatePlanId)
                        .get();

                    const ratePlan = ratePlanDoc.exists ? ratePlanDoc.data() : null;
                    console.log('Rate Plan:', ratePlan);

                    // Calculate and track hours per rate plan
                    const classHours = classData.Duration / 60;
                    totalHours += classHours;
                    
                    if (ratePlan) {
                        ratePlanHours[classData.RatePlanId] = (ratePlanHours[classData.RatePlanId] || 0) + classHours;
                        console.log(`Hours for Rate Plan ${ratePlan.Name}: ${ratePlanHours[classData.RatePlanId]}`);
                    }

                    return {
                        ...classData,
                        ratePlan,
                        seasonData,
                        classHours
                    };
                });

                const classesWithRates = await Promise.all(classPromises);
                console.log('Total Hours:', totalHours);
                console.log('Hours per Rate Plan:', ratePlanHours);
                
                // Calculate tuition based on hours per rate plan
                let totalTuition = 0;
                for (const [ratePlanId, hours] of Object.entries(ratePlanHours)) {
                    const ratePlanDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('RatePlans')
                        .doc(ratePlanId)
                        .get();
                    
                    if (ratePlanDoc.exists) {
                        const ratePlan = ratePlanDoc.data();
                        // Find the appropriate rate for these hours
                        const rate = ratePlan.HourRates.find(r => r.Hours === hours) || 
                                    ratePlan.HourRates.find(r => r.Hours > hours);
                        
                        if (rate) {
                            totalTuition += rate.Rate;
                            console.log(`Tuition for ${hours} hours in ${ratePlan.Name}: $${rate.Rate}`);
                        }
                    }
                }

                // Update the summary display
                const summaryHTML = `
                    <div class="student-summary mb-4">
                        <h6>Student Information</h6>
                        <div class="detail-item bg-white">
                            <p><strong>${newStudentData.FirstName} ${newStudentData.LastName}</strong></p>
                            <p>Age: ${newStudentData.Age}</p>
                            <p>Level: ${newStudentData.SkillLevel}</p>
                        </div>
                    </div>
                    
                    <div class="selected-classes mb-4">
                        <h6>Selected Classes</h6>
                        ${classesWithRates.map(classInfo => `
                            <div class="detail-item bg-white mb-2">
                                <div class="d-flex justify-content-between w-100">
                                    <div>
                                        <strong>${classInfo.ClassName}</strong>
                                        <div class="text-muted">
                                            ${classInfo.Days.join(', ')} ${classInfo.StartTime} - ${classInfo.EndTime}
                                            <br>
                                            <small>${classInfo.classHours} hours per week</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="fees-summary mt-4">
                        <h6>Fees Breakdown</h6>
                        <div class="detail-item bg-white">
                            <div class="d-flex flex-column w-100">
                                ${seasonFees.map(fee => `
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>${fee.Name}:</span>
                                        <span>${formatCurrency(fee.Amount)}</span>
                                    </div>
                                `).join('')}
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Monthly Tuition (${totalHours} total hours):</span>
                                    <span>${formatCurrency(totalTuition)}</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold pt-2 border-top">
                                    <span>Total Due Today:</span>
                                    <span>${formatCurrency(totalFees + totalTuition)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('registrationSummary').innerHTML = summaryHTML;
                
                // Store registration data
                newStudentData.TotalFees = totalFees;
                newStudentData.MonthlyTuition = totalTuition;
                newStudentData.TotalHours = totalHours;
                newStudentData.RatePlanHours = ratePlanHours;
                
                console.log('=== Registration Summary Complete ===');
                console.log('Season Fees:', totalFees);
                console.log('Monthly Tuition:', totalTuition);
                console.log('Total Hours:', totalHours);
                console.log('Hours per Rate Plan:', ratePlanHours);
                
            } catch (error) {
                console.error('Error updating registration summary:', error);
                document.getElementById('registrationSummary').innerHTML = 
                    '<div class="alert alert-danger">Error loading registration summary</div>';
            }
        }

        // Update the completeRegistration function
        async function completeRegistration() {
            try {
                // Create new student document
                const studentRef = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .add({
                        ...newStudentData,
                        Classes: selectedClasses,
                        FamilyId: currentFamilyId,
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                // Create charge object with proper date formatting
                const charge = {
                    Amount: newStudentData.TotalFees,
                    ChargeDate: new Date().toISOString(), // Changed from Date to ISO string
                    Description: `Registration fees for ${newStudentData.FirstName} ${newStudentData.LastName}`,
                    Status: "Unpaid",
                    Type: "Registration",
                    StudentId: studentRef.id
                };

                // Update all selected classes with new student
                const classUpdates = selectedClasses.map(classId => 
                    firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Classes')
                        .doc(classId)
                        .update({
                            Students: firebase.firestore.FieldValue.arrayUnion(studentRef.id)
                        })
                );

                // Update family document
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .update({
                        Students: firebase.firestore.FieldValue.arrayUnion(studentRef.id),
                        Balance: firebase.firestore.FieldValue.increment(newStudentData.TotalFees),
                        Charges: firebase.firestore.FieldValue.arrayUnion(charge)
                    });

                // Wait for all updates to complete
                await Promise.all(classUpdates);

                closeAddStudentModal();
                loadStudentsDetails(); // Refresh the students list
                loadFinancialInformation(); // Refresh financial information
                alert('Student registration completed successfully!');
            } catch (error) {
                console.error('Error completing registration:', error);
                alert('Error completing registration. Please try again.');
            }
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // Function to save class enrollments
        async function saveClassEnrollments() {
            try {
                if (!selectedClasses.length) {
                    alert('Please select at least one class to enroll in');
                    return;
                }

                const studentRef = firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(currentStudentId);
                    
                // Get current student data
                const studentDoc = await studentRef.get();
                const studentData = studentDoc.data();
                
                // Get existing class IDs or initialize empty array
                const existingClassIds = studentData.Classes || [];
                
                // Add new class IDs, avoiding duplicates
                const updatedClassIds = [...existingClassIds];
                selectedClasses.forEach(classId => {
                    if (!updatedClassIds.includes(classId)) {
                        updatedClassIds.push(classId);
                    }
                });

                console.log('Updating student with class IDs:', updatedClassIds);
                
                // Update student document with just the class IDs
                await studentRef.update({
                    Classes: updatedClassIds,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Close modal and refresh displays
                closeEnrollmentModal();
                loadStudentsDetails();
                loadClassesDetails();
                
                alert('Successfully enrolled in selected classes!');
                
            } catch (error) {
                console.error('Error saving enrollments:', error);
                console.error('Error details:', error.message);
                alert('There was an error enrolling in classes. Please try again.');
            }
        }

        // Function to close enrollment modal
        function closeEnrollmentModal() {
            const modal = document.getElementById('classEnrollmentModal');
            modal.classList.remove('show');
            selectedClasses = [];
            currentStudentId = null;
        }

        // Function to load classes details
        async function loadClassesDetails() {
            if (!checkRequiredIds()) return;
            
            const container = document.querySelector('.student-classes-list');
            if (!container) {
                console.error('Classes container not found');
                return;
            }

            try {
                // Get family document
                const familyDoc = await getFamilyDoc();
                if (!familyDoc || !familyDoc.exists) {
                    console.error('Family document not found');
                    return;
                }

                const familyData = familyDoc.data();
                const studentIds = familyData.Students || [];
                let classesHTML = '';

                // Fetch each student's details and classes
                for (const studentId of studentIds) {
                    const studentDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Students')
                        .doc(studentId)
                        .get();

                    if (studentDoc.exists) {
                        const student = studentDoc.data();
                        const classIds = student.Classes || [];

                        // Start student section
                        classesHTML += `
                            <div class="student-class-section mb-4">
                                <h3 class="student-name mb-3">
                                    <i class="fas fa-user-graduate me-2"></i>
                                    ${student.FirstName} ${student.LastName}
                                    <span class="badge bg-primary ms-2">${classIds.length} Classes</span>
                                </h3>
                        `;

                        if (classIds.length > 0) {
                            // Fetch all class documents for this student
                            const classPromises = classIds.map(classId => 
                                firebase.firestore()
                                    .collection('Studios')
                                    .doc(currentStudioId)
                                    .collection('Classes')
                                    .doc(classId)
                                    .get()
                            );

                            const classDocs = await Promise.all(classPromises);
                            const classes = classDocs
                                .filter(doc => doc.exists)
                                .map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));

                            // Add classes grid
                            classesHTML += `
                                <div class="class-grid">
                                    ${classes.map(classInfo => `
                                        <div class="class-card">
                                            <h4 class="class-name">${classInfo.ClassName}</h4>
                                            <div class="class-details">
                                                <div class="detail-item">
                                                    <i class="fas fa-calendar-day"></i>
                                                    <span>${classInfo.Days ? classInfo.Days.join(', ').toUpperCase() : 'N/A'}</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-clock"></i>
                                                    <span>${classInfo.StartTime || ''}-${classInfo.EndTime || ''}</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-hourglass-half"></i>
                                                    <span>${classInfo.Duration || 0} minutes</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-chalkboard-teacher"></i>
                                                    <span>${classInfo.ClassType || 'Not specified'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            classesHTML += `
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No classes enrolled
                                </div>
                            `;
                        }

                        // Close student section
                        classesHTML += '</div>';
                    }
                }

                // Update the container with all the HTML
                container.innerHTML = classesHTML || '<p>No enrolled classes found</p>';

            } catch (error) {
                console.error('Error loading classes details:', error);
                container.innerHTML = '<div class="alert alert-danger">Error loading classes information</div>';
            }
        }

        // Make sure loadClassesDetails is called when the Classes tab is shown
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                if (event.target.getAttribute('href') === '#classes') {
                    loadClassesDetails();
                }
            });
        });

        // Also call it on initial load if we're on the Classes tab
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash === '#classes') {
                loadClassesDetails();
            }
        });

        // Add these functions to your script section
        
        // Function to get family document
        async function getFamilyDoc() {
            if (!currentStudioId || !currentFamilyId) {
                console.error('Missing studio ID or family ID');
                return null;
            }
            
            try {
                const familyDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .get();
                    
                return familyDoc;
            } catch (error) {
                console.error('Error getting family doc:', error);
                return null;
            }
        }

        // Function to show class enrollment selection
        async function showClassEnrollmentSelection() {
            if (!checkRequiredIds()) return;
            
            try {
                console.log('Opening enrollment modal...');
                const modal = document.getElementById('classEnrollmentModal');
                const enrollmentContent = document.getElementById('enrollmentStudentName');
                
                if (!modal || !enrollmentContent) {
                    console.error('Modal elements not found');
                    return;
                }

                // Get family document to get list of students
                const familyDoc = await getFamilyDoc();
                if (!familyDoc || !familyDoc.exists) {
                    throw new Error('Family document not found');
                }

                const familyData = familyDoc.data();
                console.log('Family data:', familyData);

                // Get students for this family using the students array from family doc
                const studentIds = familyData.students || [];
                console.log('Student IDs from family:', studentIds);

                if (studentIds.length === 0) {
                    enrollmentContent.innerHTML = '<p>No students found in this family.</p>';
                    modal.classList.add('show');
                    return;
                }

                // Fetch all student documents
                const studentPromises = studentIds.map(studentId => 
                    firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Students')
                        .doc(studentId)
                        .get()
                );

                const studentDocs = await Promise.all(studentPromises);
                const students = studentDocs
                    .filter(doc => doc.exists)
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                console.log('Fetched students:', students);

                // Create student selection dropdown HTML with correct field names
                const studentOptions = students.map(student => 
                    `<option value="${student.id}">${student.FirstName} ${student.LastName}</option>`
                ).join('');

                // Update modal content
                enrollmentContent.innerHTML = `
                    <h3 class="mb-4">Select Student to Enroll</h3>
                    <div class="form-group mb-4">
                        <label for="studentSelect" class="form-label">Choose Student:</label>
                        <select id="studentSelect" class="form-select" onchange="handleStudentSelect(this.value)">
                            <option value="">Select a student...</option>
                            ${studentOptions}
                        </select>
                    </div>
                    <div id="classSelectionArea" style="display: none;">
                        <h4 class="mt-4 mb-3">Available Classes</h4>
                        <div class="class-filters mb-3 d-flex gap-2">
                            <select id="modalLevelFilter" class="form-select" onchange="filterModalClasses()">
                                <option value="all">All Levels</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                            
                            <select id="modalStyleFilter" class="form-select" onchange="filterModalClasses()">
                                <option value="all">All Styles</option>
                                <option value="ballet">Ballet</option>
                                <option value="hiphop">Hip Hop</option>
                                <option value="jazz">Jazz</option>
                                <option value="contemporary">Contemporary</option>
                                <option value="tap">Tap</option>
                            </select>
                        </div>
                        <div id="modalClassGrid" class="class-grid">
                            <!-- Classes will be populated here -->
                        </div>
                    </div>
                `;

                // Show the modal
                modal.classList.add('show');
                console.log('Modal opened successfully');

            } catch (error) {
                console.error('Error showing class enrollment selection:', error);
                alert('Error loading student selection. Please try again.');
            }
        }

        // Function to handle student selection
        async function handleStudentSelect(studentId) {
            if (!studentId) {
                document.getElementById('classSelectionArea').style.display = 'none';
                return;
            }
            
            console.log('Student selected:', studentId);
            currentStudentId = studentId;
            
            try {
                // Fetch student document to get their current classes
                const studentDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(studentId)
                    .get();
                    
                if (studentDoc.exists) {
                    const studentData = studentDoc.data();
                    console.log('Student data:', studentData);
                    console.log('Current classes:', studentData.Classes || []);
                    
                    // Store current classes globally
                    selectedClasses = studentData.Classes || [];
                    existingClasses = [...selectedClasses]; // Keep track of existing classes
                }

                // Show the class selection area
                const classSelectionArea = document.getElementById('classSelectionArea');
                if (classSelectionArea) {
                    classSelectionArea.style.display = 'block';
                }

                // Load and display available classes
                await loadAvailableClasses();
                populateModalClassGrid();
                
            } catch (error) {
                console.error('Error handling student selection:', error);
            }
        }

        // Function to get student data
        async function getStudentData(studentId) {
            try {
                const studentDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(studentId)
                    .get();
                    
                if (studentDoc.exists) {
                    return studentDoc.data();
                }
                return null;
            } catch (error) {
                console.error('Error getting student data:', error);
                return null;
            }
        }

        // Add filter modal classes function
        function filterModalClasses() {
            const levelFilter = document.getElementById('modalLevelFilter').value;
            const styleFilter = document.getElementById('modalStyleFilter').value;
            
            const classCards = document.querySelectorAll('#modalClassGrid .class-card');
            classCards.forEach(card => {
                const level = card.dataset.level;
                const style = card.dataset.style;
                
                const matchesLevel = levelFilter === 'all' || level === levelFilter;
                const matchesStyle = styleFilter === 'all' || style === styleFilter;
                
                card.style.display = matchesLevel && matchesStyle ? 'block' : 'none';
            });
        }

        // Add a function to ensure we have the required IDs
        function checkRequiredIds() {
            if (!currentStudioId || !currentFamilyId) {
                // Try to get from localStorage if not in global variables
                currentStudioId = localStorage.getItem('currentStudioId');
                currentFamilyId = localStorage.getItem('currentFamilyId');
                
                if (!currentStudioId || !currentFamilyId) {
                    console.error('Required IDs not found');
                    window.location.href = '/portallogin.html';
                    return false;
                }
            }
            return true;
        }

        // Add event listener for modal close button
        document.querySelector('#classEnrollmentModal .close').addEventListener('click', function() {
            closeEnrollmentModal();
        });

        // Add event listener for clicking outside modal
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('classEnrollmentModal');
            if (event.target === modal) {
                closeEnrollmentModal();
            }
        });

        // Now let's add a function to load financial information
        async function loadFinancialInformation() {
            try {
                if (!currentFamilyId || !currentStudioId) return;
                
                // Get latest family data
                const familyDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .get();
                        
                if (!familyDoc.exists) {
                    console.error('Family document not found');
                    return;
                }
                
                const updatedFamilyData = familyDoc.data();
                familyData = updatedFamilyData; // Update the global family data
                
                // Update current balance display
                currentBalance = updatedFamilyData.Balance || 0;
                const balanceElement = document.getElementById('currentBalance');
                if (balanceElement) {
                    balanceElement.textContent = formatCurrency(currentBalance);
                    balanceElement.classList.toggle('text-danger', currentBalance > 0);
                }
                
                // Update full amount option in payment modal
                const fullAmountDisplay = document.getElementById('fullAmountDisplay');
                if (fullAmountDisplay) {
                    fullAmountDisplay.textContent = formatCurrency(Math.abs(currentBalance));
                }
                
                // Fetch charges from the Families Charges subcollection
                const chargesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .collection('Charges')
                    .orderBy('ChargeDate', 'desc')
                    .get();
                    
                const charges = chargesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Fetch payments from the Families Payments subcollection
                let payments = [];
                try {
                    const paymentsSnapshot = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Families')
                        .doc(currentFamilyId)
                        .collection('Payments')
                        .orderBy('PaymentDate', 'desc')
                        .get();
                        
                    payments = paymentsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.log('No payments collection found or error fetching payments:', error);
                    // If payments collection doesn't exist yet, fall back to payments array in family doc
                    payments = updatedFamilyData.Payments || [];
                }
                
                // Update payment history
                const paymentHistoryContainer = document.getElementById('paymentHistoryContainer');
                if (!paymentHistoryContainer) return;
                
                if (charges.length === 0 && payments.length === 0) {
                    paymentHistoryContainer.innerHTML = `
                        <div class="no-charges text-center p-4">
                            <i class="fas fa-file-invoice-dollar fa-3x mb-3"></i>
                            <h5>No transaction history</h5>
                            <p class="text-muted">When you make payments or receive charges, they will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                // Combine charges and payments into a single array
                const transactions = [
                    ...charges.map(charge => ({
                        ...charge,
                        transactionDate: new Date(charge.ChargeDate),
                        isCharge: true
                    })),
                    ...payments.map(payment => ({
                        ...payment,
                        transactionDate: new Date(payment.PaymentDate),
                        isCharge: false
                    }))
                ];
                
                // Sort all transactions by date (newest first)
                transactions.sort((a, b) => b.transactionDate - a.transactionDate);
                
                let historyHTML = '<div class="payment-history">';
                
                transactions.forEach(transaction => {
                    const formattedDate = transaction.transactionDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const isCredit = transaction.Type === 'Credit';
                    const hasLineItems = transaction.isCharge && transaction.LineItems && transaction.LineItems.length > 0;
                    const transactionId = `transaction-${transaction.id}`;
                    
                    historyHTML += `
                        <div class="payment-item">
                            <div class="d-flex justify-content-between align-items-center p-4">
                                <div>
                                    <div class="d-flex align-items-center mb-1">
                                        ${hasLineItems ? `
                                            <button class="line-items-toggle-btn" 
                                                    onclick="toggleLineItems('${transactionId}')"
                                                    aria-expanded="false"
                                                    aria-controls="${transactionId}-items"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="See Charge Details">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        ` : ''}
                                        <h6 class="mb-0 fw-bold">${transaction.Description}</h6>
                                    </div>
                                    <small class="text-muted">${formattedDate}</small>
                                    <div class="mt-1">
                                        <span class="badge ${
                                            transaction.Status === 'Paid' ? 'bg-success' : 
                                            transaction.Status === 'Pending' ? 'bg-warning' : 
                                            'bg-danger'
                                        }">${transaction.Status}</span>
                                        <span class="badge bg-secondary ms-2">${transaction.Type}</span>
                                    </div>
                                    ${transaction.PaymentMethod?.Type ? `
                                        <small class="text-muted">Paid via ${transaction.PaymentMethod.Type}${
                                            transaction.PaymentMethod.LastFour ? ` ending in ${transaction.PaymentMethod.LastFour}` : ''
                                        }</small>
                                    ` : ''}
                                </div>
                                <div class="text-end">
                                    <h5 class="${transaction.isCharge ? 'text-danger' : 'text-success'}">
                                        ${transaction.isCharge ? '+' : '-'}${formatCurrency(transaction.Amount)}
                                    </h5>
                                </div>
                            </div>
                            ${hasLineItems ? `
                                <div id="${transactionId}-items" class="line-items-container p-3 border-top" style="display:none;">
                                    <div class="line-items-table">
                                        <div class="line-item header d-flex pb-2 mb-2 border-bottom">
                                            <div class="col-5"><strong>Description</strong></div>
                                            <div class="col-2"><strong>Student</strong></div>
                                            <div class="col-2"><strong>Notes</strong></div>
                                            <div class="col-3 text-end"><strong>Amount</strong></div>
                                        </div>
                                        ${transaction.LineItems.map(item => `
                                            <div class="line-item d-flex py-1">
                                                <div class="col-5">${item.Description}</div>
                                                <div class="col-2">${item.StudentName || ''}</div>
                                                <div class="col-2">${item.Notes || ''}</div>
                                                <div class="col-3 text-end">${formatCurrency(item.Amount)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                historyHTML += '</div>';
                paymentHistoryContainer.innerHTML = historyHTML;
                
                // Initialize tooltips for the newly created buttons
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(tooltipTriggerEl => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
            } catch (error) {
                console.error('Error loading financial information:', error);
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(Math.abs(amount));
        }

        // Function to update card display with data
        function updateCardDisplay(cardDetails) {
            console.log('Updating card display with:', cardDetails);
            if (!cardDetails) return;
            
            // Get card info regardless of whether it's an array or object
            const cardInfo = Array.isArray(cardDetails) ? cardDetails[0] : cardDetails;
            if (!cardInfo) return;
            
            console.log('Using card info:', cardInfo);
            
            const displayNumber = document.getElementById('displayCardNumber');
            const displayExpiry = document.getElementById('displayCardExpiry');
            
            if (displayNumber && cardInfo.LastFour) {
                displayNumber.textContent = `â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${cardInfo.LastFour}`;
                
                // Add card type icon if available
                if (cardInfo.CardType) {
                    const cardTypeIcon = document.createElement('i');
                    const cardIconClass = getCardTypeIconClass(cardInfo.CardType);
                    cardTypeIcon.className = cardIconClass + ' me-2';
                    displayNumber.prepend(cardTypeIcon);
                }
            }
            
            if (displayExpiry && cardInfo.ExpirationMonth && cardInfo.ExpirationYear) {
                displayExpiry.textContent = `${cardInfo.ExpirationMonth}/${cardInfo.ExpirationYear}`;
            }
        }
        
        // Helper function to get card icon based on card type
        function getCardTypeIconClass(cardType) {
            const type = cardType.toLowerCase();
            if (type.includes('visa')) return 'fab fa-cc-visa';
            if (type.includes('mastercard')) return 'fab fa-cc-mastercard';
            if (type.includes('amex') || type.includes('american')) return 'fab fa-cc-amex';
            if (type.includes('discover')) return 'fab fa-cc-discover';
            return 'far fa-credit-card'; // default
        }

        // Detect card type from number
        function detectCardType(cardNumber) {
            // Remove spaces and dashes
            const number = cardNumber.replace(/[\s-]/g, '');
            
            // Basic card type detection
            if (number.startsWith('4')) return 'Visa';
            if (/^5[1-5]/.test(number)) return 'Mastercard';
            if (/^3[47]/.test(number)) return 'Amex';
            if (/^6(?:011|5)/.test(number)) return 'Discover';
            return 'Unknown';
        }

        // Show card edit form
        function showCardEditForm() {
            document.getElementById('cardInfoDisplay').style.display = 'none';
            document.getElementById('cardEditForm').style.display = 'block';
            
            // Populate expiration year dropdown
            populateExpirationYears();
            
            // Pre-fill form with existing data if available
            if (familyData && familyData.CardDetails && familyData.CardDetails.length > 0) {
                const cardInfo = familyData.CardDetails[0];
                
                // Don't pre-fill card number (for security), just focus on expiration
                if (cardInfo.ExpirationMonth) {
                    document.getElementById('expirationMonth').value = cardInfo.ExpirationMonth;
                }
                
                if (cardInfo.ExpirationYear) {
                    document.getElementById('expirationYear').value = cardInfo.ExpirationYear;
                }
            }
        }
        
        // Hide card edit form
        function cancelCardEdit() {
            document.getElementById('cardInfoDisplay').style.display = 'block';
            document.getElementById('cardEditForm').style.display = 'none';
        }
        
        // Populate expiration years dropdown (current year + 10 years)
        function populateExpirationYears() {
            const yearSelect = document.getElementById('expirationYear');
            const currentYear = new Date().getFullYear();
            
            // Clear existing options except the placeholder
            while (yearSelect.options.length > 1) {
                yearSelect.remove(1);
            }
            
            // Add 10 years starting from current year
            for (let i = 0; i < 10; i++) {
                const year = currentYear + i;
                const yearLastTwo = year.toString().slice(-2);
                const option = document.createElement('option');
                option.value = yearLastTwo;
                option.textContent = yearLastTwo;
                yearSelect.appendChild(option);
            }
        }
        
        // Save card information
        async function saveCardInfo() {
            try {
                const cardNumber = document.getElementById('cardNumber').value.trim().replace(/\s/g, '');
                const expirationMonth = document.getElementById('expirationMonth').value;
                const expirationYear = document.getElementById('expirationYear').value;
                const cvc = document.getElementById('cardCVC').value.trim();
                
                // Basic validation
                if (cardNumber.length < 15 || !expirationMonth || !expirationYear || cvc.length < 3) {
                    alert('Please complete all card information fields correctly.');
                    return;
                }
                
                // Detect card type
                const cardType = detectCardType(cardNumber);
                
                // Get last four digits
                const lastFour = cardNumber.slice(-4);
                
                // Update the family document with card details as a direct object
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .update({
                        CardDetails: {
                            LastFour: lastFour,
                            ExpirationMonth: expirationMonth,
                            ExpirationYear: expirationYear,
                            CardType: cardType
                            // Note: Never store CVC in your database
                        }
                    });
                
                // Refresh family data
                await loadFinancialInformation();
                
                // Show success message and hide form
                alert('Card information updated successfully!');
                cancelCardEdit();
                
            } catch (error) {
                console.error('Error saving card information:', error);
                alert('Error updating card information. Please try again.');
            }
        }
        
        // Format card number with spaces
        document.addEventListener('DOMContentLoaded', function() {
            const cardNumberInput = document.getElementById('cardNumber');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    // Insert space every 4 digits
                    if (value.length > 0) {
                        value = value.match(/.{1,4}/g).join(' ');
                    }
                    e.target.value = value;
                });
            }
            
            // Format modal card number input
            const modalCardNumberInput = document.getElementById('modalCardNumber');
            if (modalCardNumberInput) {
                modalCardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        value = value.match(/.{1,4}/g).join(' ');
                    }
                    e.target.value = value;
                });
            }
            
            // Populate expiration years in modal
            populateModalExpirationYears();
        });

        // Update the event listeners to ensure the function is called when the tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            const financeTab = document.querySelector('a[href="#finance"]');
            if (financeTab) {
                console.log('Found finance tab');
                // Call the function when the tab is shown via Bootstrap tab event
                financeTab.addEventListener('shown.bs.tab', async function() {
                    console.log('=== Finance Tab Selected ===');
                    await loadFinancialInformation();
                });
                
                // Also call it if the tab is directly clicked
                financeTab.addEventListener('click', function() {
                    console.log('Finance tab clicked - loading financial information');
                    loadFinancialInformation();
                });
            } else {
                console.error('Finance tab not found');
            }
        });

        // Simplify the showPaymentModal function
        async function showPaymentModal() {
            try {
                if (!familyData) {
                    loadFinancialInformation();
                }

                const modal = document.getElementById('paymentModal');
                const fullAmountDisplay = document.getElementById('fullAmountDisplay');
                
                fullAmountDisplay.textContent = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(currentBalance);

                // Display the current billing information
                displayBillingInfo();

                modal.classList.add('show');
                console.log('Payment modal opened with balance:', currentBalance);
            } catch (error) {
                console.error('Error showing payment modal:', error);
                alert('Error loading payment information. Please try again.');
            }
        }

        // Function to display billing information in the payment modal
        function displayBillingInfo() {
            console.log('Displaying billing info');
            const billingInfoContainer = document.getElementById('billingInfoDisplay');
            if (!billingInfoContainer) {
                console.error('Billing info container not found');
                return;
            }
            
            // Debug the data
            debugCardDetails();
            
            if (familyData && familyData.CardDetails) {
                // Get card info regardless of whether it's an array or object
                const cardInfo = Array.isArray(familyData.CardDetails) ? 
                    familyData.CardDetails[0] : familyData.CardDetails;
                
                if (cardInfo && cardInfo.LastFour) {
                    console.log('Found card info:', cardInfo);
                    // Get the appropriate card icon
                    const cardIconClass = getCardTypeIconClass(cardInfo.CardType || 'Unknown');
                    
                    // Create HTML for card info display
                    billingInfoContainer.innerHTML = `
                        <div class="card-display">
                            <div class="d-flex align-items-center mb-2">
                                <i class="${cardIconClass} fa-lg me-2"></i>
                                <span>â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${cardInfo.LastFour || '****'}</span>
                            </div>
                            <div>
                                <small class="text-muted">Expires: ${cardInfo.ExpirationMonth || 'MM'}/${cardInfo.ExpirationYear || 'YY'}</small>
                            </div>
                        </div>
                    `;
                } else {
                    console.log('Card info missing or incomplete');
                    billingInfoContainer.innerHTML = `
                        <div class="no-card-info">
                            <p class="text-muted mb-0">Card information incomplete</p>
                        </div>
                    `;
                }
            } else {
                console.log('No CardDetails found');
                billingInfoContainer.innerHTML = `
                    <div class="no-card-info">
                        <p class="text-muted mb-0">No payment method added.</p>
                    </div>
                `;
            }
        }

        // Function to toggle between showing and editing billing information
        function toggleBillingEdit() {
            const displayElement = document.getElementById('billingDisplay');
            const formElement = document.getElementById('billingForm');
            
            if (displayElement.style.display === 'none') {
                // Switch back to display mode
                displayElement.style.display = 'block';
                formElement.style.display = 'none';
                // Refresh display
                displayBillingInfo();
            } else {
                // Switch to edit mode
                displayElement.style.display = 'none';
                formElement.style.display = 'block';
                
                // Pre-fill form with existing data if available
                if (familyData && familyData.CardDetails && familyData.CardDetails.length > 0) {
                    const cardInfo = familyData.CardDetails[0];
                    if (cardInfo.ExpirationMonth) {
                        document.getElementById('modalExpirationMonth').value = cardInfo.ExpirationMonth;
                    }
                    if (cardInfo.ExpirationYear) {
                        document.getElementById('modalExpirationYear').value = cardInfo.ExpirationYear;
                    }
                }
            }
        }

        // Function to populate the billing edit form
        function populateBillingForm() {
            const billingForm = document.getElementById('billingForm');
            
            // Create the form HTML
            billingForm.innerHTML = `
                <div class="card-form-group">
                    <label class="form-label">Card Number</label>
                    <input type="text" class="card-input" id="modalCardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                </div>
                <div class="card-form-row">
                    <div class="card-form-group" style="flex: 1;">
                        <label class="form-label">Expiration Date</label>
                        <div class="d-flex gap-2">
                            <select class="card-input" id="modalExpirationMonth">
                                <option value="">MM</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <select class="card-input" id="modalExpirationYear">
                                <option value="">YY</option>
                                <!-- Years will be populated via JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="card-form-group" style="width: 100px;">
                        <label class="form-label">CVC</label>
                        <input type="text" class="card-input" id="modalCardCVC" placeholder="123" maxlength="4">
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveBillingInfo()">
                        Save Card
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleBillingEdit()">
                        Cancel
                    </button>
                </div>
            `;
            
            // Populate expiration years dropdown
            populateModalExpirationYears();
            
            // Add card input formatting
            const cardNumberInput = document.getElementById('modalCardNumber');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        value = value.match(/.{1,4}/g).join(' ');
                    }
                    e.target.value = value;
                });
            }
            
            // Pre-fill form with existing data
            if (familyData && familyData.CardDetails && familyData.CardDetails[0]) {
                const cardInfo = familyData.CardDetails[0];
                if (cardInfo.ExpirationMonth) {
                    document.getElementById('modalExpirationMonth').value = cardInfo.ExpirationMonth;
                }
                if (cardInfo.ExpirationYear) {
                    document.getElementById('modalExpirationYear').value = cardInfo.ExpirationYear;
                }
            }
        }

        // Function to populate expiration years dropdown in the modal
        function populateModalExpirationYears() {
            const yearSelect = document.getElementById('modalExpirationYear');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            
            // Clear existing options except the placeholder
            while (yearSelect.options.length > 1) {
                yearSelect.remove(1);
            }
            
            // Add 10 years starting from current year
            for (let i = 0; i < 10; i++) {
                const year = currentYear + i;
                const yearLastTwo = year.toString().slice(-2);
                const option = document.createElement('option');
                option.value = yearLastTwo;
                option.textContent = yearLastTwo;
                yearSelect.appendChild(option);
            }
        }

        // Function to save billing info from the payment modal
        async function saveBillingInfo() {
            try {
                const cardNumber = document.getElementById('modalCardNumber').value.trim().replace(/\s/g, '');
                const expirationMonth = document.getElementById('modalExpirationMonth').value;
                const expirationYear = document.getElementById('modalExpirationYear').value;
                const cvc = document.getElementById('modalCardCVC').value.trim();
                
                // Basic validation
                if (cardNumber.length < 15 || !expirationMonth || !expirationYear || cvc.length < 3) {
                    alert('Please complete all card information fields correctly.');
                    return;
                }
                
                // Detect card type
                const cardType = detectCardType(cardNumber);
                
                // Get last four digits
                const lastFour = cardNumber.slice(-4);
                
                // Update the family document with card details as a direct object
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .update({
                        CardDetails: {
                            LastFour: lastFour,
                            ExpirationMonth: expirationMonth,
                            ExpirationYear: expirationYear,
                            CardType: cardType
                            // Note: Never store CVC in your database
                        }
                    });
                
                // Refresh family data and display
                await loadFinancialInformation();
                toggleBillingEdit(); // Switch back to display mode
                
                // Show success message
                alert('Card information updated successfully!');
                
            } catch (error) {
                console.error('Error saving billing information:', error);
                alert('Error updating card information. Please try again.');
            }
        }

        function selectAmount(type) {
            selectedAmount = type;
            document.getElementById('fullAmountOption').classList.toggle('selected', type === 'full');
            document.getElementById('customAmountOption').classList.toggle('selected', type === 'custom');
            document.getElementById('customAmountInput').classList.toggle('show', type === 'custom');
        }

        function validateCustomAmount(value) {
            const amount = parseFloat(value);
            if (amount <= 0) {
                alert('Please enter a valid amount greater than 0');
                return false;
            }
            if (amount > currentBalance) {
                alert('Amount cannot exceed current balance');
                return false;
            }
            return true;
        }

        // Update the processPayment function to use selectedAmount instead of radio buttons
        async function processPayment() {
            try {
                console.log("Processing payment...");
                
                // Get payment amount based on selectedAmount global variable
                let paymentAmount = 0;
                
                if (selectedAmount === 'full') {
                    paymentAmount = Math.abs(currentBalance);
                } else if (selectedAmount === 'custom') {
                    const customAmountInput = document.getElementById('customAmountValue');
                    if (!customAmountInput) {
                        console.error('Custom amount input not found');
                        alert('Cannot read custom amount. Please try again.');
                        return;
                    }
                    paymentAmount = parseFloat(customAmountInput.value);
                } else {
                    alert('Please select a payment option');
                    return;
                }
                
                // Validate amount
                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert('Please enter a valid payment amount');
                    return;
                }
                
                console.log(`Processing ${selectedAmount} payment of $${paymentAmount}`);
                
                if (!familyData) {
                    alert('Family data not found');
                    return;
                }
                
                // Debug
                console.log("Family data:", familyData);
                console.log("Card details:", familyData.CardDetails);
                
                // Validate card information is available
                if (!familyData.CardDetails) {
                    alert('Please add a payment method before proceeding');
                    toggleBillingEdit();
                    return;
                }
                
                // Get card info regardless of whether it's an array or object
                const cardInfo = Array.isArray(familyData.CardDetails) ? 
                    familyData.CardDetails[0] : familyData.CardDetails;
                    
                console.log("Using card info:", cardInfo);
                
                if (!cardInfo || !cardInfo.LastFour) {
                    alert('Card information is incomplete. Please update your payment method.');
                    toggleBillingEdit();
                    return;
                }
                
                // Create payment object
                const payment = {
                    Amount: paymentAmount,
                    PaymentDate: new Date().toISOString(),
                    Description: "Portal Payment",
                    Status: "Paid",
                    Type: "Credit",
                    PaymentMethod: {
                        Type: "Card",
                        LastFour: cardInfo.LastFour,
                        CardType: cardInfo.CardType || 'Unknown'
                    },
                    FamilyId: currentFamilyId,
                    FamilyName: familyData.FamilyName || `${familyData.FirstName} ${familyData.LastName}`,
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log("Payment object:", payment);
                
                // 1. Add to the Studio-level Payments collection
                console.log("Adding payment to Studio's Payments collection...");
                const studioPaymentRef = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Payments')
                    .add(payment);
                    
                console.log("Payment added to Studio's Payments collection with ID:", studioPaymentRef.id);
                
                // 2. Add to Family's Payments subcollection with the same ID for reference
                console.log("Adding payment to Family's Payments subcollection...");
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .collection('Payments')
                    .doc(studioPaymentRef.id)  // Use same ID for reference
                    .set({
                        ...payment,
                        StudioPaymentId: studioPaymentRef.id  // Reference to studio payment
                    });
                
                console.log("Payment added to Family's Payments subcollection");
                
                // 3. Update family's balance
                console.log("Updating family balance...");
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .update({
                        Balance: firebase.firestore.FieldValue.increment(-paymentAmount),
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                console.log("Family document balance updated successfully");
                
                // Close modal and refresh financial information
                closePaymentModal();
                await loadFinancialInformation();
                
                alert('Payment processed successfully!');
            } catch (error) {
                console.error('Error processing payment:', error);
                console.error('Error details:', error.code, error.message);
                
                let errorMessage = 'Error processing payment. ';
                if (error.code === 'permission-denied') {
                    errorMessage += 'You do not have permission to make payments.';
                } else if (error.code === 'not-found') {
                    errorMessage += 'Payment information not found.';
                } else {
                    errorMessage += 'Please try again later.';
                }
                
                alert(errorMessage);
            }
        }

        // Update the showAddStudentModal function
        function showAddStudentModal() {
            currentModalStep = 1;
            newStudentData = {};
            const modal = document.getElementById('addStudentModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            updateModalStep();
        }

        // Update the closeAddStudentModal function
        function closeAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            resetNewStudentForm();
        }

        // Add the resetNewStudentForm function
        function resetNewStudentForm() {
            document.getElementById('newStudentForm').reset();
            document.getElementById('newStudentPhotoPreview').innerHTML = '';
            currentModalStep = 1;
            newStudentData = {};
        }

        // Add these functions to your script section
        function updateModalStep() {
            const studentForm = document.getElementById('newStudentForm');
            const classSelection = document.getElementById('classSelectionSection');
            const summary = document.getElementById('registrationSummary');
            const nextBtn = document.getElementById('nextStepBtn');

            switch(currentModalStep) {
                case 1:
                    studentForm.style.display = 'block';
                    classSelection.style.display = 'none';
                    summary.style.display = 'none';
                    nextBtn.textContent = 'Next';
                    break;
                case 2:
                    studentForm.style.display = 'none';
                    classSelection.style.display = 'block';
                    summary.style.display = 'none';
                    nextBtn.textContent = 'Next';
                    loadAvailableClasses();
                    break;
                case 3:
                    studentForm.style.display = 'none';
                    classSelection.style.display = 'none';
                    summary.style.display = 'block';
                    nextBtn.textContent = 'Complete Registration';
                    updateRegistrationSummary();
                    break;
            }
        }

        async function handleNextStep() {
            if (currentModalStep === 1) {
                if (validateStudentForm()) {
                    saveStudentData();
                    currentModalStep++;
                    updateModalStep();
                }
            } else if (currentModalStep === 2) {
                if (validateClassSelection()) {
                    currentModalStep++;
                    updateModalStep();
                }
            } else if (currentModalStep === 3) {
                await completeRegistration();
            }
        }

        function validateStudentForm() {
            const form = document.getElementById('newStudentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            return true;
        }

        function saveStudentData() {
            newStudentData = {
                FirstName: document.getElementById('newStudentFirstName').value,
                LastName: document.getElementById('newStudentLastName').value,
                DateOfBirth: document.getElementById('newStudentDOB').value,
                SkillLevel: document.getElementById('newStudentSkillLevel').value,
                MedicalConditions: document.getElementById('newStudentMedical').value,
                Age: calculateAge(document.getElementById('newStudentDOB').value)
            };
        }

      
       

        function showEnrollmentModal() {
            currentEnrollmentStep = 1;
            selectedStudentId = null;
            selectedClasses = [];
            const modal = document.getElementById('enrollmentModal');
            modal.classList.add('show');
            populateFamilyStudents();
            updateEnrollmentStep();
        }

        function closeEnrollmentModal() {
            const modal = document.getElementById('enrollmentModal');
            modal.classList.remove('show');
            resetEnrollmentForm();
        }

        function resetEnrollmentForm() {
            currentEnrollmentStep = 1;
            selectedStudentId = null;
            selectedClasses = [];
            updateEnrollmentStep();
        }

        async function populateFamilyStudents() {
            const container = document.getElementById('familyStudentsList');
            
            try {
                const familyDoc = await getFamilyDoc();
                if (!familyDoc.exists) return;

                const familyData = familyDoc.data();
                const studentIds = familyData.Students || [];

                const studentsPromises = studentIds.map(id => 
                    firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Students')
                        .doc(id)
                        .get()
                );

                const studentDocs = await Promise.all(studentsPromises);
                const studentsHTML = studentDocs
                    .filter(doc => doc.exists)
                    .map(doc => {
                        const student = doc.data();
                        return `
                            <div class="student-selection-card ${selectedStudentId === doc.id ? 'selected' : ''}"
                                 onclick="selectStudent('${doc.id}')">
                                <div class="student-image-container">
                                    ${student.PhotoURL ? 
                                        `<img src="${student.PhotoURL}" alt="${student.FirstName}" class="student-image">` :
                                        `<div class="student-image-placeholder">
                                            <i class="fas fa-user-circle"></i>
                                        </div>`
                                    }
                                </div>
                                <h5>${student.FirstName} ${student.LastName}</h5>
                                <p>Age: ${student.Age} | Level: ${student.SkillLevel}</p>
                            </div>
                        `;
                    }).join('');

                container.innerHTML = studentsHTML;
            } catch (error) {
                console.error('Error loading family students:', error);
                container.innerHTML = '<div class="alert alert-danger">Error loading students</div>';
            }
        }

        function selectStudent(studentId) {
            selectedStudentId = studentId;
            document.querySelectorAll('.student-selection-card').forEach(card => {
                card.classList.toggle('selected', card.getAttribute('onclick').includes(studentId));
            });
        }

        function handleEnrollmentNext() {
            switch(currentEnrollmentStep) {
                case 1:
                    if (!selectedStudentId) {
                        alert('Please select a student');
                        return;
                    }
                    currentEnrollmentStep = 2;
                    loadAvailableClasses();
                    break;
                case 2:
                    if (!selectedClasses.length) {
                        alert('Please select at least one class');
                        return;
                    }
                    currentEnrollmentStep = 3;
                    updateEnrollmentSummary();
                    break;
                case 3:
                    completeEnrollment();
                    break;
            }
            updateEnrollmentStep();
        }

        function updateEnrollmentStep() {
            document.querySelectorAll('.enrollment-step').forEach(step => {
                step.style.display = 'none';
            });
            
            document.getElementById(`enrollmentStep${currentEnrollmentStep}`).style.display = 'block';
            
            const nextBtn = document.getElementById('enrollmentNextBtn');
            nextBtn.textContent = currentEnrollmentStep === 3 ? 'Complete Enrollment' : 'Next';
        }

        async function completeEnrollment() {
            try {
                const studentDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(selectedStudentId)
                    .get();

                const studentData = studentDoc.data();
                
                // Create charge for new enrollment
                const charge = {
                    Amount: calculateTotalFees(),
                    ChargeDate: new Date().toISOString(),
                    Description: `Class enrollment fees for ${studentData.FirstName} ${studentData.LastName}`,
                    Status: "Unpaid",
                    Type: "Enrollment",
                    StudentId: selectedStudentId
                };

                // Update student's classes
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(selectedStudentId)
                    .update({
                        Classes: firebase.firestore.FieldValue.arrayUnion(...selectedClasses)
                    });

                // Update family balance and charges
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .update({
                        Balance: firebase.firestore.FieldValue.increment(charge.Amount),
                        Charges: firebase.firestore.FieldValue.arrayUnion(charge)
                    });

                closeEnrollmentModal();
                loadClassesDetails();
                loadFinancialInformation();
                alert('Enrollment completed successfully!');
            } catch (error) {
                console.error('Error completing enrollment:', error);
                alert('Error completing enrollment. Please try again.');
            }
        }

        // Update the populateModalClassGrid function
        async function populateModalClassGrid() {
            const grid = document.getElementById('modalClassGrid');
            if (!grid) return;

            try {
                const classesHTML = studioClasses.map(classObj => {
                    const isSelected = selectedClasses.includes(classObj.Id);
                    const isExisting = existingClasses.includes(classObj.Id);
                    
                    return `
                        <div class="class-card ${isSelected ? 'selected' : ''}" 
                             data-class-id="${classObj.Id}"
                             data-level="${classObj.Level || ''}"
                             data-style="${classObj.ClassStyleId || ''}"
                             onclick="${isExisting ? '' : `toggleModalClass('${classObj.Id}')`}"
                             style="${isExisting ? 'cursor: not-allowed; opacity: 0.8;' : ''}">
                            <div class="class-name">
                                ${classObj.ClassName}
                                ${isExisting ? '<span class="badge bg-secondary ms-2">Currently Enrolled</span>' : ''}
                            </div>
                            <div class="class-details">
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    ${classObj.Days.join(', ')} ${classObj.StartTime} - ${classObj.EndTime}
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-user-friends"></i>
                                    ${classObj.MaxSize} spots max
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-tag"></i>
                                    ${classObj.ClassType}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                grid.innerHTML = classesHTML;
            } catch (error) {
                console.error('Error populating class grid:', error);
                grid.innerHTML = '<div class="alert alert-danger">Error loading classes</div>';
            }
        }

        // Update the toggleModalClass function
        function toggleModalClass(classId) {
            // Don't allow deselecting existing classes
            if (existingClasses.includes(classId)) {
                console.log('Cannot deselect existing class:', classId);
                return;
            }

            const index = selectedClasses.indexOf(classId);
            if (index === -1) {
                // Add class
                selectedClasses.push(classId);
            } else {
                // Remove class only if it's not an existing class
                selectedClasses.splice(index, 1);
            }

            // Update the UI
            populateModalClassGrid();
        }

        // Function to send a message
        async function sendMessage() {
            try {
                const messageInput = document.getElementById('messageInput');
                const messageText = messageInput.value.trim();
                
                if (!messageText || !currentChatId) return;
                
                // Clear input
                messageInput.value = '';
                
                // Get family info for the sender name
                const familyDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .get();
                
                let senderName = 'Family Member';
                if (familyDoc.exists) {
                    const familyData = familyDoc.data();
                    // Updated to get name directly from family document fields
                    if (familyData.FirstName && familyData.LastName) {
                        senderName = `${familyData.FirstName} ${familyData.LastName}`;
                    } else if (familyData.PrimaryContact) {
                        // Fallback to PrimaryContact if exists
                        senderName = `${familyData.PrimaryContact.FirstName} ${familyData.PrimaryContact.LastName}`;
                    }
                }
                
                console.log('Using sender name:', senderName);
                
                // Create message object with the exact field names needed
                const messageData = {
                    Content: messageText,
                    SenderId: currentFamilyId,
                    SenderName: senderName,
                    Timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add message to database
                const messageRef = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Communication')
                    .doc(currentChatId)
                    .collection('Messages')
                    .add(messageData);
                
                console.log('Message sent successfully with ID:', messageRef.id);
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            }
        }

        // Function to create a message element
        function createMessageElement(messageData) {
            const messageDiv = document.createElement('div');
            const isSentByMe = messageData.SenderId === currentFamilyId;
            
            messageDiv.className = `message-bubble ${isSentByMe ? 'message-sent' : 'message-received'}`;
            messageDiv.dataset.messageId = messageData.id || '';
            
            // Format timestamp properly with AM/PM
            const timestamp = messageData.Timestamp?.toDate ? messageData.Timestamp.toDate() : 
                             (messageData.Timestamp ? new Date(messageData.Timestamp) : new Date());
            const timeString = timestamp.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true // Ensure AM/PM format
            });
            
            // Check if message has been edited
            const isEdited = !!messageData.EditedAt;
            
            // Create message HTML structure to match communication.html
            messageDiv.innerHTML = `
                <div class="message-content">${messageData.Content}</div>
                <div class="message-meta">
                    <span class="message-sender">${messageData.SenderName || 'Unknown'}</span>
                    <span class="message-time">
                        ${timeString}
                        ${isEdited ? '<span class="edited-indicator">(edited)</span>' : ''}
                    </span>
                </div>
                ${isSentByMe ? `
                <div class="message-options">
                    <button class="message-options-btn" aria-label="Message options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="message-options-dropdown">
                        <div class="message-option edit-message">
                            <i class="fas fa-edit"></i>
                            Edit
                        </div>
                        <div class="message-option delete-message">
                            <i class="fas fa-trash"></i>
                            Delete
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Add event listeners for the options menu (important to restore this functionality)
            if (isSentByMe) {
                setTimeout(() => {
                    const optionsBtn = messageDiv.querySelector('.message-options-btn');
                    const optionsDropdown = messageDiv.querySelector('.message-options-dropdown');
                    
                    if (optionsBtn && optionsDropdown) {
                        optionsBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            optionsDropdown.classList.toggle('show');
                        });
                        
                        const editBtn = messageDiv.querySelector('.edit-message');
                        if (editBtn) {
                            editBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                editMessage(messageData);
                                optionsDropdown.classList.remove('show');
                            });
                        }
                        
                        const deleteBtn = messageDiv.querySelector('.delete-message');
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                deleteMessage(messageData);
                                optionsDropdown.classList.remove('show');
                            });
                        }
                    }
                }, 0);
            }
            
            return messageDiv;
        }

        // Function to edit a message
        async function editMessage(messageData) {
            try {
                const messageId = messageData.id;
                if (!messageId || !currentChatId) {
                    console.error('Missing message ID or chat ID for edit');
                    return;
                }
                
                // Create simple prompt for editing
                const newContent = prompt('Edit your message:', messageData.Content);
                
                if (!newContent || newContent.trim() === messageData.Content) {
                    return; // No changes or canceled
                }
                
                // Update the message in Firestore with the correct field names
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Communication')
                    .doc(currentChatId)
                    .collection('Messages')
                    .doc(messageId)
                    .update({
                        Content: newContent.trim(),
                        // Use the EditedAt field for compatibility
                        EditedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                console.log('Message updated successfully');
            } catch (error) {
                console.error('Error editing message:', error);
                alert('Error editing message. Please try again.');
            }
        }

        // Function to delete a message
        async function deleteMessage(messageData) {
            try {
                const messageId = messageData.id;
                if (!messageId || !currentChatId) {
                    console.error('Missing message ID or chat ID for delete');
                    return;
                }
                
                // Confirm deletion
                if (!confirm('Are you sure you want to delete this message?')) {
                    return;
                }
                
                // Delete the message from Firestore
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Communication')
                    .doc(currentChatId)
                    .collection('Messages')
                    .doc(messageId)
                    .delete();
                
                console.log('Message deleted successfully');
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }

        // Chat options button click handler
        document.querySelector('.chat-header .btn-icon').addEventListener('click', async function() {
            // Hide tooltip before showing modal
            const tooltip = bootstrap.Tooltip.getInstance(this);
            if (tooltip) {
                tooltip.hide();
            }
            
            if (!currentChatId) return;
            
            try {
                // Get the chat document
                const chatDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Communication')
                    .doc(currentChatId)
                    .get();

                if (!chatDoc.exists) {
                    throw new Error('Conversation not found');
                }

                const chatData = chatDoc.data();
                const membersContainer = document.getElementById('messageInfoMembers');
                membersContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                
                // Get member info
                const membersList = document.createElement('div');
                
                // Process members
                for (const memberId of chatData.Members || []) {
                    try {
                        // Try to get user or family info
                        let memberDoc;
                        let memberName = "Unknown Member";
                        
                        // Try Users collection first
                        memberDoc = await firebase.firestore()
                            .collection('Studios')
                            .doc(currentStudioId)
                            .collection('Users')
                            .doc(memberId)
                            .get();
                            
                        if (memberDoc.exists) {
                            const userData = memberDoc.data();
                            memberName = `${userData.FirstName} ${userData.LastName}`;
                        } else {
                            // Try Families collection
                            memberDoc = await firebase.firestore()
                                .collection('Studios')
                                .doc(currentStudioId)
                                .collection('Families')
                                .doc(memberId)
                                .get();
                                
                            if (memberDoc.exists) {
                                const familyData = memberDoc.data();
                                memberName = `${familyData.PrimaryContact.FirstName} ${familyData.PrimaryContact.LastName}`;
                            }
                        }
                        
                        // Create member item
                        const memberItem = document.createElement('div');
                        memberItem.className = 'member-item d-flex align-items-center mb-2 p-2';
                        memberItem.innerHTML = `
                            <div class="member-name">${memberName}</div>
                        `;
                        membersList.appendChild(memberItem);
                    } catch (error) {
                        console.error('Error getting member info:', error);
                    }
                }
                
                // Update the members container
                membersContainer.innerHTML = '';
                
                if (membersList.children.length > 0) {
                    membersContainer.appendChild(membersList);
                } else {
                    membersContainer.innerHTML = '<div class="text-muted">No members found</div>';
                }
                
                // Show the modal
                const messageInfoModal = new bootstrap.Modal(document.getElementById('messageInfoModal'));
                messageInfoModal.show();
            } catch (error) {
                console.error('Error fetching conversation info:', error);
                alert('Error loading conversation information');
            }
        });

        // Close payment modal
        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            
            // Try closing via Bootstrap API first (if initialized that way)
            try {
                const paymentModal = bootstrap.Modal.getInstance(modal);
                if (paymentModal) {
                    paymentModal.hide();
                    return;
                }
            } catch (error) {
                console.log('Not a Bootstrap modal instance, using manual close');
            }
            
            // Fallback to manual class removal
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Add this debug function to understand your data structure
        function debugCardDetails() {
            if (familyData && familyData.CardDetails) {
                console.log('CardDetails structure:', JSON.stringify(familyData.CardDetails));
                console.log('CardDetails type:', Array.isArray(familyData.CardDetails) ? 'Array' : 'Object');
            } else {
                console.log('No CardDetails found in familyData');
            }
        }

        // Also update the displayBillingInfo function
        function displayBillingInfo() {
            console.log('Displaying billing info');
            const billingInfoContainer = document.getElementById('billingInfoDisplay');
            if (!billingInfoContainer) {
                console.error('Billing info container not found');
                return;
            }
            
            // Debug the data
            debugCardDetails();
            
            if (familyData && familyData.CardDetails) {
                // Get card info regardless of whether it's an array or object
                const cardInfo = Array.isArray(familyData.CardDetails) ? 
                    familyData.CardDetails[0] : familyData.CardDetails;
                
                if (cardInfo && cardInfo.LastFour) {
                    console.log('Found card info:', cardInfo);
                    // Get the appropriate card icon
                    const cardIconClass = getCardTypeIconClass(cardInfo.CardType || 'Unknown');
                    
                    // Create HTML for card info display
                    billingInfoContainer.innerHTML = `
                        <div class="card-display">
                            <div class="d-flex align-items-center mb-2">
                                <i class="${cardIconClass} fa-lg me-2"></i>
                                <span>â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${cardInfo.LastFour || '****'}</span>
                            </div>
                            <div>
                                <small class="text-muted">Expires: ${cardInfo.ExpirationMonth || 'MM'}/${cardInfo.ExpirationYear || 'YY'}</small>
                            </div>
                        </div>
                    `;
                } else {
                    console.log('Card info missing or incomplete');
                    billingInfoContainer.innerHTML = `
                        <div class="no-card-info">
                            <p class="text-muted mb-0">Card information incomplete</p>
                        </div>
                    `;
                }
            } else {
                console.log('No CardDetails found');
                billingInfoContainer.innerHTML = `
                    <div class="no-card-info">
                        <p class="text-muted mb-0">No payment method added.</p>
                    </div>
                `;
            }
        }

        // Add this in loadFamilyData to handle object format of CardDetails
        if (familyData.CardDetails) {
            console.log('Loading card details from family data');
            // Get card info regardless of whether it's an array or object
            const cardInfo = Array.isArray(familyData.CardDetails) ? 
                familyData.CardDetails[0] : familyData.CardDetails;
            
            if (cardInfo && cardInfo.LastFour) {
                const displayCardNumber = document.getElementById('displayCardNumber');
                const displayCardExpiry = document.getElementById('displayCardExpiry');
                
                if (displayCardNumber) {
                    displayCardNumber.textContent = `â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${cardInfo.LastFour || '0000'}`;
                    
                    // Add card type icon if available
                    if (cardInfo.CardType) {
                        const cardIconClass = getCardTypeIconClass(cardInfo.CardType);
                        const iconElement = document.createElement('i');
                        iconElement.className = `${cardIconClass} me-2`;
                        displayCardNumber.prepend(iconElement);
                    }
                }
                
                if (displayCardExpiry) {
                    displayCardExpiry.textContent = `${cardInfo.ExpirationMonth || 'MM'}/${cardInfo.ExpirationYear || 'YY'}`;
                }
            }
        }

        // Improved toggle function to maintain tooltip functionality after clicking
        function toggleLineItems(transactionId) {
            const itemsContainer = document.getElementById(`${transactionId}-items`);
            const button = document.querySelector(`[aria-controls="${transactionId}-items"]`);
            
            if (itemsContainer) {
                const isHidden = itemsContainer.style.display === 'none';
                itemsContainer.style.display = isHidden ? 'block' : 'none';
                
                // Change the icon from plus to minus or vice versa
                if (button) {
                    // First hide any existing tooltip
                    const tooltipInstance = bootstrap.Tooltip.getInstance(button);
                    if (tooltipInstance) {
                        tooltipInstance.hide();
                    }
                    
                    // Change the icon
                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-plus', !isHidden);
                        icon.classList.toggle('fa-minus', isHidden);
                    }
                    button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                    
                    // Completely remove and recreate the tooltip to ensure it works on hover
                    if (tooltipInstance) {
                        tooltipInstance.dispose();
                    }
                    new bootstrap.Tooltip(button);
                }
            }
        }

        // Also add this to ensure tooltips work on document ready
        document.addEventListener('DOMContentLoaded', function() {
            // First initialize all the tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

    <!-- Add this modal HTML right before the closing body tag -->
    <div id="classEnrollmentModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="enrollmentStudentName">
                <!-- Student selection and class content will be inserted here -->
            </div>
            <div class="button-container mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeEnrollmentModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveClassEnrollments()">Enroll</button>
            </div>
        </div>
    </div>

    <!-- Update the payment modal HTML structure - make sure the element IDs match our JS references -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">Make a Payment</h4>
                <button type="button" class="btn-close" onclick="closePaymentModal()"></button>
            </div>

            <div class="amount-options">
                <div class="amount-option selected" onclick="selectAmount('full')" id="fullAmountOption">
                    <h6>Full Balance</h6>
                    <p class="mb-0" id="fullAmountDisplay">$0.00</p>
                </div>
                <div class="amount-option" onclick="selectAmount('custom')" id="customAmountOption">
                    <h6>Custom Amount</h6>
                    <p class="mb-0">You Choose</p>
                </div>
            </div>

            <div class="custom-amount-input" id="customAmountInput">
                <label class="form-label">Enter Amount</label>
                <div class="input-group mb-3">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="customAmountValue" 
                        step="0.01" min="0.01" placeholder="0.00"
                        onchange="validateCustomAmount(this.value)">
                </div>
            </div>

            <div class="billing-info">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Billing Information</h5>
                    <button class="btn btn-link p-0" onclick="toggleBillingEdit()">Edit</button>
                </div>
                
                <!-- Display current billing info -->
                <div id="billingDisplay">
                    <div id="billingInfoDisplay">
                        <!-- Card info will be inserted here by displayBillingInfo() -->
                    </div>
                </div>
                
                <!-- Billing edit form (initially hidden) -->
                <div id="billingForm" style="display: none;">
                    <div class="card-form-group">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="card-input" id="modalCardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div class="card-form-row">
                        <div class="card-form-group" style="flex: 1;">
                            <label class="form-label">Expiration Date</label>
                            <div class="d-flex gap-2">
                                <select class="card-input" id="modalExpirationMonth">
                                    <option value="">MM</option>
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <option value="03">03</option>
                                    <option value="04">04</option>
                                    <option value="05">05</option>
                                    <option value="06">06</option>
                                    <option value="07">07</option>
                                    <option value="08">08</option>
                                    <option value="09">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                                <select class="card-input" id="modalExpirationYear">
                                    <option value="">YY</option>
                                    <!-- Years will be populated via JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="card-form-group" style="width: 100px;">
                            <label class="form-label">CVC</label>
                            <input type="text" class="card-input" id="modalCardCVC" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveBillingInfo()">
                            Save Card
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleBillingEdit()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button class="btn btn-primary w-100" onclick="processPayment()">
                    Submit Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Add the new student modal -->
    <div id="addStudentModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" onclick="closeAddStudentModal()"></button>
                </div>
                <div class="modal-body">
                    <!-- Student Information Form -->
                    <form id="newStudentForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newStudentFirstName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newStudentLastName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="newStudentDOB" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Skill Level <span class="text-danger">*</span></label>
                                <select class="form-select" id="newStudentSkillLevel" required>
                                    <option value="">Select Level</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Medical Conditions</label>
                                <textarea class="form-control" id="newStudentMedical" rows="2"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Student Photo</label>
                                <div class="photo-upload-container">
                                    <input type="file" class="form-control" id="newStudentPhoto" accept="image/*">
                                    <div class="photo-preview" id="newStudentPhotoPreview"></div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Class Selection Section (initially hidden) -->
                    <div id="classSelectionSection" style="display: none;">
                        <h6 class="mt-4 mb-3">Select Classes</h6>
                        <div class="class-selection-grid">
                            <!-- Classes will be populated here -->
                        </div>
                    </div>

                    <!-- Registration Summary (initially hidden) -->
                    <div id="registrationSummary" style="display: none;">
                        <h6 class="mt-4">Registration Summary</h6>
                        <div class="summary-content">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddStudentModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="handleNextStep()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this modal HTML before the closing body tag -->
    <div id="enrollmentModal" class="modal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enroll in New Class</h5>
                    <button type="button" class="btn-close" onclick="closeEnrollmentModal()"></button>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Student Selection -->
                    <div id="enrollmentStep1" class="enrollment-step">
                        <h6 class="mb-4">Select Student</h6>
                        <div id="familyStudentsList" class="student-selection-grid">
                            <!-- Students will be populated here -->
                        </div>
                    </div>

                    <!-- Step 2: Class Selection -->
                    <div id="enrollmentStep2" class="enrollment-step" style="display: none;">
                        <h5 class="mb-3">Select Classes</h5>
                        <div id="classSelectionContainer">
                            <!-- Classes will be populated here -->
                        </div>
                    </div>

                    <!-- Step 3: Registration Summary -->
                    <div id="enrollmentStep3" class="enrollment-step" style="display: none;">
                        <h6 class="mb-4">Registration Summary</h6>
                        <div id="enrollmentSummary">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEnrollmentModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="enrollmentNextBtn" onclick="handleEnrollmentNext()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add these JavaScript code block at the end of your script section -->
    <script>
        // Variables for communication functionality
        let currentChatId = null;
        let currentChatType = null;
        let isLoadingCommunications = false;
        let messageListener = null;

        // Listen for tab activation to load communications when the communication tab is clicked
        document.getElementById('communication-tab').addEventListener('shown.bs.tab', function (e) {
            console.log('=== Communication Tab Activated ===');
            console.log('Checking authentication status...');
            
            // Check if user is authenticated
            const user = firebase.auth().currentUser;
            if (user) {
                console.log('User is authenticated:', user.email);
                console.log('Loading communications using family ID:', currentFamilyId);
                
                loadFamilyCommunications();
            } else {
                console.error('No user is authenticated when trying to load communications');
            }
        });

        // Function to load communications for family
        async function loadFamilyCommunications() {
            if (isLoadingCommunications) {
                console.log('Already loading communications, skipping...');
                return;
            }

            try {
                isLoadingCommunications = true;
                console.log('=== Starting Family Communications Load ===');
                
                if (!currentFamilyId) {
                    console.error('No family ID available');
                    return;
                }

                console.log('Loading communications for family ID:', currentFamilyId);

                // Clear existing lists
                const groupsList = document.getElementById('groupsList');
                const dmList = document.getElementById('dmList');
                
                if (!groupsList || !dmList) {
                    console.error('Communication list elements not found');
                    return;
                }
                
                groupsList.innerHTML = '<div class="shimmer-loading px-3 py-2">Loading groups...</div>';
                dmList.innerHTML = '<div class="shimmer-loading px-3 py-2">Loading messages...</div>';

                // Get all communications for this family
                const communicationsRef = firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Communication')
                    .where('Members', 'array-contains', currentFamilyId);

                // Get groups and DMs
                const groupsSnapshot = await communicationsRef
                    .where('Type', '==', 'group')
                    .get();

                const dmsSnapshot = await communicationsRef
                    .where('Type', '==', 'dm')
                    .get();

                // Clear loading states
                groupsList.innerHTML = '';
                dmList.innerHTML = '';

                // Track unique IDs
                const processedIds = new Set();
                let groupCount = 0;
                let dmCount = 0;

                console.log('=== Processing Groups ===');
                if (groupsSnapshot.empty) {
                    groupsList.innerHTML = '<div class="text-muted p-2">No group conversations</div>';
                } else {
                    groupsSnapshot.forEach(doc => {
                        const chatId = doc.id;
                        if (!processedIds.has(chatId)) {
                            processedIds.add(chatId);
                            const chatData = doc.data();
                            groupCount++;
                            
                            const groupElement = document.createElement('div');
                            groupElement.className = 'group-item';
                            groupElement.setAttribute('data-group-id', chatId);
                            groupElement.innerHTML = `
                                <span class="group-prefix">#</span>
                                <span class="group-name">${chatData.Name}</span>
                            `;
                            
                            groupElement.addEventListener('click', () => {
                                document.querySelectorAll('.group-item, .dm-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                groupElement.classList.add('active');
                                openGroupChat(chatId, chatData);
                            });
                            
                            groupsList.appendChild(groupElement);
                        }
                    });
                }

                console.log('=== Processing DMs ===');
                if (dmsSnapshot.empty) {
                    dmList.innerHTML = '<div class="text-muted p-2">No direct messages</div>';
                } else {
                    for (const doc of dmsSnapshot.docs) {
                        const dmData = doc.data();
                        const dmId = doc.id;
                        
                        // Skip if already processed
                        if (processedIds.has(dmId)) continue;
                        processedIds.add(dmId);
                        dmCount++;
                        
                        // Get the other member name for display
                        let displayName = dmData.Name || 'Chat';
                        if (!dmData.Name && dmData.Members && dmData.Members.length > 0) {
                            // Try to get the other member's name
                            for (const memberId of dmData.Members) {
                                if (memberId !== currentFamilyId) {
                                    // Try to get user or family info
                                    try {
                                        const memberDoc = await firebase.firestore()
                                            .collection('Studios')
                                            .doc(currentStudioId)
                                            .collection('Users')
                                            .doc(memberId)
                                            .get();
                                        
                                        if (memberDoc.exists) {
                                            const memberData = memberDoc.data();
                                            displayName = `${memberData.FirstName} ${memberData.LastName}`;
                                            break;
                                        }
                                        
                                        // Try family collection if user not found
                                        const familyDoc = await firebase.firestore()
                                            .collection('Studios')
                                            .doc(currentStudioId)
                                            .collection('Families')
                                            .doc(memberId)
                                            .get();
                                        
                                        if (familyDoc.exists) {
                                            const familyData = familyDoc.data();
                                            displayName = `${familyData.PrimaryContact.FirstName} ${familyData.PrimaryContact.LastName}`;
                                            break;
                                        }
                                    } catch (error) {
                                        console.error('Error getting member name:', error);
                                    }
                                }
                            }
                        }
                        
                        const dmElement = document.createElement('div');
                        dmElement.className = 'dm-item';
                        dmElement.setAttribute('data-dm-id', dmId);
                        dmElement.innerHTML = `<span class="dm-name">${displayName}</span>`;
                        
                        dmElement.addEventListener('click', () => {
                            document.querySelectorAll('.group-item, .dm-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            dmElement.classList.add('active');
                            openDMChat(dmId, dmData);
                        });
                        
                        dmList.appendChild(dmElement);
                    }
                }

                console.log('=== Communications Load Summary ===');
                console.log(`Groups found and loaded: ${groupCount}`);
                console.log(`DMs found and loaded: ${dmCount}`);
                console.log('Total unique conversations:', processedIds.size);
                console.log('=== End Communications Load ===');

            } catch (error) {
                console.error('Error loading communications:', error);
                console.error('Error details:', error.message);
            } finally {
                isLoadingCommunications = false;
            }
        }

        // Function to open a group chat
        async function openGroupChat(chatId, chatData) {
            try {
                console.log('Opening group chat:', chatId);
                currentChatId = chatId;
                currentChatType = 'group';
                
                // Update chat header
                document.getElementById('currentChatName').textContent = chatData.Name || 'Group Chat';
                
                // Update member count
                const memberCount = chatData.Members ? chatData.Members.length : 0;
                document.getElementById('memberCount').textContent = `${memberCount} members`;
                
                // Enable message input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                
                // Load messages
                await loadMessages(chatId);
            } catch (error) {
                console.error('Error opening group chat:', error);
            }
        }

        // Function to open a DM chat
        async function openDMChat(chatId, chatData) {
            try {
                console.log('Opening DM chat:', chatId);
                currentChatId = chatId;
                currentChatType = 'dm';
                
                // Update chat header
                document.getElementById('currentChatName').textContent = chatData.Name || 'Direct Message';
                
                // Update member info
                document.getElementById('memberCount').textContent = 'Private conversation';
                
                // Enable message input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                
                // Load messages
                await loadMessages(chatId);
            } catch (error) {
                console.error('Error opening DM chat:', error);
            }
        }

        // Function to load messages for a chat
        async function loadMessages(chatId) {
            try {
                console.log('Loading messages for chat:', chatId);
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div></div>';
                
                // Remove any existing listener
                if (messageListener) {
                    messageListener();
                    messageListener = null;
                }
                
                // Set up listener for messages
                messageListener = firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Communication')
                    .doc(chatId)
                    .collection('Messages')
                    .orderBy('Timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        if (snapshot.empty) {
                            messagesContainer.innerHTML = '<div class="text-center p-3">No messages yet</div>';
                            return;
                        }
                        
                        messagesContainer.innerHTML = '';
                        
                        snapshot.forEach(doc => {
                            const messageData = doc.data();
                            // Include the document ID in the message data
                            messageData.id = doc.id;
                            const messageElement = createMessageElement(messageData);
                            messagesContainer.appendChild(messageElement);
                        });
                        
                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, (error) => {
                        console.error('Error loading messages:', error);
                        messagesContainer.innerHTML = '<div class="text-center p-3 text-danger">Error loading messages</div>';
                    });
            } catch (error) {
                console.error('Error in loadMessages:', error);
            }
        }

        // Function to format message time
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Add event listener for send message button
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        
        // Add event listener for Enter key in message input
        document.getElementById('messageInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });

        // Add a document listener to close all dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Close all message option dropdowns
            document.querySelectorAll('.message-options-dropdown.show').forEach(dropdown => {
                if (!dropdown.contains(event.target) && 
                    !event.target.matches('.message-options-btn') && 
                    !event.target.closest('.message-options-btn')) {
                    dropdown.classList.remove('show');
                }
            });
        });
    </script>

    <!-- Add these modals at the end of the body -->
    <!-- Message Info Modal -->
    <div class="modal fade" id="messageInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Conversation Members</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="messageInfoMembers" class="members-list">
                        <!-- Members will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this script at the end, just before closing body tag -->
    <script>
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            // Add tooltip to the chat ellipsis button
            const chatOptionsBtn = document.querySelector('.chat-header .btn-icon');
            if (chatOptionsBtn) {
                // Add data attributes for Bootstrap tooltip
                chatOptionsBtn.setAttribute('data-bs-toggle', 'tooltip');
                chatOptionsBtn.setAttribute('data-bs-placement', 'top');
                chatOptionsBtn.setAttribute('title', 'Message Info');
                
                // Initialize the tooltip
                new bootstrap.Tooltip(chatOptionsBtn);
            }
            
            // Initialize any other tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

    <!-- Update the click handler for the chat options button -->
    <script>
        // Add this script just before the closing body tag
        document.addEventListener('DOMContentLoaded', function() {
            // Get the chat options button
            const chatOptionsBtn = document.querySelector('.chat-header .btn-icon');
            
            if (chatOptionsBtn) {
                console.log('Chat options button found, adding event listener');
                
                // Add tooltip
                chatOptionsBtn.setAttribute('data-bs-toggle', 'tooltip');
                chatOptionsBtn.setAttribute('data-bs-placement', 'top');
                chatOptionsBtn.setAttribute('title', 'Message Info');
                
                // Initialize tooltip
                new bootstrap.Tooltip(chatOptionsBtn);
                
                // Add click event listener
                chatOptionsBtn.addEventListener('click', async function(event) {
                    console.log('Chat options button clicked');
                    
                    // Explicitly hide the tooltip
                    const tooltip = bootstrap.Tooltip.getInstance(this);
                    if (tooltip) {
                        console.log('Hiding tooltip');
                        tooltip.hide();
                    }
                    
                    // Check if chat is active
                    if (!currentChatId) {
                        console.log('No active chat, returning');
                        return;
                    }
                    
                    // Get reference to members container
                    const membersContainer = document.getElementById('messageInfoMembers');
                    // Show loading spinner immediately
                    membersContainer.innerHTML = '<div class="d-flex justify-content-center my-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    
                    // Show the modal immediately
                    // Remove any existing backdrops to prevent duplicates
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                        backdrop.remove();
                    });
                    
                    // Close any existing modal instance
                    const existingModal = bootstrap.Modal.getInstance(document.getElementById('messageInfoModal'));
                    if (existingModal) {
                        existingModal.dispose();
                    }
                    
                    // Create and show new modal
                    const messageInfoModal = new bootstrap.Modal(document.getElementById('messageInfoModal'), {
                        backdrop: 'static' // Prevent clicking outside to close
                    });
                    messageInfoModal.show();
                    
                    console.log('Loading chat info for chat ID:', currentChatId);
                    
                    try {
                        // Get the chat document
                        const chatDoc = await firebase.firestore()
                            .collection('Studios')
                            .doc(currentStudioId)
                            .collection('Communication')
                            .doc(currentChatId)
                            .get();

                        if (!chatDoc.exists) {
                            throw new Error('Conversation not found');
                        }

                        console.log('Chat document found, loading members');
                        const chatData = chatDoc.data();
                        
                        // Get member info
                        const membersList = document.createElement('div');
                        
                        // Process members
                        for (const memberId of chatData.Members || []) {
                            try {
                                console.log('Processing member ID:', memberId);
                                // Try to get user or family info
                                let memberName = "Unknown Member";
                                let memberFound = false;
                                
                                // Try Users collection first
                                try {
                                    const userDoc = await firebase.firestore()
                                        .collection('Studios')
                                        .doc(currentStudioId)
                                        .collection('Users')
                                        .doc(memberId)
                                        .get();
                                        
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        if (userData.FirstName && userData.LastName) {
                                            memberName = `${userData.FirstName} ${userData.LastName}`;
                                            memberFound = true;
                                            console.log('Found user:', memberName);
                                        }
                                    }
                                } catch (userError) {
                                    console.error('Error looking up user:', userError);
                                }
                                
                                // If not found in Users, try Families collection
                                if (!memberFound) {
                                    try {
                                        const familyDoc = await firebase.firestore()
                                            .collection('Studios')
                                            .doc(currentStudioId)
                                            .collection('Families')
                                            .doc(memberId)
                                            .get();
                                            
                                        if (familyDoc.exists) {
                                            const familyData = familyDoc.data();
                                            console.log('Found family document:', familyData);
                                            
                                            // Check if FirstName/LastName exist directly on family doc
                                            if (familyData.FirstName && familyData.LastName) {
                                                memberName = `${familyData.FirstName} ${familyData.LastName}`;
                                                memberFound = true;
                                                console.log('Found family with direct name:', memberName);
                                            }
                                            // Check if PrimaryContact structure exists
                                            else if (familyData.PrimaryContact && 
                                                    familyData.PrimaryContact.FirstName && 
                                                    familyData.PrimaryContact.LastName) {
                                                memberName = `${familyData.PrimaryContact.FirstName} ${familyData.PrimaryContact.LastName}`;
                                                memberFound = true;
                                                console.log('Found family with primary contact:', memberName);
                                            }
                                            // Try to extract from FamilyName if available
                                            else if (familyData.FamilyName) {
                                                memberName = `${familyData.FamilyName} Family`;
                                                memberFound = true;
                                                console.log('Found family with family name:', memberName);
                                            }
                                        }
                                    } catch (familyError) {
                                        console.error('Error looking up family:', familyError);
                                    }
                                }
                                
                                // If not found in Families, try Instructors collection
                                if (!memberFound) {
                                    try {
                                        const instructorDoc = await firebase.firestore()
                                            .collection('Studios')
                                            .doc(currentStudioId)
                                            .collection('Instructors')
                                            .doc(memberId)
                                            .get();
                                            
                                        if (instructorDoc.exists) {
                                            const instructorData = instructorDoc.data();
                                            if (instructorData.FirstName && instructorData.LastName) {
                                                memberName = `${instructorData.FirstName} ${instructorData.LastName} (Instructor)`;
                                                memberFound = true;
                                                console.log('Found instructor:', memberName);
                                            }
                                        }
                                    } catch (instructorError) {
                                        console.error('Error looking up instructor:', instructorError);
                                    }
                                }
                                
                                // Create member item with what we've found
                                console.log('Final member name:', memberName, 'for ID:', memberId);
                                const memberItem = document.createElement('div');
                                memberItem.className = 'member-item d-flex align-items-center mb-2 p-2';
                                memberItem.innerHTML = `
                                    <div class="member-name">${memberName}</div>
                                `;
                                membersList.appendChild(memberItem);
                                
                            } catch (error) {
                                console.error('Error processing member:', error);
                                // Add an unknown member entry
                                const memberItem = document.createElement('div');
                                memberItem.className = 'member-item d-flex align-items-center mb-2 p-2';
                                memberItem.innerHTML = `
                                    <div class="member-name">Unknown Member</div>
                                `;
                                membersList.appendChild(memberItem);
                            }
                        }
                        
                        // Update the members container
                        membersContainer.innerHTML = '';
                        
                        if (membersList.children.length > 0) {
                            membersContainer.appendChild(membersList);
                        } else {
                            membersContainer.innerHTML = '<div class="text-muted">No members found</div>';
                        }
                        
                        console.log('Showing modal');
                        
                        // Remove any existing backdrops to prevent duplicates
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                            backdrop.remove();
                        });
                        
                        // Close any existing modal instance
                        const existingModal = bootstrap.Modal.getInstance(document.getElementById('messageInfoModal'));
                        if (existingModal) {
                            existingModal.dispose();
                        }
                        
                        // Create and show new modal
                        const messageInfoModal = new bootstrap.Modal(document.getElementById('messageInfoModal'), {
                            backdrop: 'static' // Prevent clicking outside to close
                        });
                        messageInfoModal.show();
                    } catch (error) {
                        console.error('Error fetching conversation info:', error);
                        alert('Error loading conversation information');
                    }
                });
                
                console.log('Event listener added to chat options button');
            } else {
                console.warn('Chat options button not found');
            }
            
            // Initialize any other tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

    <script>
        // In the loadFamilyData function where the address is loaded, add:
        if (familyData.EmergencyContacts && familyData.EmergencyContacts.length > 0) {
            const emergencyContact = familyData.EmergencyContacts[0];
            document.getElementById('emergencyContactName').value = emergencyContact.Name || '';
            document.getElementById('emergencyContactPhone').value = emergencyContact.Phone || '';
        }

        // In the contactForm submit handler, modify the update object to include emergency contacts:
        document.getElementById('contactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Get all the form values
                const address1 = document.getElementById('address1').value;
                const address2 = document.getElementById('address2').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const zipCode = document.getElementById('zipCode').value;
                const emergencyContactName = document.getElementById('emergencyContactName').value;
                const emergencyContactPhone = document.getElementById('emergencyContactPhone').value;
                
                // Create the update object
                const updateData = {
                    Address1: address1,
                    Address2: address2,
                    City: city,
                    State: state,
                    ZipCode: zipCode,
                    EmergencyContacts: [{
                        Name: emergencyContactName,
                        Phone: emergencyContactPhone
                    }]
                };
                
                // Update the document
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Families')
                    .doc(currentFamilyId)
                    .update(updateData);
                    
                alert('Information updated successfully!');
            } catch (error) {
                console.error('Error updating information:', error);
                alert('Error updating information. Please try again.');
            }
        });
    </script>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student Information</h5>
                    <button type="button" class="btn-close" onclick="closeEditStudentModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm" class="needs-validation" novalidate>
                        <input type="hidden" id="editStudentId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editStudentFirstName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editStudentLastName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editStudentDOB" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Skill Level <span class="text-danger">*</span></label>
                                <select class="form-select" id="editStudentSkillLevel" required>
                                    <option value="">Select Level</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Medical Conditions</label>
                                <textarea class="form-control" id="editStudentMedical" rows="2"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Student Photo</label>
                                <div class="photo-upload-container">
                                    <input type="file" class="form-control" id="editStudentPhoto" accept="image/*">
                                    <div class="photo-preview mt-2" id="editStudentPhotoPreview"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditStudentModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateStudent()">Update Student</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Functions for editing student
        let currentEditingStudentId = null;
        
        async function editStudent(studentId) {
            try {
                currentEditingStudentId = studentId;
                
                // Fetch student data
                const studentDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(studentId)
                    .get();
                
                if (!studentDoc.exists) {
                    throw new Error('Student not found');
                }
                
                const studentData = studentDoc.data();
                
                // Populate form with student data
                document.getElementById('editStudentId').value = studentId;
                document.getElementById('editStudentFirstName').value = studentData.FirstName || '';
                document.getElementById('editStudentLastName').value = studentData.LastName || '';
                document.getElementById('editStudentDOB').value = studentData.DateOfBirth || '';
                document.getElementById('editStudentSkillLevel').value = studentData.SkillLevel || '';
                document.getElementById('editStudentMedical').value = studentData.MedicalConditions || '';
                
                // Display existing photo if available
                const photoPreview = document.getElementById('editStudentPhotoPreview');
                if (studentData.PhotoURL) {
                    photoPreview.innerHTML = `<img src="${studentData.PhotoURL}" alt="Student Photo" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">`;
                } else {
                    photoPreview.innerHTML = '';
                }
                
                // Show the modal
                const modal = document.getElementById('editStudentModal');
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                
            } catch (error) {
                console.error('Error editing student:', error);
                alert('Error loading student information. Please try again.');
            }
        }
        
        function closeEditStudentModal() {
            const modal = document.getElementById('editStudentModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            currentEditingStudentId = null;
        }
        
        // Preview photo when selected
        document.getElementById('editStudentPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById('editStudentPhotoPreview');
                photoPreview.innerHTML = `<img src="${e.target.result}" alt="Student Photo" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">`;
            };
            reader.readAsDataURL(file);
        });
        
        async function updateStudent() {
            try {
                if (!currentEditingStudentId) return;
                
                const form = document.getElementById('editStudentForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // Show loading indicator
                const updateButton = document.querySelector('button[onclick="updateStudent()"]');
                updateButton.disabled = true;
                updateButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
                
                // Get form values
                const firstName = document.getElementById('editStudentFirstName').value;
                const lastName = document.getElementById('editStudentLastName').value;
                const dob = document.getElementById('editStudentDOB').value;
                const skillLevel = document.getElementById('editStudentSkillLevel').value;
                const medicalConditions = document.getElementById('editStudentMedical').value;
                const photoFile = document.getElementById('editStudentPhoto').files[0];
                
                // Calculate age from DOB
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                // Create update object
                const updateData = {
                    FirstName: firstName,
                    LastName: lastName,
                    DateOfBirth: dob,
                    Age: age,
                    SkillLevel: skillLevel,
                    MedicalConditions: medicalConditions,
                    LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // If a new photo was selected, upload it to Firebase Storage
                if (photoFile) {
                    try {
                        console.log('Uploading new student photo...');
                        
                        // Create a unique filename using student name and timestamp
                        const fileName = `${firstName.toLowerCase()}_${lastName.toLowerCase()}_${Date.now()}`;
                        
                        // Use the correct storage reference syntax
                        const storageRef = firebase.app().storage().ref(`StudentImages/${fileName}`);
                        // OR
                        // const storage = firebase.storage();
                        // const storageRef = storage.ref(`StudentImages/${fileName}`);
                        
                        // Upload the file
                        const uploadTask = await storageRef.put(photoFile);
                        console.log('Photo uploaded successfully:', uploadTask);
                        
                        // Get the download URL and add it to the update data
                        const photoURL = await storageRef.getDownloadURL();
                        console.log('Photo URL obtained:', photoURL);
                        updateData.PhotoURL = photoURL;
                    } catch (uploadError) {
                        console.error('Error uploading photo:', uploadError);
                        alert('Error uploading photo. Student info will be updated without the new photo.');
                    }
                }
                
                // Update the student document
                await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(currentEditingStudentId)
                    .update(updateData);
                
                // Close modal and refresh student data
                closeEditStudentModal();
                await loadStudentsDetails();
                
                alert('Student information updated successfully!');
                
            } catch (error) {
                console.error('Error updating student:', error);
                alert('Error updating student information. Please try again.');
            } finally {
                // Reset update button
                const updateButton = document.querySelector('button[onclick="updateStudent()"]');
                if (updateButton) {
                    updateButton.disabled = false;
                    updateButton.innerHTML = 'Update Student';
                }
            }
        }

        // Enhanced preview photo when selected 
        document.getElementById('editStudentPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/avif'];
            if (!validImageTypes.includes(file.type)) {
                alert('Please select a valid image file (JPEG, PNG, GIF)');
                this.value = ''; // Clear the input
                return;
            }
            
            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB in bytes
            if (file.size > maxSize) {
                alert('Image is too large. Please select an image under 5MB.');
                this.value = ''; // Clear the input
                return;
            }
            
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById('editStudentPhotoPreview');
                photoPreview.innerHTML = `<img src="${e.target.result}" alt="Student Photo" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">`;
            };
            reader.readAsDataURL(file);
        });
    </script>

    <!-- Add this function to load all classes and pre-select the ones the student is enrolled in -->
    <script>
        async function loadClassesForEnrollment() {
            try {
                const classesContainer = document.getElementById('classSelectionContainer');
                classesContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading classes...</p></div>';
                
                console.log("Loading all classes for studio:", currentStudioId);
                
                // Fetch all classes from the studio without filtering
                const classesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Classes')
                    .get();
                    
                console.log("Classes found:", classesSnapshot.size);
                    
                if (classesSnapshot.empty) {
                    console.log("No classes found in this studio");
                    classesContainer.innerHTML = '<div class="alert alert-info">No classes available for enrollment</div>';
                    return;
                }
                
                // Fetch all class styles to get their names
                const classStylesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('ClassStyles')
                    .get();
                
                // Create a map of style IDs to style names
                const styleMap = {};
                classStylesSnapshot.forEach(doc => {
                    styleMap[doc.id] = doc.data().StyleName || 'Unknown Style';
                });
                
                // If we have a selected student, fetch their classes
                let studentClasses = [];
                if (selectedStudentId) {
                    const studentDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(currentStudioId)
                        .collection('Students')
                        .doc(selectedStudentId)
                        .get();
                        
                    if (studentDoc.exists) {
                        studentClasses = studentDoc.data().Classes || [];
                        console.log("Student is enrolled in", studentClasses.length, "classes");
                    }
                }
                
                // Helper function to format day abbreviations to full day names
                function formatDays(days) {
                    if (!days) return 'N/A';
                    
                    const dayMap = {
                        'mon': 'Monday',
                        'tue': 'Tuesday',
                        'wed': 'Wednesday',
                        'thu': 'Thursday',
                        'fri': 'Friday',
                        'sat': 'Saturday',
                        'sun': 'Sunday'
                    };
                    
                    if (Array.isArray(days)) {
                        return days.map(day => dayMap[day.toLowerCase()] || day).join(', ');
                    }
                    
                    return dayMap[days.toLowerCase()] || days;
                }
                
                // Helper function to format time from 24h to 12h
                function formatTime(time) {
                    if (!time) return '';
                    
                    try {
                        const [hours, minutes] = time.split(':');
                        let h = parseInt(hours);
                        const ampm = h >= 12 ? 'PM' : 'AM';
                        h = h % 12 || 12; // Convert to 12-hour format
                        return `${h}:${minutes} ${ampm}`;
                    } catch (e) {
                        return time; // If parsing fails, return the original time
                    }
                }
                
                // Create class cards for all classes, without filtering
                let classesHTML = '<div class="class-grid">';
                
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    console.log("Processing class:", classData.ClassName);
                    const isEnrolled = studentClasses.includes(doc.id);
                    const isSelected = selectedClasses.includes(doc.id);
                    const styleName = classData.ClassStyleId ? styleMap[classData.ClassStyleId] || 'Unknown Style' : '';
                    
                    classesHTML += `
                        <div class="class-card ${isEnrolled ? 'enrolled' : ''} ${isSelected ? 'selected' : ''}" 
                             data-class-id="${doc.id}" 
                             onclick="toggleClassSelection('${doc.id}', ${isEnrolled})">
                            <h4 class="class-name">${classData.ClassName || 'Unnamed Class'}</h4>
                            <div class="class-meta">
                                <span class="class-level">${classData.Level || 'All Levels'}</span>
                                <span class="class-style">${styleName}</span>
                                <span class="class-capacity">${(classData.Students || []).length}/${classData.MaxSize || classData.Capacity || 'âˆž'} students</span>
                            </div>
                            <div class="class-details">
                                <div class="detail-item">
                                    <i class="fas fa-calendar-day"></i>
                                    <span>${formatDays(classData.Days)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${formatTime(classData.StartTime)} - ${formatTime(classData.EndTime)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-user-graduate"></i>
                                    <span>${classData.Instructor || 'TBD'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span class="room-info" data-room-id="${classData.RoomId || ''}">${classData.Room || 'TBD'}</span>
                                </div>
                            </div>
                            ${isEnrolled ? '<div class="enrollment-badge">Currently Enrolled</div>' : ''}
                        </div>
                    `;
                });
                
                classesHTML += '</div>';
                classesContainer.innerHTML = classesHTML;
                
                // Load room names like in studentregister.html
                loadRoomNames();
                
            } catch (error) {
                console.error('Error loading classes for enrollment:', error);
                document.getElementById('classSelectionContainer').innerHTML = 
                    '<div class="alert alert-danger">Error loading classes. Please try again.</div>';
            }
        }

        // Function to toggle class selection
        function toggleClassSelection(classId, isAlreadyEnrolled) {
            // If already enrolled, we shouldn't toggle selection
            if (isAlreadyEnrolled) {
                return;
            }
            
            const index = selectedClasses.indexOf(classId);
            if (index === -1) {
                // Add to selected classes
                selectedClasses.push(classId);
            } else {
                // Remove from selected classes
                selectedClasses.splice(index, 1);
            }
            
            // Update the UI to reflect selection
            const classCards = document.querySelectorAll('.class-card');
            classCards.forEach(card => {
                if (card.dataset.classId === classId) {
                    card.classList.toggle('selected', selectedClasses.includes(classId));
                }
            });
        }

        // Update the function that handles enrollment steps
        function updateEnrollmentStep() {
            // Hide all steps
            document.querySelectorAll('.enrollment-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Show current step
            const currentStep = document.getElementById(`enrollmentStep${currentEnrollmentStep}`);
            if (currentStep) {
                currentStep.style.display = 'block';
            }
            
            // Update buttons
            const prevButton = document.getElementById('prevStepBtn');
            const nextButton = document.getElementById('nextStepBtn');
            const finishButton = document.getElementById('finishEnrollmentBtn');
            
            if (prevButton) {
                prevButton.style.display = currentEnrollmentStep > 1 ? 'block' : 'none';
            }
            
            if (nextButton) {
                nextButton.style.display = currentEnrollmentStep < 3 ? 'block' : 'none';
            }
            
            if (finishButton) {
                finishButton.style.display = currentEnrollmentStep === 3 ? 'block' : 'none';
            }
            
            // If we're on the class selection step, load classes
            if (currentEnrollmentStep === 2) {
                loadClassesForEnrollment();
            }
            
            // If we're on the review step, populate with review info
            if (currentEnrollmentStep === 3) {
                populateEnrollmentReview();
            }
        }

        // Function to move to next step in enrollment
        function nextEnrollmentStep() {
            // Validate current step
            if (currentEnrollmentStep === 1 && !selectedStudentId) {
                alert('Please select a student to continue');
                return;
            }
            
            if (currentEnrollmentStep === 2 && selectedClasses.length === 0) {
                alert('Please select at least one class to continue');
                return;
            }
            
            currentEnrollmentStep++;
            updateEnrollmentStep();
        }

        // Function to populate the review step
        function populateEnrollmentReview() {
            const reviewContainer = document.getElementById('enrollmentReviewContainer');
            if (!reviewContainer) return;
            
            reviewContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading review...</p></div>';
            
            try {
                // Get student info
                firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Students')
                    .doc(selectedStudentId)
                    .get()
                    .then(studentDoc => {
                        if (!studentDoc.exists) {
                            reviewContainer.innerHTML = '<div class="alert alert-danger">Student information not found</div>';
                            return;
                        }
                        
                        const studentData = studentDoc.data();
                        
                        // Get class info for selected classes
                        const classPromises = selectedClasses.map(classId => 
                            firebase.firestore()
                                .collection('Studios')
                                .doc(currentStudioId)
                                .collection('Classes')
                                .doc(classId)
                                .get()
                        );
                        
                        Promise.all(classPromises).then(classResults => {
                            const classesData = classResults
                                .filter(doc => doc.exists)
                                .map(doc => ({ id: doc.id, ...doc.data() }));
                            
                            // Create review HTML
                            let reviewHTML = `
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Student Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Name:</strong> ${studentData.FirstName} ${studentData.LastName}</p>
                                        <p><strong>Age:</strong> ${studentData.Age}</p>
                                        <p><strong>Skill Level:</strong> ${studentData.SkillLevel || 'Not specified'}</p>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Selected Classes</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group">
                    `;
                    
                    classesData.forEach(classData => {
                        reviewHTML += `
                            <li class="list-group-item">
                                <h6 class="mb-1">${classData.ClassName}</h6>
                                <p class="mb-1">
                                    ${Array.isArray(classData.Days) ? classData.Days.join(', ') : classData.Days || 'N/A'} 
                                    ${classData.StartTime || ''} - ${classData.EndTime || ''}
                                </p>
                            </li>
                        `;
                    });
                    
                    reviewHTML += `
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    reviewContainer.innerHTML = reviewHTML;
                });
            });
            
        } catch (error) {
            console.error('Error populating enrollment review:', error);
            reviewContainer.innerHTML = '<div class="alert alert-danger">Error preparing review. Please try again.</div>';
        }
    }

    // Function to complete the enrollment
    async function completeEnrollment() {
        try {
            // Show loading state
            const finishButton = document.getElementById('finishEnrollmentBtn');
            if (finishButton) {
                finishButton.disabled = true;
                finishButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            }
            
            // Get current enrolled classes
            const studentDoc = await firebase.firestore()
                .collection('Studios')
                .doc(currentStudioId)
                .collection('Students')
                .doc(selectedStudentId)
                .get();
                
            if (!studentDoc.exists) {
                throw new Error('Student not found');
            }
            
            const currentClasses = studentDoc.data().Classes || [];
            
            // Combine current classes with newly selected classes (avoid duplicates)
            const updatedClasses = [...new Set([...currentClasses, ...selectedClasses])];
            
            // Update student document
            await firebase.firestore()
                .collection('Studios')
                .doc(currentStudioId)
                .collection('Students')
                .doc(selectedStudentId)
                .update({
                    Classes: updatedClasses,
                    LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            // Update class documents to include this student
            const classUpdatePromises = selectedClasses.map(classId => {
                return firebase.firestore()
                    .collection('Studios')
                    .doc(currentStudioId)
                    .collection('Classes')
                    .doc(classId)
                    .update({
                        Students: firebase.firestore.FieldValue.arrayUnion(selectedStudentId)
                    });
            });
            
            await Promise.all(classUpdatePromises);
            
            // Close modal and reload data
            closeEnrollmentModal();
            await loadStudentsDetails();
            await loadClassesByStudent();
            
            // Show success message
            alert('Enrollment completed successfully!');
            
        } catch (error) {
            console.error('Error completing enrollment:', error);
            alert(`Error: ${error.message}`);
            
            // Reset button state
            const finishButton = document.getElementById('finishEnrollmentBtn');
            if (finishButton) {
                finishButton.disabled = false;
                finishButton.innerHTML = 'Complete Enrollment';
            }
        }
    }

    // Update the function that shows the enrollment modal to handle student ID correctly
    function showEnrollmentModal(studentId = null) {
            currentEnrollmentStep = 1;
        selectedStudentId = studentId;  // Use the provided student ID if available
        selectedClasses = [];
        
        const modal = document.getElementById('enrollmentModal');
        modal.classList.add('show');
        
        populateFamilyStudents();
        updateEnrollmentStep();
    }

    // Function to move to previous step in enrollment
    function prevEnrollmentStep() {
        if (currentEnrollmentStep > 1) {
            currentEnrollmentStep--;
            updateEnrollmentStep();
        }
    }

    // Function to select a student in the enrollment modal
    function selectStudent(studentId) {
        selectedStudentId = studentId;
        
        // Update UI to show selected student
        const studentCards = document.querySelectorAll('.student-selection-card');
        studentCards.forEach(card => {
            card.classList.toggle('selected', card.getAttribute('onclick').includes(studentId));
        });
    }
    </script>

    <!-- Add room name lookup function -->
    <script>
        async function loadRoomNames() {
            const roomElements = document.querySelectorAll('.room-info');
            if (roomElements.length === 0) return;
            
            // Create a set of unique room IDs
            const roomIds = new Set();
            roomElements.forEach(el => roomIds.add(el.dataset.roomId));
            
            // Fetch room data for all room IDs
            try {
                const db = firebase.firestore();
                const roomsData = {};
                
                // Fetch each room
                for (const roomId of roomIds) {
                    if (!roomId) continue;
                    
                    const roomDoc = await db.collection('Studios')
                        .doc(currentStudioId)
                        .collection('StudioRooms')
                        .doc(roomId)
                        .get();
                        
                    if (roomDoc.exists) {
                        roomsData[roomId] = roomDoc.data().Name || 'Unnamed Room';
                    } else {
                        roomsData[roomId] = 'Unknown Room';
                    }
                }
                
                // Update all room elements with the room names
                roomElements.forEach(el => {
                    const roomId = el.dataset.roomId;
                    if (roomId && roomsData[roomId]) {
                        el.textContent = roomsData[roomId];
                    }
                });
                
            } catch (error) {
                console.error('Error loading room names:', error);
                roomElements.forEach(el => {
                    el.textContent = 'Room info unavailable';
                });
            }
        }
    </script>
</body>
</html>
