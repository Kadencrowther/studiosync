<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/ssdancer.svg" type="image/svg+xml">
    <title>Student Registration - Dance Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3DCED7;
            --primary-hover: #36b8c0;  /* Darker shade of primary */
            --secondary-color: #3A506B;
            --secondary-hover: #324660;  /* Darker shade of secondary */
            --background-color: #F5F5F5;
            --text-color: #333333;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: var(--background-color);
            font-family: 'Arial', sans-serif;
            padding: 20px 40px 40px 40px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 40px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            color: var(--text-color);
        }

        h2 {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 14px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            gap: 20px;
        }

        .main-buttons {
            display: flex;
            gap: 15px;
            flex-grow: 1;
            justify-content: flex-end;
        }

        .skip-btn {
            background-color: #e0e0e0;
            color: #666;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
            font-weight: normal;
            width: auto;
        }

        .skip-btn:hover {
            background-color: #d0d0d0;
        }

        .back-btn, .next-btn {
            width: auto;
            min-width: 120px;
            padding: 12px 24px;
        }

        .back-btn {
            background-color: #f0f0f0;
            color: var(--text-color);
        }

        .back-btn:hover {
            background-color: #e0e0e0;
        }

        .next-btn {
            background-color: var(--primary-color);
        }

        .next-btn:hover {
            background-color: var(--primary-hover);
        }

        .processor-setup {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .processor-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .processor-options .checkbox-item {
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .processor-options .checkbox-item:hover {
            border-color: var(--primary-color);
        }

        button {
            width: 48%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        .note {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #888888;
        }

        .students-list {
            margin-top: 30px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .student-card {
            display: flex;
            gap: 15px;
            align-items: start;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        .add-student-btn {
            width: 100%;
            margin-top: 20px;
        }

        .no-students {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        select[multiple] {
            height: 120px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
            padding-left: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;  /* Add this line */
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            margin-right: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
        }

        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .checkbox-item input[type="checkbox"]:checked::before {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 16px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            animation: checkmark 0.3s ease-in-out;
        }

        @keyframes checkmark {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
        }

        .payment-summary {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .total-amount {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: right;
            font-size: 1.2em;
        }

        .card-details {
            display: flex;
            gap: 20px;
        }

        .expiry-date, .cvv {
            flex: 1;
        }

        #cardNumber {
            letter-spacing: 1px;
        }

        .checkbox-container {
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
            margin: 5px 0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        .note {
            margin-left: 24px;
        }

        .waiver-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        .waiver-section {
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .electronic-signature {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .waiver-acceptance {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .waiver-acceptance .checkbox-item {
            margin: 15px 0;
        }

        .step {
            display: none !important; /* Force hide inactive steps */
        }
        
        .step.active {
            display: block !important; /* Force show active step */
        }

        .waiver-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        /* Ensure proper layering */
        .container {
            position: relative;
            overflow: hidden;
        }

        .signature-display {
            margin-top: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease;
        }

        .signature-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        .signature-main {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            color: #000080; /* Dark blue ink color */
            line-height: 1.4;
            display: block; /* Make sure it's displayed */
        }

        .signature-text, .signature-date {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            color: #000080;
            display: block;
            line-height: 1.2;
        }

        .signature-text {
            font-size: 2.8em;
            margin-bottom: 5px;
        }

        .signature-date {
            font-size: 2em;
            margin-bottom: 12px;
        }

        .signature-details {
            font-family: Arial, sans-serif;
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .signature-timestamp, .signature-ip {
            padding: 1px 0;
        }

        .signature-loading {
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        /* Add to the existing style section in the head */
        .signature-text {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            font-size: 2em;
            color: #000066;  /* Changed back to dark blue */
            padding: 15px 0;
            margin-top: 10px;
            border-bottom: 1px solid #ccc;
            display: none; /* Hidden by default */
        }

        .signature-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .waiver-student-name {
            padding: 5px 0;
            font-size: 1.1em;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0; /* Default gray */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-circle {
            background-color: var(--primary-color) !important; /* Force blue background */
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(61, 206, 215, 0.3);
        }

        .step-indicator.completed .step-circle {
            background-color: var(--primary-color); /* Blue for completed steps */
            color: white;
        }

        .step-indicator[data-skipped="true"] .step-circle {
            background-color: #e0e0e0; /* Keep skipped steps gray */
            color: #666;
        }

        .step-line {
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 2px;
            background-color: #e0e0e0;
            transition: background-color 0.3s ease;
        }

        .step-line.completed {
            background-color: var(--primary-color);
        }

        .step-indicator[data-skipped="true"] + .step-line {
            background-color: #e0e0e0; /* Keep lines after skipped steps gray */
        }

        .step-label {
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }

        .step-indicator.active .step-label {
            color: var(--primary-color);
            font-weight: bold;
        }

        .step-indicator.completed .step-label {
            color: var(--primary-color);
        }

        /* Add these modal styles */
        .modal {
            display: none;  /* Only this display property */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;  /* Keep these */
            justify-content: center;
        }

        .modal.show {
            display: flex !important;  /* Add !important to ensure it shows */
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal .close:hover {
            color: var(--primary-color);
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--secondary-color);
        }

        .button-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }

        .button-container button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .button-container button:first-child {
            background-color: #e0e0e0;
            color: #666;
        }

        .button-container button:last-child {
            color: white;
        }

        /* Add smooth scrollbar styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Adjust the edit form spacing */
        .edit-student-form {
            margin-top: 20px;
            padding-right: 10px; /* Add space for scrollbar */
        }

        .edit-student-form > * {
            margin-bottom: 15px; /* Consistent spacing between elements */
        }

        .edit-student-form {
            margin-top: 30px;
        }

        .edit-student-form h2 {
            color: var(--secondary-color);
            margin-bottom: 30px;
        }

        .modal .checkbox-group {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Add these styles to your style section */
        .step h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            margin: -40px -40px 30px -40px;
            border-radius: 0;
            text-align: left;
        }

        .required-star {
            color: #ff0000 !important;  /* Red color that can't be changed */
            margin-left: 3px;
        }

        .emergency-contact-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .emergency-contact-inputs {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .emergency-contact-inputs input {
            flex: 1;
        }

        .add-emergency-contact {
            width: 40px !important;
            height: 40px;
            border-radius: 50% !important;
            padding: 0 !important;
            font-size: 24px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4CAF50 !important; /* Soft green color */
        }

        .add-emergency-contact:hover {
            background-color: #45a049 !important; /* Slightly darker green for hover */
        }

        .remove-emergency-contact {
            width: 40px !important;
            height: 40px;
            border-radius: 50% !important;
            padding: 0 !important;
            font-size: 18px !important;
            background-color: #ff4444 !important;
        }

        .step-description {
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        /* Update the textarea styling to match other inputs */
        textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 14px;
            font-family: 'Arial', sans-serif; /* Match the font family of other inputs */
            resize: vertical; /* Allow vertical resizing only */
            min-height: 80px; /* Set minimum height */
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .waiver-content h3 {
            color: var(--secondary-color);
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .waiver-text {
            margin-bottom: 30px;
        }

        .waiver-text p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .photo-upload {
            margin: 10px 0;
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            background-color: #f8f8f8;
        }

        .photo-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
        }

        /* Add these styles */
        .photo-preview {
            position: relative;
        }

        .remove-photo {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .student-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            transition: transform 0.2s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .students-list {
            margin-top: 30px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .student-card-content {
            display: flex;
            gap: 15px;
            align-items: start;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        .student-class-registration {
            margin-top: 20px;
        }

        .student-registration-card {
            display: flex;
            gap: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .student-details {
            flex: 1;
        }

        .student-classes {
            flex: 1;
            padding-left: 20px;
            border-left: 1px solid #e0e0e0;
        }

        .register-classes-btn {
            width: auto !important;
            padding: 8px 16px !important;
            margin-top: 10px;
        }

        .class-selection {
            display: none;
            margin-top: 15px;
        }

        .class-selection.show {
            display: block;
        }

        .selected-classes {
            margin-top: 10px;
        }

        .selected-class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.9em;
        }

        .remove-class {
            margin-left: 5px;
            cursor: pointer;
        }

        .registered-students {
            margin-bottom: 30px;
        }

        .student-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-info h4 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
        }

        .selected-classes {
            margin-top: 10px;
        }

        .class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
        }

        .register-button {
            padding: 8px 16px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .register-button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-2px);
        }

        .class-selection-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .class-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .class-filters select {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .class-card {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .class-card.selected {
            background: var(--primary-color);
            color: white;
        }

        .registered-students {
            margin-bottom: 30px;
        }

        .student-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-info h4 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
        }

        .selected-classes {
            margin-top: 10px;
        }

        .class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
        }

        .register-button {
            width: auto;
            padding: 8px 16px;
            margin: 0 0 0 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .register-button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-2px);
        }

        /* Update the student card styles in the classes step */
        .student-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
        }

        .student-photo {
            width: 50px;  /* Reduced from 80px */
            height: 50px; /* Reduced from 80px */
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }

        .student-details {
            flex-grow: 1;
        }

        .student-details h4 {
            margin: 0 0 5px 0;
        }

        .student-summary {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .student-summary-header {
            margin-bottom: 15px;
        }

        .student-summary-header h4 {
            margin: 0;
            color: var(--secondary-color);
        }

        .student-summary-classes {
            margin-bottom: 15px;
        }

        .class-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #e0e0e0;
        }

        .student-summary-fees {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .fee-item.total {
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 10px;
        }

        .final-summary {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .final-summary .fee-item {
            font-size: 1.2em;
        }

        /* Add these styles in the style section */
        .registration-summary-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .students-summary {
            padding: 0;
        }

        .student-summary-row {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .student-name-classes {
            flex: 1;
        }

        .student-name-classes h4 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
        }

        .classes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .class-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .student-charges {
            min-width: 200px;
            text-align: right;
        }

        .charge-item {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .student-total {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .total-summary {
            background: var(--primary-color);
            color: white;
            padding: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .grand-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255,255,255,0.2);
            font-size: 1.2em;
        }

        /* Update the payment form styles */
        .payment-form {
            margin-top: 30px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .payment-form h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        /* Add these styles for validation indicators */
        .input-error {
            border-color: #ff4444 !important;
            background-color: #fff8f8;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.85em;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Add a red asterisk for required fields */
        .required-star {
            color: #ff4444;
            margin-left: 3px;
        }

        /* Add visual feedback on input focus */
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(61, 206, 215, 0.2);
        }

        input.input-error:focus, select.input-error:focus, textarea.input-error:focus {
            border-color: #ff4444;
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2);
        }

        /* Add these styles */
        .list-container {
            margin-bottom: 20px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .item-actions button {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .add-btn {
            width: auto !important;
            padding: 10px 20px !important;
            margin-bottom: 20px;
        }

        .organization-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .organization-section:last-child {
            border-bottom: none;
        }

        /* Add this after the logo section in Step 2: Studio Details */
        .studio-colors {
            margin: 30px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .studio-colors h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--secondary-color);
        }

        .color-pickers {
            display: flex;
            gap: 30px;
        }

        .color-picker-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .color-label {
            font-weight: bold;
            color: var(--text-color);
        }

        .color-value {
            font-family: monospace;
            color: #666;
            font-size: 14px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 80px;
            height: 80px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
            padding: 0;
        }

        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 50%;
            padding: 0;
        }

        input[type="color"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }

        /* Add these styles for the payment processing section */
        .payment-setup-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
        }

        .payment-intro {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid var(--primary-color);
        }

        .payment-description {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            margin: 0;
        }

        .processor-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .processor-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .processor-card {
            position: relative;
            display: block;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .processor-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .processor-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .processor-card input[type="radio"]:checked + .processor-content {
            color: var(--primary-color);
        }

        .processor-card input[type="radio"]:checked + .processor-content .processor-icon {
            background-color: var(--primary-color);
            color: white;
        }

        .processor-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .processor-icon {
            width: 50px;
            height: 50px;
            background-color: #f0f0f0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
            transition: all 0.3s ease;
        }

        .processor-info h4 {
            margin: 0 0 5px 0;
            color: inherit;
        }

        .processor-info p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        .setup-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .currency-input {
            position: relative;
            margin-bottom: 20px;
        }

        .currency-symbol {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .currency-input input {
            padding-left: 30px;
        }

        .file-upload-container {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            margin-top: 10px;
            cursor: pointer;
        }

        .file-upload-container:hover {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .file-upload-label i {
            font-size: 30px;
            color: var(--primary-color);
        }

        .file-input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        .file-preview {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: white;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        /* Add to your existing style section */
        .logo-header {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 30px auto;
            padding: 20px;
            text-align: center;
        }

        .logo-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px; /* Increased gap between icon and text */
        }

        .logo-header .icon {
            height: 80px; /* Increased from 50px */
            width: auto;
            transition: transform 0.3s ease;
        }

        .logo-header .studio-text {
            color: var(--primary-color); /* Changed from #3A506B to use the primary turquoise color */
            font-size: 3.5em;
            font-weight: bold;
            transition: transform 0.3s ease;
            font-family: 'Arial', sans-serif;
        }

        .logo-header .icon:hover,
        .logo-header .studio-text:hover {
            transform: scale(1.05);
        }

        /* Add/update these styles */
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .remove-file {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: auto;
        }

        #otherProcessorSetup textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
        }

        #otherProcessorSetup textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(61, 206, 215, 0.2);
        }

        /* Add these styles for the logo preview */
        #logoPreview {
            width: 200px;
            height: 200px;
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #logoPreview:hover {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }

        #logoPreview .upload-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #666;
        }

        #logoPreview .upload-placeholder i {
            font-size: 30px;
            color: var(--primary-color);
        }

        #logoPreview .preview-image {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        #logoPreview .remove-photo {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff4444;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #logoPreview .remove-photo:hover {
            background-color: #ff3333;
        }

        /* Add this style for the file upload styling throughout the app */
        .modern-file-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            margin-top: 10px;
            cursor: pointer;
            background-color: #f8f9fa;
        }

        .modern-file-upload:hover {
            border-color: var(--primary-color);
            background-color: rgba(61, 206, 215, 0.05);
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .upload-placeholder i {
            font-size: 36px;
            color: var(--primary-color);
        }

        .upload-text {
            color: #666;
            font-size: 1.1em;
        }

        .upload-note {
            color: #888;
            font-size: 0.9em;
        }

        .file-preview {
            margin-top: 15px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .logo-preview-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            position: relative;
        }

        .logo-preview-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: white;
        }

        .logo-preview-details {
            flex-grow: 1;
        }

        .logo-preview-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .logo-preview-size {
            color: #666;
            font-size: 0.9em;
        }

        .remove-logo {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff4444;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }

        .remove-logo:hover {
            background-color: #ff3333;
        }

        /* Add to the existing style section */
        .or-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 30px);
            height: 1px;
            background-color: #e0e0e0;
        }

        .or-divider::before {
            left: 0;
        }

        .or-divider::after {
            right: 0;
        }

        .or-divider span {
            background-color: white;
            padding: 0 15px;
            color: #666;
            font-size: 0.9em;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .file-icon.pdf {
            color: #ff4444;
        }

        .file-icon.doc {
            color: #2196F3;
        }

        .file-icon.txt {
            color: #4CAF50;
        }

        /* Add to your existing style section */
        .password-requirements {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .requirement {
            margin: 5px 0;
            color: #666;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .requirement i {
            font-size: 14px;
        }

        .requirement i.fa-times-circle {
            color: #ff4444;
        }

        .requirement i.fa-check-circle {
            color: #4CAF50;
        }

        .requirement.met {
            color: #4CAF50;
        }

        /* Add to your existing style section */
        input[type="password"].valid-password {
            border-color: #4CAF50;
            background-color: #f8fff8;
        }

        input[type="password"].invalid-password {
            border-color: #ff4444;
            background-color: #fff8f8;
        }

        .password-requirements {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff8f8;
            border-radius: 8px;
            border: 1px solid #ff4444;
        }

        .currency-input {
            position: relative;
            margin-bottom: 20px;
        }

        .currency-symbol {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .currency-input input {
            padding-left: 30px;
        }

        .pay-rate {
            color: var(--secondary-color);
            font-size: 0.9em;
            font-weight: 500;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: var(--secondary-color);
            font-size: 1.2em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #studioIdDisplay {
            position: fixed;
            top: 10px;
            right: 20px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: monospace;
            z-index: 9999;
            border: 1px solid #e0e0e0;
        }
        
        #studioIdValue {
            font-weight: bold;
            color: var(--primary-color);
        }

        .studio-id {
            margin-left: 20px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--secondary-color);
        }

        .studio-id span {
            font-family: monospace;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Password input container */
        .password-container {
            position: relative;
            width: 100%;
        }

        .password-container input {
            width: 100%;
            padding-right: 40px; /* Space for the eye icon */
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        .step-indicator.active .step-circle {
            background-color: var(--primary-color) !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(61, 206, 215, 0.3);
        }

        .step-indicator.active .step-label {
            color: var(--primary-color) !important;
            font-weight: bold;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .setup-form h3 {
            color: var(--secondary-color);
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .setup-form h3:first-child {
            margin-top: 0;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .color-preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }

        .color-hex {
            font-family: monospace;
            font-size: 14px;
            color: #666;
        }

        /* Replace the existing color-picker-group styles with: */
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .color-preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-hex {
            font-family: monospace;
            font-size: 14px;
            color: #666;
        }

        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
            padding: 0;
        }

        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 50%;
            padding: 0;
        }

        /* Add these styles where your other styles are */
        .studio-rooms-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            width: 100%;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .item-actions button {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
    </style>
    <script>
        // Immediate check for studioId on page load
        console.log(' Starting onboarding page initialization...');
        
        // Define the check function first
        function checkAndDisplayStudioId() {
            try {
                // Check all storage locations
                const registrationData = JSON.parse(localStorage.getItem('registrationData'));
                const localStudioId = localStorage.getItem('studioId');
                const sessionStudioId = sessionStorage.getItem('studioId');
                
                console.log('ðŸ” Checking storage locations:', {
                    registrationData: registrationData?.studioId,
                    localStudioId,
                    sessionStudioId
                });
                
                // Use first available studioId
                const studioId = localStudioId || sessionStudioId || registrationData?.studioId;
                
                if (studioId) {
                    console.log('âœ… Found Studio ID:', studioId);
                    // Ensure it's stored in both places
                    localStorage.setItem('studioId', studioId);
                    sessionStorage.setItem('studioId', studioId);
                }
                
                return studioId;
                
            } catch (error) {
                console.error('âŒ Error checking studioId:', error);
                return null;
            }
        }

        // Wait for DOM to be ready
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“„ DOM Content Loaded');
            
            const studioId = checkAndDisplayStudioId();
            const studioIdValue = document.getElementById('studioIdValue');
            
            if (studioIdValue) {
                if (studioId) {
                    studioIdValue.textContent = studioId;
                    studioIdValue.style.color = '#3DCED7';
                    console.log('âœ… Displayed Studio ID:', studioId);
                } else {
                    studioIdValue.textContent = 'Not found';
                    studioIdValue.style.color = '#ff4444';
                    console.error('âŒ No Studio ID found to display');
                }
            }
        });
    </script>
    <!-- Add this in the head section, after your other Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-storage.js"></script>
</head>
<body>
    <!-- Add this at the top of body -->
    <div id="studioIdDisplay" style="padding: 10px; background: #f8f9fa; margin: 10px 0; border-radius: 4px;">
        Studio ID: <span id="studioIdValue">Loading...</span>
    </div>

    <!-- Replace the existing logo-header div with this -->
    <div class="logo-header">
        <div class="logo-content">
            <img src="assets/ssdancerblue.svg" alt="Studio Sync Icon" class="icon">
            <span class="studio-text">Studio Sync</span>
        </div>
    </div>

    <!-- Then keep the existing progress-steps div -->
    <div class="progress-steps">
        <div class="step-indicator" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Studio Details</div>
        </div>
        <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Policies</div>
        </div>
        <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Organization</div>
        </div>
        <div class="step-indicator" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-label">Payment Setup</div>
        </div>
    </div>
    <div class="container">
        <form id="contactForm">
            <!-- Step 1: Studio Details -->
            <div class="step active" id="step1">
                <h2>Studio Details</h2>
                <p class="step-description">Enter your studio's basic information and customize your studio's appearance.</p>
                
                <label for="studioName">Studio Name <span class="required-star">*</span></label>
                <input type="text" id="studioName" name="studioName" required>

                <!-- Studio Logo -->
                <label for="studioLogo">Studio Logo</label>
                <div class="modern-file-upload" onclick="document.getElementById('studioLogo').click()">
                    <input type="file" id="studioLogo" accept="image/*" style="display: none" onchange="handleLogoUpload(event)">
                    <div class="upload-placeholder">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div class="upload-text">Click to upload your studio logo</div>
                        <div class="upload-note">Recommended size: 200x200px (PNG or JPG)</div>
                    </div>
                </div>
                <div id="logoPreview" class="file-preview"></div>

                <!-- Studio Address -->
                <label for="studioAddress1">Studio Address 1 <span class="required-star">*</span></label>
                <input type="text" id="studioAddress1" name="studioAddress1" required>

                <label for="studioAddress2">Studio Address 2</label>
                <input type="text" id="studioAddress2" name="studioAddress2">

                <label for="studioCity">City <span class="required-star">*</span></label>
                <input type="text" id="studioCity" name="studioCity" required>

                <label for="studioState">State <span class="required-star">*</span></label>
                <select id="studioState" name="studioState" required>
                    <option value="UT">Utah</option>
                    <!-- Add other states -->
                </select>

                <label for="studioZip">ZIP Code <span class="required-star">*</span></label>
                <input type="text" id="studioZip" name="studioZip" required>

                <!-- Studio Colors -->
                <div class="studio-colors">
                    <h3>Studio Theme Colors</h3>
                    <div class="color-pickers">
                        <div class="color-picker-group">
                            <div class="color-label">Primary Color</div>
                            <input type="color" id="primaryColor" name="primaryColor" value="#3DCED7">
                            <div class="color-value" id="primaryColorValue">#3DCED7</div>
                        </div>

                        <div class="color-picker-group">
                            <div class="color-label">Secondary Color</div>
                            <input type="color" id="secondaryColor" name="secondaryColor" value="#3A506B">
                            <div class="color-value" id="secondaryColorValue">#3A506B</div>
                        </div>
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="skipStep()" class="skip-btn">Skip Step</button>
                    <div class="main-buttons">
                        <button type="button" onclick="handleStep1Next()" class="next-btn">Next</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Policies -->
            <div class="step" id="step2">
                <h2>Studio Policies</h2>
                <p class="step-description">Enter your studio's policies and guidelines. These will be shown to students and parents during registration.</p>
                
                <label for="policyTitle">Policy Title <span class="required-star">*</span></label>
                <input 
                    type="text" 
                    id="policyTitle" 
                    placeholder="Enter policy title (e.g., 'General Studio Policies', 'Attendance Policy')"
                    required
                >

                <label for="policyContent">Policy Content <span class="required-star">*</span></label>
                <textarea 
                    id="policyContent" 
                    rows="15" 
                    placeholder="Enter your studio's policy content here..."
                    style="width: 100%; padding: 15px;"
                    required
                ></textarea>

                <div class="button-container">
                    <button type="button" onclick="skipStep()" class="skip-btn">Skip Step</button>
                    <div class="main-buttons">
                        <button type="button" onclick="goToPreviousStep()" class="back-btn">Back</button>
                        <button type="button" onclick="handleStep2Next()" class="next-btn">Next</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Organization -->
            <div class="step" id="step3">
                <h2>Organization Setup</h2>
                
                <!-- Instructors Section -->
                <div class="organization-section">
                    <h3>Instructors</h3>
                    <div id="instructorsList" class="list-container"></div>
                    <button type="button" class="add-btn" onclick="showAddInstructorModal()">
                        Add Instructor
                    </button>
                </div>

                <!-- Studios Section -->
                <div class="organization-section">
                    <h3>Studio Rooms</h3>
                    <p class="section-description">Create a room for each studio room in your studio.</p>
                    <div id="studioRoomsList" class="studio-rooms-list"></div>
                    <button type="button" class="add-btn" onclick="showAddStudioModal()">
                        Add Studio Room
                    </button>
                </div>

                <!-- Season Section -->
                <div class="organization-section">
                    <h3>Seasons</h3>
                    <div id="seasonsList" class="list-container"></div>
                    <button type="button" class="add-btn" onclick="showAddSeasonModal()">
                        Add Season
                    </button>
                </div>

                <!-- Add this right after the Organization Setup h2 in Step 3 -->
                <div class="organization-section">
                    <h3>Additional Directors (Optional)</h3>
                    <p class="section-description">Add additional studio directors if needed.</p>
                    <div id="directorsList" class="list-container"></div>
                    <button type="button" class="add-btn" onclick="showAddDirectorModal()">
                        Add Director
                    </button>
                </div>

                <div class="button-container">
                    <button type="button" onclick="skipStep()" class="skip-btn">Skip Step</button>
                    <div class="main-buttons">
                        <button type="button" onclick="goToPreviousStep()" class="back-btn">Back</button>
                        <button type="button" onclick="handleStep3Next()" class="next-btn">Next</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Payment Processing -->
            <div class="step" id="step4">
                <h2>Payment Processing Setup</h2>
                
                <div class="payment-setup-section">
                    <div class="payment-intro">
                        <p class="payment-description">
                            Run all payments in your Studio business straight from our software. StudioSync payment processing is easy, fast, and cost effective! 
                            Simply fill out the details below and start taking payments now!
                        </p>
                    </div>

                    <div class="setup-form">
                        <!-- Personal Information Section -->
                        <h3>Personal Information</h3>
                        <div class="form-section">
                            <label for="ownerName">Owner Name <span class="required-star">*</span></label>
                            <input type="text" id="ownerName" placeholder="Full legal name">

                            <label for="ownerTitle">Title <span class="required-star">*</span></label>
                            <input type="text" id="ownerTitle" placeholder="e.g., Owner, CEO">

                            <label for="ownerDob">Date of Birth <span class="required-star">*</span></label>
                            <input type="date" id="ownerDob">

                            <label for="ownerSsn">SSN (Last 4 digits) <span class="required-star">*</span></label>
                            <input type="text" id="ownerSsn" maxlength="4" placeholder="Last 4 digits">

                            <label for="ownerAddress">Home Address <span class="required-star">*</span></label>
                            <input type="text" id="ownerAddress" placeholder="Street address">

                            <label for="ownerCity">City <span class="required-star">*</span></label>
                            <input type="text" id="ownerCity">

                            <label for="ownerState">State <span class="required-star">*</span></label>
                            <input type="text" id="ownerState">

                            <label for="ownerZip">ZIP Code <span class="required-star">*</span></label>
                            <input type="text" id="ownerZip">
                        </div>

                        <!-- Business Information Section -->
                        <h3>Business Information</h3>
                        <div class="form-section">
                            <label for="businessName">Business Legal Name <span class="required-star">*</span></label>
                            <input type="text" id="businessName" placeholder="Legal business name">

                            <label for="businessType">Business Type <span class="required-star">*</span></label>
                            <select id="businessType">
                                <option value="">Select business type</option>
                                <option value="LLC">LLC</option>
                                <option value="S Corp">S Corp</option>
                                <option value="C Corp">C Corp</option>
                                <option value="Sole Prop">Sole Proprietorship</option>
                            </select>

                            <label for="taxId">Tax ID (EIN) <span class="required-star">*</span></label>
                            <input type="text" id="taxId" placeholder="XX-XXXXXXX">

                            <label for="businessPhone">Business Phone <span class="required-star">*</span></label>
                            <input type="tel" id="businessPhone">

                            <label for="businessEmail">Business Email <span class="required-star">*</span></label>
                            <input type="email" id="businessEmail">

                            <label for="businessAddress">Business Address <span class="required-star">*</span></label>
                            <input type="text" id="businessAddress">

                            <label for="businessCity">City <span class="required-star">*</span></label>
                            <input type="text" id="businessCity">

                            <label for="businessState">State <span class="required-star">*</span></label>
                            <input type="text" id="businessState">

                            <label for="businessZip">ZIP Code <span class="required-star">*</span></label>
                            <input type="text" id="businessZip">

                            <label for="monthlyVolume">Estimated Monthly Volume <span class="required-star">*</span></label>
                            <div class="currency-input">
                                <span class="currency-symbol">$</span>
                                <input type="text" id="monthlyVolume" placeholder="0.00">
                            </div>
                        </div>

                        <!-- Required Documents Section -->
                        <h3>Required Documents</h3>
                        <div class="form-section">
                            <label for="driverLicenseFront">Driver's License (Front) <span class="required-star">*</span></label>
                            <div class="modern-file-upload" onclick="document.getElementById('driverLicenseFront').click()">
                                <input type="file" id="driverLicenseFront" accept="image/*,.pdf" style="display: none" 
                                       onchange="handleDocumentUpload(event, 'driverLicenseFrontPreview', 'DriverLicenses')">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <div class="upload-text">Click to upload driver's license front</div>
                                    <div class="upload-note">Accepts images and PDF</div>
                                </div>
                            </div>
                            <div id="driverLicenseFrontPreview" class="file-preview"></div>

                            <label for="voidedCheck">Voided Check <span class="required-star">*</span></label>
                            <div class="modern-file-upload" onclick="document.getElementById('voidedCheck').click()">
                                <input type="file" id="voidedCheck" accept="image/*,.pdf" style="display: none" 
                                       onchange="handleDocumentUpload(event, 'voidedCheckPreview', 'VoidedChecks')">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <div class="upload-text">Click to upload voided check</div>
                                    <div class="upload-note">Accepts images and PDF</div>
                                </div>
                            </div>
                            <div id="voidedCheckPreview" class="file-preview"></div>

                            <label for="merchantStatement">Merchant Statement <span class="required-star">*</span></label>
                            <div class="modern-file-upload" onclick="document.getElementById('merchantStatement').click()">
                                <input type="file" id="merchantStatement" accept="image/*,.pdf" style="display: none" 
                                       onchange="handleDocumentUpload(event, 'merchantStatementPreview', 'MerchantStatements')">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <div class="upload-text">Click to upload merchant statement</div>
                                    <div class="upload-note">Accepts images and PDF</div>
                                </div>
                            </div>
                            <div id="merchantStatementPreview" class="file-preview"></div>
                        </div>
                    </div>

                    <div class="button-container">
                        <button type="button" onclick="skipStep()" class="skip-btn">Skip Step</button>
                        <div class="main-buttons">
                            <button type="button" onclick="goToPreviousStep()" class="back-btn">Back</button>
                            <button type="button" onclick="handleStep4Next()" class="next-btn">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Update the edit modal content -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Student</h2>
            <div class="edit-student-form">
                <label for="editStudentFirstName">Student's First Name <span class="required-star">*</span></label>
                <input type="text" id="editStudentFirstName" required>

                <label for="editStudentLastName">Student's Last Name <span class="required-star">*</span></label>
                <input type="text" id="editStudentLastName" required>

                <label for="editStudentBirthday">Birthday <span class="required-star">*</span></label>
                <input type="date" id="editStudentBirthday" required>

                <label for="editStudentGender">Gender</label>
                <select id="editStudentGender">
                    <option value="" disabled>Select Gender</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                    <option value="other">Other</option>
                    <option value="prefer-not">Prefer not to say</option>
                </select>

                <label for="editMedicalInfo">Any medical information we should know</label>
                <textarea id="editMedicalInfo" rows="3" placeholder="Enter any medical conditions, allergies, or other important health information"></textarea>

                <label for="editSkillLevel">Skill Level <span class="required-star">*</span></label>
                <select id="editSkillLevel" required>
                    <option value="" disabled>Select Skill Level</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                    <option value="other">Other</option>
                </select>

                <label for="editStudentPhoto">Student Photo</label>
                <div class="photo-upload">
                    <input type="file" id="editStudentPhoto" accept="image/*" class="photo-input">
                    <div class="photo-preview" id="editPhotoPreview"></div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="closeEditModal()">Cancel</button>
                    <button type="button" onclick="saveEditedStudent()">Save Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add these script tags right before your existing scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Initialize Firebase with storage
        const firebaseConfig = {
            apiKey: "AIzaSyDRSW3u6gJSs98Z2Mkp5DYSC__ibDXXHAE",
            authDomain: "studiosync-af73d.firebaseapp.com",
            projectId: "studiosync-af73d",
            storageBucket: "studiosync-af73d.appspot.com", // Make sure this is included
            messagingSenderId: "172555302276",
            appId: "1:172555302276:web:55b661f9849441e2de59d1",
            measurementId: "G-EK7EFQGMSG"
        };
        
        firebase.initializeApp(firebaseConfig);


         // Initialize the directors array at the top of your script
         let directors = [];

        // Add this helper function to generate a subdomain from studio name
        function generateSubdomain(studioName) {
            return studioName
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-'); // Replace multiple hyphens with single hyphen
        }

        // Add this function to check if subdomain exists
        async function isSubdomainUnique(subdomain) {
            const querySnapshot = await firebase.firestore()
                .collection('Studios')
                .where('StudioSubdomain', '==', subdomain)
                .get();
            
            return querySnapshot.empty;
        }

        // Add this function to generate random numbers
        function generateRandomNumbers() {
            return Math.floor(Math.random() * 900 + 100); // Generates a random 3-digit number
        }

        // First, add this function to handle logo upload to Firebase Storage
        async function uploadStudioLogo(file, studioId) {
            if (!file) return '';
            
            try {
                const storageRef = firebase.storage().ref();
                const logoRef = storageRef.child(`StudioLogos/${studioId}/${file.name}`);
                const snapshot = await logoRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('âœ… Logo uploaded successfully');
                return downloadURL;
            } catch (error) {
                console.error('âŒ Error uploading logo:', error);
                throw error;
            }
        }

        // Add this function to handle merchant statement upload to Firebase Storage
        async function uploadMerchantStatement(file, studioId) {
            if (!file) return '';
            
            try {
                const storageRef = firebase.storage().ref();
                const statementRef = storageRef.child(`MerchantStatements/${studioId}/${file.name}`);
                const snapshot = await statementRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('âœ… Merchant statement uploaded successfully');
                return downloadURL;
            } catch (error) {
                console.error('âŒ Error uploading merchant statement:', error);
                throw error;
            }
        }

        // Then update the completeOnboarding function to include the studio details
        async function completeOnboarding() {
            try {
                // Get the studioId
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                // Store studioId in localStorage for login page
                localStorage.setItem('onboardingStudioId', studioId);
                console.log('ðŸ’¾ Studio ID stored for login page');

                // Hide loading overlay
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'none';

                // Simple redirect to studiologin
                console.log('ðŸ”„ Redirecting to studiologin...');
                window.location.href = '/studiologin';

            } catch (error) {
                console.error('âŒ Error in completing onboarding:', error);
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'none';
                alert(`Failed to complete onboarding: ${error.message}`);
                
                // Still redirect to studiologin on error
                window.location.href = '/studiologin';
            }
        }

        // Update or add the generateSubdomain function
        function generateSubdomain(studioName) {
            return studioName
                .toLowerCase() // Convert to lowercase
                .trim() // Remove leading/trailing spaces
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters except spaces and hyphens
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
                .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
        }

        // Helper function to upload merchant statement
        async function uploadMerchantStatement(studioId) {
            const merchantStatement = document.getElementById('merchantStatement');
            if (merchantStatement.files.length > 0) {
                const file = merchantStatement.files[0];
                const storageRef = firebase.storage().ref(`MerchantStatements/${studioId}`);
                const snapshot = await storageRef.put(file);
                return await snapshot.ref.getDownloadURL();
            }
            return '';
        }

        // Add these new functions
        function showSuccessModal(studioName, studioUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Studio Setup Complete! ðŸŽ‰</h2>
                    <div class="success-info">
                        <p>Congratulations! Your studio "${studioName}" has been successfully set up.</p>
                        
                        <div class="login-details">
                            <h3>Your Studio Login URL:</h3>
                            <div class="url-box">
                                <input type="text" value="${studioUrl}" readonly>
                                <button onclick="copyToClipboard('${studioUrl}')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>

                        <div class="next-steps">
                            <h3>Next Steps:</h3>
                            <ol>
                                <li>Bookmark your studio's login URL</li>
                                <li>Check your email for login credentials</li>
                                <li>Share the URL with your staff members</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button onclick="window.location.href='${studioUrl}'" class="primary-btn">
                            Go to Studio Login
                        </button>
                        <button onclick="copyToClipboard('${studioUrl}')" class="secondary-btn">
                            Copy Login URL
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add styles for the success modal
            const style = document.createElement('style');
            style.textContent = `
                .success-info {
                    margin: 20px 0;
                    text-align: left;
                }
                .login-details {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                }
                .url-box {
                    display: flex;
                    gap: 10px;
                    margin-top: 10px;
                }
                .url-box input {
                    flex: 1;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-family: monospace;
                }
                .next-steps {
                    margin: 20px 0;
                }
                .next-steps ol {
                    padding-left: 20px;
                }
                .next-steps li {
                    margin: 10px 0;
                }
                .modal-actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 20px;
                }
                .modal-actions button {
                    flex: 1;
                    padding: 12px;
                }
            `;
            document.head.appendChild(style);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URL copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        async function sendWelcomeEmail(email, studioName, studioUrl) {
            // This would typically be handled by your backend
            // For now, we'll just log it
            console.log('Welcome email would be sent to:', email, {
                subject: `Welcome to StudioSync - ${studioName}`,
                studioUrl: studioUrl
            });
            
            // In production, you would make an API call to your backend:
            /*
            await fetch('/api/send-welcome-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email,
                    studioName,
                    studioUrl
                })
            });
            */
        }

        // 1. KEEP ONLY THIS ONE SET OF DECLARATIONS AT THE TOP
        let currentStepNumber = 1;  // Initialize at step 1
        const TOTAL_STEPS = 4;     // Define total number of steps
        const students = [];        // Add this if needed for student functionality
        
        // Global arrays for storing data
        const instructors = [];
        const studios = [];
        const studioLocations = [];
        const seasons = [];
        
        const contactInfo = {
            firstName: '',
            lastName: '',
            address1: '',
            address2: '',
            city: '',
            state: '',
            zip: '',
            phone: '',
            email: '',
            password: ''
        };

        // 2. REMOVE these duplicate declarations from:
        // - Around line 1782-1785
        // - Around line 2772-2775
        // Delete or comment out ALL other declarations of:
        // - instructors = []
        // - studios = []
        // - studioLocations = []
        // - seasons = []
        // - contactInfo = {}

        // Rest of your code stays the same...

        // Add these validation functions
        function validatePaymentSetup() {
            clearValidationErrors();
            
            const selectedProcessor = document.querySelector('input[name="paymentProcessor"]:checked');
            if (!selectedProcessor) {
                alert('Please select a payment processor');
                return false;
            }
            
            if (selectedProcessor.value === 'studiosync') {
                const monthlyVolume = document.getElementById('monthlyVolume').value;
                const merchantStatement = document.getElementById('merchantStatement').value;
                
                if (!monthlyVolume) {
                    showError(document.getElementById('monthlyVolume'), 'Please enter estimated monthly volume');
                    return false;
                }
                
                if (!merchantStatement) {
                    showError(document.getElementById('merchantStatement').parentElement, 'Please upload a merchant statement');
                    return false;
                }
            } else if (selectedProcessor.value === 'other') {
                const processorName = document.getElementById('processorName').value;
                const processorContact = document.getElementById('processorContact').value;
                
                if (!processorName || !processorContact) {
                    if (!processorName) showError(document.getElementById('processorName'), 'Please enter processor name');
                    if (!processorContact) showError(document.getElementById('processorContact'), 'Please enter contact information');
                    return false;
                }
            }
            
            return true;
        }

        // Add this helper function to calculate darker shades
        function adjustColor(color, percent) {
            let R = parseInt(color.substring(1,3), 16);
            let G = parseInt(color.substring(3,5), 16);
            let B = parseInt(color.substring(5,7), 16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            R = Math.max(0, R);
            G = Math.max(0, G);
            B = Math.max(0, B);

            const RR = ((R.toString(16).length === 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length === 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length === 1) ? "0" + B.toString(16) : B.toString(16));

            return "#" + RR + GG + BB;
        }

        // Add these helper functions
        function showError(element, message) {
            element.classList.add('input-error');
            
            // Create or update error message
            let errorDiv = element.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                element.parentNode.insertBefore(errorDiv, element.nextSibling);
            }
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function clearValidationErrors() {
            // Remove all error classes and messages
            document.querySelectorAll('.input-error').forEach(element => {
                element.classList.remove('input-error');
            });
            document.querySelectorAll('.error-message').forEach(element => {
                element.classList.remove('show');
            });
        }

        // Add input event listeners to clear errors when user starts typing
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('input', function() {
                this.classList.remove('input-error');
                const errorMessage = this.nextElementSibling;
                if (errorMessage && errorMessage.classList.contains('error-message')) {
                    errorMessage.classList.remove('show');
                }
            });
        });

        function goToStep1() {
            hideAllSteps();
            document.getElementById('step1').style.display = 'block';
        }

        function cancelRegistration() {
            if (confirm('Are you sure you want to cancel the registration?')) {
                window.location.href = 'home.html'; // Redirect to the home page or other relevant page
            }
        }
        

        document.getElementById('contactForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get the signature
            const signature = document.getElementById('generatedSignature').textContent;
            
            // Create an object with all the form data including the signature
            const formData = {
                contactInfo: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    // ... other contact fields
                },
                students: students,
                waiver: {
                    termsAccepted: document.getElementById('termsAccept').checked,
                    electronicSignature: signature,
                    signatureDate: new Date().toISOString()
                },
                payment: {
                    cardName: document.getElementById('cardName').value,
                    // ... other payment fields (you might want to handle these securely)
                }
            };

            // Here you would send formData to your backend
            console.log('Form submitted with data:', formData);
            alert('Registration complete! Thank you for registering your student.');
        });

        // Add these functions for student functionality
        function calculateAge(birthday) {
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Add this function to validate student data
        function validateStudent(student) {
            const errors = [];
            
            if (!student.firstName?.trim()) errors.push('First Name');
            if (!student.lastName?.trim()) errors.push('Last Name');
            if (!student.birthday) errors.push('Birthday');
            if (!student.skillLevel) errors.push('Skill Level');
            
            return errors;
        }

        // Update the addStudent function with validation
        function addStudent() {
            clearValidationErrors();
            
            const studentData = {
                firstName: document.getElementById('studentFirstName').value.trim(),
                lastName: document.getElementById('studentLastName').value.trim(),
                birthday: document.getElementById('studentBirthday').value,
                gender: document.getElementById('studentGender').value,
                medicalInfo: document.getElementById('medicalInfo').value.trim(),
                skillLevel: document.getElementById('skillLevel').value,
                photoUrl: document.getElementById('photoPreview').style.backgroundImage.replace(/^url\(['"](.+)['"]\)$/, '$1') || ''
            };

            const errors = validateStudent(studentData);
            
            if (errors.length > 0) {
                errors.forEach(field => {
                    const element = document.getElementById('student' + field.replace(/\s+/g, ''));
                    if (element) {
                        showError(element, `${field} is required`);
                    }
                });
                return;
            }

            studentData.age = calculateAge(studentData.birthday);
            students.push(studentData);
            updateStudentsList();
            clearStudentForm();
        }

        function clearStudentForm() {
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentBirthday').value = '';
            document.getElementById('studentGender').selectedIndex = 0;
            document.getElementById('medicalInfo').value = '';
            document.getElementById('skillLevel').selectedIndex = 0;
            document.getElementById('photoPreview').style.backgroundImage = '';
            document.getElementById('studentPhoto').value = '';
            document.querySelectorAll('input[name="danceClass"]')
                .forEach(checkbox => checkbox.checked = false);
        }

        function updateStudentsList() {
            const listContainer = document.getElementById('studentsList');
            if (students.length === 0) {
                listContainer.innerHTML = '<div class="no-students">No students added yet</div>';
                return;
            }

            listContainer.innerHTML = students.map((student, index) => `
                <div class="student-card" data-student-index="${index}">
                    <div class="student-card-content">
                        ${student.photoUrl ? 
                            `<div class="student-photo" style="background-image: url('${student.photoUrl}')"></div>` 
                            : ''}
                        <div class="student-info">
                            <strong>${student.firstName} ${student.lastName}</strong> (Age: ${student.age})<br>
                            Birthday: ${new Date(student.birthday).toLocaleDateString()}<br>
                            ${student.gender ? `Gender: ${student.gender}<br>` : ''}
                            ${student.medicalInfo ? `Medical Info: ${student.medicalInfo}<br>` : ''}
                            Level: ${student.skillLevel}
                        </div>
                        <div class="student-actions">
                            <button onclick="editStudent(${index})" class="action-btn">Edit</button>
                            <button onclick="deleteStudent(${index})" class="action-btn">Delete</button>
                        </div>
                    </div>
                    <div class="error-message"></div>
                </div>
            `).join('');
        }

        function editStudent(index) {
            currentEditIndex = index;
            const student = students[index];
            const modal = document.getElementById('editStudentModal');
            
            // Fill the form with student data
            document.getElementById('editStudentFirstName').value = student.firstName;
            document.getElementById('editStudentLastName').value = student.lastName;
            document.getElementById('editStudentBirthday').value = student.birthday;
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editMedicalInfo').value = student.medicalInfo || '';
            document.getElementById('editSkillLevel').value = student.skillLevel;
            
            // Set photo preview if exists
            const editPhotoPreview = document.getElementById('editPhotoPreview');
            if (student.photoUrl) {
                editPhotoPreview.style.backgroundImage = `url('${student.photoUrl}')`;
                editPhotoPreview.innerHTML = `<div class="remove-photo" onclick="removePhoto('editPhotoPreview')">Ã—</div>`;
            } else {
                editPhotoPreview.style.backgroundImage = '';
                editPhotoPreview.innerHTML = '';
            }

            modal.classList.add('show');
        }

        function closeEditModal() {
            const modal = document.getElementById('editStudentModal');
            modal.classList.remove('show');  // Remove the show class
            currentEditIndex = -1;
        }

        function saveEditedStudent() {
            if (currentEditIndex === -1) return;

            const firstName = document.getElementById('editStudentFirstName').value;
            const lastName = document.getElementById('editStudentLastName').value;
            const birthday = document.getElementById('editStudentBirthday').value;
            const gender = document.getElementById('editStudentGender').value;
            const medicalInfo = document.getElementById('editMedicalInfo').value;
            const skillLevel = document.getElementById('editSkillLevel').value;
            const photoPreview = document.getElementById('editPhotoPreview').style.backgroundImage;
            const photoUrl = photoPreview ? photoPreview.slice(5, -2) : '';

            if (!firstName || !lastName || !birthday || !skillLevel) {
                alert('Please fill in all required fields');
                return;
            }

            // Update the student data
            students[currentEditIndex] = {
                firstName,
                lastName,
                birthday,
                age: calculateAge(birthday),
                gender,
                medicalInfo,
                skillLevel,
                photoUrl
            };

            updateStudentsList();
            closeEditModal();
        }

        // Add photo preview functionality for edit modal
        document.getElementById('editStudentPhoto').addEventListener('change', function(e) {
            updatePhotoPreview('editPhotoPreview', e.target.files[0]);
        });

        // Add event listener for the close button
        document.querySelector('.close').addEventListener('click', closeEditModal);

        // Close modal if clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editStudentModal');
            if (event.target === modal) {
                closeEditModal();
            }
        });

        function deleteStudent(index) {
            if (confirm('Are you sure you want to remove this student?')) {
                students.splice(index, 1);
                updateStudentsList();
            }
        }

        // Update the goToStep3 function with better validation
        function goToStep3() {
            clearValidationErrors();

            if (students.length === 0) {
                alert('Please add at least one student before proceeding');
                return false;
            }

            let hasErrors = false;
            students.forEach((student, index) => {
                const errors = validateStudent(student);
                if (errors.length > 0) {
                    hasErrors = true;
                    const studentCard = document.querySelector(`[data-student-index="${index}"]`);
                    if (studentCard) {
                        showError(studentCard, `Please complete all required fields for ${student.firstName || 'this student'}: ${errors.join(', ')}`);
                    }
                }
            });

            if (hasErrors) {
                return false;
            }

            hideAllSteps();
            document.getElementById('step3').style.display = 'block';
            updateProgressSteps(3);
            updateStudentClassList();
            return true;
        }

        function goToStep4() {
            // Check if each student has at least one class
            const allStudentsHaveClasses = students.every(student => 
                student.classes && student.classes.length > 0
            );

            if (!allStudentsHaveClasses) {
                alert('Please select at least one class for each student before proceeding');
                return;
            }

            // If validation passes, proceed to step 4
            hideAllSteps();
            document.getElementById('step4').style.display = 'block';
            updateProgressSteps(4);
            updateWaiverStudentList();
        }

        function goToStep5() {
            // Check waiver acceptance
            if (!document.getElementById('termsAccept').checked || 
                !document.getElementById('electronicSignatureAccept').checked) {
                alert('Please accept both the waiver and provide electronic signature consent');
                return;
            }

            // If validation passes, proceed to step 5
            hideAllSteps();
            document.getElementById('step5').style.display = 'block';
            updateProgressSteps(5);
            updateRegistrationSummary();
        }

        function hasSelectedClasses() {
            const selectedClasses = document.querySelectorAll('input[name="danceClass"]:checked');
            return selectedClasses.length > 0;
        }

        function updateWaiverStudentList() {
            const waiverListContainer = document.getElementById('waiverStudentList');
            if (students.length === 0) {
                waiverListContainer.innerHTML = '<div class="no-students">No students added</div>';
                return;
            }

            waiverListContainer.innerHTML = students.map(student => 
                `<div class="waiver-student-name">${student.firstName} ${student.lastName}</div>`
            ).join('');
        }

        // Replace the existing updateRegistrationSummary function with this one
        function updateRegistrationSummary() {
            const summaryContainer = document.getElementById('registrationSummary');
            let totalAmount = 0;
            const classPrice = 50; // Price per class
            const registrationFee = 30; // One-time registration fee per student

            const summary = students.map(student => {
                const classesTotal = student.classes ? student.classes.length * classPrice : 0;
                const studentTotal = classesTotal + registrationFee;
                totalAmount += studentTotal;

                return `
                    <div class="student-summary">
                        <div class="student-summary-header">
                            <h4>${student.firstName} ${student.lastName}</h4>
                            <p>Age: ${student.age} | Level: ${student.skillLevel}</p>
                        </div>
                        <div class="student-summary-classes">
                            <h5>Registered Classes:</h5>
                            ${student.classes ? student.classes.map(className => 
                                `<div class="class-item">
                                    <span>${className}</span>
                                    <span>$${classPrice.toFixed(2)}</span>
                                </div>`
                            ).join('') : 'No classes selected'}
                        </div>
                        <div class="student-summary-fees">
                            <div class="fee-item">
                                <span>Registration Fee:</span>
                                <span>$${registrationFee.toFixed(2)}</span>
                            </div>
                            <div class="fee-item">
                                <span>Classes Subtotal:</span>
                                <span>$${classesTotal.toFixed(2)}</span>
                            </div>
                            <div class="fee-item total">
                                <strong>Student Total:</strong>
                                <strong>$${studentTotal.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add final summary section
            const finalSummary = `
                <div class="final-summary">
                    <div class="fee-item">
                        <strong>Total Registration Amount:</strong>
                        <strong>$${totalAmount.toFixed(2)}</strong>
                    </div>
                </div>
            `;

            summaryContainer.innerHTML = summary + finalSummary;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
        }

        function submitRegistration() {
            // Validate payment information
            clearValidationErrors();
            let hasErrors = false;

            // Required payment fields validation
            const paymentFields = [
                { id: 'cardName', message: 'Please enter the name on card' },
                { id: 'cardNumber', message: 'Please enter a valid card number' },
                { id: 'expiryDate', message: 'Please enter the expiry date' },
                { id: 'cvv', message: 'Please enter the CVV' }
            ];

            // Check each required field
            paymentFields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = element.value.trim();
                
                if (!value) {
                    showError(element, field.message);
                    hasErrors = true;
                }
            });

            // Validate card number format (remove spaces and check length)
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            if (cardNumber && (cardNumber.length < 15 || cardNumber.length > 16)) {
                showError(document.getElementById('cardNumber'), 'Please enter a valid card number');
                hasErrors = true;
            }

            // Validate expiry date format (MM/YY)
            const expiryDate = document.getElementById('expiryDate').value;
            const expiryPattern = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
            if (expiryDate && !expiryPattern.test(expiryDate)) {
                showError(document.getElementById('expiryDate'), 'Please enter a valid expiry date (MM/YY)');
                hasErrors = true;
            }

            // Validate CVV (3 or 4 digits)
            const cvv = document.getElementById('cvv').value;
            if (cvv && !/^[0-9]{3,4}$/.test(cvv)) {
                showError(document.getElementById('cvv'), 'Please enter a valid CVV');
                hasErrors = true;
            }

            if (hasErrors) {
                // Scroll to the first error
                const firstError = document.querySelector('.input-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }

            // If validation passes, prepare the final submission data
            const registrationData = {
                contactInfo: contactInfo,
                students: students,
                payment: {
                    cardName: document.getElementById('cardName').value,
                    cardNumber: cardNumber,
                    expiryDate: expiryDate,
                    cvv: cvv,
                    sameAsContact: document.getElementById('sameAsContact').checked
                },
                signature: document.getElementById('generatedSignature').innerHTML,
                timestamp: new Date().toISOString()
            };

            // Here you would typically send the data to your server
            console.log('Registration data:', registrationData);

            // Show success message and redirect
            alert('Registration completed successfully! Thank you for registering.');
            window.location.href = 'home.html'; // or wherever you want to redirect after success

            return true;
        }

        // Add card number formatting
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value;
        });

        // Add expiry date formatting
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0,2) + '/' + value.slice(2);
            }
            e.target.value = value;
        });

        // Initialize the empty students list
        updateStudentsList();

        // Add this function to generate the signature
        async function generateSignature() {
            // Check if we have stored contact info
            if (!contactInfo.firstName || !contactInfo.lastName) {
                alert('Error: Could not find contact information. Please complete Step 1 first.');
                return null;
            }

            const fullName = `${contactInfo.firstName} ${contactInfo.lastName}`;
            const timestamp = new Date().toLocaleString();
            const ip = await getIPAddress();
            
            return {
                name: fullName,
                timestamp: timestamp,
                ip: ip
            };
        }

        // Add this function to check if contact info exists
        function hasContactInfo() {
            return contactInfo.firstName && contactInfo.lastName;
        }

        // Update the signature generation part in the event listener
        document.getElementById('electronicSignatureAccept').addEventListener('change', async function(e) {
            const signatureDisplay = document.getElementById('generatedSignature').closest('.signature-display');
            
            if (e.target.checked) {
                if (!contactInfo.firstName || !contactInfo.lastName) {
                    alert('Error: Could not find contact information from Step 1');
                    e.target.checked = false;
                    return;
                }

                signatureDisplay.innerHTML = '<div class="signature-loading">Generating signature...</div>';
                
                try {
                    const ip = await getIPAddress();
                    const date = new Date();
                    const formattedDate = date.toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric'
                    });
                    
                    const formattedTime = date.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    const fullName = `${contactInfo.firstName} ${contactInfo.lastName}`;
                    
                    // Updated signature structure to ensure consistent styling
                    signatureDisplay.innerHTML = `
                        <p>Electronic Signature:</p>
                        <div class="signature-main">
                            <span class="signature-text">${fullName}</span>
                            <span class="signature-date">${formattedDate}</span>
                            <div class="signature-details">
                                <div class="signature-timestamp">Time of Signature: ${formattedTime}</div>
                                <div class="signature-ip">IP: ${ip}</div>
                            </div>
                    `;
                    
                    // Make sure all signature elements are visible
                    const signatureElements = signatureDisplay.querySelectorAll('.signature-text, .signature-date');
                    signatureElements.forEach(el => {
                        el.style.display = 'block';
                    });
                    
                    setTimeout(() => {
                        signatureDisplay.classList.add('show');
                    }, 50);
                    
                } catch (error) {
                    console.error('Error generating signature:', error);
                    alert('There was an error generating the signature. Please try again.');
                    e.target.checked = false;
                }
            } else {
                signatureDisplay.classList.remove('show');
                setTimeout(() => {
                    signatureDisplay.innerHTML = '';
                }, 500);
            }
        });

        function hideAllSteps() {
            document.querySelectorAll('.step').forEach(step => {
                step.style.display = 'none';
            });
        }

       
        // Add this JavaScript function to update the progress indicator
        function updateProgressSteps(currentStep) {
            console.log('Updating progress steps to:', currentStep);
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                const stepNum = index + 1;
                
                // Remove all classes
                indicator.classList.remove('active', 'completed');
                
                // Then add appropriate class
                if (stepNum === currentStep) {
                    indicator.classList.add('active');
                    console.log(`Step ${stepNum} marked as active`);
                } else if (stepNum < currentStep) {
                    indicator.classList.add('completed');
                    console.log(`Step ${stepNum} marked as completed`);
                }
            });
        }

        // Update the existing navigation functions to include progress updates
        function goToStep1() {
            hideAllSteps();
            document.getElementById('step1').style.display = 'block';
            updateProgressSteps(1);
        }

        // Replace the existing goToStep2 function with this one
        async function goToStep2() {
            console.log('ðŸ”„ Switching to Step 2');
            // First hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.style.cssText = 'display: none !important';  // Force hide with !important
                console.log('ðŸ’« Hiding step:', step.id);
            });
            
            // Then show step 2
            const step2 = document.getElementById('step2');
            step2.classList.add('active');
            step2.style.cssText = 'display: block !important';  // Force show with !important
            currentStepNumber = 2;  // Add this line to update the step number
            console.log('âœ… Step 2 is now visible');
            // Verify step 2 is actually visible
            setTimeout(() => {
                const isStep2Visible = window.getComputedStyle(step2).display !== 'none';
                console.log('ðŸ” Step 2 visibility check:', isStep2Visible ? 'Visible' : 'Hidden');
                console.log('ðŸŽ¨ Step 2 computed styles:', {
                    display: window.getComputedStyle(step2).display,
                    visibility: window.getComputedStyle(step2).visibility,
                    opacity: window.getComputedStyle(step2).opacity
                });
            }, 100);
        }

        // Add close modal function
        function closeModal(button) {
            const modal = button.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add these functions after goToStep2()
        function goToPreviousStep() {
            if (currentStepNumber <= 1) return;
            
            console.log('Going back to step', currentStepNumber - 1);
            
            // Hide all steps
            hideAllSteps();
            
            // Update current step number
            currentStepNumber--;
            
            // Show the previous step
            document.getElementById(`step${currentStepNumber}`).style.cssText = 'display: block !important';
            
            // Update progress bar to show current step
            updateProgressSteps(currentStepNumber);
        }

        // Replace the existing goToNextStep function with this one
        function goToNextStep() {
            const currentStep = currentStepNumber;
            
            if (currentStep === 1) {
                // Collect director information
                const directorData = {
                    firstName: document.getElementById('directorFirstName').value,
                    lastName: document.getElementById('directorLastName').value,
                    email: document.getElementById('directorEmail').value,
                    phone: document.getElementById('directorPhone').value,
                    password: document.getElementById('directorPassword').value,
                    confirmPassword: document.getElementById('confirmDirectorPassword').value
                };

                // Store for later use in final step
                sessionStorage.setItem('directorData', JSON.stringify(directorData));

                // Proceed to next step if validation passes
                if (validateDirectorInfo(directorData)) {
                    hideAllSteps();
                    document.getElementById('step2').style.display = 'block';
                    updateProgressSteps(2);
                }
            } else if (currentStep === 5) {
                // On final step, create Firebase user and director document
                completeOnboarding();
            } else {
                // Handle other steps normally
                if (validateStep(currentStep)) {
                    hideAllSteps();
                    document.getElementById(`step${currentStep + 1}`).style.display = 'block';
                    updateProgressSteps(currentStep + 1);
                }
            }
        }
        

       

        function validateStep(step) {
            let isValid = false;
            switch(step) {
                case 1:
                    isValid = validateDirectorInfo(JSON.parse(sessionStorage.getItem('directorData')));
                    break;
                case 2:
                    isValid = validateStudioDetails();
                    break;
                case 3:
                    isValid = true; // Policies are optional
                    break;
                case 4:
                    isValid = validateOrganization();
                    break;
                case 5:
                    isValid = validatePaymentSetup();
                    break;
                default:
                    isValid = true;
            }
            return isValid;
        }

        function canGoToNextStep() {
            return currentStepNumber < TOTAL_STEPS && validateStep(currentStepNumber);
        }

        function canGoToPreviousStep() {
            return currentStepNumber > 1;
        }

        function validateStudioDetails() {
            clearValidationErrors();
            const requiredFields = [
                { id: 'studioName', message: 'Please enter studio name' },
                { id: 'studioAddress1', message: 'Please enter studio address' },
                { id: 'studioCity', message: 'Please enter city' },
                { id: 'studioState', message: 'Please select state' },
                { id: 'studioZip', message: 'Please enter ZIP code' },
                { id: 'primaryColor', message: 'Please select a primary color' },
                { id: 'secondaryColor', message: 'Please select a secondary color' }
            ];

            let hasErrors = false;
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element && !element.value.trim()) {
                    showError(element, field.message);
                    hasErrors = true;
                }
            });

            return !hasErrors;
        }

        // Replace the existing validateOrganization function
        function validateOrganization() {
            let isValid = true;
            let message = [];

            // Check if at least one instructor is added
            if (instructors.length === 0) {
                message.push('at least one instructor');
                isValid = false;
            }

            // Check if at least one studio location is added
            if (studioLocations.length === 0) {
                message.push('at least one studio location');
                isValid = false;
            }

            // Check if at least one season is added
            if (seasons.length === 0) {
                message.push('at least one season');
                isValid = false;
            }

            if (!isValid) {
                alert(`Please add ${message.join(', ')} before proceeding.`);
                return false;
            }

            return true;
        }

        // Add this inside the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Add input event listeners to clear errors when user starts typing
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', function() {
                    this.classList.remove('input-error');
                    const errorMessage = this.nextElementSibling;
                    if (errorMessage && errorMessage.classList.contains('error-message')) {
                        errorMessage.classList.remove('show');
                    }
                });
            });

            // Contact form submit handler
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    // Get the signature
                    const signature = document.getElementById('generatedSignature')?.textContent || '';
                    
                    // Create an object with all the form data including the signature
                    const formData = {
                        contactInfo: {
                            firstName: document.getElementById('firstName')?.value || '',
                            lastName: document.getElementById('lastName')?.value || '',
                            // ... other contact fields
                        },
                        students: students,
                        waiver: {
                            termsAccepted: document.getElementById('termsAccept')?.checked || false,
                            electronicSignature: signature,
                            signatureDate: new Date().toISOString()
                        },
                        payment: {
                            cardName: document.getElementById('cardName')?.value || '',
                            // ... other payment fields (you might want to handle these securely)
                        }
                    };

                    // Here you would send formData to your backend
                    console.log('Form submitted with data:', formData);
                    alert('Registration complete! Thank you for registering your student.');
                });
            }

            // Payment processor radio buttons
            const processorRadios = document.getElementsByName('paymentProcessor');
            processorRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const stripeSetup = document.getElementById('stripeSetup');
                    const squareSetup = document.getElementById('squareSetup');
                    
                    if (stripeSetup) {
                        stripeSetup.style.display = this.value === 'stripe' ? 'block' : 'none';
                    }
                    if (squareSetup) {
                        squareSetup.style.display = this.value === 'square' ? 'block' : 'none';
                    }
                });
            });

            // Set initial CSS variables
            document.documentElement.style.setProperty('--primary-color', '#3DCED7');
            document.documentElement.style.setProperty('--secondary-color', '#3A506B');
            document.documentElement.style.setProperty('--background-color', '#F5F5F5');
            document.documentElement.style.setProperty('--primary-hover', '#36b8c0');
            document.documentElement.style.setProperty('--secondary-hover', '#324660');

            // Initialize the first step as active
            updateProgressSteps(1);

            // Initialize payment processor to Studio Sync
            toggleProcessorFields('studiosync');

            // Check for registration data
            const registrationData = JSON.parse(sessionStorage.getItem('registrationData'));
            if (registrationData) {
                // Pre-fill director information
                document.getElementById('directorFirstName').value = registrationData.ownerName.split(' ')[0];
                document.getElementById('directorLastName').value = registrationData.ownerName.split(' ')[1] || '';
                document.getElementById('directorEmail').value = registrationData.ownerEmail;
                document.getElementById('directorPhone').value = registrationData.ownerPhone;
                
                // Pre-fill studio name
                document.getElementById('studioName').value = registrationData.studioName;
                
                // Clear the registration data from sessionStorage
                sessionStorage.removeItem('registrationData');
            }

            // Check for studioId immediately when page loads
            const studioId = sessionStorage.getItem('studioId');
            console.log('ðŸ” Checking for Studio ID on page load:', studioId || 'Not found');
            
            if (!studioId) {
                console.warn('âš ï¸ No Studio ID found in session storage. User may need to complete registration first.');
            } else {
                console.log('âœ… Found Studio ID:', studioId);
                console.log('ðŸ‘‰ Will use this path for all operations:', `Studios/${studioId}/...`);
            }

            // Initialize other onboarding functionality
            initializeOnboarding();

            // Add event listener for step 1 next button
            const step1NextBtn = document.getElementById('step1NextBtn');
            if (step1NextBtn) {
                step1NextBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('ðŸ‘‰ Step 1 Next button clicked');
                    await handleStep1Next();
                });
                console.log('âœ… Step 1 Next button listener attached');
            } else {
                console.error('âŒ Could not find step1NextBtn element');
            }
        });

        // Add this function for removing the studio logo
        function removeStudioLogo() {
            const logoPreview = document.getElementById('logoPreview');
            const logoInput = document.getElementById('studioLogo');
            logoPreview.style.backgroundImage = '';
            logoPreview.innerHTML = '';
            logoInput.value = '';
        }

        // Add these functions for instructors
        function deleteInstructor(index) {
            if (confirm('Are you sure you want to delete this instructor?')) {
                instructors.splice(index, 1);
                updateInstructorsList();
            }
        }

        function editInstructor(index) {
            const instructor = instructors[index];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Edit Instructor</h2>
                    <form id="editInstructorForm">
                        <label for="editInstructorFirstName">First Name <span class="required-star">*</span></label>
                        <input type="text" id="editInstructorFirstName" value="${instructor.FirstName}" required>
                        
                        <label for="editInstructorLastName">Last Name <span class="required-star">*</span></label>
                        <input type="text" id="editInstructorLastName" value="${instructor.LastName}" required>
                        
                        <label for="editInstructorEmail">Email <span class="required-star">*</span></label>
                        <input type="email" id="editInstructorEmail" value="${instructor.Email}" required>
                        
                        <label for="editInstructorPhone">Phone <span class="required-star">*</span></label>
                        <input type="tel" id="editInstructorPhone" value="${instructor.Phone}" required>
                        
                        <label for="editInstructorPayRate">Pay Rate ($/hour) <span class="required-star">*</span></label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="editInstructorPayRate" min="0" step="0.01" value="${instructor.PayRate}" required>
                        </div>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="saveEditedInstructor(${index})">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEditedInstructor(index) {
            const firstName = document.getElementById('editInstructorFirstName').value;
            const lastName = document.getElementById('editInstructorLastName').value;
            const email = document.getElementById('editInstructorEmail').value;
            const phone = document.getElementById('editInstructorPhone').value;
            const payRate = parseFloat(document.getElementById('editInstructorPayRate').value);

            if (!firstName || !lastName || !email || !phone || !payRate) {
                alert('Please fill in all required fields');
                return;
            }

            instructors[index] = { 
                FirstName: firstName,
                LastName: lastName,
                Email: email,
                Phone: phone,
                PayRate: payRate,
                CreatedAt: instructors[index].CreatedAt,
                UpdatedAt: new Date()
            };
            
            updateInstructorsList();
            closeModal(document.querySelector('.modal .close'));
        }

        // Add these functions for studios
        function deleteStudio(index) {
            if (confirm('Are you sure you want to delete this studio location?')) {
                studioLocations.splice(index, 1);
                updateStudiosList();
            }
        }

        function editStudio(index) {
            const studio = studioLocations[index];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Edit Studio Location</h2>
                    <form id="editStudioForm">
                        <label for="editStudioName">Studio Name <span class="required-star">*</span></label>
                        <input type="text" id="editStudioName" value="${studio.name}" required>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="saveEditedStudio(${index})">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEditedStudio(index) {
            const name = document.getElementById('editStudioName').value;

            if (!name) {
                alert('Please enter a studio name');
                return;
            }

            studioLocations[index] = { name };
            updateStudiosList();
            closeModal(document.querySelector('.modal .close'));
        }

        // Add these functions for seasons
        function deleteSeason(index) {
            if (confirm('Are you sure you want to delete this season?')) {
                seasons.splice(index, 1);
                updateSeasonsList();
            }
        }

        function editSeason(index) {
            const season = seasons[index];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Edit Season</h2>
                    <form id="editSeasonForm">
                        <label for="editSeasonName">Season Name <span class="required-star">*</span></label>
                        <input type="text" id="editSeasonName" value="${season.name}" required>
                        
                        <label for="editSeasonStartDate">Start Date <span class="required-star">*</span></label>
                        <input type="date" id="editSeasonStartDate" value="${season.startDate}" required>
                        
                        <label for="editSeasonEndDate">End Date <span class="required-star">*</span></label>
                        <input type="date" id="editSeasonEndDate" value="${season.endDate}" required>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="saveEditedSeason(${index})">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEditedSeason(index) {
            const name = document.getElementById('editSeasonName').value;
            const startDate = document.getElementById('editSeasonStartDate').value;
            const endDate = document.getElementById('editSeasonEndDate').value;

            if (!name || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                alert('End date must be after start date');
                return;
            }

            seasons[index] = { name, startDate, endDate };
            updateSeasonsList();
            closeModal(document.querySelector('.modal .close'));
        }

        // Add to your existing JavaScript
        document.getElementById('monthlyVolume').addEventListener('input', function(e) {
            // Remove any non-numeric characters except decimal point
            let value = e.target.value.replace(/[^\d.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Format with commas for thousands
            const numParts = value.split('.');
            numParts[0] = numParts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
            e.target.value = numParts.join('.');
        });

    
        // Update the validatePaymentSetup function
        function validatePaymentSetup() {
            clearValidationErrors();
            
            const selectedProcessor = document.querySelector('input[name="paymentProcessor"]:checked');
            if (!selectedProcessor) {
                alert('Please select a payment processor');
                return false;
            }
            
            if (selectedProcessor.value === 'studiosync') {
                const monthlyVolume = document.getElementById('monthlyVolume').value;
                const merchantStatement = document.getElementById('merchantStatement').value;
                
                if (!monthlyVolume) {
                    showError(document.getElementById('monthlyVolume'), 'Please enter estimated monthly volume');
                    return false;
                }
                
                if (!merchantStatement) {
                    showError(document.getElementById('merchantStatement').parentElement, 'Please upload a merchant statement');
                    return false;
                }
            } else if (selectedProcessor.value === 'other') {
                const processorName = document.getElementById('processorName').value;
                const processorContact = document.getElementById('processorContact').value;
                
                if (!processorName || !processorContact) {
                    if (!processorName) showError(document.getElementById('processorName'), 'Please enter processor name');
                    if (!processorContact) showError(document.getElementById('processorContact'), 'Please enter contact information');
                    return false;
                }
            }
            
            return true;
        }

        function toggleProcessorFields(processor) {
            const studiosyncFields = document.getElementById('studiosyncSetup');
            const otherFields = document.getElementById('otherProcessorSetup');
            
            if (processor === 'studiosync') {
                studiosyncFields.style.display = 'block';
                otherFields.style.display = 'none';
            } else if (processor === 'other') {
                studiosyncFields.style.display = 'none';
                otherFields.style.display = 'block';
            }
        }

        // Add to the existing script section
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size should be less than 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('logoPreview');
                preview.innerHTML = `
                    <div class="logo-preview-container">
                        <div class="logo-preview-image" style="background-image: url('${e.target.result}')"></div>
                        <div class="logo-preview-details">
                            <div class="logo-preview-name">${file.name}</div>
                            <div class="logo-preview-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="remove-logo" onclick="removeLogo()">&times;</button>
                    </div>
                `;
                preview.classList.add('show');
            };
            reader.readAsDataURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeLogo() {
            const preview = document.getElementById('logoPreview');
            const input = document.getElementById('studioLogo');
            preview.innerHTML = '';
            preview.classList.remove('show');
            input.value = '';
        }

        // Add to the existing script section
        function handlePolicyUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain'
            ];
            if (!allowedTypes.includes(file.type)) {
                alert('Please upload a PDF, DOC, DOCX, or TXT file');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size should be less than 10MB');
                return;
            }

            const preview = document.getElementById('policyPreview');
            const fileIcon = getFileIcon(file.type);
            
            preview.innerHTML = `
                <div class="logo-preview-container">
                    <i class="file-icon ${fileIcon.class}">${fileIcon.icon}</i>
                    <div class="logo-preview-details">
                        <div class="logo-preview-name">${file.name}</div>
                        <div class="logo-preview-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="remove-logo" onclick="removePolicy()">&times;</button>
                </div>
            `;
            preview.classList.add('show');
        }

        function handleMerchantStatementUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg',
                'image/png',
                'image/gif'
            ];
            
            if (!allowedTypes.includes(file.type) && !file.type.startsWith('image/')) {
                alert('Please upload a PDF, DOC, DOCX, or image file');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size should be less than 10MB');
                return;
            }

            const preview = document.getElementById('merchantStatementPreview');
            
            if (file.type.startsWith('image/')) {
                // Handle image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div class="logo-preview-container">
                            <div class="logo-preview-image" style="background-image: url('${e.target.result}')"></div>
                            <div class="logo-preview-details">
                                <div class="logo-preview-name">${file.name}</div>
                                <div class="logo-preview-size">${formatFileSize(file.size)}</div>
                            </div>
                            <button class="remove-logo" onclick="removeMerchantStatement()">&times;</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                // Handle document preview
                const fileIcon = getFileIcon(file.type);
                preview.innerHTML = `
                    <div class="logo-preview-container">
                        <i class="file-icon ${fileIcon.class}">${fileIcon.icon}</i>
                        <div class="logo-preview-details">
                            <div class="logo-preview-name">${file.name}</div>
                            <div class="logo-preview-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="remove-logo" onclick="removeMerchantStatement()">&times;</button>
                    </div>
                `;
            }
            preview.classList.add('show');
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') {
                return { icon: '<i class="fas fa-file-pdf"></i>', class: 'pdf' };
            } else if (fileType.includes('word')) {
                return { icon: '<i class="fas fa-file-word"></i>', class: 'doc' };
            } else {
                return { icon: '<i class="fas fa-file-alt"></i>', class: 'txt' };
            }
        }

        function removePolicy() {
            const preview = document.getElementById('policyPreview');
            const input = document.getElementById('policyFile');
            preview.innerHTML = '';
            preview.classList.remove('show');
            input.value = '';
        }

        function removeMerchantStatement() {
            const preview = document.getElementById('merchantStatementPreview');
            const input = document.getElementById('merchantStatement');
            preview.innerHTML = '';
            preview.classList.remove('show');
            input.value = '';
        }

        // Add these functions to your script section
        function validatePassword() {
            const password = document.getElementById('directorPassword');
            const confirmPassword = document.getElementById('confirmDirectorPassword');
            
            // Check all requirements
            const hasLength = password.value.length >= 6;
            const hasNumber = /\d/.test(password.value);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password.value);
            const passwordsMatch = password.value && password.value === confirmPassword.value;
            
            const isValid = hasLength && hasNumber && hasSpecial && passwordsMatch;

            // Update styling
            if (password.value) {
                password.classList.toggle('valid-password', isValid);
                password.classList.toggle('invalid-password', !isValid);
            }

            if (confirmPassword.value) {
                confirmPassword.classList.toggle('valid-password', passwordsMatch);
                confirmPassword.classList.toggle('invalid-password', !passwordsMatch);
            }

            // Show/hide requirements
            const requirements = document.querySelector('.password-requirements');
            if (password.value && !isValid) {
                requirements.style.display = 'block';
                updateRequirement('lengthCheck', hasLength);
                updateRequirement('numberCheck', hasNumber);
                updateRequirement('specialCheck', hasSpecial);
                updateRequirement('matchCheck', passwordsMatch);
            } else {
                requirements.style.display = 'none';
            }

            return isValid;
        }

        function updateRequirement(id, isValid) {
            const element = document.getElementById(id);
            element.classList.toggle('met', isValid);
            element.querySelector('i').className = isValid ? 'fas fa-check-circle' : 'fas fa-times-circle';
        }

        // Update the goToStep2 function's password validation
        function goToStep2() {
            clearValidationErrors();
            const password = document.getElementById('directorPassword').value;
            const confirmPassword = document.getElementById('confirmDirectorPassword').value;

            // Show requirements if validation fails
            if (password.length < 6 || !/\d/.test(password) || 
                !/[!@#$%^&*(),.?":{}|<>]/.test(password) || 
                password !== confirmPassword) {
                
                document.querySelector('.password-requirements').style.display = 'block';
                validatePassword(); // This will update all the requirement indicators
                return false;
            }

            // Rest of your goToStep2 validation...
        }

        // Add event listener for confirm password
        document.addEventListener('DOMContentLoaded', function() {
            const confirmPasswordInput = document.getElementById('confirmDirectorPassword');
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('keyup', validatePassword);
            }
        });

        // First, add this to the showAddInstructorModal function
        function showAddInstructorModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Add Instructor</h2>
                    <form id="addInstructorForm">
                        <label for="instructorFirstName">First Name <span class="required-star">*</span></label>
                        <input type="text" id="instructorFirstName" required>
                        
                        <label for="instructorLastName">Last Name <span class="required-star">*</span></label>
                        <input type="text" id="instructorLastName" required>
                        
                        <label for="instructorEmail">Email <span class="required-star">*</span></label>
                        <input type="email" id="instructorEmail" required>
                        
                        <label for="instructorPhone">Phone <span class="required-star">*</span></label>
                        <input type="tel" id="instructorPhone" required>
                        
                        <label for="instructorPayRate">Pay Rate ($/hour) <span class="required-star">*</span></label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="instructorPayRate" min="0" step="0.01" required>
                        </div>

                        <label for="instructorPassword">Temporary Password <span class="required-star">*</span></label>
                        <div class="password-container">
                            <input type="password" id="instructorPassword" required onkeyup="checkInstructorPassword()">
                            <i class="fas fa-eye password-toggle" onclick="togglePassword('instructorPassword')"></i>
                        </div>
                        <div class="password-requirements" style="display: none;">
                            <div class="requirement" id="instructor-length-req">
                                <i class="fas fa-times-circle"></i>
                                At least 8 characters
                            </div>
                            <div class="requirement" id="instructor-uppercase-req">
                                <i class="fas fa-times-circle"></i>
                                At least one uppercase letter
                            </div>
                            <div class="requirement" id="instructor-lowercase-req">
                                <i class="fas fa-times-circle"></i>
                                At least one lowercase letter
                            </div>
                            <div class="requirement" id="instructor-number-req">
                                <i class="fas fa-times-circle"></i>
                                At least one number
                            </div>
                            <div class="requirement" id="instructor-special-req">
                                <i class="fas fa-times-circle"></i>
                                At least one special character
                            </div>
                        </div>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="addInstructor()">Add Instructor</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Add event listener for password validation
            document.getElementById('instructorPassword').addEventListener('input', checkInstructorPassword);
        }

        // Add password validation function for instructors
        function checkInstructorPassword() {
            const password = document.getElementById('instructorPassword').value;
            const requirements = validatePasswordRequirements(password);
            const passwordReqs = document.querySelector('.password-requirements');
            
            if (password.length > 0) {
                passwordReqs.style.display = 'block';
            }

            updateRequirementUI('instructor-length-req', requirements.length);
            updateRequirementUI('instructor-uppercase-req', requirements.upperCase);
            updateRequirementUI('instructor-lowercase-req', requirements.lowerCase);
            updateRequirementUI('instructor-number-req', requirements.number);
            updateRequirementUI('instructor-special-req', requirements.special);
            
            const allRequirementsMet = Object.values(requirements).every(req => req);
            const passwordInput = document.getElementById('instructorPassword');
            
            if (allRequirementsMet) {
                passwordInput.classList.add('valid');
                passwordReqs.style.display = 'none';
            } else {
                passwordInput.classList.remove('valid');
            }

            return allRequirementsMet;
        }

        // Update the addInstructor function
        async function addInstructor() {
            try {
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                const firstName = document.getElementById('instructorFirstName').value;
                const lastName = document.getElementById('instructorLastName').value;
                const email = document.getElementById('instructorEmail').value;
                const phone = document.getElementById('instructorPhone').value;
                const payRate = document.getElementById('instructorPayRate').value;
                const password = document.getElementById('instructorPassword').value;

                if (!firstName || !lastName || !email || !phone || !payRate || !password) {
                    alert('Please fill in all required fields');
                    loadingOverlay.style.display = 'none';
                    return;
                }

                // Validate password
                if (!checkInstructorPassword()) {
                    alert('Please ensure the password meets all requirements');
                    loadingOverlay.style.display = 'none';
                    return;
                }

                // Create Firebase Auth user with custom password
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;

                // Get studioId
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                // Add to Firestore
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const batch = firebase.firestore().batch();

                // Add to Instructors subcollection
                const instructorRef = studioRef.collection('Instructors').doc(userId);
                batch.set(instructorRef, {
                    UserId: userId,
                    FirstName: firstName,
                    LastName: lastName,
                    Email: email,
                    Phone: phone,
                    PayRate: parseFloat(payRate),
                    Role: 'Instructor',
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    IsActive: true,
                    TempPassword: password // Use custom password instead of generated one
                });

                // Add to Users subcollection
                const userRef = studioRef.collection('Users').doc(userId);
                batch.set(userRef, {
                    UserId: userId,
                    FirstName: firstName,
                    LastName: lastName,
                    Email: email,
                    Phone: phone,
                    Role: 'Instructor',
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    IsActive: true
                });

                // Commit the batch
                await batch.commit();

                // Add to local array for UI updates
                instructors.push({ 
                    UserId: userId,
                    FirstName: firstName,
                    LastName: lastName,
                    Email: email,
                    Phone: phone,
                    PayRate: parseFloat(payRate),
                    Role: 'Instructor',
                    CreatedAt: new Date(),
                    UpdatedAt: new Date(),
                    IsActive: true
                });
                
                updateInstructorsList();
                
                // Close modal
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.remove();
                }

                loadingOverlay.style.display = 'none';
                console.log('âœ… Instructor account created successfully');
                alert(`Instructor account created successfully!\nTemporary password: ${password}\nPlease share these credentials with the instructor.`);

            } catch (error) {
                console.error('âŒ Error adding instructor:', error);
                alert(`Failed to add instructor: ${error.message}`);
                loadingOverlay.style.display = 'none';
            }
        }

        // Update the updateInstructorsList function
        function updateInstructorsList() {
            const listContainer = document.getElementById('instructorsList');
            if (instructors.length === 0) {
                listContainer.innerHTML = '<div class="no-items">No instructors added yet</div>';
                return;
            }

            listContainer.innerHTML = instructors.map((instructor, index) => `
                <div class="list-item">
                    <div class="item-info">
                        <strong>${instructor.FirstName} ${instructor.LastName}</strong><br>
                        ${instructor.Email}<br>
                        ${instructor.Phone}<br>
                        <span class="pay-rate">Pay Rate: $${instructor.PayRate.toFixed(2)}/hour</span>
                    </div>
                    <div class="item-actions">
                        <button onclick="editInstructor(${index})">Edit</button>
                        <button onclick="deleteInstructor(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Update the editInstructor function
        function editInstructor(index) {
            const instructor = instructors[index];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Edit Instructor</h2>
                    <form id="editInstructorForm">
                        <label for="editInstructorFirstName">First Name <span class="required-star">*</span></label>
                        <input type="text" id="editInstructorFirstName" value="${instructor.FirstName}" required>
                        
                        <label for="editInstructorLastName">Last Name <span class="required-star">*</span></label>
                        <input type="text" id="editInstructorLastName" value="${instructor.LastName}" required>
                        
                        <label for="editInstructorEmail">Email <span class="required-star">*</span></label>
                        <input type="email" id="editInstructorEmail" value="${instructor.Email}" required>
                        
                        <label for="editInstructorPhone">Phone <span class="required-star">*</span></label>
                        <input type="tel" id="editInstructorPhone" value="${instructor.Phone}" required>
                        
                        <label for="editInstructorPayRate">Pay Rate ($/hour) <span class="required-star">*</span></label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="editInstructorPayRate" min="0" step="0.01" value="${instructor.PayRate}" required>
                        </div>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="saveEditedInstructor(${index})">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Update the saveEditedInstructor function
        function saveEditedInstructor(index) {
            const firstName = document.getElementById('editInstructorFirstName').value;
            const lastName = document.getElementById('editInstructorLastName').value;
            const email = document.getElementById('editInstructorEmail').value;
            const phone = document.getElementById('editInstructorPhone').value;
            const payRate = parseFloat(document.getElementById('editInstructorPayRate').value);

            if (!firstName || !lastName || !email || !phone || !payRate) {
                alert('Please fill in all required fields');
                return;
            }

            instructors[index] = { 
                FirstName: firstName,
                LastName: lastName,
                Email: email,
                Phone: phone,
                PayRate: payRate,
                CreatedAt: instructors[index].CreatedAt,
                UpdatedAt: new Date()
            };
            
            updateInstructorsList();
            closeModal(document.querySelector('.modal .close'));
        }

        // Add this function to handle the final step
        async function completeOnboarding() {
            try {
                // ... all existing onboarding steps ...

                // Hide loading overlay
                loadingOverlay.style.display = 'none';

                // Clear session storage
                sessionStorage.clear();

                // Sign out the authenticated user
                await firebase.auth().signOut();
                console.log('âœ… User signed out successfully');

                // Redirect to studio login
                window.location.href = '/studiologin.html';

            } catch (error) {
                console.error('âŒ Error completing setup:', error);
                loadingOverlay.style.display = 'none';
                alert(`Failed to complete setup: ${error.message}`);
            }
        }

        // Add validation function for director info
        function validateDirectorInfo(data) {
            if (!data.firstName || !data.lastName || !data.email || !data.phone) {
                alert('Please fill in all required fields');
                return false;
            }

            if (data.password !== data.confirmPassword) {
                alert('Passwords do not match');
                return false;
            }

            // Add any additional validation as needed
            return true;
        }

        // Add these functions for Studio Locations
        function showAddStudioModal() {
            const modal = document.getElementById('addStudioModal');
            if (!modal) return; // Guard clause in case modal doesn't exist
            
            modal.classList.add('show'); // Use class to show modal
            updateColorPreview(document.getElementById('studioRoomColor').value);
        }

        // Update the closeAddStudioModal function
        function closeAddStudioModal() {
            const modal = document.getElementById('addStudioModal');
            if (!modal) return;
            
            modal.classList.remove('show'); // Remove class instead of changing display
        }

        // Add this to your DOMContentLoaded event listener to ensure modals are hidden on page load
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing initialization code ...

            // Hide all modals on page load
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('show');
            });
        });

        // Add these functions for Seasons
        function showAddSeasonModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Add Season</h2>
                    <form id="addSeasonForm">
                        <label for="seasonName">Season Name <span class="required-star">*</span></label>
                        <input type="text" id="seasonName" required>
                        
                        <label for="seasonStartDate">Start Date <span class="required-star">*</span></label>
                        <input type="date" id="seasonStartDate" required>
                        
                        <label for="seasonEndDate">End Date <span class="required-star">*</span></label>
                        <input type="date" id="seasonEndDate" required>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="addSeason()">Add Season</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Add functions to handle adding locations and seasons
        function addStudioRoom() {
            const roomName = document.getElementById('roomName').value;

            if (!roomName) {
                alert('Please fill in all required fields');
                return;
            }

            studioLocations.push({ 
                name: roomName,
                createdAt: new Date()
            });
            
            updateStudiosList();
            
            // Close modal directly
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
            }
        }

        function addSeason() {
            const seasonData = {
                name: document.getElementById('seasonName').value,
                startDate: document.getElementById('seasonStartDate').value,
                endDate: document.getElementById('seasonEndDate').value
            };

            if (!seasonData.name || !seasonData.startDate || !seasonData.endDate) {
                alert('Please fill in all required fields');
                return;
            }

            if (new Date(seasonData.startDate) >= new Date(seasonData.endDate)) {
                alert('End date must be after start date');
                return;
            }

            seasons.push(seasonData);
            updateSeasonsList();
            // Close the modal directly
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
            }
        }


        function updateSeasonsList() {
            const listContainer = document.getElementById('seasonsList');
            if (seasons.length === 0) {
                listContainer.innerHTML = '<div class="no-items">No seasons added yet</div>';
                return;
            }

            listContainer.innerHTML = seasons.map((season, index) => `
                <div class="list-item">
                    <div class="item-info">
                        <strong>${season.name}</strong><br>
                        ${new Date(season.startDate).toLocaleDateString()} - 
                        ${new Date(season.endDate).toLocaleDateString()}
                    </div>
                    <div class="item-actions">
                        <button onclick="editSeason(${index})">Edit</button>
                        <button onclick="deleteSeason(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Handle Step 1 completion
        async function handleStep1Completion() {
            try {
                console.log('ðŸš€ Starting Step 1 processing...');
                const directorData = JSON.parse(sessionStorage.getItem('directorData'));
                
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found from registration');
                }
                console.log('ðŸ‘‰ Found Studio ID from registration:', studioId);

                let userId;
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    console.log('âœ… User already authenticated:', currentUser.email);
                    userId = currentUser.uid;
                } else {
                    try {
                        console.log('ðŸ‘‰ Creating new Firebase user...');
                        const newUserCredential = await firebase.auth().createUserWithEmailAndPassword(
                            directorData.email,
                            directorData.password
                        );
                        userId = newUserCredential.user.uid;
                        console.log('âœ… New Firebase user created with ID:', userId);
                    } catch (authError) {
                        console.error('âŒ Error creating user:', authError);
                        throw authError;
                    }
                }

                // Create director in the Users subcollection of the registered studio
                console.log('ðŸ‘‰ Creating director in studio Users subcollection...');
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const directorDoc = studioRef.collection('Users').doc(userId);

                await directorDoc.set({
                    FirstName: directorData.firstName,
                    LastName: directorData.lastName,
                    Email: directorData.email,
                    Phone: directorData.phone,
                    Role: 'Director',
                    StudioId: studioId,  // Use the studio ID from registration
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('âœ… Director document created at:', `Studios/${studioId}/Users/${userId}`);
                
                // Store IDs for next steps
                sessionStorage.setItem('userId', userId);
                
                // Move to next step
                goToStep2();
                console.log('âœ… Step 1 completed successfully');

            } catch (error) {
                console.error('âŒ Error in Step 1:', error);
                alert(`Failed to complete Step 1: ${error.message}`);
            }
        }

        // Add this function to store director data
        function storeDirectorData() {
            const directorData = {
                firstName: document.getElementById('directorFirstName').value,
                lastName: document.getElementById('directorLastName').value,
                email: document.getElementById('directorEmail').value,
                phone: document.getElementById('directorPhone').value,
                password: document.getElementById('directorPassword').value  // Store actual password
            };
            
            console.log('ðŸ’¾ Storing director data:', {
                ...directorData,
                password: '***'  // Only hide in logs, not in stored data
            });

            sessionStorage.setItem('directorData', JSON.stringify(directorData));
        }

        // Replace both handleStep1Completion and handleStep1Next with this single function
        async function handleStep1Next() {
            try {
                console.log(' Processing Step 1: Studio Details');
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                // Get all input values
                const studioData = {
                    StudioName: document.getElementById('studioName').value.trim(),
                    StudioAddress1: document.getElementById('studioAddress1').value.trim(),
                    StudioAddress2: document.getElementById('studioAddress2').value.trim() || null,
                    StudioCity: document.getElementById('studioCity').value.trim(),
                    StudioState: document.getElementById('studioState').value,
                    StudioZip: document.getElementById('studioZip').value.trim(),
                    PrimaryColor: document.getElementById('primaryColor').value,
                    SecondaryColor: document.getElementById('secondaryColor').value,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Validate required fields
                const requiredFields = ['StudioName', 'StudioAddress1', 'StudioCity', 'StudioState', 'StudioZip'];
                const missingFields = requiredFields.filter(field => !studioData[field]);
                if (missingFields.length > 0) {
                    throw new Error(`Please fill in all required fields: ${missingFields.join(', ')}`);
                }

                // Handle logo upload if exists
                const logoInput = document.getElementById('studioLogo');
                if (logoInput.files.length > 0) {
                    const logoFile = logoInput.files[0];
                    console.log('ðŸ“¤ Uploading studio logo...');
                    
                    // Create storage reference
                    const storageRef = firebase.storage().ref();
                    const logoRef = storageRef.child(`StudioLogos/${studioId}/${logoFile.name}`);
                    
                    // Upload logo
                    const snapshot = await logoRef.put(logoFile);
                    const logoUrl = await snapshot.ref.getDownloadURL();
                    
                    // Add logo URL to studio data
                    studioData.LogoUrl = logoUrl;
                    console.log('âœ… Logo uploaded successfully');
                }

                // Update studio document
                console.log('ðŸ“ Updating studio document...');
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                await studioRef.update(studioData);

                console.log('âœ… Studio details saved successfully');
                loadingOverlay.style.display = 'none';

                // Move to step 2
                hideAllSteps();
                const step2 = document.getElementById('step2');
                step2.classList.add('active');
                step2.style.cssText = 'display: block !important';
                currentStepNumber = 2;
                updateProgressSteps(2);

            } catch (error) {
                console.error('âŒ Error in Step 1:', error);
                alert(error.message);
                loadingOverlay.style.display = 'none';
            }
        }

        // Make sure these navigation functions are defined
        function goToStep2() {
            console.log('ðŸ”„ Switching to Step 2');
            // First hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.style.cssText = 'display: none !important';  // Force hide with !important
            });
            
            // Then show step 2
            const step2 = document.getElementById('step2');
            step2.classList.add('active');
            step2.style.cssText = 'display: block !important';  // Force show with !important
            console.log('âœ… Step 2 is now visible');
        }

        function updateProgressSteps(stepNumber) {
            console.log('ðŸ”„ Updating progress steps to:', stepNumber);
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                const stepNum = index + 1;
                
                // Remove all classes first
                indicator.classList.remove('active', 'completed');
                
                if (stepNum === stepNumber) {
                    // Current step
                    indicator.classList.add('active');
                } else if (stepNum < stepNumber) {
                    // Previous completed steps
                    indicator.classList.add('completed');
                }
                // Future steps remain without classes
            });
        }

        // Add these handler functions
        async function handleStep2Next() {
            try {
                console.log('ðŸš€ Processing Step 2: Policies');
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const policyTitle = document.getElementById('policyTitle').value.trim();
                const policyContent = document.getElementById('policyContent').value.trim();

                // Validate required fields
                if (!policyTitle || !policyContent) {
                    alert('Please fill in both policy title and content');
                    loadingOverlay.style.display = 'none';
                    return;
                }

                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                
                // Write to Policies subcollection using Pascal Case
                await studioRef.collection('Policies').add({
                    Title: policyTitle,
                    Content: policyContent,
                    Type: 'General',
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    IsActive: true
                });

                console.log('âœ… Policy saved successfully');
                loadingOverlay.style.display = 'none';

                // Move to step 3
                hideAllSteps();
                const step3 = document.getElementById('step3');
                step3.classList.add('active');
                step3.style.cssText = 'display: block !important';
                currentStepNumber = 3;
                updateProgressSteps(3);

            } catch (error) {
                console.error('âŒ Error in Step 2:', error);
                alert(`Failed to save policies: ${error.message}`);
                loadingOverlay.style.display = 'none';
            }
        }

        // Step 3 Handler 
        async function handleStep3Next() {
            try {
                console.log('ðŸš€ Starting Step 3 processing...');
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                // Get studioId
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const batch = firebase.firestore().batch();

                // Add Instructors
                console.log('ðŸ“ Adding instructors...');
                for (const instructor of instructors) {
                    // Use the instructor's UserId as the document ID
                    const instructorRef = studioRef.collection('Instructors').doc(instructor.UserId);
                    batch.set(instructorRef, {
                        FirstName: instructor.FirstName,
                        LastName: instructor.LastName,
                        Email: instructor.Email,
                        Phone: instructor.Phone,
                        PayRate: instructor.PayRate,
                        Role: 'Instructor',
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        IsActive: true
                    });

                    // Also add to Users collection
                    const userRef = studioRef.collection('Users').doc(instructor.UserId);
                    batch.set(userRef, {
                        FirstName: instructor.FirstName,
                        LastName: instructor.LastName,
                        Email: instructor.Email,
                        Phone: instructor.Phone,
                        Role: 'Instructor',
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        IsActive: true
                    });
                }

                // Add Studio Rooms
                console.log('ðŸ“ Adding studio rooms...');
                for (const room of studioLocations) {
                    const roomRef = studioRef.collection('StudioRooms').doc();
                    batch.set(roomRef, {
                        Name: room.name,
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        IsActive: true
                    });
                }

                // Add Seasons
                console.log('ðŸ“ Adding seasons...');
                for (const season of seasons) {
                    const seasonRef = studioRef.collection('Seasons').doc();
                    batch.set(seasonRef, {
                        Name: season.name,
                        StartDate: new Date(season.startDate),
                        EndDate: new Date(season.endDate),
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        IsActive: true
                    });
                }

                // Update studio document
                batch.update(studioRef, {
                    OrganizationSetupCompleted: true,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Commit the batch
                await batch.commit();
                console.log('âœ… Organization setup completed successfully');

                // Move to next step
                loadingOverlay.style.display = 'none';
                hideAllSteps();
                document.getElementById('step4').style.cssText = 'display: block !important';
                currentStepNumber = 4;
                updateProgressSteps(4);

            } catch (error) {
                console.error('âŒ Error in organization setup:', error);
                alert('Error saving organization setup: ' + error.message);
                loadingOverlay.style.display = 'none';
            }
        }


        // Step 5 Handler (Payment Processing)
        async function handleStep5Next() {
            try {
                console.log('ðŸš€ Starting Step 5 processing...');
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const monthlyVolume = document.getElementById('monthlyVolume').value;
                if (!monthlyVolume) {
                    throw new Error('Please provide estimated monthly volume');
                }

                try {
                    // Create PaymentProcessing subcollection and save settings
                    console.log('ðŸ“ Creating PaymentProcessing subcollection...');
                    const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                    
                    // Initialize subcollection with both documents
                    await Promise.all([
                        // Create init document
                        studioRef.collection('PaymentProcessing').doc('init').set({
                            Initialized: true,
                            CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }),
                        // Create settings document with monthly volume
                        studioRef.collection('PaymentProcessing').doc('settings').set({
                            MonthlyVolume: parseFloat(monthlyVolume.replace(/[^0-9.]/g, '')),
                            CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                    ]);
                    console.log('âœ… Payment processing info saved to Firestore');

                    // Sign out the user
                    console.log('ðŸ‘‹ Signing out user...');
                    await firebase.auth().signOut();

                    // Store studioId in localStorage for login page
                    localStorage.setItem('onboardingStudioId', studioId);
                    console.log('ðŸ’¾ Studio ID stored for login page');

                    // Hide loading overlay
                    loadingOverlay.style.display = 'none';

                    // Redirect to login page
                    console.log('ðŸ”„ Redirecting to login...');
                    window.location.href = `/studiologin.html?studioId=${studioId}`;

                } catch (error) {
                    console.error('âŒ Error in data save:', error);
                    loadingOverlay.style.display = 'none';
                    throw error;
                }

            } catch (error) {
                console.error('âŒ Error in Step 5:', error);
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'none';
                alert(`Failed to complete Step 5: ${error.message}`);
            }
        }

        // Add this at the very start of your script
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”„ Onboarding page loaded, beginning studioId checks...');
            
            // First try to get studioId from registrationData
            let studioId = null;
            const registrationData = JSON.parse(localStorage.getItem('registrationData'));
            
            console.log('ðŸ“¦ Registration data from localStorage:', registrationData);
            
            if (registrationData?.studioId) {
                studioId = registrationData.studioId;
                console.log('âœ… Found Studio ID in registrationData:', studioId);
            } else {
                console.log('âš ï¸ No studioId in registrationData, checking localStorage directly...');
                
                // Try direct localStorage
                studioId = localStorage.getItem('studioId');
                if (studioId) {
                    console.log('âœ… Found Studio ID in localStorage:', studioId);
                } else {
                    console.log('âš ï¸ No studioId in localStorage, checking sessionStorage...');
                    
                    // Try sessionStorage
                    studioId = sessionStorage.getItem('studioId');
                    if (studioId) {
                        console.log('âœ… Found Studio ID in sessionStorage:', studioId);
                    } else {
                        console.error('âŒ Studio ID not found in any storage location');
                    }
                }
            }
            
            // Update UI immediately when we have the result
            const studioIdDisplay = document.getElementById('studioIdDisplay');
            if (studioIdDisplay) {
                if (!studioId) {
                    console.error('âŒ No Studio ID found to display');
                    studioIdDisplay.textContent = 'Studio ID not found';
                    studioIdDisplay.style.color = '#ff4444';
                } else {
                    console.log('âœ¨ Displaying Studio ID:', studioId);
                    studioIdDisplay.textContent = studioId;
                    studioIdDisplay.style.color = '#3DCED7';
                }
            } else {
                console.error('âŒ Could not find studioIdDisplay element');
            }

            // Rest of your initialization code...
        });

        // Update the initializeOnboarding function
        function initializeOnboarding() {
            const studioId = sessionStorage.getItem('studioId');
            console.log('ðŸ”„ Initializing onboarding with Studio ID:', studioId);

            updateProgressSteps(1);
            toggleProcessorFields('studiosync');
            
            // Check for registration data
            const registrationData = JSON.parse(sessionStorage.getItem('registrationData'));
            if (registrationData) {
                console.log('ðŸ“ Found registration data:', registrationData);
                
                // Pre-fill director information
                document.getElementById('directorFirstName').value = registrationData.ownerName.split(' ')[0];
                document.getElementById('directorLastName').value = registrationData.ownerName.split(' ')[1] || '';
                document.getElementById('directorEmail').value = registrationData.ownerEmail;
                document.getElementById('directorPhone').value = registrationData.ownerPhone;
                
                // Pre-fill studio name
                document.getElementById('studioName').value = registrationData.studioName;
            }
        }

        // Keep only this validateStep4 function near the top
        function validateStep4() {
            return true; // Always valid, since all fields are optional
        }

        // Add this function back since it's needed by skipStep
        function setCurrentStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= TOTAL_STEPS) {
                currentStepNumber = stepNumber;
                hideAllSteps();
                const nextStep = document.getElementById(`step${stepNumber}`);
                if (nextStep) {
                    nextStep.style.cssText = 'display: block !important';
                }
            }
        }

        // Add this function to initialize step navigation
        function initializeStepNavigation() {
            // Set initial step
            currentStepNumber = 1;
            
            // Hide all steps except the first one
            document.querySelectorAll('.step').forEach((step, index) => {
                if (index === 0) {
                    step.classList.add('active');
                    step.style.cssText = 'display: block !important';
                } else {
                    step.classList.remove('active');
                    step.style.cssText = 'display: none !important';
                }
            });

            // Update progress indicators
            updateProgressSteps(1);

            // Add back button event listeners (except for step 1)
            document.querySelectorAll('.back-btn').forEach(button => {
                button.addEventListener('click', goToPreviousStep);
            });
        }

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Initialize step navigation
            initializeStepNavigation();
        });

        // Add these helper functions
        function showPasswordVerificationModal(directorData, studioId) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Existing Account Found</h2>
                    <p>This email is already registered as the Owner account.</p>
                    <div class="password-verify-section">
                        <label for="verifyPassword">Please verify your existing password:</label>
                        <div class="password-container">
                            <input type="password" id="verifyPassword" placeholder="Enter existing password">
                            <i class="fas fa-eye password-toggle" onclick="togglePassword('verifyPassword')"></i>
                        </div>
                        <div class="button-container">
                            <button onclick="verifyAndProceed('${studioId}')">Verify & Continue</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function verifyAndProceed(studioId) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                const password = document.getElementById('verifyPassword').value;
                const email = document.getElementById('directorEmail').value;

                // Verify password by attempting to sign in
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                
                // Get reference to studio's Users collection
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                
                // Query Users collection to find document with matching email
                const usersQuery = await studioRef.collection('Users')
                    .where('Email', '==', email)
                    .get();

                if (!usersQuery.empty) {
                    // Get the first matching document
                    const userDoc = usersQuery.docs[0];
                    
                    // Update existing document - change Role from Owner to Director
                    await userDoc.ref.update({
                        Role: 'Director',  // Change role from Owner to Director
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log('âœ… Updated user role from Owner to Director');
                } else {
                    console.error('âŒ User document not found for email:', email);
                    throw new Error('User document not found. Please contact support.');
                }

                // Auto fill password fields
                document.getElementById('directorPassword').value = password;
                document.getElementById('confirmDirectorPassword').value = password;

                // Find and remove the modal from the DOM
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.remove();
                }

                // Proceed to next step
                goToStep2();
                updateProgressSteps(2);
                currentStepNumber = 2;

                loadingOverlay.style.display = 'none';
                console.log('âœ… User role changed from Owner to Director');

            } catch (error) {
                loadingOverlay.style.display = 'none';
                console.error('âŒ Error verifying password:', error);
                if (error.code === 'auth/wrong-password') {
                    alert('Incorrect password. Please try again.');
                } else {
                    alert('Error updating user role. Please try again or contact support.');
                }
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Add the director modal HTML after your existing modals
        const directorModal = `
        <div id="addDirectorModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal(this)">&times;</span>
                <h2>Add Director</h2>
                <form id="addDirectorForm">
                    <label for="directorFirstName">First Name <span class="required-star">*</span></label>
                    <input type="text" id="directorFirstName" required>
                    
                    <label for="directorLastName">Last Name <span class="required-star">*</span></label>
                    <input type="text" id="directorLastName" required>
                    
                    <label for="directorEmail">Email <span class="required-star">*</span></label>
                    <input type="email" id="directorEmail" required>
                    
                    <label for="directorPhone">Phone <span class="required-star">*</span></label>
                    <input type="tel" id="directorPhone" required>
                    
                    <label for="directorPassword">Temporary Password <span class="required-star">*</span></label>
                    <div class="password-container">
                        <input type="password" id="directorPassword" required>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('directorPassword')"></i>
                    </div>
                    
                    <div class="button-container">
                        <button type="button" onclick="closeModal(this)">Cancel</button>
                        <button type="button" onclick="addDirector()">Add Director</button>
                    </div>
                </form>
            </div>
        </div>`;

        // Add function to show director modal
        function showAddDirectorModal() {
            const modal = document.createElement('div');
            modal.innerHTML = directorModal;
            document.body.appendChild(modal.firstChild);
            document.getElementById('addDirectorModal').classList.add('show');
        }

        // Add function to create director
        async function addDirector() {
            try {
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                const firstName = document.getElementById('directorFirstName').value;
                const lastName = document.getElementById('directorLastName').value;
                const email = document.getElementById('directorEmail').value;
                const phone = document.getElementById('directorPhone').value;
                const password = document.getElementById('directorPassword').value;

                if (!firstName || !lastName || !email || !phone || !password) {
                    alert('Please fill in all required fields');
                    loadingOverlay.style.display = 'none';
                    return;
                }

                // Create Firebase Auth user
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;

                // Get studioId
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                // Add to Firestore
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const batch = firebase.firestore().batch();

                // Add to Users subcollection
                const userRef = studioRef.collection('Users').doc(userId);
                batch.set(userRef, {
                    UserId: userId,
                    FirstName: firstName,
                    LastName: lastName,
                    Email: email,
                    Phone: phone,
                    Role: 'Director',
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    IsActive: true,
                    TempPassword: password
                });

                // Commit the batch
                await batch.commit();

                // Add to local array for UI updates
                directors.push({ 
                    UserId: userId,
                    FirstName: firstName,
                    LastName: lastName,
                    Email: email,
                    Phone: phone,
                    Role: 'Director',
                    CreatedAt: new Date(),
                    UpdatedAt: new Date(),
                    IsActive: true
                });
                
                updateDirectorsList();
                
                // Close modal
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.remove();
                }

                loadingOverlay.style.display = 'none';
                console.log('âœ… Director account created successfully');
                alert(`Director account created successfully!\nTemporary password: ${password}\nPlease share these credentials with the director.`);

            } catch (error) {
                console.error('âŒ Error adding director:', error);
                alert(`Failed to add director: ${error.message}`);
                loadingOverlay.style.display = 'none';
            }
        }

        // Update the step navigation functions
        function updateProgressSteps(currentStep) {
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                const stepNum = index + 1;
                indicator.classList.remove('active', 'completed');
                
                if (stepNum === currentStep) {
                    indicator.classList.add('active');
                } else if (stepNum < currentStep) {
                    indicator.classList.add('completed');
                }
            });
        }

        // Update skipStep function for new flow
        function skipStep() {
            console.log('Skipping step', currentStepNumber);
            
            // If we're on step 4 and skipping, redirect to studio login
            if (currentStepNumber === 4) {
                try {
                    const studioId = sessionStorage.getItem('studioId');
                    if (!studioId) {
                        throw new Error('Studio ID not found');
                    }

                    // Get studio name from Firestore
                    firebase.firestore().collection('Studios').doc(studioId).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const studioData = doc.data();
                                const studioName = studioData.StudioName;
                                const formattedStudioName = studioName.replace(/[^a-zA-Z0-9]/g, '');
                                
                                console.log('ðŸ”„ Redirecting to studio login page...');
                                window.location.href = `https://studiosyncdance.com/studiologin/${formattedStudioName}/${studioId}`;
                            } else {
                                throw new Error('Studio not found');
                            }
                        })
                        .catch((error) => {
                            console.error('âŒ Error redirecting to studio login:', error);
                            alert('Error redirecting to studio login: ' + error.message);
                        });
                    return;
                } catch (error) {
                    console.error('âŒ Error in skip step:', error);
                    alert('Error skipping step: ' + error.message);
                    return;
                }
            }

            // For other steps, continue with normal skip behavior
            const currentIndicator = document.querySelector(`.step-indicator[data-step="${currentStepNumber}"]`);
            if (currentIndicator) {
                currentIndicator.setAttribute('data-skipped', 'true');
            }

            hideAllSteps();
            currentStepNumber++;
            
            const nextStep = document.getElementById(`step${currentStepNumber}`);
            if (nextStep) {
                nextStep.classList.add('active');
                nextStep.style.cssText = 'display: block !important';
            }
            
            updateProgressSteps(currentStepNumber);
        }

        // Add event listener for the add director button
        document.getElementById('addDirectorBtn').addEventListener('click', showAddDirectorModal);

        // Add this initialization when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - initializing step 1');
            
            // Hide all steps first
            hideAllSteps();
            
            // Show step 1
            const step1 = document.getElementById('step1');
            step1.classList.add('active');
            step1.style.cssText = 'display: block !important';
            
            // Set initial step number
            currentStepNumber = 1;
            
            // Force the first step indicator to be active
            const firstIndicator = document.querySelector('.step-indicator[data-step="1"]');
            if (firstIndicator) {
                firstIndicator.classList.add('active');
            }
        });

        // Update the hideAllSteps function
        function hideAllSteps() {
            console.log('Hiding all steps');
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.style.cssText = 'display: none !important';
            });
            
            // Also clear all form fields when hiding steps
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.value = '';
            });
        }

        // Update the initialization code - place this at the start of your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”„ Page loaded - initializing step 1');
            
            // Initialize step 1 first
            currentStepNumber = 1;
            
            // Explicitly set step 1 indicator as active
            const firstStepIndicator = document.querySelector('.step-indicator[data-step="1"]');
            if (firstStepIndicator) {
                firstStepIndicator.classList.remove('completed'); // Remove any existing classes
                firstStepIndicator.classList.add('active');
                
                // Force the circle to be highlighted
                const circle = firstStepIndicator.querySelector('.step-circle');
                if (circle) {
                    circle.style.backgroundColor = 'var(--primary-color)';
                    circle.style.color = 'white';
                }
                
                // Highlight the label
                const label = firstStepIndicator.querySelector('.step-label');
                if (label) {
                    label.style.color = 'var(--primary-color)';
                }
            }
            
            // Hide all steps first
            hideAllSteps();
            
            // Show step 1
            const step1 = document.getElementById('step1');
            step1.classList.add('active');
            step1.style.cssText = 'display: block !important';
            
            // Force update the progress steps
            updateProgressSteps(1);
            
            console.log('âœ… Step 1 initialization complete');
        });

        // Then add these JavaScript functions to handle the uploads
        async function handleDocumentUpload(event, previewId, folderName) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                alert('Please upload an image or PDF file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size should be less than 5MB');
                return;
            }

            const preview = document.getElementById(previewId);
            
            // Show loading state
            preview.innerHTML = `
                <div class="logo-preview-container">
                    <div class="logo-preview-details">
                        <div class="logo-preview-name">Uploading ${file.name}...</div>
                        <div class="logo-preview-size">${formatFileSize(file.size)}</div>
                    </div>
                </div>
            `;
            preview.classList.add('show');

            try {
                // Get studioId
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) throw new Error('Studio ID not found');

                // Upload to Firebase Storage
                const downloadURL = await uploadDocument(file, studioId, folderName);
                console.log(`âœ… ${folderName} uploaded successfully:`, downloadURL);

                // Update preview with success state
                preview.innerHTML = `
                    <div class="logo-preview-container">
                        ${file.type.startsWith('image/') 
                            ? `<div class="logo-preview-image" style="background-image: url('${downloadURL}')"></div>`
                            : `<i class="file-icon fas fa-file-pdf"></i>`
                        }
                        <div class="logo-preview-details">
                            <div class="logo-preview-name">${file.name}</div>
                            <div class="logo-preview-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="remove-logo" onclick="removeDocument('${previewId}', '${event.target.id}', '${studioId}', '${folderName}')">&times;</button>
                    </div>
                `;

            } catch (error) {
                console.error(`âŒ Error uploading ${folderName}:`, error);
                preview.innerHTML = `
                    <div class="logo-preview-container error">
                        <div class="logo-preview-details">
                            <div class="logo-preview-name">Error uploading ${file.name}</div>
                            <div class="logo-preview-size">${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }

        async function uploadDocument(file, studioId, folderName) {
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`${folderName}/${studioId}/${file.name}`);
            const snapshot = await fileRef.put(file);
            return await snapshot.ref.getDownloadURL();
        }

        async function removeDocument(previewId, inputId, studioId, folderName) {
            try {
                // Clear the file input
                const input = document.getElementById(inputId);
                input.value = '';

                // Clear the preview
                const preview = document.getElementById(previewId);
                preview.innerHTML = '';
                preview.classList.remove('show');

                // Remove from Firebase Storage if needed
                const storageRef = firebase.storage().ref();
                const fileRef = storageRef.child(`${folderName}/${studioId}`);
                await fileRef.delete();
                
                console.log(`âœ… ${folderName} removed successfully`);
            } catch (error) {
                console.error(`âŒ Error removing ${folderName}:`, error);
                alert(`Error removing file: ${error.message}`);
            }
        }

       

        // Add password validation functions
        function validatePasswordRequirements(password) {
            return {
                length: password.length >= 8,
                upperCase: /[A-Z]/.test(password),
                lowerCase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
        }

        function updateRequirementUI(elementId, isMet) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('i');
            
            if (isMet) {
                element.classList.add('met');
                icon.className = 'fas fa-check-circle';
            } else {
                element.classList.remove('met');
                icon.className = 'fas fa-times-circle';
            }
        }

        function checkDirectorPassword() {
            const password = document.getElementById('directorPassword').value;
            const requirements = validatePasswordRequirements(password);
            const passwordReqs = document.querySelector('.password-requirements');
            
            if (password.length > 0) {
                passwordReqs.style.display = 'block';
            }

            updateRequirementUI('length-req', requirements.length);
            updateRequirementUI('uppercase-req', requirements.upperCase);
            updateRequirementUI('lowercase-req', requirements.lowerCase);
            updateRequirementUI('number-req', requirements.number);
            updateRequirementUI('special-req', requirements.special);
            
            const allRequirementsMet = Object.values(requirements).every(req => req);
            const passwordInput = document.getElementById('directorPassword');
            
            if (allRequirementsMet) {
                passwordInput.classList.add('valid');
                passwordReqs.style.display = 'none';
            } else {
                passwordInput.classList.remove('valid');
            }

            return allRequirementsMet;
        }

        // Update the showAddDirectorModal function
        function showAddDirectorModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Add Director</h2>
                    <form id="addDirectorForm">
                        <label for="directorFirstName">First Name <span class="required-star">*</span></label>
                        <input type="text" id="directorFirstName" required>
                        
                        <label for="directorLastName">Last Name <span class="required-star">*</span></label>
                        <input type="text" id="directorLastName" required>
                        
                        <label for="directorEmail">Email <span class="required-star">*</span></label>
                        <input type="email" id="directorEmail" required>
                        
                        <label for="directorPhone">Phone <span class="required-star">*</span></label>
                        <input type="tel" id="directorPhone" required>
                        
                        <label for="directorPassword">Temporary Password <span class="required-star">*</span></label>
                        <div class="password-container">
                            <input type="password" id="directorPassword" required>
                            <i class="fas fa-eye password-toggle" onclick="togglePassword('directorPassword')"></i>
                        </div>
                        <div class="password-requirements" style="display: none;">
                            <div class="requirement" id="length-req">
                                <i class="fas fa-times-circle"></i>
                                At least 8 characters
                            </div>
                            <div class="requirement" id="uppercase-req">
                                <i class="fas fa-times-circle"></i>
                                At least one uppercase letter
                            </div>
                            <div class="requirement" id="lowercase-req">
                                <i class="fas fa-times-circle"></i>
                                At least one lowercase letter
                            </div>
                            <div class="requirement" id="number-req">
                                <i class="fas fa-times-circle"></i>
                                At least one number
                            </div>
                            <div class="requirement" id="special-req">
                                <i class="fas fa-times-circle"></i>
                                At least one special character
                            </div>
                        </div>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="submit" class="add-director-btn">Add Director</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Add event listener to the form
            const form = modal.querySelector('#addDirectorForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await addDirector();
            });
        }

        // Add the updateDirectorsList function
        function updateDirectorsList() {
            const listContainer = document.getElementById('directorsList');
            if (directors.length === 0) {
                listContainer.innerHTML = '<div class="no-items">No additional directors added yet</div>';
                return;
            }

            listContainer.innerHTML = directors.map((director, index) => `
                <div class="list-item">
                    <div class="item-info">
                        <strong>${director.FirstName} ${director.LastName}</strong><br>
                        ${director.Email}<br>
                        ${director.Phone}
                    </div>
                    <div class="item-actions">
                        <button onclick="editDirector(${index})">Edit</button>
                        <button onclick="deleteDirector(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Add these helper functions for directors
        function editDirector(index) {
            const director = directors[index];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeModal(this)">&times;</span>
                    <h2>Edit Director</h2>
                    <form id="editDirectorForm">
                        <label for="editDirectorFirstName">First Name <span class="required-star">*</span></label>
                        <input type="text" id="editDirectorFirstName" value="${director.FirstName}" required>
                        
                        <label for="editDirectorLastName">Last Name <span class="required-star">*</span></label>
                        <input type="text" id="editDirectorLastName" value="${director.LastName}" required>
                        
                        <label for="editDirectorEmail">Email <span class="required-star">*</span></label>
                        <input type="email" id="editDirectorEmail" value="${director.Email}" required>
                        
                        <label for="editDirectorPhone">Phone <span class="required-star">*</span></label>
                        <input type="tel" id="editDirectorPhone" value="${director.Phone}" required>
                        
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="saveEditedDirector(${index})">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveEditedDirector(index) {
            const firstName = document.getElementById('editDirectorFirstName').value;
            const lastName = document.getElementById('editDirectorLastName').value;
            const email = document.getElementById('editDirectorEmail').value;
            const phone = document.getElementById('editDirectorPhone').value;

            if (!firstName || !lastName || !email || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            directors[index] = { 
                FirstName: firstName,
                LastName: lastName,
                Email: email,
                Phone: phone,
                CreatedAt: directors[index].CreatedAt,
                UpdatedAt: new Date()
            };
            
            updateDirectorsList();
            
            // Close modal directly
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
            }
        }

        function deleteDirector(index) {
            if (confirm('Are you sure you want to remove this director?')) {
                directors.splice(index, 1);
                updateDirectorsList();
            }
        }

        // Add the handleStep4Next function
        async function handleStep4Next() {
            try {
                console.log(' Starting Step 4 processing...');
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';

                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const batch = firebase.firestore().batch();

                // Create PaymentProcessing document with auto-generated ID
                const paymentProcessingRef = studioRef.collection('PaymentProcessing').doc();
                
                // Get all input values
                const paymentData = {
                    // Document URLs (if they exist)
                    DriverLicenseFront: document.getElementById('driverLicenseFrontPreview').innerHTML || null,
                    DriverLicenseBack: document.getElementById('driverLicenseBackPreview').innerHTML || null,
                    VoidedCheck: document.getElementById('voidedCheckPreview').innerHTML || null,
                    MerchantStatement: document.getElementById('merchantStatementPreview').innerHTML || null,
                    
                    // Input field values
                    BusinessName: document.getElementById('businessName')?.value || null,
                    BusinessType: document.getElementById('businessType')?.value || null,
                    BusinessPhone: document.getElementById('businessPhone')?.value || null,
                    BusinessEmail: document.getElementById('businessEmail')?.value || null,
                    TaxId: document.getElementById('taxId')?.value || null,
                    BusinessAddress: document.getElementById('businessAddress')?.value || null,
                    BusinessCity: document.getElementById('businessCity')?.value || null,
                    BusinessState: document.getElementById('businessState')?.value || null,
                    BusinessZip: document.getElementById('businessZip')?.value || null,
                    
                    // Bank Information
                    BankName: document.getElementById('bankName')?.value || null,
                    AccountNumber: document.getElementById('accountNumber')?.value || null,
                    RoutingNumber: document.getElementById('routingNumber')?.value || null,
                    AccountType: document.getElementById('accountType')?.value || null,
                    
                    // Owner Information
                    OwnerName: document.getElementById('ownerName')?.value || null,
                    OwnerTitle: document.getElementById('ownerTitle')?.value || null,
                    OwnerDob: document.getElementById('ownerDob')?.value || null,
                    OwnerSsn: document.getElementById('ownerSsn')?.value || null,
                    OwnerAddress: document.getElementById('ownerAddress')?.value || null,
                    OwnerCity: document.getElementById('ownerCity')?.value || null,
                    OwnerState: document.getElementById('ownerState')?.value || null,
                    OwnerZip: document.getElementById('ownerZip')?.value || null,
                    
                    // Timestamps
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    IsActive: true
                };

                // Add to PaymentProcessing subcollection
                batch.set(paymentProcessingRef, paymentData);

                // Update studio document to mark documents step as complete
                batch.update(studioRef, {
                    DocumentsSetupCompleted: true,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                console.log('âœ… Payment processing setup completed successfully');

                // Get studio name and redirect
                const studioDoc = await studioRef.get();
                const studioData = studioDoc.data();
                const studioName = studioData.StudioName;
                const formattedStudioName = studioName.replace(/[^a-zA-Z0-9]/g, '');
                const redirectUrl = `https://studiosyncdance.com/studiologin/${formattedStudioName}/${studioId}`;
                
                console.log('ðŸ”„ Redirecting to:', redirectUrl);
                window.location.href = redirectUrl;

            } catch (error) {
                console.error('âŒ Error in payment processing setup:', error);
                alert('Error saving payment processing information: ' + error.message);
                loadingOverlay.style.display = 'none';
            }
        }

        // Update the uploadDocument function to handle any document type
        async function uploadDocument(file, studioId, folderName) {
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`${folderName}/${studioId}/${file.name}`);
            const snapshot = await fileRef.put(file);
            return await snapshot.ref.getDownloadURL();
        }

        // Show add studio modal
        function showAddStudioModal() {
            const modal = document.getElementById('addStudioModal');
            if (!modal) return; // Guard clause in case modal doesn't exist
            
            modal.classList.add('show'); // Use class to show modal
            updateColorPreview(document.getElementById('studioRoomColor').value);
        }

        // Close add studio modal
        function closeAddStudioModal() {
            const modal = document.getElementById('addStudioModal');
            if (!modal) return;
            
            modal.classList.remove('show'); // Remove class instead of changing display
        }

        // Update color preview
        function updateColorPreview(color) {
            const hexValue = document.getElementById('colorHexValue');
            hexValue.textContent = color;
        }

        // Add event listener for color picker
        document.getElementById('studioRoomColor').addEventListener('input', (e) => {
            updateColorPreview(e.target.value);
        });

        // Save studio room
        async function saveStudioRoom() {
            const name = document.getElementById('studioRoomName').value;
            const color = document.getElementById('studioRoomColor').value;

            if (!name) {
                alert('Please enter a room name');
                return;
            }

            try {
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const studioRoomRef = studioRef.collection('StudioRooms').doc();

                await studioRoomRef.set({
                    Name: name,
                    Color: color,
                    IsActive: true,
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeAddStudioModal();
                await updateStudiosList(); // Update the UI
            } catch (error) {
                console.error('Error saving studio room:', error);
                alert('Error saving studio room: ' + error.message);
            }
        }

        // Add this function to update the UI with studio rooms
        async function updateStudiosList() {
            try {
                const studioId = sessionStorage.getItem('studioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const roomsSnapshot = await studioRef.collection('StudioRooms').get();
                
                const roomsList = document.getElementById('studioRoomsList');
                roomsList.innerHTML = ''; // Clear existing rooms

                if (roomsSnapshot.empty) {
                    roomsList.innerHTML = '<div class="no-items">No rooms added yet</div>';
                    return;
                }

                roomsSnapshot.forEach((doc) => {
                    const room = doc.data();
                    const roomElement = document.createElement('div');
                    roomElement.className = 'list-item';
                    roomElement.innerHTML = `
                        <div class="item-info">
                            <strong>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="room-color-circle" style="background-color: ${room.Color}; width: 20px; height: 20px; border-radius: 50%;"></div>
                                    ${room.Name}
                                </div>
                            </strong>
                        </div>
                        <div class="item-actions">
                            <button onclick="editStudioRoom('${doc.id}')" style="background-color: var(--primary-color);">Edit</button>
                            <button onclick="deleteStudioRoom('${doc.id}')" style="background-color: var(--primary-color);">Delete</button>
                        </div>
                    `;
                    roomsList.appendChild(roomElement);
                });
            } catch (error) {
                console.error('Error updating studios list:', error);
            }
        }

        // Add these functions for edit and delete functionality
        async function editStudioRoom(roomId) {
            try {
                const studioId = sessionStorage.getItem('studioId');
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                const roomDoc = await studioRef.collection('StudioRooms').doc(roomId).get();
                const room = roomDoc.data();

                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="closeModal(this)">&times;</span>
                        <h2>Edit Studio Room</h2>
                        <div class="form-group">
                            <label for="editRoomName">Room Name <span class="required-star">*</span></label>
                            <input type="text" id="editRoomName" value="${room.Name}" required>
                            
                            <label for="editRoomColor">Room Color <span class="required-star">*</span></label>
                            <div class="color-picker-group">
                                <input type="color" id="editRoomColor" value="${room.Color}">
                                <span class="color-hex" id="editColorHexValue">${room.Color}</span>
                            </div>
                        </div>
                        <div class="button-container">
                            <button type="button" onclick="closeModal(this)">Cancel</button>
                            <button type="button" onclick="saveEditedRoom('${roomId}')" style="background-color: var(--primary-color);">Save Changes</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Add color picker event listener
                document.getElementById('editRoomColor').addEventListener('input', (e) => {
                    document.getElementById('editColorHexValue').textContent = e.target.value;
                });

            } catch (error) {
                console.error('Error editing studio room:', error);
                alert('Error editing studio room: ' + error.message);
            }
        }

        // Update the saveEditedRoom function
        async function saveEditedRoom(roomId) {
            try {
                const name = document.getElementById('editRoomName').value;
                const color = document.getElementById('editRoomColor').value;

                if (!name) {
                    alert('Please enter a room name');
                    return;
                }

                const studioId = sessionStorage.getItem('studioId');
                const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                
                // Show loading state
                const saveButton = document.querySelector(`button[onclick="saveEditedRoom('${roomId}')"]`);
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saving...';
                }

                // Update in Firestore
                await studioRef.collection('StudioRooms').doc(roomId).update({
                    Name: name,
                    Color: color,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Close modal first
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.remove();
                }

                // Then update the UI
                await updateStudiosList();
                
                console.log('âœ… Studio room updated successfully');

            } catch (error) {
                console.error('âŒ Error saving studio room:', error);
                alert('Error saving studio room: ' + error.message);
                
                // Re-enable save button if there's an error
                const saveButton = document.querySelector(`button[onclick="saveEditedRoom('${roomId}')"]`);
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            }
        }

        // Add or update the closeModal function
        function closeModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Add back the deleteStudioRoom function
        async function deleteStudioRoom(roomId) {
            if (confirm('Are you sure you want to delete this room?')) {
                try {
                    const studioId = sessionStorage.getItem('studioId');
                    const studioRef = firebase.firestore().collection('Studios').doc(studioId);
                    
                    // Delete from Firestore
                    await studioRef.collection('StudioRooms').doc(roomId).delete();
                    console.log('âœ… Studio room deleted successfully');
                    
                    // Update UI
                    await updateStudiosList();
                    
                } catch (error) {
                    console.error('âŒ Error deleting studio room:', error);
                    alert('Error deleting studio room: ' + error.message);
                }
            }
        }
    </script>

    <!-- Add this right after the <body> tag -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Creating studio account...</div>
    </div>

    <!-- Add this modal HTML right before the closing </body> tag -->
    <div id="addStudioModal" class="modal">
        <div class="modal-content">
            <h3>Add Studio Room</h3>
            <div class="form-group">
                <label for="studioRoomName">Room Name <span class="required-star">*</span></label>
                <input type="text" id="studioRoomName" required>
                
                <label for="studioRoomColor">Room Color <span class="required-star">*</span></label>
                <div class="color-picker-group">
                    <input type="color" id="studioRoomColor" value="#ff746c">
                    <span class="color-hex" id="colorHexValue">#ff746c</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeAddStudioModal()">Cancel</button>
                <button type="button" class="save-btn" onclick="saveStudioRoom()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add this after the addStudioModal div, but before the closing </body> tag -->
    <div id="studioRoomsList" class="studio-rooms-list">
        <!-- Rooms will be displayed here -->
    </div>
</body>
</html>
