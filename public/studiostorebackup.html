<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Studio Store - Studio Sync</title>
    <!-- Favicon -->
    <link rel="icon" href="assets/ssdancer.svg" type="image/svg+xml">

    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-...+..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <!-- Custom CSS for Modern Styling -->
    <style>
        :root {
            --primary-color: #3DCED7;
            --primary-hover: #36B8C0;
            --secondary-color: #3A506B;
            --primary-color-rgb: 61, 206, 215;  /* Default fallback */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #sidebar-wrapper {
            background-color: var(--primary-color);
            min-height: 100vh;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-heading {
            color: white;
            background-color: var(--primary-color);
            padding: 1.5rem 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .list-group-item {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease, padding 0.3s ease, transform 0.3s ease;
            padding: 1rem 1.5rem;
        }

        .list-group-item:hover,
        .list-group-item-action:focus {
            background-color: var(--primary-hover);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
        }

        .navbar .navbar-nav .nav-link {
            color: #333;
            transition: color 0.3s ease;
        }

        .navbar .navbar-nav .nav-link:hover {
            color: var(--primary-color);
        }

        .container-fluid {
            background-color: #fff;
            color: #525f7f;
            padding: 2rem;
        }

        /* Modernized Dashboard Content */
        .dashboard-insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .dashboard-insights .insight-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
        }

        .insight-box h3 {
            font-size: 1.2rem;
            color: #525f7f;
            margin-bottom: 0.5rem;
        }

        .insight-box p:not(.loading-value) {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin: 0;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .progress-ring {
            margin-top: 20px;
        }

        /* Schedule Table */
        .schedule-table {
            margin-top: 2rem;
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .schedule-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .schedule-table td {
            background-color: #f9f9f9;
        }

        /* New styles for the pie chart and layout */
        .dashboard-container {
            display: flex;
            gap: 1.5rem; /* Match the gap of dashboard-insights */
        }

        .pie-chart-container {
            flex: 0.7;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: calc(100% - 3rem);
            min-height: 400px;
            transition: box-shadow 0.3s ease;
            min-width: 250px;
        }

        .pie-chart-container:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .chart-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            max-height: 350px;
            min-height: 200px;
            width: 100%;
            aspect-ratio: 1;
        }

        .kpi-container {
            flex: 2;
        }

        .dashboard-insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            height: 100%;
        }

        .insight-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Payment form styles */
        #payment-form {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #card-element {
            margin-bottom: 20px;
        }

        #submit-payment {
            background-color: #3DCED7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #submit-payment:hover {
            background-color: #36B8C0;
        }

        #submit-payment:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Subscription form styles */
        .subscription-form {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .subscription-form input, .subscription-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .subscription-form button {
            background-color: #3DCED7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .subscription-form button:hover {
            background-color: #36B8C0;
        }

        .navbar-nav .dropdown-menu {
            min-width: 250px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 0;
        }

        .navbar-nav .dropdown-item {
            padding: 12px 20px;
            color: #333;
            transition: background-color 0.3s ease;
        }

        .navbar-nav .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .navbar-nav .dropdown-divider {
            margin: 0;
            border-top-color: #e9ecef;
        }

        .navbar-nav .dropdown-header {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            background-color: #f8f9fa;
        }

        .navbar-nav .dropdown-item-text {
            padding: 12px 20px;
            color: #6c757d;
        }

        .fa-user-circle {
            font-size: 1.8em; /* Slightly smaller profile icon */
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            padding: 0.5rem 0.5rem;
        }

        .fa-bell {
            font-size: 1.2em;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 0.6em;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-weight: bold;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
        }

        .notification-icon {
            margin-right: 15px;
            font-size: 1.2em;
            color: #3DCED7;
        }

        .notification-content {
            flex-grow: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .notification-subtitle {
            font-size: 0.85em;
            color: #6c757d;
        }

        .navbar-nav .dropdown-toggle::after {
            display: none;
        }

        @media (max-width: 991.98px) {
            .navbar-brand-center {
                position: static;
                transform: none;
            }

            .navbar-nav {
                flex-direction: row;
            }

            .nav-item.dropdown {
                position: static;
            }

            .dropdown-menu {
                left: 0;
                right: 0;
                width: 100%;
            }
        }

        @media (max-width: 575.98px) {
            .navbar-brand-center {
                max-width: 200px;
                margin: 0 auto;
            }

            #studio-logo, #studio-name {
                max-width: 100%;
            }

            .navbar-nav {
                justify-content: center;
            }
        }

        /* Add styles for the page content wrapper */
        #page-content-wrapper {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
        }

        /* Update the wrapper styles */
        #wrapper {
            display: flex;
            overflow: hidden;
            height: 100vh;
        }

        /* Sidebar overlay styles */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1045;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 768px) {
            #sidebar-wrapper {
                margin-left: -250px;
                transition: margin 0.3s ease-out;
                position: fixed;
                z-index: 1050;
                height: 100vh;
            }

            .sidebar-overlay.show {
                display: block;
            }

            #wrapper.toggled #sidebar-wrapper {
                margin-left: 0;
            }
        }

        /* Wrapper transitions */
        #wrapper.toggled #sidebar-wrapper {
            margin-left: -250px;
        }

        #wrapper.toggled #page-content-wrapper {
            margin-left: 0;
        }

        /* Update the toggle button styles */
        #sidebarToggle {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transition: all 0.3s ease;
        }

        #sidebarToggle:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Update other elements that use the primary color */
        .navbar .navbar-nav .nav-link:hover {
            color: var(--primary-color);
        }

        .insight-box p {
            color: var(--primary-color);
        }

        .schedule-table th {
            background-color: var(--primary-color);
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .loading-content {
            text-align: center;
        }

        .loading-text {
            margin-top: 20px;
        }

        .loading-text h2 {
            color: #ffffff;
            margin-bottom: 10px;
            transition: color 0.5s ease;
        }

        .loading-text p {
            color: #ffffff;
            font-size: 1.1em;
            transition: color 0.5s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ffffff;
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 1s linear infinite;
            transition: border-top-color 0.5s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* User Avatar Styles */
        .user-avatar {
            width: 38px;
            height: 38px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .initials {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Profile Dropdown Styles */
        .dropdown-menu .dropdown-item-text#studioNameDisplay {
            padding: 0.3rem 1.5rem;
            margin: 0;
            color: #333333;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .dropdown-menu .dropdown-item-text#userRole {
            padding: 0.2rem 1.5rem;
            margin: 0;
            color: #666;
            font-size: 0.85rem;
            font-weight: 400;
        }

        /* User Profile Styles */
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.75rem);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            padding: 1rem 0;
            min-width: 280px;
            display: none;
            z-index: 1000;
            border: 1px solid rgba(0,0,0,0.08);
            position: fixed;
            margin-right: 1rem;
        }

        /* Responsive Styles */
        @media (max-width: 1200px) {
            .pie-chart-container {
                flex: 0.5;
            }
            .chart-wrapper {
                max-height: 250px;
            }
        }

        @media (max-width: 991.98px) {
            .dashboard-container {
                flex-direction: column;
            }
            .pie-chart-container {
                width: 100%;
                flex: none;
            }
            .chart-wrapper {
                max-height: 300px;
                margin: 0 auto;
                width: 80%;
            }
        }

        @media (max-width: 768px) {
            .chart-wrapper {
                width: 100%;
                max-height: 250px;
            }
        }

        @media (max-width: 576px) {
            .chart-wrapper {
                max-height: 200px;
            }
        }

        /* Ensure content doesn't overflow on very small devices */
        @media (max-width: 360px) {
            .container-fluid {
                padding: 0.75rem;
            }

            .insight-box {
                padding: 0.75rem;
            }

            .insight-box h3 {
                font-size: 0.9rem;
            }

            .insight-box p {
                font-size: 1.75rem;
            }

            .navbar-brand-center {
                max-width: 120px;
            }

            #studio-name {
                font-size: 1rem;
            }
        }

        /* Replace the shimmer animation styles with spinner styles */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-value {
            position: relative;
            color: transparent !important;
            font-size: 2.5rem;
            margin: 0;
        }

        .loading-value::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 24px;
            height: 24px;
            margin: -12px 0 0 -12px;
            border: 3px solid #a0a0a0;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .schedule-table tr {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .schedule-table tr:hover {
            background-color: rgba(var(--primary-color-rgb), 0.12) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        /* Schedule Table Responsive Styles */
        .schedule-table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-top: 2rem;
            -webkit-overflow-scrolling: touch;
            position: relative;
            background: linear-gradient(to right, white 30%, rgba(255, 255, 255, 0)),
                        linear-gradient(to left, white 30%, rgba(255, 255, 255, 0)) 100% 0;
            background-size: 50px 100%, 50px 100%;
            background-repeat: no-repeat;
            background-attachment: local, local;
        }

        .schedule-table {
            min-width: 900px; /* Minimum width to ensure all columns are visible */
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
        }

        .schedule-table th,
        .schedule-table td {
            white-space: nowrap;
            padding: 12px 15px;
            font-size: 14px;
        }

        .schedule-table th {
            position: sticky;
            top: 0;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            z-index: 1;
        }

        .schedule-table td {
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .schedule-table th,
            .schedule-table td {
                padding: 8px 12px;
                font-size: 13px;
            }

            h2 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            .schedule-table-wrapper {
                margin-top: 1rem;
                border: 1px solid #eee;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            /* Add subtle scroll indication */
            .schedule-table-wrapper::after {
                content: '→';
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--primary-color);
                font-size: 20px;
                animation: scrollIndication 1.5s infinite;
                pointer-events: none;
            }
        }

        /* Scroll indication animation */
        @keyframes scrollIndication {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* Priority-based column display for very small screens */
        @media (max-width: 480px) {
            .schedule-table th,
            .schedule-table td {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Weekend Schedule Table Styles */
        .weekend-schedule-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-top: 2rem;
            -webkit-overflow-scrolling: touch;
            position: relative;
            background: linear-gradient(to right, white 30%, rgba(255, 255, 255, 0)),
                        linear-gradient(to left, white 30%, rgba(255, 255, 255, 0)) 100% 0;
            background-size: 50px 100%, 50px 100%;
            background-repeat: no-repeat;
            background-attachment: local, local;
        }

        #weekendClassesTable {
            width: 100%;
            min-width: 900px;
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
        }

        #weekendClassesTable th,
        #weekendClassesTable td {
            white-space: nowrap;
            padding: 12px 15px;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        #weekendClassesTable th {
            position: sticky;
            top: 0;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            z-index: 1;
        }

        #weekendClassesTable td {
            background-color: #f9f9f9;
        }

        /* Mobile-specific styles for weekend table */
        @media (max-width: 768px) {
            .weekend-schedule-wrapper {
                margin-top: 1rem;
                border: 1px solid #eee;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            #weekendClassesTable th,
            #weekendClassesTable td {
                padding: 8px 12px;
                font-size: 13px;
            }

            /* Add subtle scroll indication */
            .weekend-schedule-wrapper::after {
                content: '→';
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--primary-color);
                font-size: 20px;
                animation: scrollIndication 1.5s infinite;
                pointer-events: none;
                opacity: 0.7;
            }

            /* Optimize column headers for mobile */
            #weekendClassesTable th {
                font-size: 12px;
                padding: 8px 10px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            #weekendClassesTable th,
            #weekendClassesTable td {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Add modern styles for the Recital Manager section */
        .recital-form {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 2rem;
        }

        .recital-form h2 {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .recital-form input,
        .recital-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .recital-form button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .recital-form button:hover {
            background-color: var(--primary-hover);
        }

        #recitalList {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        #recitalList h2 {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        #recitalList table {
            width: 100%;
            border-collapse: collapse;
        }

        #recitalList th,
        #recitalList td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        #recitalList th {
            background-color: var(--primary-color);
            color: white;
        }

        #recitalList td {
            background-color: #f9f9f9;
        }

        #recitalList tr:hover {
            background-color: rgba(var(--primary-color-rgb), 0.12);
        }

        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .section-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 20px;
        }

        /* Tabs Styling */
        .nav-tabs {
            border-bottom: 1px solid #ddd;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: #555;
            padding: 10px 20px;
            transition: color 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        .nav-tabs .nav-link:hover {
            color: #0056b3;
        }

        /* Tab Content Styling */
        .tab-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        /* Product Form Styling */
        .product-form {
            margin-bottom: 20px;
        }

        .product-form input,
        .product-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .product-form button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .product-form button:hover {
            background-color: #0056b3;
        }

        /* Product List Styling */
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-item {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .product-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .product-item-content {
            padding: 15px;
        }

        .product-item h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1rem;
        }

        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .product-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
        }

        .btn-delete {
            background-color: #f8d7da;
            color: #dc3545;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-delete:hover {
            background-color: #f5c2c7;
        }

        .btn-edit {
            background-color: #e2f3f5;
            color: var(--primary-color);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-edit:hover {
            background-color: #d0ebee;
        }

        /* Dashboard Card Styling */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .card-header h3 {
            margin: 0;
        }
        
        .dropdown-toggle::after {
            display: none;
        }

        /* Modern File Upload Styling */
        .file-upload-container {
            width: 100%;
            margin-bottom: 15px;
        }

        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            background-color: #f9f9f9;
            position: relative;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }

        .file-upload-placeholder {
            width: 100%;
        }

        .file-upload-placeholder i {
            font-size: 2.5rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .file-upload-placeholder p {
            margin: 5px 0;
            color: #666;
        }

        .file-upload-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        .file-upload-button:hover {
            background-color: var(--primary-hover);
        }

        .file-preview {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .file-preview-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .file-preview-info span {
            font-size: 0.9rem;
            color: #333;
            max-width: calc(100% - 30px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Add these styles for better product display and loading */
        .loading-products, .no-products, .error-loading {
            text-align: center;
            padding: 30px;
            grid-column: 1 / -1;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .loading-products i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .no-products {
            color: #666;
            font-style: italic;
        }

        .error-loading {
            color: #dc3545;
        }

        /* Improved file upload styles */
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            background-color: #f9f9f9;
            position: relative;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }

        .file-preview {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .file-preview-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .file-preview-info span {
            font-size: 0.9rem;
            color: #333;
            max-width: calc(100% - 30px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-preview-info .btn-close {
            font-size: 0.8rem;
            padding: 0.2rem;
        }

        /* Styles for multiple image upload */
        .images-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            color: #ff4444;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .image-preview-item .remove-image:hover {
            background: #ff4444;
            color: white;
        }

        @media (max-width: 768px) {
            .image-preview-item {
                width: calc(50% - 5px);
            }
        }

        @media (max-width: 480px) {
            .image-preview-item {
                width: 100%;
            }
        }

        /* Store Layout Template Styling */
        .template-selection {
            margin-top: 30px;
        }

        .template-card {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            background-color: white;
            height: 100%;
            position: relative;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .template-card.selected {
            border: 3px solid var(--primary-color);
        }

        .template-preview {
            width: 100%;
            height: 250px;
            overflow: hidden;
            position: relative;
        }

        .template-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .template-card:hover .template-preview img {
            transform: scale(1.05);
        }

        .template-info {
            padding: 20px;
        }

        .template-info h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }

        .template-info p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .template-info ul {
            margin-bottom: 20px;
            padding-left: 20px;
            color: #555;
        }

        .template-info ul li {
            margin-bottom: 5px;
        }

        .template-select-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .template-select-btn:hover {
            background-color: var(--primary-hover);
        }

        .template-select-btn.selected {
            background-color: var(--secondary-color);
        }

        .template-preview-container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .preview-frame {
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            background-color: white;
        }

        @media (max-width: 767px) {
            .template-preview {
                height: 200px;
            }
        }

        /* Template cards with CSS backgrounds instead of external placeholder images */
        .template-selection {
            margin-top: 30px;
        }

        .template-card {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            background-color: white;
            height: 100%;
            position: relative;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .template-card.selected {
            border: 3px solid var(--primary-color);
        }

        .template-preview {
            width: 100%;
            height: 250px;
            overflow: hidden;
            position: relative;
        }

        .template-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .template-card:hover .template-preview img {
            transform: scale(1.05);
        }

        .template-info {
            padding: 20px;
        }

        .template-info h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }

        .template-info p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .template-info ul {
            margin-bottom: 20px;
            padding-left: 20px;
            color: #555;
        }

        .template-info ul li {
            margin-bottom: 5px;
        }

        .template-select-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .template-select-btn:hover {
            background-color: var(--primary-hover);
        }

        .template-select-btn.selected {
            background-color: var(--secondary-color);
        }

        .template-preview-container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .preview-frame {
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            background-color: white;
        }

        @media (max-width: 767px) {
            .template-preview {
                height: 200px;
            }
        }

        /* Modern Template Preview Styles */
        .modern-preview {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .boutique-preview {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
        }

        .preview-placeholder {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .preview-placeholder i {
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .preview-placeholder span {
            font-size: 1.5rem;
            font-weight: 600;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .template-card:hover .template-preview .preview-placeholder i {
            transform: scale(1.1);
            transition: transform 0.5s ease;
        }

        /* Store Preview Tab Styles */
        .preview-container {
            background-color: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-device-frame {
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .preview-desktop {
            width: 100%;
            height: 600px;
        }

        .preview-tablet {
            width: 768px;
            height: 1024px;
            max-width: 100%;
            max-height: 80vh;
            border-radius: 20px;
            padding: 20px;
        }

        .preview-mobile {
            width: 375px;
            height: 667px;
            max-width: 100%;
            max-height: 80vh;
            border-radius: 25px;
            padding: 15px 5px;
        }

        #storePreviewFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Add this to the existing style section */
        #openStoreButton {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #openStoreButton:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Image Preview Styles */
        .image-preview-container {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 2px;
            position: relative;
        }

        .preview-image:hover {
            border-color: var(--primary-color);
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            color: #ff4444;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-preview:hover {
            background: #ff4444;
            color: white;
        }

        /* Product Details Modal Styling */
        #productDetailsModal .modal-dialog {
            max-width: 95%;
            width: 1400px;
        }

        #productDetailsModal .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        #productDetailsModal .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1.25rem 1.5rem;
        }

        #productDetailsModal .modal-body {
            padding: 0;
        }

        #productDetailsModal .header-card {
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
        }

        #productDetailsModal .card {
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        #productDetailsModal .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 1.25rem 1.5rem;
        }

        #productDetailsModal .card-body {
            padding: 1.5rem;
        }

        #productDetailsModal h3 {
            color: var(--secondary-color);
            font-weight: 600;
        }

        #productDetailsModal h4 {
            color: var(--primary-color);
            font-weight: 600;
        }

        #productDetailsModal .text-muted {
            font-size: 0.9rem;
        }

        .product-actions .btn-view {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }

        .product-actions .btn-view:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .product-actions .btn-view i {
            margin-right: 0.5rem;
        }

        /* Dashboard Filter Dropdown Styling */
        #dashboardFilterDropdown {
            font-size: 1.3rem;
            padding: 1rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            margin: -0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            border: none;
            outline: none;
            box-shadow: none;
            text-decoration: none;
        }

        #dashboardFilterDropdown:focus,
        #dashboardFilterDropdown:active,
        #dashboardFilterDropdown:focus-visible {
            outline: none;
            box-shadow: none;
            text-decoration: none;
        }

        #dashboardFilterDropdown:hover {
            background-color: rgba(0, 0, 0, 0.05);
            text-decoration: none;
        }

        #dashboardFilterDropdown .fas {
            color: #666;
        }

        #dashboardFilterDropdown:hover .fas {
            color: #333;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50px;
        }
        
        .insight-box {
            position: relative;
        }
        
        .insight-box .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .insight-box p {
            transition: opacity 0.3s ease;
        }

        /* Add this to your existing styles */
        .btn-link.dropdown-toggle {
            color: #6c757d;
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .btn-link.dropdown-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #6c757d;
        }
        
        .btn-link.dropdown-toggle:focus {
            box-shadow: none;
        }

        /* Add these new styles for the orders table three dots */
        #ordersTable .btn-link.dropdown-toggle {
            font-size: 1.2rem;
            padding: 0.5rem 0.75rem;
            margin-left: 0.5rem;
        }

        #ordersTable .btn-link.dropdown-toggle i {
            font-size: 1.2rem;
        }
    </style>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Payarc JS -->
    <script>
        function loadPayarcScript(src) {
            var script = document.createElement('script');
            script.src = src;
            script.onerror = function() {
                if (src === 'https://js.payarc.com/v1/payarc.js') {
                    console.warn('CDN failed, falling back to local copy');
                    loadPayarcScript('/path/to/local/payarc.js');
                } else {
                    console.error('Failed to load Payarc library');
                }
            };
            document.head.appendChild(script);
        }
        loadPayarcScript('https://js.payarc.com/v1/payarc.js');
    </script>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">
                <h2>Loading</h2>
                <p id="loadingStatus">Loading studio branding...</p>
            </div>
        </div>
    </div>

    <div class="d-flex" id="wrapper">
        <!-- Sidebar-->
        <div class="border-end" id="sidebar-wrapper">
            <div class="sidebar-heading">
                <img src="assets/StudioSyncTransparent.svg" alt="Studio Sync Logo" style="width: 150px; height: auto;">
            </div>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action p-3" href="dashboard.html">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <a class="list-group-item list-group-item-action p-3" href="class-calendar.html">
                    <i class="fas fa-calendar-alt me-2"></i>Class Calendar
                </a>
                <a class="list-group-item list-group-item-action p-3 d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#classesDropdown" role="button" aria-expanded="false" aria-controls="classesDropdown">
                    <span><i class="fas fa-chalkboard-teacher me-2"></i>Classes</span>
                    <i class="fas fa-chevron-down"></i>
                </a>
                <div class="collapse" id="classesDropdown">
                    <a class="list-group-item list-group-item-action ps-5" href="allclasses.html">
                        <i class="fas fa-list me-2"></i>All Classes
                    </a>
                    <a class="list-group-item list-group-item-action ps-5" href="recreational.html">
                        <i class="fas fa-dumbbell me-2"></i>Recreational
                    </a>
                    <a class="list-group-item list-group-item-action ps-5" href="team.html">
                        <i class="fas fa-users me-2"></i>Team
                    </a>
                    <a class="list-group-item list-group-item-action ps-5" href="soloduettrio.html">
                        <i class="fas fa-user-friends me-2"></i>Solo/Duet/Trio
                    </a>
                </div>
                <a class="list-group-item list-group-item-action p-3" href="families.html">
                    <i class="fas fa-home me-2"></i>Families
                </a>
                <a class="list-group-item list-group-item-action p-3" href="students.html">
                    <i class="fas fa-user-graduate me-2"></i>Students
                </a>
                <a class="list-group-item list-group-item-action p-3" href="instructors.html">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Instructors
                </a>
                <a class="list-group-item list-group-item-action p-3" href="costumes.html">
                    <i class="fas fa-tshirt me-2"></i>Costumes
                </a>
                <a class="list-group-item list-group-item-action p-3" href="communication.html">
                    <i class="fas fa-comments me-2"></i>Communication
                </a>
                <a class="list-group-item list-group-item-action p-3" href="charges-payments.html">
                    <i class="fas fa-dollar-sign me-2"></i>Charges/Payments
                </a>
                <a class="list-group-item list-group-item-action p-3" href="reports.html">
                    <i class="fas fa-chart-bar me-2"></i>Reports
                </a>
                <a class="list-group-item list-group-item-action p-3" href="settings.html">
                    <i class="fas fa-cog me-2"></i>Settings
                </a>
            </div>
            <div class="mt-auto" style="margin-top: auto; padding: 1rem;">
                <button id="debugButton" class="btn btn-sm btn-outline-light w-100 d-none">
                    <i class="fas fa-bug me-2"></i>Debug Tools
                </button>
            </div>
        </div>

        <!-- Page content wrapper-->
        <div id="page-content-wrapper">
            <!-- Top navigation-->
            <nav class="navbar navbar-expand-lg navbar-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="sidebarToggle" style="width: 100px;" data-bs-toggle="tooltip" data-bs-placement="right" title="Toggle Menu" data-bs-trigger="hover focus">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Centered Logo -->
                    <div class="navbar-brand-center">
                        <img id="studio-logo" src="" alt="Studio Logo" style="max-height: 120px; max-width: 240px; display: none;">
                        <span id="studio-name" style="font-size: 1.5rem; font-weight: bold; color: #3DCED7;"></span>
                    </div>

                    <!-- Notifications and Profile Icons -->
                    <div class="navbar-nav ms-auto d-flex align-items-center">
                        <!-- Profile Icon Dropdown -->
                        <div class="nav-item dropdown">
                            <a class="nav-link" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="user-avatar">
                                    <span class="initials"></span>
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li><h6 class="dropdown-header" id="userName" style="font-size: 1.2rem; font-weight: 700; color: #333333;">User Name</h6></li>
                                <li><p class="dropdown-item-text" id="userEmail" style="font-size: 0.95rem; font-weight: 400; color: #333333;">user@example.com</p></li>
                                <li><p class="dropdown-item-text" id="studioNameDisplay" style="font-size: 1.1rem; font-weight: 600; color: #333333;">Studio Name</p></li>
                                <li><p class="dropdown-item-text" id="userRole" style="font-size: 0.85rem; font-weight: 400; color: #333333;">Role</p></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                <li><a class="dropdown-item" href="account.html"><i class="fas fa-user-cog me-2"></i>Account</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutButton"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Page content-->
            <div class="container-fluid">
                <!-- Store Manager Content -->
                <div class="container">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="section-title">Studio Store Manager</h1>
                        <a id="openStoreButton" href="#" target="_blank" class="btn btn-success">
                            <i class="fas fa-external-link-alt me-2"></i>Open Studio Store
                        </a>
                    </div>

                    <!-- Tabs for different sections -->
                    <ul class="nav nav-tabs" id="storeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">Products</button>
                        </li>
                       
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab" aria-controls="orders" aria-selected="false">Orders</button>
                        </li>
                    
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content" id="storeTabsContent">
                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>Store Dashboard</h2>
                                <div class="dropdown">
                                    <button class="btn btn-link dropdown-toggle p-0" type="button" id="dashboardFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dashboardFilterDropdown">
                                        <li><a class="dropdown-item" href="#" onclick="filterDashboard('day')">Day</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="filterDashboard('week')">Week</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="filterDashboard('month')">Month</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="filterDashboard('6months')">6 Months</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="filterDashboard('year')">Year</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="dashboard-insights">
                                <div class="insight-box">
                                    <div class="card-header">
                                        <h3>Total Sales</h3>
                                    </div>
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <p id="totalSales" style="display: none;">$0.00</p>
                                </div>
                                <div class="insight-box">
                                    <h3>Products Purchased</h3>
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <p id="productsPurchased" style="display: none;">0</p>
                                </div>
                                <div class="insight-box">
                                    <h3>New Customers</h3>
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <p id="newCustomers" style="display: none;">0</p>
                                </div>
                                <div class="insight-box">
                                    <h3>Returning Customers</h3>
                                    <div class="loading-spinner">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <p id="returningCustomers" style="display: none;">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Products Tab -->
                        <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                            <div class="products-header d-flex justify-content-between align-items-center mb-4">
                                <h2>Manage Products</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                    <i class="fas fa-plus"></i> Add New Product
                                </button>
                            </div>
                            
                            <div id="productList" class="product-list">
                                <!-- Product items will populate here -->
                            </div>
                        </div>

                        <!-- Store Layout Tab - Redesigned with visual template selection -->
                        <div class="tab-pane fade" id="store-layout" role="tabpanel" aria-labelledby="store-layout-tab">
                            <h2>Store Layout</h2>
                            <p>Choose a template for your public-facing store page. The selected template will be customized with your studio's colors, logo, and products.</p>
                            
                            <div class="template-selection">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="template-card" data-template="modern">
                                            <div class="template-preview modern-preview">
                                                <!-- Using a div with background instead of img -->
                                                <div class="preview-placeholder">
                                                    <i class="fas fa-store"></i>
                                                    <span>Modern Template</span>
                                                </div>
                                            </div>
                                            <div class="template-info">
                                                <h3>Modern Layout</h3>
                                                <p>A clean, contemporary design with large product images and minimalist navigation. Ideal for showcasing premium products.</p>
                                                <ul>
                                                    <li>Large product images</li>
                                                    <li>Minimalist navigation</li>
                                                    <li>Featured product carousel</li>
                                                    <li>Mobile-optimized</li>
                                                </ul>
                                                <button class="btn btn-primary template-select-btn" onclick="selectTemplate('modern')">
                                                    <span class="status-text">Select Template</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="template-card" data-template="boutique">
                                            <div class="template-preview boutique-preview">
                                                <!-- Using a div with background instead of img -->
                                                <div class="preview-placeholder">
                                                    <i class="fas fa-shopping-bag"></i>
                                                    <span>Boutique Template</span>
                                                </div>
                                            </div>
                                            <div class="template-info">
                                                <h3>Boutique Layout</h3>
                                                <p>An elegant, gallery-style layout with category sections and detailed product views. Perfect for studios with diverse product offerings.</p>
                                                <ul>
                                                    <li>Category navigation</li>
                                                    <li>Gallery-style product display</li>
                                                    <li>Studio story section</li>
                                                    <li>Customer testimonials</li>
                                                </ul>
                                                <button class="btn btn-primary template-select-btn" onclick="selectTemplate('boutique')">
                                                    <span class="status-text">Select Template</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="template-preview-container mt-4" id="templatePreviewContainer" style="display: none;">
                                <h3>Template Preview</h3>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> This preview shows how your store will appear to customers using your studio's colors, logo, and products.
                                </div>
                                <div class="preview-frame">
                                    <iframe id="templatePreviewFrame" src="" frameborder="0" style="width: 100%; height: 500px;"></iframe>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-success" id="saveTemplateBtn" onclick="saveStoreLayout()">
                                        <i class="fas fa-save"></i> Save as My Store Layout
                                    </button>
                                    <button class="btn btn-secondary" onclick="hideTemplatePreview()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Orders Tab -->
                        <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                            <div class="orders-header d-flex justify-content-between align-items-center mb-4">
                                <h2>Manage Orders</h2>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="ordersTable">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Date</th>
                                            <th>Customer Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Orders will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Add this after the store-layout tab-pane -->
                        <div class="tab-pane fade" id="store-preview" role="tabpanel" aria-labelledby="store-preview-tab">
                            <h2>Store Preview</h2>
                            <p>Preview how your store will appear to customers. This preview uses your actual products and studio information.</p>
                            
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i> Your store will use the template selected in the Store Layout tab and your studio's colors and branding.
                            </div>
                            
                            <div class="d-flex justify-content-between mb-4">
                                <div>
                                    <button class="btn btn-outline-primary" onclick="refreshStorePreview()">
                                        <i class="fas fa-sync-alt"></i> Refresh Preview
                                    </button>
                                </div>
                                <div>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-secondary" onclick="togglePreviewMode('desktop')">
                                            <i class="fas fa-desktop"></i> Desktop
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="togglePreviewMode('tablet')">
                                            <i class="fas fa-tablet-alt"></i> Tablet
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="togglePreviewMode('mobile')">
                                            <i class="fas fa-mobile-alt"></i> Mobile
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="preview-container">
                                <div id="previewDeviceFrame" class="preview-device-frame preview-desktop">
                                    <iframe id="storePreviewFrame" src="about:blank" frameborder="0"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const wrapper = document.getElementById('wrapper');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const overlay = document.querySelector('.sidebar-overlay');

            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                wrapper.classList.toggle('toggled');
                
                if (window.innerWidth <= 768) {
                    if (wrapper.classList.contains('toggled')) {
                        overlay.classList.add('show');
                    } else {
                        overlay.classList.remove('show');
                    }
                }
            }

            // Toggle button click handler
            sidebarToggle.addEventListener('click', toggleSidebar);

            // Overlay click handler
            overlay.addEventListener('click', toggleSidebar);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    overlay.classList.remove('show');
                }
            });
        });
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDRSW3u6gJSs98Z2Mkp5DYSC__ibDXXHAE",
            authDomain: "studiosync-af73d.firebaseapp.com",
            projectId: "studiosync-af73d",
            storageBucket: "studiosync-af73d.appspot.com",
            messagingSenderId: "172555302276",
            appId: "1:172555302276:web:55b661f9849441e2de59d1",
            measurementId: "G-EK7EFQGMSG"
        };
        firebase.initializeApp(firebaseConfig);

        // Function to apply studio branding colors
        function applyStudioBranding(studioData) {
            console.log('🎨 Applying studio branding colors:', {
                PrimaryColor: studioData.PrimaryColor,
                SecondaryColor: studioData.SecondaryColor
            });

            const primaryColor = studioData.PrimaryColor || '#3DCED7';
            const secondaryColor = studioData.SecondaryColor || '#3A506B';

            // Update CSS variables for the sidebar and related elements
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--primary-hover', adjustColor(primaryColor, -10));
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);

            // Update loading overlay elements with branded colors
            const loadingTitle = document.querySelector('.loading-text h2');
            const loadingText = document.querySelector('.loading-text p');
            const spinner = document.querySelector('.spinner');

            if (loadingTitle) loadingTitle.style.color = primaryColor;
            if (loadingText) loadingText.style.color = secondaryColor;
            if (spinner) spinner.style.borderTopColor = primaryColor;

            // Add RGB values for hover effects
            document.documentElement.style.setProperty('--primary-color-rgb', hexToRgb(primaryColor));
        }

        // Helper function to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }

        // Function to get current user data
        async function getCurrentUserData() {
            const loadingStatus = document.getElementById('loadingStatus');
            const loadingOverlay = document.getElementById('loadingOverlay');

            try {
                const user = await new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            loadingStatus.textContent = "Authenticating user...";
                            resolve(user);
                        } else {
                            console.log('No user signed in');
                            window.location.href = '/studiologin.html';
                        }
                    });
                });

                const studioId = localStorage.getItem('currentStudioId');
                const studioData = JSON.parse(localStorage.getItem('currentStudioData'));
                const userDocId = localStorage.getItem('userDocId');

                loadingStatus.textContent = "Loading studio branding...";
                
                if (studioData) {
                    applyStudioBranding(studioData);
                }

                loadingStatus.textContent = "Fetching user data...";

                try {
                    const userDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Users')
                        .doc(userDocId)
                        .get();

                    const instructorDoc = !userDoc.exists ? await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Instructors')
                        .doc(user.uid)
                        .get() : null;

                    let userData;
                    let collectionType;

                    if (userDoc.exists) {
                        userData = userDoc.data();
                        collectionType = 'Users';
                    } else if (instructorDoc?.exists) {
                        userData = instructorDoc.data();
                        collectionType = 'Instructors';
                    }

                    if (userData) {
                        loadingStatus.textContent = "Loading...";
                        
                        const fullName = `${userData.FirstName} ${userData.LastName}`;
                        document.getElementById('userName').textContent = fullName;
                        document.getElementById('userEmail').textContent = userData.Email;
                        
                        // Set studio name in profile dropdown
                        const studioNameElement = document.getElementById('studioNameDisplay');
                        if (studioNameElement && studioData) {
                            studioNameElement.textContent = studioData.StudioName || 'Studio Name';
                        }
                        
                        // Set user initials in avatar
                        const initials = `${userData.FirstName[0]}${userData.LastName[0]}`;
                        const initialsElement = document.querySelector('.initials');
                        if (initialsElement) {
                            initialsElement.textContent = initials;
                        }

                        const roleElement = document.getElementById('userRole');
                        if (userData.Role) {
                            roleElement.textContent = userData.Role;
                            roleElement.style.color = '#333333';
                            roleElement.style.fontWeight = '700';
                        } else {
                            roleElement.textContent = 'No Role Assigned';
                            roleElement.style.color = '#666';
                        }

                        if (studioData?.LogoUrl) {
                            await loadStudioLogo(studioData.LogoUrl, studioData.StudioName);
                        } else {
                            await loadStudioLogo(null, studioData?.StudioName);
                        }

                        // Hide loading overlay with fade effect
                        loadingOverlay.classList.add('fade-out');
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error getting user document:', error);
                    loadingStatus.textContent = "Error loading dashboard. Please refresh...";
                }
                
                if (studioData) {
                    applyStudioBranding(studioData);
                    updateSidebarLinks(studioData);
                    updatePageUrl(studioData.StudioName);
                }
            } catch (error) {
                console.error('Error:', error);
                loadingStatus.textContent = "Error loading dashboard. Please refresh...";
            }
        }

        // Function to load and display the studio logo
        function loadStudioLogo(logoUrl, studioName) {
            return new Promise((resolve) => {
                const logoElement = document.getElementById('studio-logo');
                const nameElement = document.getElementById('studio-name');
                
                if (logoUrl) {
                    logoElement.onload = () => resolve();
                    logoElement.src = logoUrl;
                    logoElement.alt = studioName || 'Studio Logo';
                    logoElement.style.display = 'block';
                    nameElement.style.display = 'none';
                } else {
                    logoElement.style.display = 'none';
                    nameElement.textContent = studioName || 'Studio Sync';
                    nameElement.style.display = 'block';
                    resolve();
                }
            });
        }

        // Call the function when the page loads
        getCurrentUserData();

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', function() {
            firebase.auth().signOut().then(() => {
                // Clear studio context from localStorage
                localStorage.removeItem('currentStudioId');
                localStorage.removeItem('currentStudioData');
                // Redirect to studio login
                window.location.href = '/studiologin.html';
            }).catch((error) => {
                console.error('Logout Error:', error);
            });
        });

        // Add this function after the firebase initialization
        function getStudioNameForUrl(studioName) {
            // Remove spaces and special characters, keep alphanumeric only
            return studioName.replace(/[^a-zA-Z0-9]/g, '');
        }

        function updateSidebarLinks(studioData) {
            if (studioData?.StudioName) {
                const studioNameParam = getStudioNameForUrl(studioData.StudioName);
                
                const sidebarLinks = document.querySelectorAll('#sidebar-wrapper .list-group-item');
                sidebarLinks.forEach(link => {
                    const currentHref = link.getAttribute('href');
                    if (currentHref && currentHref.endsWith('.html')) {
                        const newHref = currentHref.replace('.html', `?studio=${studioNameParam}`);
                        link.setAttribute('href', newHref);
                    }
                });
            }
        }

        function updatePageUrl(studioName) {
            if (studioName) {
                const studioNameParam = getStudioNameForUrl(studioName);
                const currentUrl = new URL(window.location.href);
                
                // Only update if we're on a .html page and don't already have the studio parameter
                if (currentUrl.pathname.endsWith('.html') && !currentUrl.searchParams.has('studio')) {
                    const newUrl = `${currentUrl.pathname.replace('.html', '')}?studio=${studioNameParam}`;
                    window.history.replaceState({}, '', newUrl);
                }
            }
        }

        // Add this after the applyStudioBranding function
        function hexToRgb(hex) {
            // Remove the # if present
            hex = hex.replace('#', '');
            
            // Parse the hex values
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            return `${r}, ${g}, ${b}`;
        }

        function filterSales(period) {
            // Implement filtering logic here
            console.log('Filtering sales by:', period);
        }

        function addProductToList(name, price, description, imageUrl, productId, imageUrls = []) {
            const productList = document.getElementById('productList');
            
            // Check if product already exists in the list
            const existingProduct = productId ? document.querySelector(`.product-item[data-id="${productId}"]`) : null;
            
            if (existingProduct) {
                // Update existing product
                existingProduct.querySelector('img').src = imageUrl;
                existingProduct.querySelector('h3').textContent = name;
                existingProduct.querySelector('.product-price').textContent = `$${parseFloat(price).toFixed(2)}`;
                existingProduct.querySelector('.product-description').textContent = description || 'No description available';
                // Store all image URLs as a data attribute
                if (imageUrls.length) {
                    existingProduct.setAttribute('data-image-urls', JSON.stringify(imageUrls));
                }
            } else {
                // Create new product item
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.setAttribute('data-id', productId);
                if (imageUrls.length) {
                    productItem.setAttribute('data-image-urls', JSON.stringify(imageUrls));
                }
                
                productItem.innerHTML = `
                    <img src="${imageUrl}" alt="${name}">
                    <div class="product-item-content">
                        <h3>${name}</h3>
                        <div class="product-price">$${parseFloat(price).toFixed(2)}</div>
                        <div class="product-description">${description || 'No description available'}</div>
                        <div class="product-actions">
                            <button class="btn-view" onclick="showProductDetails('${productId}')"><i class="fas fa-eye"></i> View</button>
                            <button class="btn-edit" onclick="editProduct('${productId}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-delete" onclick="deleteProduct('${productId}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                productList.appendChild(productItem);
            }
        }

        // Function to edit a product
        async function editProduct(productId) {
            try {
                console.log('Edit button clicked for product ID:', productId);
                const studioId = localStorage.getItem('currentStudioId');
                if (!studioId) {
                    showModalError('No studio ID found. Please log in again.');
                    return;
                }

                // Get product data from Firestore
                const productDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Products')
                    .doc(productId)
                    .get();

                if (!productDoc.exists) {
                    showModalError('Product not found');
                    return;
                }

                const productData = productDoc.data();
                
                // Set edit mode
                document.getElementById('addProductModal').setAttribute('data-edit-id', productId);
                document.getElementById('addProductModalLabel').textContent = 'Edit Product';
                document.querySelector('#addProductModal .btn-primary').textContent = 'Update Product';
                
                console.log('Opening edit modal in edit mode for product:', productId);
                
                // Populate the modal with product data
                document.getElementById('productName').value = productData.Name;
                document.getElementById('productPrice').value = productData.Price;
                document.getElementById('productDescription').value = productData.Description || '';
                
                // Handle sizes
                if (productData.Sizes && productData.Sizes.length > 0) {
                    document.getElementById('hasMultipleSizes').checked = true;
                    document.getElementById('sizesContainer').style.display = 'block';
                    document.getElementById('singleInventoryContainer').style.display = 'none';
                    
                    const sizesList = document.getElementById('sizesList');
                    sizesList.innerHTML = ''; // Clear existing sizes
                    
                    // Add each size with its quantity
                    productData.Sizes.forEach(sizeData => {
                        const sizeRow = document.createElement('div');
                        sizeRow.className = 'size-row mb-2';
                        sizeRow.innerHTML = `
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control size-name" value="${sizeData.Size}" placeholder="Size (e.g., S, M, L)">
                                <input type="number" class="form-control size-inventory" value="${sizeData.Quantity}" min="0" placeholder="Quantity">
                                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.size-row').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        sizesList.appendChild(sizeRow);
                    });
                } else {
                    document.getElementById('hasMultipleSizes').checked = false;
                    document.getElementById('sizesContainer').style.display = 'none';
                    document.getElementById('singleInventoryContainer').style.display = 'block';
                    document.getElementById('singleInventory').value = productData.Inventory || 0;
                }

                // Handle image previews
                const previewContainer = document.getElementById('imagesPreviewContainer');
                previewContainer.innerHTML = ''; // Clear existing previews
                
                // Get all image URLs
                const imageUrls = productData.ImageUrls || [];
                if (productData.ImageUrl && !imageUrls.includes(productData.ImageUrl)) {
                    imageUrls.unshift(productData.ImageUrl);
                }

                // Create preview for each existing image
                imageUrls.forEach(imageUrl => {
                    const container = document.createElement('div');
                    container.style.position = 'relative';
                    container.style.display = 'inline-block';
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.className = 'preview-image';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-preview';
                    removeBtn.innerHTML = '×';
                    removeBtn.onclick = function() {
                        container.remove();
                        // Update the stored image URLs
                        const remainingImages = Array.from(previewContainer.querySelectorAll('img.preview-image'))
                            .map(img => img.src);
                        previewContainer.setAttribute('data-existing-images', JSON.stringify(remainingImages));
                    };
                    
                    container.appendChild(img);
                    container.appendChild(removeBtn);
                    previewContainer.appendChild(container);
                });

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading product for edit:', error);
                showModalError('Failed to load product data: ' + error.message);
            }
        }

        // Update getSizesData function to properly handle size data
        function getSizesData() {
            const hasMultipleSizes = document.getElementById('hasMultipleSizes').checked;
            
            if (!hasMultipleSizes) {
                return {
                    HasMultipleSizes: false,
                    Inventory: parseInt(document.getElementById('singleInventory').value) || 0
                };
            }

            const sizes = [];
            
            // Handle both edit mode (size-row) and add mode (size-input-group)
            document.querySelectorAll('#sizesList .size-row, #sizesList .size-input-group').forEach(group => {
                let sizeName, quantity;
                
                if (group.classList.contains('size-row')) {
                    // Edit mode
                    sizeName = group.querySelector('.size-name').value;
                    quantity = parseInt(group.querySelector('.size-inventory').value) || 0;
                } else {
                    // Add mode
                    const inputs = group.querySelectorAll('input');
                    sizeName = inputs[0].value;
                    quantity = parseInt(inputs[1].value) || 0;
                }
                
                if (sizeName) {
                    sizes.push({
                        Size: sizeName.toLowerCase(),
                        Quantity: quantity
                    });
                }
            });

            return {
                HasMultipleSizes: true,
                Sizes: sizes
            };
        }

        // Modify createProduct function to handle existing images during update
        async function createProduct() {
            const isEdit = document.getElementById('addProductModal').hasAttribute('data-edit-id');
            const productId = isEdit ? document.getElementById('addProductModal').getAttribute('data-edit-id') : null;
            
            const productName = document.getElementById('productName').value.trim();
            const productPrice = document.getElementById('productPrice').value.trim();
            const productDescription = document.getElementById('productDescription').value.trim();
            const productImages = Array.from(document.getElementById('productImage').files);
            const sizeData = getSizesData();
            
            // Check for existing images in the preview container
            const previewContainer = document.getElementById('imagesPreviewContainer');
            const hasExistingImages = previewContainer.querySelectorAll('img.preview-image').length > 0;

            // Validation
            if (!productName) {
                showFormError('Please enter a product name');
                return;
            }
            
            if (!productPrice || isNaN(parseFloat(productPrice)) || parseFloat(productPrice) <= 0) {
                showFormError('Please enter a valid price');
                return;
            }

            // Only check for required images in add mode
            if (!isEdit && !productImages.length) {
                showFormError('Please upload at least one product image');
                return;
            }

            // In edit mode, make sure we have either existing images or new ones
            if (isEdit && !hasExistingImages && !productImages.length) {
                showFormError('Please upload at least one product image');
                return;
            }

            if (sizeData.HasMultipleSizes && (!sizeData.Sizes || sizeData.Sizes.length === 0)) {
                showFormError('Please add at least one size');
                return;
            }

            // Show loading state
            const addButton = document.querySelector('#addProductModal .btn-primary');
            addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (isEdit ? 'Updating...' : 'Adding...');
            addButton.disabled = true;
            
            // Clear any previous errors
            clearFormErrors();

            // Get studio ID
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                showModalError('No studio ID found. Please log in again.');
                resetButton(addButton, isEdit ? 'Update Product' : 'Add Product');
                return;
            }

            try {
                const db = firebase.firestore();
                const storageRef = firebase.storage().ref();
                
                let uploadedImageUrls = [];
                
                // If this is an edit and no new images were uploaded, use existing images
                if (isEdit && productImages.length === 0) {
                    const existingImages = JSON.parse(document.getElementById('imagesPreviewContainer').getAttribute('data-existing-images') || '[]');
                    uploadedImageUrls = existingImages;
                } else {
                    // Upload new images
                    const uploadPromises = productImages.map(image => {
                        const imageRef = storageRef.child(`products/${studioId}/${Date.now()}_${image.name}`);
                        return imageRef.put(image)
                            .then(() => imageRef.getDownloadURL())
                            .then(imageUrl => {
                                uploadedImageUrls.push(imageUrl);
                            });
                    });
                    
                    await Promise.all(uploadPromises);
                }

                // Prepare product data
                const productData = {
                    Name: productName,
                    Price: parseFloat(productPrice),
                    Description: productDescription,
                    ImageUrl: uploadedImageUrls[0],
                    ImageUrls: uploadedImageUrls,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    ...sizeData
                };

                // Update or create product
                if (isEdit) {
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Products')
                        .doc(productId)
                        .update(productData);
                } else {
                    productData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    productData.Active = true;
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Products')
                        .add(productData);
                }

                // Reset form and close modal
                document.getElementById('productForm').reset();
                document.getElementById('imagesPreviewContainer').innerHTML = '';
                document.getElementById('sizesList').innerHTML = '';
                document.getElementById('sizesContainer').style.display = 'none';
                document.getElementById('singleInventoryContainer').style.display = 'block';
                
                // Remove edit mode attributes
                document.getElementById('addProductModal').removeAttribute('data-edit-id');
                document.getElementById('addProductModalLabel').textContent = 'Add New Product';
                document.querySelector('#addProductModal .btn-primary').textContent = 'Add Product';
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
                if (modal) modal.hide();
                
                // Refresh product list
                loadProducts();
                
                // Show success toast
                showToast('Success', `Product ${isEdit ? 'updated' : 'added'} successfully`);
            } catch (error) {
                console.error('Error saving product:', error);
                showModalError(`Failed to ${isEdit ? 'update' : 'add'} product: ` + error.message);
            } finally {
                resetButton(addButton, isEdit ? 'Update Product' : 'Add Product');
            }
        }

        function showFormError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-3';
            errorDiv.textContent = message;
            
            // Remove any existing error
            clearFormErrors();
            
            // Add the new error
            document.getElementById('productForm').appendChild(errorDiv);
        }

        function clearFormErrors() {
            const existingErrors = document.querySelectorAll('#productForm .alert');
            existingErrors.forEach(error => error.remove());
        }

        function showModalError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            
            const modalBody = document.querySelector('#addProductModal .modal-body');
            modalBody.insertBefore(errorDiv, modalBody.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function resetButton(button, text) {
            button.innerHTML = text;
            button.disabled = false;
        }

        function showToast(title, message) {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1050';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="toast-header" style="background-color: var(--primary-color); color: white;">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            bsToast.show();
            
            // Remove toast from DOM after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }

        // Enhanced function for adding product to list
        function addProductToList(name, price, description, imageUrl, productId, imageUrls) {
            const productList = document.getElementById('productList');
            
            // Check if product already exists in the list
            const existingProduct = productId ? document.querySelector(`.product-item[data-id="${productId}"]`) : null;
            
            if (existingProduct) {
                // Update existing product
                existingProduct.querySelector('img').src = imageUrl;
                existingProduct.querySelector('h3').textContent = name;
                existingProduct.querySelector('.product-price').textContent = `$${parseFloat(price).toFixed(2)}`;
                existingProduct.querySelector('.product-description').textContent = description || 'No description available';
            } else {
                // Create new product item
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                if (productId) productItem.setAttribute('data-id', productId);
                
                productItem.innerHTML = `
                    <img src="${imageUrl}" alt="${name}">
                    <div class="product-item-content">
                        <h3>${name}</h3>
                        <div class="product-price">$${parseFloat(price).toFixed(2)}</div>
                        <div class="product-description">${description || 'No description available'}</div>
                        <div class="product-actions">
                            <button class="btn-view" onclick="showProductDetails('${productId}')"><i class="fas fa-eye"></i> View</button>
                            <button class="btn-edit" onclick="editProduct('${productId}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-delete" onclick="deleteProduct('${productId}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                productList.appendChild(productItem);
            }
        }

        // Enhanced function for deleting products
        async function deleteProduct(productId) {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                if (!studioId) {
                    showModalError('No studio ID found. Please log in again.');
                    return;
                }

                // Show confirmation dialog
                if (!confirm('Are you sure you want to delete this product?')) {
                    return;
                }

                // Delete from Firestore
                await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Products')
                    .doc(productId)
                    .delete();

                // Remove from UI
                const productItem = document.querySelector(`.product-item[data-id="${productId}"]`);
                if (productItem) {
                    productItem.remove();
                }

                // Show success toast
                showToast('Success', 'Product deleted successfully');
            } catch (error) {
                console.error('Error deleting product:', error);
                showModalError('Error deleting product. Please try again.');
            }
        }

        // File upload handling with preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('productImage');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const filePreview = document.getElementById('filePreview');
            const fileUploadPlaceholder = document.getElementById('fileUploadPlaceholder');
            const imagePreview = document.getElementById('imagePreview');
            const fileName = document.getElementById('fileName');
            const removeFileBtn = document.getElementById('removeFile');

            if (!fileInput || !fileUploadArea || !filePreview || !fileUploadPlaceholder || 
                !imagePreview || !fileName || !removeFileBtn) {
                console.error('Some file upload elements not found!');
                return;
            }

            // Click the hidden file input when the upload area is clicked
            fileUploadArea.addEventListener('click', function(e) {
                // Don't trigger if they clicked the remove button
                if (e.target !== removeFileBtn && !removeFileBtn.contains(e.target)) {
                    fileInput.click();
                }
            });

            // Handle file selection
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Validate file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size exceeds 5MB limit. Please choose a smaller file.');
                        this.value = '';
                        return;
                    }
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        fileName.textContent = file.name;
                        fileUploadPlaceholder.style.display = 'none';
                        filePreview.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Remove file
            removeFileBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering fileUploadArea click
                fileInput.value = '';
                filePreview.style.display = 'none';
                fileUploadPlaceholder.style.display = 'block';
            });

            // Drag and drop support
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, function() {
                    fileUploadArea.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, function() {
                    fileUploadArea.classList.remove('dragover');
                }, false);
            });

            fileUploadArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files && files.length) {
                    fileInput.files = files;
                    
                    // Trigger change event
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }, false);
        });

        // Load products when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for Firebase auth to initialize
            setTimeout(loadProducts, 2000);
        });

        // Load existing products from Firestore
        function loadProducts() {
            console.log('Starting loadProducts function');
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                console.error('No studio ID found in localStorage.');
                const productList = document.getElementById('productList');
                if (productList) {
                    productList.innerHTML = '<div class="error-loading">Error: No studio ID found. Please try logging in again.</div>';
                }
                return;
            }
            console.log('Studio ID found:', studioId);

            const productList = document.getElementById('productList');
            if (!productList) {
                console.error('Product list element not found in the DOM.');
                return;
            }

            // Clear existing products
            productList.innerHTML = '<div class="loading-products"><i class="fas fa-spinner fa-spin"></i> Loading products...</div>';
            console.log('Cleared product list, showing loading indicator');

            // Check if Firebase is initialized
            if (!firebase || !firebase.firestore) {
                console.error('Firebase or Firestore is not initialized');
                productList.innerHTML = '<div class="error-loading">Error: Firebase not initialized. Please refresh the page.</div>';
                return;
            }

            console.log('Attempting to fetch products from Firestore');
            console.log('Query path: Studios/' + studioId + '/Products');
            
            // OPTION 1: Simplest solution - just get all products without filtering or ordering
            firebase.firestore()
                .collection('Studios')
                .doc(studioId)
                .collection('Products')
                .get()
                .then((querySnapshot) => {
                    console.log('Query executed successfully');
                    
                    // Remove loading indicator
                    const loadingElement = document.querySelector('.loading-products');
                    if (loadingElement) {
                        loadingElement.remove();
                    }

                    if (querySnapshot.empty) {
                        console.log('No products found in Firestore');
                        productList.innerHTML = '<div class="no-products">No products found. Add your first product!</div>';
                        return;
                    }

                    console.log('Found ' + querySnapshot.size + ' products');
                    
                    // Client-side filtering and sorting
                    const products = [];
                    querySnapshot.forEach((doc) => {
                        const productData = doc.data();
                        
                        // Only include active products (client-side filtering)
                        if (productData.Active === true) {
                            products.push({
                                id: doc.id,
                                data: productData
                            });
                        }
                    });
                    
                    // Sort by CreatedAt if available (client-side sorting)
                    products.sort((a, b) => {
                        const timeA = a.data.CreatedAt ? a.data.CreatedAt.toMillis() : 0;
                        const timeB = b.data.CreatedAt ? b.data.CreatedAt.toMillis() : 0;
                        return timeB - timeA; // descending order (newest first)
                    });
                    
                    if (products.length === 0) {
                        productList.innerHTML = '<div class="no-products">No active products found. Add your first product!</div>';
                        return;
                    }
                    
                    // Display the filtered and sorted products
                    products.forEach(product => {
                        const productData = product.data;
                        console.log('Processing product document:', product.id);
                        
                        try {
                            const imageUrls = productData.ImageUrls || [productData.ImageUrl];
                            addProductToList(
                                productData.Name || 'Unnamed Product', 
                                productData.Price || 0, 
                                productData.Description || '', 
                                productData.ImageUrl || (imageUrls && imageUrls[0]) || '', 
                                product.id,
                                imageUrls
                            );
                            console.log('Successfully added product to list:', product.id);
                        } catch (err) {
                            console.error('Error adding product to list:', err, product.id);
                        }
                    });
                })
                .catch((error) => {
                    console.error('Error loading products from Firestore:', error);
                    productList.innerHTML = `<div class="error-loading">Error loading products: ${error.message}</div>`;
                });
        }

        // Let's also add a helper function to debug Firebase initialization
        function checkFirebaseStatus() {
            console.log('Checking Firebase status:');
            if (typeof firebase === 'undefined') {
                console.error('Firebase is not defined');
                return false;
            }
            
            console.log('Firebase version:', firebase.SDK_VERSION);
            
            if (!firebase.apps || !firebase.apps.length) {
                console.error('Firebase has not been initialized');
                return false;
            }
            
            console.log('Firebase app initialized');
            
            if (!firebase.auth) {
                console.error('Firebase auth is not available');
                return false;
            }
            
            console.log('Firebase auth is available');
            
            if (!firebase.firestore) {
                console.error('Firebase firestore is not available');
                return false;
            }
            
            console.log('Firebase firestore is available');
            return true;
        }

        // Call this when document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking Firebase status');
            
            // Check Firebase status on page load
            setTimeout(checkFirebaseStatus, 1000);
            
            // Add event listener for tab changes with better error handling
            const productsTab = document.getElementById('products-tab');
            
            if (productsTab) {
                console.log('Products tab found, adding event listener');
                productsTab.addEventListener('shown.bs.tab', function() {
                    console.log('Products tab shown, loading products');
                    try {
                        loadProducts();
                    } catch (err) {
                        console.error('Uncaught error in loadProducts:', err);
                        const productList = document.getElementById('productList');
                        if (productList) {
                            productList.innerHTML = `<div class="error-loading">Unexpected error: ${err.message}</div>`;
                        }
                    }
                });
            } else {
                console.warn('Products tab element not found');
            }
            
            // Also initialize file upload for multiple images
            try {
                initializeMultiImageUpload();
                console.log('Multi-image upload initialized');
            } catch (err) {
                console.error('Error initializing multi-image upload:', err);
            }
        });
        function filterDashboard(period) {
            console.log(`Filtering dashboard for period: ${period}`);
            // Reload dashboard with filtered data
            loadDashboard(period);
        }

        // Function to load dashboard data
        async function loadDashboard(period = 'all') {
            console.log('Loading dashboard data...');
            
            // Show loading spinners
            document.querySelectorAll('.loading-spinner').forEach(spinner => {
                spinner.style.display = 'flex';
            });
            document.querySelectorAll('.insight-box p').forEach(p => {
                p.style.display = 'none';
            });

            try {
                const studioId = localStorage.getItem('currentStudioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                console.log('Fetching orders from Firestore...');
                const db = firebase.firestore();
                let query = db
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Orders')
                    .orderBy('PaymentDate', 'desc');

                // Apply time filter if specified
                if (period !== 'all') {
                    const now = new Date();
                    const startDate = new Date();

                    switch (period) {
                        case 'day':
                            startDate.setDate(now.getDate() - 1);
                            break;
                        case 'week':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'month':
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case '6months':
                            startDate.setMonth(now.getMonth() - 6);
                            break;
                        case 'year':
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }

                    // Convert to ISO string for comparison with PaymentDate
                    const startDateISO = startDate.toISOString();
                    console.log('Filtering orders from:', startDateISO);
                    
                    query = query.where('PaymentDate', '>=', startDateISO);
                }

                const ordersSnapshot = await query.get();

                console.log(`Processing ${ordersSnapshot.size} orders...`);
                const orders = [];
                ordersSnapshot.forEach(doc => {
                    const orderData = doc.data();
                    // Convert PaymentDate string to Date object for easier manipulation
                    const paymentDate = new Date(orderData.PaymentDate);
                    orders.push({
                        ...orderData,
                        OrderId: doc.id,
                        PaymentDateObj: paymentDate
                    });
                });

                // Log the first few orders for debugging
                if (orders.length > 0) {
                    console.log('Sample orders:', orders.slice(0, 3).map(order => ({
                        OrderId: order.OrderId,
                        PaymentDate: order.PaymentDate,
                        Total: order.Total
                    })));
                }

                console.log('Updating dashboard metrics...');
                // Calculate and update metrics
                await updateDashboardMetrics(orders);
                
                console.log('Dashboard data loaded successfully');
                // Hide loading spinners and show data
                document.querySelectorAll('.loading-spinner').forEach(spinner => {
                    spinner.style.display = 'none';
                });
                document.querySelectorAll('.insight-box p').forEach(p => {
                    p.style.display = 'block';
                });
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Handle error state
                document.querySelectorAll('.loading-spinner').forEach(spinner => {
                    spinner.style.display = 'none';
                });
                document.querySelectorAll('.insight-box p').forEach(p => {
                    p.style.display = 'block';
                    p.textContent = 'Error';
                });
            }
        }

        // Function to update dashboard metrics
        async function updateDashboardMetrics(orders) {
            console.log('Starting dashboard metrics update...');
            try {
                if (!orders || !Array.isArray(orders)) {
                    throw new Error('No orders data available');
                }

                let totalSales = 0;
                let totalProducts = 0;
                let newCustomers = 0;
                let returningCustomers = 0;
                const customerEmails = new Set();

                console.log(`Processing ${orders.length} orders...`);
                orders.forEach(order => {
                    totalSales += parseFloat(order.Total || 0);
                    
                    if (order.Items && Array.isArray(order.Items)) {
                        order.Items.forEach(item => {
                            totalProducts += parseInt(item.Quantity || 0);
                        });
                    }
                    
                    if (order.CustomerInfo?.Email) {
                        if (customerEmails.has(order.CustomerInfo.Email)) {
                            returningCustomers++;
                        } else {
                            customerEmails.add(order.CustomerInfo.Email);
                            newCustomers++;
                        }
                    }
                });

                function formatNumber(num) {
                    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }

                console.log('Updating dashboard display...');
                document.getElementById('totalSales').textContent = `$${formatNumber(totalSales.toFixed(2))}`;
                document.getElementById('productsPurchased').textContent = formatNumber(totalProducts);
                document.getElementById('newCustomers').textContent = formatNumber(newCustomers);
                document.getElementById('returningCustomers').textContent = formatNumber(returningCustomers);
                
                console.log('Dashboard metrics updated successfully:', {
                    totalSales,
                    totalProducts,
                    newCustomers,
                    returningCustomers
                });
            } catch (error) {
                console.error('Error updating dashboard metrics:', error);
                throw error;
            }
        }

        // Load dashboard on page load if dashboard tab is active
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Checking if dashboard should load on page init...');
            if (document.getElementById('dashboard-tab').classList.contains('active')) {
                console.log('Dashboard tab is active on load - loading data');
                loadDashboard();
            }
        });

        // Initialize dashboard when the dashboard tab is shown
        document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function() {
            console.log('Dashboard tab shown - loading data');
            loadDashboard();
        });

        // Add click event listener to ensure dashboard loads every time tab is clicked
        document.getElementById('dashboard-tab').addEventListener('click', function() {
            console.log('Dashboard tab clicked - loading data');
            loadDashboard();
        });

        // Function to delete an order
        async function deleteOrder(orderId) {
            try {
                const confirmed = confirm('Are you sure you want to delete this order? This action cannot be undone.');
                if (!confirmed) return;

                const studioId = localStorage.getItem('currentStudioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const db = firebase.firestore();
                await db
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Orders')
                    .doc(orderId)
                    .delete();

                // Reload orders after deletion
                loadOrders();
                // Update dashboard metrics
                updateDashboardMetrics();
                
                // Show success message
                alert('Order deleted successfully');
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error deleting order: ' + error.message);
            }
        }
    </script>

    <!-- Add Product Modal - Updated file input to support preview -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--primary-color);">
                    <h5 class="modal-title" id="addProductModalLabel" style="color: white;">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="productPrice" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="hasMultipleSizes">
                                <label class="form-check-label" for="hasMultipleSizes">This product has multiple sizes</label>
                            </div>
                        </div>
                        <div class="mb-3" id="singleInventoryContainer">
                            <label for="singleInventory" class="form-label">Inventory Quantity</label>
                            <input type="number" class="form-control" id="singleInventory" min="0" value="0">
                        </div>
                        <div class="mb-3" id="sizesContainer" style="display: none;">
                            <label class="form-label">Sizes and Inventory</label>
                            <div id="sizesList">
                                <!-- Size inputs will be added here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSizeInput()">
                                <i class="fas fa-plus"></i> Add Size
                            </button>
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label">Product Images</label>
                            <div class="file-upload-container" id="fileUploadContainer">
                                <div class="file-upload-area" id="fileUploadArea">
                                    <div class="file-upload-placeholder" id="fileUploadPlaceholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Drag & drop your images here</p>
                                        <p>or</p>
                                        <label for="productImage" class="file-upload-button">Browse Files</label>
                                    </div>
                                </div>
                                <input type="file" class="form-control visually-hidden" id="productImage" accept="image/*" multiple>
                            </div>
                            <div id="imagesPreviewContainer" class="images-preview-container">
                                <!-- Image previews will be added here -->
                            </div>
                            <small class="text-muted">Recommended size: 800x800px. Max file size: 5MB per image</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createProduct()">Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for handling tab change to load products -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for tab changes
            const productsTab = document.getElementById('products-tab');
            
            if (productsTab) {
                productsTab.addEventListener('shown.bs.tab', function() {
                    loadProducts();
                });
            }

            // Add event listener for Add New Product modal
            const addProductModal = document.getElementById('addProductModal');
            if (addProductModal) {
                addProductModal.addEventListener('show.bs.modal', function() {
                    const isEditMode = document.getElementById('addProductModal').hasAttribute('data-edit-id');
                    if (isEditMode) {
                        console.log('Opening modal in edit mode');
                    } else {
                        console.log('Add new button clicked - resetting form and opening add new product modal in create mode');
                        resetProductModal();
                    }
                });

                // Add listener for when modal is hidden
                addProductModal.addEventListener('hidden.bs.modal', function() {
                    console.log('Modal closed - clearing edit mode');
                    document.getElementById('addProductModal').removeAttribute('data-edit-id');
                });
            }

            // Add click handler for Add New Product button
            const addNewProductBtn = document.querySelector('[data-bs-target="#addProductModal"]');
            if (addNewProductBtn) {
                addNewProductBtn.addEventListener('click', function() {
                    console.log('Add New Product button clicked - ensuring create mode');
                    document.getElementById('addProductModal').removeAttribute('data-edit-id');
                    document.getElementById('addProductModalLabel').textContent = 'Add New Product';
                    document.querySelector('#addProductModal .btn-primary').textContent = 'Add Product';
                });
            }
        });

        function resetProductModal() {
            // Reset form fields
            document.getElementById('productForm').reset();
            document.getElementById('imagesPreviewContainer').innerHTML = '';
            document.getElementById('sizesList').innerHTML = '';
            document.getElementById('sizesContainer').style.display = 'none';
            document.getElementById('singleInventoryContainer').style.display = 'block';
            
            // Reset modal state
            document.getElementById('addProductModal').removeAttribute('data-edit-id');
            document.getElementById('addProductModalLabel').textContent = 'Add New Product';
            document.querySelector('#addProductModal .btn-primary').textContent = 'Add Product';
        }

        // Updated product list function to support multiple images
        function addProductToList(name, price, description, imageUrl, productId, imageUrls = []) {
            const productList = document.getElementById('productList');
            
            // Check if product already exists in the list
            const existingProduct = productId ? document.querySelector(`.product-item[data-id="${productId}"]`) : null;
            
            if (existingProduct) {
                // Update existing product
                existingProduct.querySelector('img').src = imageUrl;
                existingProduct.querySelector('h3').textContent = name;
                existingProduct.querySelector('.product-price').textContent = `$${parseFloat(price).toFixed(2)}`;
                existingProduct.querySelector('.product-description').textContent = description || 'No description available';
                // Store all image URLs as a data attribute
                if (imageUrls.length) {
                    existingProduct.setAttribute('data-image-urls', JSON.stringify(imageUrls));
                }
            } else {
                // Create new product item
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.setAttribute('data-id', productId);
                if (imageUrls.length) {
                    productItem.setAttribute('data-image-urls', JSON.stringify(imageUrls));
                }
                
                productItem.innerHTML = `
                    <img src="${imageUrl}" alt="${name}">
                    <div class="product-item-content">
                        <h3>${name}</h3>
                        <div class="product-price">$${parseFloat(price).toFixed(2)}</div>
                        <div class="product-description">${description || 'No description available'}</div>
                        <div class="product-actions">
                            <button class="btn-view" onclick="showProductDetails('${productId}')"><i class="fas fa-eye"></i> View</button>
                            <button class="btn-edit" onclick="editProduct('${productId}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-delete" onclick="deleteProduct('${productId}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                productList.appendChild(productItem);
            }
        }

        // Enhanced load products function with better error logging
        function loadProducts() {
            console.log('Starting loadProducts function');
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                console.error('No studio ID found in localStorage.');
                const productList = document.getElementById('productList');
                if (productList) {
                    productList.innerHTML = '<div class="error-loading">Error: No studio ID found. Please try logging in again.</div>';
                }
                return;
            }
            console.log('Studio ID found:', studioId);

            const productList = document.getElementById('productList');
            if (!productList) {
                console.error('Product list element not found in the DOM.');
                return;
            }

            // Clear existing products
            productList.innerHTML = '<div class="loading-products"><i class="fas fa-spinner fa-spin"></i> Loading products...</div>';
            console.log('Cleared product list, showing loading indicator');

            // Check if Firebase is initialized
            if (!firebase || !firebase.firestore) {
                console.error('Firebase or Firestore is not initialized');
                productList.innerHTML = '<div class="error-loading">Error: Firebase not initialized. Please refresh the page.</div>';
                return;
            }

            console.log('Attempting to fetch products from Firestore');
            console.log('Query path: Studios/' + studioId + '/Products');
            
            // OPTION 1: Simplest solution - just get all products without filtering or ordering
            firebase.firestore()
                .collection('Studios')
                .doc(studioId)
                .collection('Products')
                .get()
                .then((querySnapshot) => {
                    console.log('Query executed successfully');
                    
                    // Remove loading indicator
                    const loadingElement = document.querySelector('.loading-products');
                    if (loadingElement) {
                        loadingElement.remove();
                    }

                    if (querySnapshot.empty) {
                        console.log('No products found in Firestore');
                        productList.innerHTML = '<div class="no-products">No products found. Add your first product!</div>';
                        return;
                    }

                    console.log('Found ' + querySnapshot.size + ' products');
                    
                    // Client-side filtering and sorting
                    const products = [];
                    querySnapshot.forEach((doc) => {
                        const productData = doc.data();
                        
                        // Only include active products (client-side filtering)
                        if (productData.Active === true) {
                            products.push({
                                id: doc.id,
                                data: productData
                            });
                        }
                    });
                    
                    // Sort by CreatedAt if available (client-side sorting)
                    products.sort((a, b) => {
                        const timeA = a.data.CreatedAt ? a.data.CreatedAt.toMillis() : 0;
                        const timeB = b.data.CreatedAt ? b.data.CreatedAt.toMillis() : 0;
                        return timeB - timeA; // descending order (newest first)
                    });
                    
                    if (products.length === 0) {
                        productList.innerHTML = '<div class="no-products">No active products found. Add your first product!</div>';
                        return;
                    }
                    
                    // Display the filtered and sorted products
                    products.forEach(product => {
                        const productData = product.data;
                        console.log('Processing product document:', product.id);
                        
                        try {
                            const imageUrls = productData.ImageUrls || [productData.ImageUrl];
                            addProductToList(
                                productData.Name || 'Unnamed Product', 
                                productData.Price || 0, 
                                productData.Description || '', 
                                productData.ImageUrl || (imageUrls && imageUrls[0]) || '', 
                                product.id,
                                imageUrls
                            );
                            console.log('Successfully added product to list:', product.id);
                        } catch (err) {
                            console.error('Error adding product to list:', err, product.id);
                        }
                    });
                })
                .catch((error) => {
                    console.error('Error loading products from Firestore:', error);
                    productList.innerHTML = `<div class="error-loading">Error loading products: ${error.message}</div>`;
                });
        }

        // Let's also add a helper function to debug Firebase initialization
        function checkFirebaseStatus() {
            console.log('Checking Firebase status:');
            if (typeof firebase === 'undefined') {
                console.error('Firebase is not defined');
                return false;
            }
            
            console.log('Firebase version:', firebase.SDK_VERSION);
            
            if (!firebase.apps || !firebase.apps.length) {
                console.error('Firebase has not been initialized');
                return false;
            }
            
            console.log('Firebase app initialized');
            
            if (!firebase.auth) {
                console.error('Firebase auth is not available');
                return false;
            }
            
            console.log('Firebase auth is available');
            
            if (!firebase.firestore) {
                console.error('Firebase firestore is not available');
                return false;
            }
            
            console.log('Firebase firestore is available');
            return true;
        }

        // Call this when document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking Firebase status');
            
            // Check Firebase status on page load
            setTimeout(checkFirebaseStatus, 1000);
            
            // Add event listener for tab changes with better error handling
            const productsTab = document.getElementById('products-tab');
            
            if (productsTab) {
                console.log('Products tab found, adding event listener');
                productsTab.addEventListener('shown.bs.tab', function() {
                    console.log('Products tab shown, loading products');
                    try {
                        loadProducts();
                    } catch (err) {
                        console.error('Uncaught error in loadProducts:', err);
                        const productList = document.getElementById('productList');
                        if (productList) {
                            productList.innerHTML = `<div class="error-loading">Unexpected error: ${err.message}</div>`;
                        }
                    }
                });
            } else {
                console.warn('Products tab element not found');
            }
            
            // Also initialize file upload for multiple images
            try {
                initializeMultiImageUpload();
                console.log('Multi-image upload initialized');
            } catch (err) {
                console.error('Error initializing multi-image upload:', err);
            }
        });
    </script>

    <!-- Template selection and management -->
    <script>
        function selectTemplate(templateName) {
            console.log(`Selected template: ${templateName}`);
            
            // Update UI to show selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
                const statusText = card.querySelector('.status-text');
                if (statusText) statusText.textContent = 'Select Template';
            });
            
            const selectedCard = document.querySelector(`.template-card[data-template="${templateName}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                const statusText = selectedCard.querySelector('.status-text');
                if (statusText) statusText.textContent = 'Selected';
            }
            
            // Show preview container
            const previewContainer = document.getElementById('templatePreviewContainer');
            if (previewContainer) {
                previewContainer.style.display = 'block';
                
                // In a real implementation, you would load a dynamic preview with the studio's
                // colors, logo, and products. For now, we'll simulate this with a placeholder:
                const previewFrame = document.getElementById('templatePreviewFrame');
                if (previewFrame) {
                    // This would be a real URL to a preview generator in production
                    previewFrame.src = `about:blank`; // Reset the iframe
                    
                    // Set a timeout to simulate loading
                    setTimeout(() => {
                        // Get studio colors for customization
                        const primaryColor = getComputedStyle(document.documentElement)
                            .getPropertyValue('--primary-color').trim();
                        const secondaryColor = getComputedStyle(document.documentElement)
                            .getPropertyValue('--secondary-color').trim();
                        
                        // Create a simple preview HTML directly in the iframe
                        const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                        doc.open();
                        doc.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="utf-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1">
                                <title>Store Template Preview</title>
                                <style>
                                    :root {
                                        --primary-color: ${primaryColor || '#3DCED7'};
                                        --secondary-color: ${secondaryColor || '#3A506B'};
                                    }
                                    body {
                                        font-family: 'Segoe UI', sans-serif;
                                        margin: 0;
                                        padding: 0;
                                        color: #333;
                                    }
                                    .preview-header {
                                        background-color: var(--primary-color);
                                        color: white;
                                        padding: 15px;
                                        text-align: center;
                                    }
                                    .preview-content {
                                        padding: 20px;
                                    }
                                    .preview-footer {
                                        background-color: var(--secondary-color);
                                        color: white;
                                        padding: 15px;
                                        text-align: center;
                                    }
                                    .preview-products {
                                        display: grid;
                                        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                                        gap: 15px;
                                        margin-top: 20px;
                                    }
                                    .preview-product {
                                        border: 1px solid #eee;
                                        border-radius: 5px;
                                        overflow: hidden;
                                    }
                                    .preview-product img {
                                        width: 100%;
                                        height: 150px;
                                        object-fit: cover;
                                    }
                                    .preview-product-info {
                                        padding: 10px;
                                    }
                                    .preview-product-title {
                                        margin: 0 0 5px 0;
                                        font-weight: 600;
                                    }
                                    .preview-product-price {
                                        font-weight: bold;
                                        color: var(--primary-color);
                                    }
                                    .template-${templateName} .special-feature {
                                        background-color: var(--${templateName === 'modern' ? 'primary' : 'secondary'}-color);
                                        color: white;
                                        padding: 20px;
                                        margin: 20px 0;
                                        border-radius: 5px;
                                        text-align: center;
                                    }
                                </style>
                            </head>
                            <body class="template-${templateName}">
                                <div class="preview-header">
                                    <h1>Your Studio Store</h1>
                                </div>
                                <div class="preview-content">
                                    <h2>Welcome to our store</h2>
                                    <p>This is a preview of the ${templateName} template for your studio store.</p>
                                    
                                    <div class="special-feature">
                                        ${templateName === 'modern' 
                                            ? '<h3>Featured Products Carousel</h3><p>Your best products will be showcased here</p>' 
                                            : '<h3>Studio Story Section</h3><p>Tell your customers about your studio journey</p>'}
                                    </div>
                                    
                                    <h3>Products</h3>
                                    <div class="preview-products">
                                        <!-- Sample products - in reality, these would be your actual products -->
                                        <div class="preview-product">
                                            <img src="https://via.placeholder.com/300x300/f5f5f5/333?text=Product" alt="Product">
                                            <div class="preview-product-info">
                                                <h4 class="preview-product-title">Product Name</h4>
                                                <div class="preview-product-price">$99.99</div>
                                            </div>
                                        </div>
                                        <div class="preview-product">
                                            <img src="https://via.placeholder.com/300x300/f5f5f5/333?text=Product" alt="Product">
                                            <div class="preview-product-info">
                                                <h4 class="preview-product-title">Product Name</h4>
                                                <div class="preview-product-price">$99.99</div>
                                            </div>
                                        </div>
                                        <div class="preview-product">
                                            <img src="https://via.placeholder.com/300x300/f5f5f5/333?text=Product" alt="Product">
                                            <div class="preview-product-info">
                                                <h4 class="preview-product-title">Product Name</h4>
                                                <div class="preview-product-price">$99.99</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="preview-footer">
                                    <p>© ${new Date().getFullYear()} Your Studio Name. All rights reserved.</p>
                                </div>
                            </body>
                            </html>
                        `);
                        doc.close();
                    }, 500);
                }
            }
            
            // Store the selected template
            localStorage.setItem('selectedStoreTemplate', templateName);
        }

        function hideTemplatePreview() {
            const previewContainer = document.getElementById('templatePreviewContainer');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        }

        // Enhanced saveStoreLayout function with more detailed data saving
        function saveStoreLayout() {
            const selectedTemplate = localStorage.getItem('selectedStoreTemplate');
            if (!selectedTemplate) {
                showToast('Error', 'Please select a template first');
                return;
            }
            
            // Show saving state
            const saveBtn = document.getElementById('saveTemplateBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                showToast('Error', 'No studio ID found. Please log in again.');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                return;
            }
            
            console.log(`Saving template "${selectedTemplate}" to StoreLayout collection for studio ${studioId}`);
            
            // Get studio colors for storing with template
            const primaryColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--primary-color').trim();
            const secondaryColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--secondary-color').trim();
            
            // Save comprehensive data to Firestore
            firebase.firestore()
                .collection('Studios')
                .doc(studioId)
                .collection('StoreLayout')
                .doc('settings')
                .set({
                    TemplateType: selectedTemplate,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    StudioColors: {
                        Primary: primaryColor,
                        Secondary: secondaryColor
                    },
                    IsPublished: true,
                    LastModifiedBy: firebase.auth().currentUser ? firebase.auth().currentUser.email : 'unknown'
                }, { merge: true })
                .then(() => {
                    console.log('Store layout saved successfully to Firestore!');
                    showToast('Success', 'Store layout saved successfully');
                    
                    // Update main studio document to reference this template is active
                    return firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .update({
                            StoreLayoutTemplate: selectedTemplate,
                            StoreLastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                })
                .then(() => {
                    console.log('Main studio document updated with template reference');
                    // Load the selected template on page load next time
                    localStorage.setItem('storeLayoutSaved', 'true');
                })
                .catch(error => {
                    console.error('Error saving store layout:', error);
                    showToast('Error', `Failed to save store layout: ${error.message}`);
                })
                .finally(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                });
        }

        // Load saved template when store layout tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            const storeLayoutTab = document.getElementById('store-layout-tab');
            
            if (storeLayoutTab) {
                storeLayoutTab.addEventListener('shown.bs.tab', function() {
                    // Load saved template selection from Firestore
                    const studioId = localStorage.getItem('currentStudioId');
                    if (!studioId) return;
                    
                    firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('StoreLayout')
                        .doc('settings')
                        .get()
                        .then(doc => {
                            if (doc.exists && doc.data().TemplateType) {
                                const savedTemplate = doc.data().TemplateType;
                                // Pre-select the saved template
                                selectTemplate(savedTemplate);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading saved template:', error);
                        });
                });
            }
        });
    </script>

    <!-- Add this to the existing script section near the end of the file -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Setup the Open Studio Store button
            setupStoreButton();
        });

        // Function to set up the store button with the correct link
        function setupStoreButton() {
            const storeButton = document.getElementById('openStoreButton');
            if (!storeButton) return;
            
            const studioId = localStorage.getItem('currentStudioId');
            const studioData = JSON.parse(localStorage.getItem('currentStudioData') || '{}');
            const studioName = studioData?.StudioName || '';
            
            if (studioId && studioName) {
                const encodedStudioName = encodeURIComponent(studioName);
                storeButton.href = `https://studiosyncdance.com/store?studio=${encodedStudioName}&sid=${studioId}`;
            } else {
                storeButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    showToast('Error', 'Studio information not available. Please refresh the page.');
                });
            }
        }
    </script>

    <script>
        // ... existing code ...

        // Size management functions
        document.getElementById('hasMultipleSizes').addEventListener('change', function() {
            const sizesContainer = document.getElementById('sizesContainer');
            const singleInventoryContainer = document.getElementById('singleInventoryContainer');
            
            if (this.checked) {
                sizesContainer.style.display = 'block';
                singleInventoryContainer.style.display = 'none';
            } else {
                sizesContainer.style.display = 'none';
                singleInventoryContainer.style.display = 'block';
            }
        });

        function addSizeInput() {
            const sizesList = document.getElementById('sizesList');
            const sizeDiv = document.createElement('div');
            sizeDiv.className = 'size-input-group mb-2';
            sizeDiv.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Size (e.g., S, M, L)" required>
                    <input type="number" class="form-control" placeholder="Quantity" min="0" value="0" required>
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            sizesList.appendChild(sizeDiv);
        }

        function getSizesData() {
            const hasMultipleSizes = document.getElementById('hasMultipleSizes').checked;
            
            if (!hasMultipleSizes) {
                return {
                    HasMultipleSizes: false,
                    Inventory: parseInt(document.getElementById('singleInventory').value) || 0
                };
            }

            const sizes = [];
            
            // Handle both edit mode (size-row) and add mode (size-input-group)
            document.querySelectorAll('#sizesList .size-row, #sizesList .size-input-group').forEach(group => {
                let sizeName, quantity;
                
                if (group.classList.contains('size-row')) {
                    // Edit mode
                    sizeName = group.querySelector('.size-name').value;
                    quantity = parseInt(group.querySelector('.size-inventory').value) || 0;
                } else {
                    // Add mode
                    const inputs = group.querySelectorAll('input');
                    sizeName = inputs[0].value;
                    quantity = parseInt(inputs[1].value) || 0;
                }
                
                if (sizeName) {
                    sizes.push({
                        Size: sizeName.toLowerCase(),
                        Quantity: quantity
                    });
                }
            });

            return {
                HasMultipleSizes: true,
                Sizes: sizes
            };
        }

       
    </script>

    <script>
        // Add this to your existing script section
        document.getElementById('productImage').addEventListener('change', function(e) {
            const previewContainer = document.getElementById('imagesPreviewContainer');
            previewContainer.innerHTML = ''; // Clear existing previews
            
            if (this.files) {
                Array.from(this.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const container = document.createElement('div');
                        container.style.position = 'relative';
                        container.style.display = 'inline-block';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-preview';
                        removeBtn.innerHTML = '×';
                        removeBtn.onclick = function() {
                            container.remove();
                        };
                        
                        container.appendChild(img);
                        container.appendChild(removeBtn);
                        previewContainer.appendChild(container);
                    }
                    reader.readAsDataURL(file);
                });
            }
        });
    </script>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Product Overview Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card header-card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div id="productImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                                                <div class="carousel-inner" id="productImagesContainer">
                                                    <!-- Product images will be added here -->
                                                </div>
                                                <button class="carousel-control-prev" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="prev">
                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                    <span class="visually-hidden">Previous</span>
                                                </button>
                                                <button class="carousel-control-next" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="next">
                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                    <span class="visually-hidden">Next</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <h3 id="productDetailsName" class="mb-3"></h3>
                                            <h4 id="productDetailsPrice" class="text-primary mb-4"></h4>
                                            <p id="productDetailsDescription" class="mb-4"></p>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6 class="text-muted mb-2">Inventory</h6>
                                                    <p id="productDetailsInventory" class="mb-0"></p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-muted mb-2">Status</h6>
                                                    <p id="productDetailsStatus" class="mb-0"></p>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <button class="btn btn-primary me-2" onclick="editProductFromDetails()">
                                                    <i class="fas fa-edit me-2"></i>Edit Product
                                                </button>
                                                <button class="btn btn-danger" onclick="deleteProductFromDetails()">
                                                    <i class="fas fa-trash me-2"></i>Delete Product
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Sizes Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Size Information</h5>
                                </div>
                                <div class="card-body">
                                    <div id="productSizesContainer">
                                        <!-- Size information will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to show product details
        function showProductDetails(productId) {
            const db = firebase.firestore();
            const studioId = localStorage.getItem('currentStudioId');
            
            db.collection('Studios')
                .doc(studioId)
                .collection('Products')
                .doc(productId)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        const productData = doc.data();
                        
                        // Set basic product information
                        document.getElementById('productDetailsName').textContent = productData.Name;
                        document.getElementById('productDetailsPrice').textContent = `$${parseFloat(productData.Price).toFixed(2)}`;
                        document.getElementById('productDetailsDescription').textContent = productData.Description || 'No description available';
                        
                        // Set inventory and status
                        if (productData.HasMultipleSizes) {
                            const totalInventory = productData.Sizes.reduce((sum, size) => sum + (parseInt(size.Quantity) || 0), 0);
                            document.getElementById('productDetailsInventory').textContent = `${totalInventory} total items`;
                        } else {
                            document.getElementById('productDetailsInventory').textContent = `${productData.Inventory || 0} items`;
                        }
                        document.getElementById('productDetailsStatus').textContent = productData.Active ? 'Active' : 'Inactive';
                        
                        // Set up image carousel
                        const imagesContainer = document.getElementById('productImagesContainer');
                        imagesContainer.innerHTML = '';
                        
                        if (productData.ImageUrls && productData.ImageUrls.length > 0) {
                            productData.ImageUrls.forEach((imageUrl, index) => {
                                const carouselItem = document.createElement('div');
                                carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                                carouselItem.innerHTML = `<img src="${imageUrl}" class="d-block w-100" alt="Product image ${index + 1}">`;
                                imagesContainer.appendChild(carouselItem);
                            });
                        } else if (productData.ImageUrl) {
                            const carouselItem = document.createElement('div');
                            carouselItem.className = 'carousel-item active';
                            carouselItem.innerHTML = `<img src="${productData.ImageUrl}" class="d-block w-100" alt="Product image">`;
                            imagesContainer.appendChild(carouselItem);
                        }
                        
                        // Set up size information
                        const sizesContainer = document.getElementById('productSizesContainer');
                        sizesContainer.innerHTML = '';
                        
                        if (productData.HasMultipleSizes && productData.Sizes) {
                            const sizeTable = document.createElement('table');
                            sizeTable.className = 'table table-hover';
                            sizeTable.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productData.Sizes.map(size => `
                                        <tr>
                                            <td>${size.Size}</td>
                                            <td>${size.Quantity || 0}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            `;
                            sizesContainer.appendChild(sizeTable);
                        } else {
                            sizesContainer.innerHTML = '<p class="text-muted mb-0">No size variations available</p>';
                        }
                        
                        // Store the product ID for edit/delete operations
                        document.getElementById('productDetailsModal').setAttribute('data-product-id', productId);
                        
                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
                        modal.show();
                    }
                })
                .catch(error => {
                    console.error('Error loading product details:', error);
                    showToast('Error', 'Failed to load product details');
                });
        }

        // Function to edit product from details modal
        function editProductFromDetails() {
            const productId = document.getElementById('productDetailsModal').getAttribute('data-product-id');
            if (productId) {
                editProduct(productId);
                const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailsModal'));
                modal.hide();
            }
        }

        // Function to delete product from details modal
        function deleteProductFromDetails() {
            const productId = document.getElementById('productDetailsModal').getAttribute('data-product-id');
            if (productId) {
                deleteProduct(productId);
                const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailsModal'));
                modal.hide();
            }
        }

        // Function to load orders into the table
        async function loadOrders() {
            try {
                console.log('Starting to load orders...');
                
                // Get the studio ID from localStorage
                const studioId = localStorage.getItem('currentStudioId');
                console.log('Studio ID from localStorage:', studioId);
                
                if (!studioId) {
                    throw new Error('Studio ID not found in localStorage');
                }

                // Get Firestore instance
                const db = firebase.firestore();
                console.log('Firestore instance obtained');
                
                // Fetch orders from the correct path: Studios/{studioId}/Orders
                console.log('Attempting to fetch orders from path: Studios/', studioId, '/Orders');
                const ordersSnapshot = await db
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Orders')
                    .orderBy('PaymentDate', 'desc')
                    .get();
                
                console.log('Orders snapshot received, size:', ordersSnapshot.size);
                
                const orders = [];
                ordersSnapshot.forEach(doc => {
                    const orderData = doc.data();
                    console.log('Processing order:', doc.id, orderData);
                    orders.push({
                        ...orderData,
                        OrderId: doc.id
                    });
                });
                
                console.log('Total orders processed:', orders.length);
                console.log('Orders array:', orders);
                
                const tableBody = document.querySelector('#ordersTable tbody');
                tableBody.innerHTML = ''; // Clear existing rows
                
                if (!orders || orders.length === 0) {
                    console.log('No orders found in the array');
                    tableBody.innerHTML = `
                        <tr class="text-center text-muted">
                            <td colspan="8">No orders found</td>
                        </tr>
                    `;
                    return;
                }
                
                console.log('Starting to render orders in table...');
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    
                    // Format the date
                    const paymentDate = new Date(order.PaymentDate).toLocaleString();
                    
                    // Create status badge
                    const statusClasses = {
                        'Completed': 'bg-success',
                        'Pending': 'bg-warning',
                        'Failed': 'bg-danger'
                    };
                    const statusClass = statusClasses[order.Status] || 'bg-secondary';
                    
                    // Format total amount
                    const total = `$${parseFloat(order.Total).toFixed(2)}`;
                    
                    row.innerHTML = `
                        <td>${order.OrderId}</td>
                        <td>${paymentDate}</td>
                        <td>${order.CustomerInfo.Name}</td>
                        <td>${order.CustomerInfo.Email}</td>
                        <td>${order.CustomerInfo.Phone}</td>
                        <td>${total}</td>
                        <td><span class="badge ${statusClass}">${order.Status}</span></td>
                        <td>
                            <div class="btn-group">
                                <div class="dropdown">
                                    <button class="btn btn-link dropdown-toggle p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="viewOrderDetails('${order.OrderId}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteOrder('${order.OrderId}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                console.log('All orders have been rendered in the table');
            } catch (error) {
                console.error('Error loading orders:', error);
                console.error('Error stack:', error.stack);
                const tableBody = document.querySelector('#ordersTable tbody');
                tableBody.innerHTML = `
                    <tr class="text-center text-danger">
                        <td colspan="8">Error loading orders: ${error.message}</td>
                    </tr>
                `;
            }
        }

        // Function to view order details
        function viewOrderDetails(orderId) {
            // Implement your order details viewing logic here
            console.log('Viewing order:', orderId);
        }

        // Function to calculate and update dashboard metrics
        function updateDashboardMetrics(orders) {
            // Calculate total sales
            const totalSales = orders.reduce((sum, order) => {
                return sum + (order.Status === 'Completed' ? order.Total : 0);
            }, 0);
            
            // Calculate total products purchased
            const totalProducts = orders.reduce((sum, order) => {
                return sum + (order.Status === 'Completed' ? 
                    order.Items.reduce((itemSum, item) => itemSum + item.Quantity, 0) : 0);
            }, 0);
            
            // Track unique customers
            const customerMap = new Map();
            let newCustomers = 0;
            let returningCustomers = 0;
            
            orders.forEach(order => {
                if (order.Status === 'Completed') {
                    const customerId = order.CustomerInfo.FamilyId;
                    if (!customerMap.has(customerId)) {
                        customerMap.set(customerId, 1);
                        newCustomers++;
                    } else {
                        customerMap.set(customerId, customerMap.get(customerId) + 1);
                        if (customerMap.get(customerId) === 2) {
                            newCustomers--;
                            returningCustomers++;
                        }
                    }
                }
            });
            
            // Update dashboard elements
            document.getElementById('totalSales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('productsPurchased').textContent = totalProducts;
            document.getElementById('newCustomers').textContent = newCustomers;
            document.getElementById('returningCustomers').textContent = returningCustomers;
        }

        // Initialize orders table when the orders tab is shown
        document.getElementById('orders-tab').addEventListener('shown.bs.tab', function() {
            loadOrders();
        });

        // Initialize dashboard metrics when the dashboard tab is shown
        document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function() {
            // Load orders to update dashboard metrics
            loadOrders();
        });

        // Function to delete an order
        async function deleteOrder(orderId) {
            try {
                const confirmed = confirm('Are you sure you want to delete this order? This action cannot be undone.');
                if (!confirmed) return;

                const studioId = localStorage.getItem('currentStudioId');
                if (!studioId) {
                    throw new Error('Studio ID not found');
                }

                const db = firebase.firestore();
                await db
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Orders')
                    .doc(orderId)
                    .delete();

                // Reload orders after deletion
                loadOrders();
                // Update dashboard metrics
                updateDashboardMetrics();
                
                // Show success message
                alert('Order deleted successfully');
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error deleting order: ' + error.message);
            }
        }
    </script>
</body>
</html>