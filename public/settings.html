<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Recreational Classes - Studio Sync</title>
    <!-- Favicon -->
    <link rel="icon" href="assets/ssdancer.svg" type="image/svg+xml">

    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-...+..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Custom CSS for Modern Styling -->
    <style>
        :root {
            --primary-color: #3DCED7;
            --primary-hover: #36B8C0;
            --secondary-color: #3A506B;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #sidebar-wrapper {
            background-color: var(--primary-color);
            min-height: 100vh;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-heading {
            color: white;
            background-color: var(--primary-color);
            padding: 1.5rem 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .list-group-item {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease, padding 0.3s ease, transform 0.3s ease;
            padding: 1rem 1.5rem;
        }

        .list-group-item:hover,
        .list-group-item-action:focus {
            background-color: var(--primary-hover);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
        }

        .navbar .navbar-nav .nav-link {
            color: #333;
            transition: color 0.3s ease;
        }

        .navbar .navbar-nav .nav-link:hover {
            color: var(--primary-color);
        }

        .container-fluid {
            background-color: #fff;
            color: #525f7f;
            padding: 2rem;
        }

        /* Modernized Dashboard Content */
        .dashboard-insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .dashboard-insights .insight-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
        }

        .insight-box h3 {
            font-size: 1.2rem;
            color: #525f7f;
            margin-bottom: 0.5rem;
        }

        .insight-box p {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin: 0;
        }

        .progress-ring {
            margin-top: 20px;
        }

        /* Schedule Table */
        .schedule-table {
            margin-top: 2rem;
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .schedule-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .schedule-table td {
            background-color: #f9f9f9;
        }

        /* New styles for the pie chart and layout */
        .dashboard-container {
            display: flex;
            gap: 1.5rem; /* Match the gap of dashboard-insights */
        }

        .pie-chart-container {
            flex: 0.8;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: calc(100% - 3rem); /* Subtract padding to match KPI cards exactly */
            transition: box-shadow 0.3s ease;
        }

        .pie-chart-container:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .chart-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .capacity-input-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }

        .capacity-input-container label {
            font-size: 0.8rem;
            margin-right: 0.5rem;
            color: #525f7f;
        }

        #capacityInput {
            width: 60px;
            padding: 0.3rem 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #525f7f;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }

        #capacityInput:focus {
            outline: none;
            border-color: #3DCED7;
            box-shadow: 0 0 0 2px rgba(61, 206, 215, 0.1);
            background-color: #ffffff;
        }

        #capacityInput::-webkit-inner-spin-button,
        #capacityInput::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #capacityInput {
            -moz-appearance: textfield;
        }

        .kpi-container {
            flex: 2;
        }

        .dashboard-insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            height: 100%;
        }

        .insight-box {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Payment form styles */
        #payment-form {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #card-element {
            margin-bottom: 20px;
        }

        #submit-payment {
            background-color: #3DCED7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #submit-payment:hover {
            background-color: #36B8C0;
        }

        #submit-payment:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Subscription form styles */
        .subscription-form {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .subscription-form input, .subscription-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .subscription-form button {
            background-color: #3DCED7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .subscription-form button:hover {
            background-color: #36B8C0;
        }

        .navbar-nav .dropdown-menu {
            min-width: 250px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 0;
        }

        .navbar-nav .dropdown-item {
            padding: 12px 20px;
            color: #333;
            transition: background-color 0.3s ease;
        }

        .navbar-nav .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .navbar-nav .dropdown-divider {
            margin: 0;
            border-top-color: #e9ecef;
        }

        .navbar-nav .dropdown-header {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            background-color: #f8f9fa;
        }

        .navbar-nav .dropdown-item-text {
            padding: 12px 20px;
            color: #6c757d;
        }

        .fa-user-circle {
            font-size: 1.8em; /* Slightly smaller profile icon */
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            padding: 0.5rem 0.5rem;
        }

        .fa-bell {
            font-size: 1.2em;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 0.6em;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-weight: bold;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
        }

        .notification-icon {
            margin-right: 15px;
            font-size: 1.2em;
            color: #3DCED7;
        }

        .notification-content {
            flex-grow: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .notification-subtitle {
            font-size: 0.85em;
            color: #6c757d;
        }

        .navbar-nav .dropdown-toggle::after {
            display: none;
        }

        @media (max-width: 991.98px) {
            .navbar-brand-center {
                position: static;
                transform: none;
            }

            .navbar-nav {
                flex-direction: row;
            }

            .nav-item.dropdown {
                position: static;
            }

            .dropdown-menu {
                left: 0;
                right: 0;
                width: 100%;
            }
        }

        @media (max-width: 575.98px) {
            .navbar-brand-center {
                max-width: 200px;
                margin: 0 auto;
            }

            #studio-logo, #studio-name {
                max-width: 100%;
            }

            .navbar-nav {
                justify-content: center;
            }
        }

        /* Add styles for the page content wrapper */
        #page-content-wrapper {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
        }

        /* Update the wrapper styles */
        #wrapper {
            display: flex;
            overflow: hidden;
            height: 100vh;
        }

        /* Sidebar overlay styles */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1045;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 768px) {
            #sidebar-wrapper {
                margin-left: -250px;
                transition: margin 0.3s ease-out;
                position: fixed;
                z-index: 1050;
                height: 100vh;
            }

            .sidebar-overlay.show {
                display: block;
            }

            #wrapper.toggled #sidebar-wrapper {
                margin-left: 0;
            }
        }

        /* Wrapper transitions */
        #wrapper.toggled #sidebar-wrapper {
            margin-left: -250px;
        }

        #wrapper.toggled #page-content-wrapper {
            margin-left: 0;
        }

        /* Update the toggle button styles */
        #sidebarToggle {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transition: all 0.3s ease;
        }

        #sidebarToggle:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Update other elements that use the primary color */
        .navbar .navbar-nav .nav-link:hover {
            color: var(--primary-color);
        }

        .insight-box p {
            color: var(--primary-color);
        }

        .schedule-table th {
            background-color: var(--primary-color);
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .loading-content {
            text-align: center;
        }

        .loading-text {
            margin-top: 20px;
        }

        .loading-text h2 {
            color: #ffffff;
            margin-bottom: 10px;
            transition: color 0.5s ease;
        }

        .loading-text p {
            color: #ffffff;
            font-size: 1.1em;
            transition: color 0.5s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ffffff;
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 1s linear infinite;
            transition: border-top-color 0.5s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* User Avatar Styles */
        .user-avatar {
            width: 38px;
            height: 38px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .initials {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Profile Dropdown Styles */
        .dropdown-menu .dropdown-item-text#studioNameDisplay {
            padding: 0.3rem 1.5rem;
            margin: 0;
            color: #333333;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .dropdown-menu .dropdown-item-text#userRole {
            padding: 0.2rem 1.5rem;
            margin: 0;
            color: #666;
            font-size: 0.85rem;
            font-weight: 400;
        }

        /* User Profile Styles */
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.75rem);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            padding: 1rem 0;
            min-width: 280px;
            display: none;
            z-index: 1000;
            border: 1px solid rgba(0,0,0,0.08);
            position: fixed;
            margin-right: 1rem;
        }

        /* Responsive Styles */
        @media (max-width: 991.98px) {
            .dashboard-container {
                flex-direction: column;
                gap: 1.5rem;
            }

            .pie-chart-container {
                width: 100%;
                min-height: 300px;
            }

            .kpi-container {
                width: 100%;
            }

            .dashboard-insights {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .insight-box {
                padding: 1rem;
            }

            .insight-box h3 {
                font-size: 1rem;
            }

            .insight-box p {
                font-size: 2rem;
            }

            .schedule-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .schedule-table th,
            .schedule-table td {
                padding: 8px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 575.98px) {
            .dashboard-insights {
                grid-template-columns: 1fr;
            }

            .container-fluid {
                padding: 1rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .pie-chart-container {
                min-height: 250px;
            }

            .insight-box {
                margin-bottom: 0.5rem;
            }

            .schedule-table th,
            .schedule-table td {
                padding: 6px;
                font-size: 0.85rem;
            }

            #wrapper {
                min-height: 100vh;
                overflow-x: hidden;
                position: relative;
            }

            #sidebar-wrapper {
                margin-left: -250px;
                transition: margin 0.25s ease-out;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1050;
                width: 250px;
            }

            #wrapper.toggled #sidebar-wrapper {
                margin-left: 0;
            }

            #page-content-wrapper {
                min-width: 100vw;
                margin-left: 0;
                transition: margin 0.25s ease-out;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1045;
            }

            #wrapper.toggled .sidebar-overlay {
                display: block;
            }

            /* Adjust navbar for mobile */
            .navbar {
                padding: 0.5rem;
            }

            .navbar-brand-center {
                max-width: 150px;
            }

            #studio-logo {
                max-height: 80px;
            }

            #studio-name {
                font-size: 1.2rem;
            }

            #sidebarToggle {
                padding: 0.375rem 0.75rem;
                font-size: 0.9rem;
            }
        }

        /* Ensure content doesn't overflow on very small devices */
        @media (max-width: 360px) {
            .container-fluid {
                padding: 0.75rem;
            }

            .insight-box {
                padding: 0.75rem;
            }

            .insight-box h3 {
                font-size: 0.9rem;
            }

            .insight-box p {
                font-size: 1.75rem;
            }

            .navbar-brand-center {
                max-width: 120px;
            }

            #studio-name {
                font-size: 1rem;
            }
        }

        .badge {
            padding: 0.5em 1em;
            font-size: 0.85em;
            font-weight: 500;
            border-radius: 20px;
        }

        .bg-success {
            background-color: #28a745 !important;
        }

        .bg-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }

        .bg-danger {
            background-color: #dc3545 !important;
        }

        .schedule-table td {
            vertical-align: middle;
        }

        .schedule-table tr:hover {
            background-color: #f5f5f5;
            transition: background-color 0.3s ease;
        }

        /* Settings grid styles */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .settings-search {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .settings-search i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .settings-search input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }

        .settings-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(61, 206, 215, 0.1);
        }

        .setting-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .setting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .setting-card i {
            font-size: 2.5rem;
            color: #6c757d;
            margin-bottom: 1.2rem;
            transition: color 0.3s ease;
        }

        .setting-card:hover i {
            color: var(--primary-color);
        }

        .setting-card h3 {
            font-size: 1.4rem;
            margin-bottom: 0.8rem;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .setting-card:hover h3 {
            color: var(--primary-color);
        }

        .setting-card p {
            font-size: 1rem;
            color: #666;
            margin: 0;
        }

        .setting-card.hidden {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 2rem;
            border: none;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            color: #333;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-body {
            max-height: calc(100vh - 210px);
            overflow-y: auto;
            padding: 1rem 0;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding-top: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #6c757d;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close:hover {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Form styles for modals */
        .modal-form-group {
            margin-bottom: 1.5rem;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #495057;
            font-weight: 500;
        }

        .modal-form-group input,
        .modal-form-group select,
        .modal-form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .modal-form-group input:focus,
        .modal-form-group select:focus,
        .modal-form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(61, 206, 215, 0.1);
        }

        /* Modal buttons */
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .modal-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .modal-btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        /* Modal animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalFadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tabs .nav-link {
            margin-bottom: -1px;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
            color: #495057;
            padding: 0.5rem 1rem;
        }

        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }

        .tab-content {
            padding: 1rem 0;
        }

        #classStylesTable {
            width: 100%;
            margin-top: 1rem;
        }

        #classStylesTable th,
        #classStylesTable td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        #classTypesTable {
            width: 100%;
            margin-top: 1rem;
        }

        #classTypesTable th,
        #classTypesTable td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        #classTypesTable th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        #classTypesTable tr:hover {
            background-color: #f8f9fa;
        }

        #classTypesTable td strong {
            color: var(--primary-color);
            font-size: 1.1em;
        }

        /* Make modal larger and scrollable */
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Adjust table styles for better visibility */
        .table {
            margin-bottom: 2rem;
        }

        .table th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }

        /* Add some padding to the modal body */
        .modal-body {
            padding: 1.5rem;
        }

        /* Remove the existing #classTypesTable styles */
        #classTypesTable {
            width: 100%;
            margin-top: 1rem;
        }

        #classTypesTable th,
        #classTypesTable td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        /* Make both tables use the same styles */
        .table {
            margin-bottom: 2rem;
        }

        .table th {
            position: sticky;
            top: 0;
            background-color: white !important; /* Force white background for all table headers */
            z-index: 1;
            font-weight: 500;
            border-bottom: 2px solid #dee2e6;
            color: #333; /* Consistent text color */
        }

        .table td {
            border-bottom: 1px solid #dee2e6;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.075);
        }

        /* Remove any specific table styling */
        #classTypesTable th,
        #classStylesTable th {
            background-color: white;
            color: #333;
        }

        /* Add these styles for the payment processing modal */
        #payment-processing-modal .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(61, 206, 215, 0.25);
            border-color: var(--primary-color);
        }

        #payment-processing-modal .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #payment-processing-modal .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #payment-processing-modal .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 28px rgba(0, 0, 0, 0.1);
        }

        #payment-processing-modal .btn-primary:hover {
            background-color: var(--primary-hover) !important;
            transform: translateY(-1px);
        }

        #payment-processing-modal .form-control::placeholder {
            color: #a0aec0;
            font-size: 0.9rem;
        }

        #payment-processing-modal .input-group-text {
            color: #525f7f;
            font-weight: 500;
        }

        /* Modern tab styling */
        #billingTabs {
            border-bottom: none;
            gap: 0.5rem;
        }

        #billingTabs .nav-link {
            border: none;
            padding: 0.75rem 1.5rem;
            color: #495057;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        #billingTabs .nav-link:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
        }

        #billingTabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        /* Modern table styling */
        .billing-table {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            overflow-x: auto; /* Enable horizontal scrolling if needed */
        }

        .billing-table .table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            border: none;
            min-width: 800px; /* Ensure minimum width for readability */
        }

        .billing-table thead th {
            background-color: #f8f9fa;
            border: none;
            padding: 1rem;
            font-weight: 600;
            color: #495057;
            white-space: nowrap; /* Prevent header text from wrapping */
        }

        .billing-table tbody td {
            border: none;
            padding: 1rem;
            vertical-align: middle;
            word-break: break-word; /* Allow long text to wrap */
        }

        /* Responsive styles for billing modal */
        @media (max-width: 768px) {
            #billing-modal .modal-content {
                width: 95%;
                margin: 10px auto;
            }

            #billing-modal .card-body {
                padding: 1rem !important;
            }

            #billing-modal .d-flex {
                flex-direction: column;
                gap: 1rem !important;
            }

            #billing-modal .btn-subscription {
                width: 100%;
            }

            #billingTabs {
                flex-wrap: wrap;
            }

            #billingTabs .nav-link {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .billing-table {
                padding: 0.75rem;
                margin: 0 -0.75rem;
                border-radius: 0;
            }

            .billing-table td {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            /* Adjust badge size on mobile */
            .badge {
                padding: 0.35rem 0.75rem;
                font-size: 0.8rem;
            }

            /* Make plan name and status stack on mobile */
            .d-flex.justify-content-between {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem;
            }

            /* Adjust modal header */
            #billing-modal .modal-header {
                padding: 1rem;
            }

            #billing-modal .modal-title {
                font-size: 1.25rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 576px) {
            .billing-table {
                margin: 0 -1rem;
            }

            .billing-table td, 
            .billing-table th {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            #billing-modal .modal-body {
                padding: 1rem;
            }

            #billingTabs .nav-link {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: white !important;
        }

        .badge.bg-success {
            background-color: #10B981 !important;
        }

        .badge.bg-danger {
            background-color: #EF4444 !important;
        }

        .badge.bg-warning {
            background-color: #F59E0B !important;
        }

        /* Modern button styling */
        .btn-subscription {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-subscription:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Team table styling */
        .team-table-container {
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }

        #teamTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        #teamTable th {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: #f8f9fa;
            padding: 1rem;
            font-weight: 600;
            color: #1F2937;
            border: none;
            text-align: left;
        }

        #teamTable td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f1f1;
            color: #4B5563;
        }

        #teamTable tbody tr {
            transition: all 0.2s ease;
        }

        #teamTable tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Role badge styling */
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.125rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: var(--primary-color);
            color: white;
        }

        /* Password toggle styles */
        .password-toggle {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d;
            pointer-events: none;
        }

        /* Password requirements styles */
        .password-requirements {
            display: none;
            margin-top: 10px;
            padding-left: 20px;
            color: #dc3545;
        }

        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .requirement i {
            margin-right: 5px;
        }

        .requirement.met {
            color: #28a745;
        }

        /* Update password container and toggle styles */
        .password-container {
            position: relative;
            width: 100%;
        }

        .password-container input {
            width: 100%;
            padding-right: 45px; /* Increase right padding to make room for the eye icon */
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
            pointer-events: auto; /* Make icon clickable */
            background-color: rgba(255, 255, 255, 0.8); /* Add semi-transparent background */
            padding: 0 5px; /* Add some padding around the icon */
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        .policy-card {
            transition: all 0.3s ease;
        }

        .policy-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .policy-content {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .upload-box {
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .upload-box:hover {
            border-color: #3DCED7 !important;
            background-color: rgba(61, 206, 215, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .upload-box.has-file {
            border-style: solid !important;
            border-color: #3DCED7 !important;
            background-color: rgba(61, 206, 215, 0.05);
        }

        .upload-box .img-thumbnail {
            max-width: 120px;
            max-height: 120px;
            margin-top: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .upload-box .btn-outline-primary {
            margin-top: 1rem;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .upload-box .btn-outline-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(61, 206, 215, 0.2);
        }

        /* Update the surcharge settings colors to use primary color variable */
        #surcharge-settings-modal .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #surcharge-settings-modal .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #surcharge-settings-modal .btn-outline-primary:hover,
        #surcharge-settings-modal .btn-check:checked + .btn-outline-primary {
            color: white;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #surcharge-settings-modal .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #surcharge-settings-modal .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .modern-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e0e0e0;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toggle-input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        .toggle-input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        
    .video-item {
        transition: all 0.3s ease;
    }
    
    .video-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .video-item iframe {
        transition: all 0.3s ease;
    }
    
    .video-item:hover iframe {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
</style>
    </style>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Payarc JS -->
    <script>
        function loadPayarcScript(src) {
            var script = document.createElement('script');
            script.src = src;
            script.onerror = function() {
                if (src === 'https://js.payarc.com/v1/payarc.js') {
                    console.warn('CDN failed, falling back to local copy');
                    loadPayarcScript('/path/to/local/payarc.js');
                } else {
                    console.error('Failed to load Payarc library');
                }
            };
            document.head.appendChild(script);
        }
        loadPayarcScript('https://js.payarc.com/v1/payarc.js');
    </script>
    <!-- Add DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">
                <h2>Loading</h2>
                <p id="loadingStatus">Loading studio branding...</p>
            </div>
        </div>
    </div>

    <div class="d-flex" id="wrapper">
           <!-- Sidebar-->
           <div class="border-end" id="sidebar-wrapper">
            <div class="sidebar-heading">
                <img src="assets/StudioSyncTransparent.svg" alt="Studio Sync Logo" style="width: 150px; height: auto;">
            </div>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action p-3" href="dashboard.html">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <a class="list-group-item list-group-item-action p-3" href="class-calendar.html">
                    <i class="fas fa-calendar-alt me-2"></i>Class Calendar
                </a>
                <a class="list-group-item list-group-item-action p-3" href="allclasses.html">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Classes
                </a>
                <a class="list-group-item list-group-item-action p-3" href="families.html">
                    <i class="fas fa-home me-2"></i>Families
                </a>
                <a class="list-group-item list-group-item-action p-3" href="students.html">
                    <i class="fas fa-user-graduate me-2"></i>Students
                </a>
                <a class="list-group-item list-group-item-action p-3" href="instructors.html">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Instructors
                </a>
                <a class="list-group-item list-group-item-action p-3" href="costumes.html">
                    <i class="fas fa-tshirt me-2"></i>Costumes
                </a>
                <a class="list-group-item list-group-item-action p-3" href="recital.html">
                    <i class="fas fa-theater-masks me-2"></i>Recital
                </a>
                <a class="list-group-item list-group-item-action p-3" href="communication.html">
                    <i class="fas fa-comments me-2"></i>Communication
                </a>
                <a class="list-group-item list-group-item-action p-3" href="studiostore.html">
                    <i class="fas fa-store me-2"></i>Studio Store
                </a>
                <a class="list-group-item list-group-item-action p-3" href="charges-payments.html">
                    <i class="fas fa-dollar-sign me-2"></i>Charges/Payments
                </a>
                <a class="list-group-item list-group-item-action p-3" href="reports.html">
                    <i class="fas fa-chart-bar me-2"></i>Reports
                </a>
                <a class="list-group-item list-group-item-action p-3" href="settings.html">
                    <i class="fas fa-cog me-2"></i>Settings
                </a>
            </div>
            
            <!-- Bottom Margin -->
            <div style="margin-bottom: 4rem;"></div>
        </div>

        <!-- Page content wrapper-->
        <div id="page-content-wrapper">
            <!-- Top navigation-->
            <nav class="navbar navbar-expand-lg navbar-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="sidebarToggle" style="width: 100px;" data-bs-toggle="tooltip" data-bs-placement="right" title="Toggle Menu" data-bs-trigger="hover focus">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Centered Logo -->
                    <div class="navbar-brand-center">
                        <img id="studio-logo" src="" alt="Studio Logo" style="max-height: 120px; max-width: 240px; display: none;">
                        <span id="studio-name" style="font-size: 1.5rem; font-weight: bold; color: #3DCED7;"></span>
                    </div>

                    <!-- Notifications and Profile Icons -->
                    <div class="navbar-nav ms-auto d-flex align-items-center">
                        <!-- Profile Icon Dropdown -->
                        <div class="nav-item dropdown">
                            <a class="nav-link" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="user-avatar">
                                    <span class="initials"></span>
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li><h6 class="dropdown-header" id="userName" style="font-size: 1.2rem; font-weight: 700; color: #333333;">User Name</h6></li>
                                <li><p class="dropdown-item-text" id="userEmail" style="font-size: 0.95rem; font-weight: 400; color: #333333;">user@example.com</p></li>
                                <li><p class="dropdown-item-text" id="studioNameDisplay" style="font-size: 1.1rem; font-weight: 600; color: #333333;">Studio Name</p></li>
                                <li><p class="dropdown-item-text" id="userRole" style="font-size: 0.85rem; font-weight: 400; color: #333333;">Role</p></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutButton"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Page content-->
            <div class="container-fluid">
                <h1 class="mt-4">Settings</h1>
                <div class="settings-header">
                    <div></div>
                    <div class="settings-search">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search settings..." id="settingsSearch">
                    </div>
                </div>
                <div class="settings-grid">
                    <div class="setting-card" data-modal="studio-settings-modal">
                        <i class="fas fa-building"></i>
                        <h3>Studio Info</h3>
                        <p>Manage studio information and branding</p>
                    </div>
                    <div class="setting-card" data-modal="profile-modal">
                        <i class="fas fa-user"></i>
                        <h3>Profile</h3>
                        <p>Update your personal information</p>
                    </div>
                    <div class="setting-card" data-modal="activity-log-modal">
                        <i class="fas fa-sitemap"></i>
                        <h3>Classes/Seasons</h3>
                        <p>Mangage your class styl and seasons</p>
                    </div>
                    <div class="setting-card" data-modal="payment-processing-modal">
                        <i class="fas fa-money-check-alt"></i>
                        <h3>Payment Processing</h3>
                        <p>Configure payment gateways and processing settings</p>
                    </div>
                    <div class="setting-card" data-modal="general-payment-settings-modal">
                        <i class="fas fa-money-check-alt"></i>
                        <h3>General Payment Settings</h3>
                        <p>Configure general payment settings</p>
                    </div>
                    <div class="setting-card" data-modal="billing-modal">
                        <i class="fas fa-credit-card"></i>
                        <h3>Subscriptions & Billing</h3>
                        <p>View and update billing information and Subscriptions</p>
                    </div>
                    <div class="setting-card" data-modal="team-modal">
                        <i class="fas fa-users-cog"></i>
                        <h3>Team</h3>
                        <p>Manage team members and roles</p>
                    </div>
                    <div class="setting-card" data-modal="appearance-modal">
                        <i class="fas fa-palette"></i>
                        <h3>Appearance</h3>
                        <p>Customize the look and feel</p>
                    </div>
                    <div class="setting-card" data-modal="security-modal">
                        <i class="fas fa-lock"></i>
                        <h3>Security</h3>
                        <p>Update password and security settings</p>
                    </div>
                    <div class="setting-card" data-modal="language-coming-soon-modal">
                        <i class="fas fa-language"></i>
                        <h3>Language</h3>
                        <p>Change language and localization</p>
                    </div>
                    <!-- Add this card to the settings-grid div -->
                    <div class="setting-card" data-modal="policies-modal">
                        <i class="fas fa-file-contract"></i>
                        <h3>Policies</h3>
                        <p>Manage studio policies and terms</p>
                    </div>
                    <!-- Add this card in the settings-grid div, after Policies -->
                    <div class="setting-card" data-modal="studio-rooms-modal">
                        <i class="fas fa-door-open"></i>
                        <h3>Studio Rooms</h3>
                        <p>Manage your studio rooms and locations</p>
                    </div>
                    <div class="setting-card" data-modal="skills-management-modal">
                        <i class="fas fa-brain"></i>
                        <h3>Skills Management</h3>
                        <p>Manage your Studio skills</p>
                    </div>
                    <div class="setting-card" data-modal="tags-modal">
                        <i class="fas fa-tags"></i>
                        <h3>Tags</h3>
                        <p>Manage your Studio Tags</p>
                    </div>
                    <div class="setting-card" data-modal="videos-modal">
                        <i class="fas fa-video"></i>
                        <h3>Videos</h3>
                        <p>Watch recorded videos to learn about how to use Studio Sync</p>
                    </div>
                    

                    <div class="setting-card" onclick="window.location.href='import.html'">
                        <i class="fas fa-file-import"></i>
                        <h3>Import Data</h3>
                        <p>Import data from other systems</p>
                    </div>
                    
                    <div class="setting-card" data-modal="function-logs-modal">
                        <i class="fas fa-file-alt"></i>
                        <h3>Function Logs</h3>
                        <p>View all System Function Logs</p>
                    </div>

                     <div class="setting-card" data-modal="support-modal">
                        <i class="fas fa-question-circle"></i>
                        <h3>Support</h3>
                        <p>Get help from Studio Sync Support</p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script>
        // Initialize Firebase services
        const storage = firebase.storage();
        
        document.addEventListener('DOMContentLoaded', function() {
            const wrapper = document.getElementById('wrapper');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const overlay = document.querySelector('.sidebar-overlay');

            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                wrapper.classList.toggle('toggled');
                
                if (window.innerWidth <= 768) {
                    if (wrapper.classList.contains('toggled')) {
                        overlay.classList.add('show');
                    } else {
                        overlay.classList.remove('show');
                    }
                }
            }

            // Toggle button click handler
            sidebarToggle.addEventListener('click', toggleSidebar);

            // Overlay click handler
            overlay.addEventListener('click', toggleSidebar);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    overlay.classList.remove('show');
                }
            });
        });
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Enrollment chart
        const ctx = document.getElementById('enrollmentChart').getContext('2d');
        let enrollmentChart;

        function getColor(percentage) {
            // Ensure the percentage is between 0 and 100
            percentage = Math.max(0, Math.min(100, percentage));
            
            if (percentage <= 50) {
                // Vibrant Red (220,55,55) to Muted Yellow (220,200,110)
                const g = Math.round(55 + (145 * (percentage / 50)));
                const b = Math.round(55 + (55 * (percentage / 50)));
                return `rgb(220, ${g}, ${b})`;
            } else {
                // Muted Yellow (220,200,110) to Muted Green (110,200,110)
                const r = Math.round(220 - (110 * ((percentage - 50) / 50)));
                return `rgb(${r}, 200, 110)`;
            }
        }

        function updateChart(enrolled, capacity) {
            if (enrollmentChart) {
                enrollmentChart.destroy();
            }

            const percentageFilled = Math.round((enrolled / capacity) * 100);
            const filledColor = getColor(percentageFilled);

            enrollmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Enrolled', 'Available'],
                    datasets: [{
                        data: [enrolled, Math.max(0, capacity - enrolled)],
                        backgroundColor: [filledColor, '#E0E0E0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label;
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: (chart) => {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;

                        ctx.restore();
                        ctx.font = 'bold 32px Arial';
                        ctx.textBaseline = 'middle';
                        ctx.textAlign = 'center';
                        ctx.fillStyle = filledColor;

                        const text = `${percentageFilled}%`;
                        const textX = width / 2;
                        const textY = height / 2;

                        ctx.fillText(text, textX, textY);

                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#525f7f';
                        ctx.fillText('Capacity', textX, textY + 30);

                        ctx.save();
                    }
                }]
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const enrolledStudents = 142; // Updated for recreational students
            
            setTimeout(() => {
                updateChart(enrolledStudents, 150); // Updated capacity for recreational classes
            }, 400);

            const capacityInput = document.getElementById('capacityInput');
            capacityInput.addEventListener('input', function() {
                const capacity = parseInt(this.value) || 1;
                updateChart(enrolledStudents, capacity);
            });
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDRSW3u6gJSs98Z2Mkp5DYSC__ibDXXHAE",
            authDomain: "studiosync-af73d.firebaseapp.com",
            projectId: "studiosync-af73d",
            storageBucket: "studiosync-af73d.appspot.com",
            messagingSenderId: "172555302276",
            appId: "1:172555302276:web:55b661f9849441e2de59d1",
            measurementId: "G-EK7EFQGMSG"
        };
        firebase.initializeApp(firebaseConfig);

        // Function to apply studio branding colors
        function applyStudioBranding(studioData) {
            console.log(' Applying studio branding colors:', {
                PrimaryColor: studioData.PrimaryColor,
                SecondaryColor: studioData.SecondaryColor
            });

            const primaryColor = studioData.PrimaryColor || '#3DCED7';
            const secondaryColor = studioData.SecondaryColor || '#3A506B';

            // Update CSS variables for the sidebar and related elements
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--primary-hover', adjustColor(primaryColor, -10));
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);

            // Update loading overlay elements with branded colors
            const loadingTitle = document.querySelector('.loading-text h2');
            const loadingText = document.querySelector('.loading-text p');
            const spinner = document.querySelector('.spinner');

            if (loadingTitle) loadingTitle.style.color = primaryColor;
            if (loadingText) loadingText.style.color = secondaryColor;
            if (spinner) spinner.style.borderTopColor = primaryColor;
        }

        // Helper function to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }

        // Function to get current user data
        async function getCurrentUserData() {
            const loadingStatus = document.getElementById('loadingStatus');
            const loadingOverlay = document.getElementById('loadingOverlay');

            try {
                const user = await new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            loadingStatus.textContent = "Authenticating user...";
                            resolve(user);
                        } else {
                            console.log('No user signed in');
                            window.location.href = '/studiologin.html';
                        }
                    });
                });

                const studioId = localStorage.getItem('currentStudioId');
                const studioData = JSON.parse(localStorage.getItem('currentStudioData'));
                const userDocId = localStorage.getItem('userDocId');

                loadingStatus.textContent = "Loading studio branding...";
                
                if (studioData) {
                    applyStudioBranding(studioData);
                }

                loadingStatus.textContent = "Fetching user data...";

                try {
                    const userDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Users')
                        .doc(userDocId)
                        .get();

                    const instructorDoc = !userDoc.exists ? await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Instructors')
                        .doc(user.uid)
                        .get() : null;

                    let userData;
                    let collectionType;

                    if (userDoc.exists) {
                        userData = userDoc.data();
                        collectionType = 'Users';
                    } else if (instructorDoc?.exists) {
                        userData = instructorDoc.data();
                        collectionType = 'Instructors';
                    }

                    if (userData) {
                        loadingStatus.textContent = "Loading...";
                        
                        const fullName = `${userData.FirstName} ${userData.LastName}`;
                        document.getElementById('userName').textContent = fullName;
                        document.getElementById('userEmail').textContent = userData.Email;
                        
                        // Set studio name in profile dropdown
                        const studioNameElement = document.getElementById('studioNameDisplay');
                        if (studioNameElement && studioData) {
                            studioNameElement.textContent = studioData.StudioName || 'Studio Name';
                        }
                        
                        // Set user initials in avatar
                        const initials = `${userData.FirstName[0]}${userData.LastName[0]}`;
                        const initialsElement = document.querySelector('.initials');
                        if (initialsElement) {
                            initialsElement.textContent = initials;
                        }

                        const roleElement = document.getElementById('userRole');
                        if (userData.Role) {
                            roleElement.textContent = userData.Role;
                            roleElement.style.color = '#333333';
                            roleElement.style.fontWeight = '700';
                        } else {
                            roleElement.textContent = 'No Role Assigned';
                            roleElement.style.color = '#666';
                        }

                        if (studioData?.LogoUrl) {
                            await loadStudioLogo(studioData.LogoUrl, studioData.StudioName);
                        } else {
                            await loadStudioLogo(null, studioData?.StudioName);
                        }

                        // Hide loading overlay with fade effect
                        loadingOverlay.classList.add('fade-out');
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error getting user document:', error);
                    loadingStatus.textContent = "Error loading dashboard. Please refresh...";
                }
                
                if (studioData) {
                    applyStudioBranding(studioData);
                    updateSidebarLinks(studioData);
                    updatePageUrl(studioData.StudioName);
                }
            } catch (error) {
                console.error('Error:', error);
                loadingStatus.textContent = "Error loading dashboard. Please refresh...";
            }
        }

        // Function to load and display the studio logo
        function loadStudioLogo(logoUrl, studioName) {
            return new Promise((resolve) => {
                const logoElement = document.getElementById('studio-logo');
                const nameElement = document.getElementById('studio-name');
                
                if (logoUrl) {
                    logoElement.onload = () => resolve();
                    logoElement.src = logoUrl;
                    logoElement.alt = studioName || 'Studio Logo';
                    logoElement.style.display = 'block';
                    nameElement.style.display = 'none';
                } else {
                    logoElement.style.display = 'none';
                    nameElement.textContent = studioName || 'Studio Sync';
                    nameElement.style.display = 'block';
                    resolve();
                }
            });
        }

        // Call the function when the page loads
        getCurrentUserData();

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', function() {
            firebase.auth().signOut().then(() => {
                // Clear studio context from localStorage
                localStorage.removeItem('currentStudioId');
                localStorage.removeItem('currentStudioData');
                // Redirect to studio login
                window.location.href = '/studiologin.html';
            }).catch((error) => {
                console.error('Logout Error:', error);
            });
        });

        // Add this function after the firebase initialization
        function getStudioNameForUrl(studioName) {
            // Remove spaces and special characters, keep alphanumeric only
            return studioName.replace(/[^a-zA-Z0-9]/g, '');
        }

        function updateSidebarLinks(studioData) {
            if (studioData?.StudioName) {
                const studioNameParam = getStudioNameForUrl(studioData.StudioName);
                
                const sidebarLinks = document.querySelectorAll('#sidebar-wrapper .list-group-item');
                sidebarLinks.forEach(link => {
                    const currentHref = link.getAttribute('href');
                    if (currentHref && currentHref.endsWith('.html')) {
                        const newHref = currentHref.replace('.html', `?studio=${studioNameParam}`);
                        link.setAttribute('href', newHref);
                    }
                });
            }
        }

        function updatePageUrl(studioName) {
            if (studioName) {
                const studioNameParam = getStudioNameForUrl(studioName);
                const currentUrl = new URL(window.location.href);
                
                // Only update if we're on a .html page and don't already have the studio parameter
                if (currentUrl.pathname.endsWith('.html') && !currentUrl.searchParams.has('studio')) {
                    const newUrl = `${currentUrl.pathname.replace('.html', '')}?studio=${studioNameParam}`;
                    window.history.replaceState({}, '', newUrl);
                }
            }
        }
    </script>

    <!-- Add DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

    <script>
        // Initialize DataTables
        $(document).ready(function() {
            var table = $('#classesTable').DataTable({
                responsive: true,
                columns: [
                    { 
                        data: null,
                        defaultContent: '',
                        orderable: false,
                        className: 'select-checkbox',
                        render: function (data, type, row) {
                            return '<input type="checkbox" class="row-select">';
                        }
                    },
                    { data: 'className' },
                    { data: 'season' },
                    { data: 'days' },
                    { data: 'time' },
                    { data: 'instructor' },
                    { data: 'classType' },
                    { data: 'location' },
                    { data: 'songs' }
                ]
            });
        });
    </script>

    <!-- Add all modals from settingsbackuppp.html -->
    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Profile Settings</h2>
                <button type="button" class="close" onclick="closeModal('profile-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="row g-4">
                    <!-- Personal Information -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Personal Information</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">First Name</label>
                                    <input type="text" id="firstName" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                </div>
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Last Name</label>
                                    <input type="text" id="lastName" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                </div>
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Email</label>
                                    <input type="email" id="profileEmail" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Phone Number</label>
                                    <input type="tel" id="phoneNumber" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Role & Preferences -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-user-cog me-2"></i>Role & Preferences</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Role</label>
                                    <input type="text" id="profileRole" class="form-control" readonly
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; background-color: #f8f9fa;">
                                </div>
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Time Zone</label>
                                    <select id="timeZone" class="form-control"
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                        <option value="America/New_York">Eastern Time (ET)</option>
                                        <option value="America/Chicago">Central Time (CT)</option>
                                        <option value="America/Denver">Mountain Time (MT)</option>
                                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                        <option value="America/Anchorage">Alaska Time (AKT)</option>
                                        <option value="Pacific/Honolulu">Hawaii Time (HT)</option>
                                    </select>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input type="checkbox" class="form-check-input" id="emailNotifications" role="switch"
                                        style="width: 3em; height: 1.5em; margin-right: 0.5em;">
                                    <label class="form-check-label" for="emailNotifications" style="color: #525f7f;">
                                        Email Notifications
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" id="smsNotifications" role="switch"
                                        style="width: 3em; height: 1.5em; margin-right: 0.5em;">
                                    <label class="form-check-label" for="smsNotifications" style="color: #525f7f;">
                                        SMS Notifications
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-secondary" 
                    style="border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="closeModal('profile-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" 
                    style="background: var(--primary-color); border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="saveProfileSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Security Modal -->
    <div id="security-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Security Settings</h2>
                <button type="button" class="close" onclick="closeModal('security-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="passwordChangeForm">
                    <div class="modal-form-group">
                        <label for="currentPassword">Current Password</label>
                        <div class="password-container">
                            <input type="password" id="currentPassword" class="form-control">
                            <i class="fas fa-eye password-toggle" onclick="togglePassword('currentPassword')"></i>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label for="newPassword">New Password</label>
                        <div class="password-container">
                            <input type="password" id="newPassword" class="form-control">
                            <i class="fas fa-eye password-toggle" onclick="togglePassword('newPassword')"></i>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label for="confirmNewPassword">Confirm New Password</label>
                        <div class="password-container">
                            <input type="password" id="confirmNewPassword" class="form-control">
                            <i class="fas fa-eye password-toggle" onclick="togglePassword('confirmNewPassword')"></i>
                        </div>
                    </div>

                    <!-- Password Requirements Section -->
                    <div class="password-requirements" style="display: none;">
                        <div class="requirement" id="length-req">
                            <i class="fas fa-times-circle"></i>
                            At least 8 characters
                        </div>
                        <div class="requirement" id="uppercase-req">
                            <i class="fas fa-times-circle"></i>
                            At least one uppercase letter
                        </div>
                        <div class="requirement" id="lowercase-req">
                            <i class="fas fa-times-circle"></i>
                            At least one lowercase letter
                        </div>
                        <div class="requirement" id="number-req">
                            <i class="fas fa-times-circle"></i>
                            At least one number
                        </div>
                        <div class="requirement" id="special-req">
                            <i class="fas fa-times-circle"></i>
                            At least one special character
                        </div>
                        <div class="requirement" id="match-req">
                            <i class="fas fa-times-circle"></i>
                            Passwords match
                        </div>
                    </div>
                </form>

                <!-- Reset Password Link -->
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <button onclick="showResetPasswordModal()" class="btn btn-link" style="color: var(--primary-color);">
                        Reset My Password
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('security-modal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="updatePassword()">Update Password</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="reset-password-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Reset Password</h2>
                <button type="button" class="close" onclick="closeModal('reset-password-modal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 20px;">We'll send a password reset link to your email address.</p>
                <div class="modal-form-group">
                    <input type="email" id="resetEmailInput" class="form-control" placeholder="Confirm your email address">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('reset-password-modal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="sendPasswordReset()">Send Reset Link</button>
            </div>
        </div>
    </div>

    <!-- Add this JavaScript for password functionality -->
    <script>
        // Password visibility toggle
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentElement.querySelector('.password-toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password validation functions
        function validatePasswordRequirements(password) {
            return {
                length: password.length >= 8,
                upperCase: /[A-Z]/.test(password),
                lowerCase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
        }

        function updateRequirementUI(elementId, isMet) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('i');
            
            if (isMet) {
                element.classList.add('met');
                icon.className = 'fas fa-check-circle';
            } else {
                element.classList.remove('met');
                icon.className = 'fas fa-times-circle';
            }
        }

        // Check password requirements in real-time
        function checkNewPasswords() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            const requirements = validatePasswordRequirements(newPassword);
            const passwordReqs = document.querySelector('.password-requirements');
            
            if (newPassword.length > 0) {
                passwordReqs.style.display = 'block';
            }

            updateRequirementUI('length-req', requirements.length);
            updateRequirementUI('uppercase-req', requirements.upperCase);
            updateRequirementUI('lowercase-req', requirements.lowerCase);
            updateRequirementUI('number-req', requirements.number);
            updateRequirementUI('special-req', requirements.special);
            updateRequirementUI('match-req', newPassword === confirmPassword && newPassword.length > 0);

            return Object.values(requirements).every(req => req) && newPassword === confirmPassword;
        }

        // Add event listeners for password fields
        document.getElementById('newPassword').addEventListener('input', checkNewPasswords);
        document.getElementById('confirmNewPassword').addEventListener('input', checkNewPasswords);

        // Update password function
        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!checkNewPasswords()) {
                alert('Please ensure all password requirements are met');
                return;
            }

            try {
                const user = firebase.auth().currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email, 
                    currentPassword
                );

                // Reauthenticate user
                await user.reauthenticateWithCredential(credential);
                
                // Update password
                await user.updatePassword(newPassword);
                
                alert('Password updated successfully!');
                closeModal('security-modal');
            } catch (error) {
                console.error('Error updating password:', error);
                if (error.code === 'auth/wrong-password') {
                    alert('Current password is incorrect');
                } else {
                    alert('Error updating password. Please try again.');
                }
            }
        }

        // Reset password functions
        function showResetPasswordModal() {
            closeModal('security-modal');
            openModal('reset-password-modal');
            
            // Pre-fill email if available
            const user = firebase.auth().currentUser;
            if (user && user.email) {
                document.getElementById('resetEmailInput').value = user.email;
            }
        }

        async function sendPasswordReset() {
            const email = document.getElementById('resetEmailInput').value;
            
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                alert('Password reset email sent! Please check your inbox.');
                closeModal('reset-password-modal');
            } catch (error) {
                console.error('Error sending reset email:', error);
                alert('Error sending reset email. Please try again.');
            }
        }
    </script>

    <!-- Classes/Seasons Modal -->
    <div id="activity-log-modal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 1200px; min-height: 80vh;">
            <div class="modal-header">
                <h2 class="modal-title">Classes & Seasons Settings</h2>
                <button type="button" class="close" onclick="closeModal('activity-log-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Main Tabs -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes" type="button" role="tab">Classes</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="seasons-tab" data-bs-toggle="tab" data-bs-target="#seasons" type="button" role="tab">Seasons</button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Classes Tab -->
                    <div class="tab-pane fade show active" id="classes" role="tabpanel">
                        <!-- Classes Sub-Tabs -->
                        <ul class="nav nav-tabs mt-3" id="classesSubTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="class-types-tab" data-bs-toggle="tab" data-bs-target="#class-types" type="button" role="tab">Class Types</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="class-styles-tab" data-bs-toggle="tab" data-bs-target="#class-styles" type="button" role="tab">Class Styles</button>
                            </li>
                        </ul>

                        <!-- Classes Sub-Tab Content -->
                        <div class="tab-content" id="classesSubTabContent">
                            <!-- Class Types Tab -->
                            <div class="tab-pane fade show active" id="class-types" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <h4>Class Types</h4>
                                </div>
                                
                                <!-- Class Types Table -->
                                <div class="table-responsive mt-3">
                                    <table class="table" id="classTypesTable">
                                        <thead>
                                            <tr>
                                                <th>Type Name</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Recreational</td>
                                                <td>Non-competitive dance classes focused on learning, enjoyment, and skill development at a comfortable pace.</td>
                                            </tr>
                                            <tr>
                                                <td>Team</td>
                                                <td>Competitive dance program for dedicated students who want to perform and compete at various events and competitions.</td>
                                            </tr>
                                            <tr>
                                                <td>Solo/Duet/Trio</td>
                                                <td>Specialized training and choreography for individual dancers or small groups, typically for competition or showcase performances.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Class Styles Tab -->
                            <div class="tab-pane fade" id="class-styles" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <h4>Class Styles</h4>
                                    <button class="btn btn-primary" onclick="openCreateStyleModal()">
                                        <i class="fas fa-plus"></i> Add Style
                                    </button>
                                </div>
                                
                                <!-- Class Styles Table -->
                                <div class="table-responsive mt-3">
                                    <table class="table" id="classStylesTable">
                                        <thead>
                                            <tr>
                                                <th>Style Name</th>
                                                <th>Description</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="classStylesTableBody">
                                            <!-- Class styles will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seasons Tab -->
                    <div class="tab-pane fade" id="seasons" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <h4>Seasons</h4>
                            <button class="btn btn-primary" onclick="openCreateSeasonModal()">
                                <i class="fas fa-plus"></i> Add Season
                            </button>
                        </div>
                        
                        <!-- Seasons Table -->
                        <div class="table-responsive mt-3">
                            <table class="table" id="seasonsTable">
                                <thead>
                                    <tr>
                                        <th>Season Name</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="seasonsTableBody">
                                    <!-- Seasons will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Create Class Style Modal -->
    <div id="createStyleModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Class Style</h2>
                <button type="button" class="close" onclick="closeModal('createStyleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createStyleForm">
                    <div class="modal-form-group">
                        <label for="styleName">Style Name</label>
                        <input type="text" id="styleName" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="styleDescription">Description</label>
                        <textarea id="styleDescription" class="form-control" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('createStyleModal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="saveClassStyle()">Save Style</button>
            </div>
        </div>
    </div>

    <!-- Add Edit Class Style Modal -->
    <div id="editStyleModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Class Style</h2>
                <button type="button" class="close" onclick="closeModal('editStyleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editStyleForm">
                    <input type="hidden" id="editStyleId">
                    <div class="modal-form-group">
                        <label for="editStyleName">Style Name</label>
                        <input type="text" id="editStyleName" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editStyleDescription">Description</label>
                        <textarea id="editStyleDescription" class="form-control" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('editStyleModal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="updateClassStyle()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Create Season Modal -->
    <div id="createSeasonModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Season</h2>
                <button type="button" class="close" onclick="closeModal('createSeasonModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createSeasonForm">
                    <div class="modal-form-group">
                        <label for="seasonName">Season Name</label>
                        <input type="text" id="seasonName" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="seasonStartDate">Start Date</label>
                        <input type="date" id="seasonStartDate" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="seasonEndDate">End Date</label>
                        <input type="date" id="seasonEndDate" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="seasonDescription">Description</label>
                        <textarea id="seasonDescription" class="form-control" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('createSeasonModal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="saveSeason()">Save Season</button>
            </div>
        </div>
    </div>

    <!-- Add Edit Season Modal -->
    <div id="editSeasonModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Season</h2>
                <button type="button" class="close" onclick="closeModal('editSeasonModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editSeasonForm">
                    <input type="hidden" id="editSeasonId">
                    <div class="modal-form-group">
                        <label for="editSeasonName">Season Name</label>
                        <input type="text" id="editSeasonName" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editSeasonStartDate">Start Date</label>
                        <input type="date" id="editSeasonStartDate" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editSeasonEndDate">End Date</label>
                        <input type="date" id="editSeasonEndDate" class="form-control" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editSeasonDescription">Description</label>
                        <textarea id="editSeasonDescription" class="form-control" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('editSeasonModal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="updateSeason()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Function to handle modal opening with animation
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal with id ${modalId} not found`);
                return;
            }
            
            modal.style.display = "block";
            setTimeout(() => {
                modal.classList.add('show');
                // If it's the profile modal, load the settings
                if (modalId === 'profile-modal') {
                    loadProfileSettings();
                }
                // If it's the tags modal, load the tags
                if (modalId === 'tags-modal') {
                    console.log('Tags management opened');
                    loadTags();
                }
            }, 10);
        }

        // Function to close modals with animation
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = "none";
            }, 300);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        // Initialize all modals
        document.addEventListener('DOMContentLoaded', function() {
            const settingCards = document.querySelectorAll('.setting-card');
            settingCards.forEach(card => {
                card.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    openModal(modalId);
                });
            });
        });

        // Function to open create style modal
        function openCreateStyleModal() {
            closeModal('activity-log-modal');
            openModal('createStyleModal');
        }

        // Function to save class style
        async function saveClassStyle() {
            const styleName = document.getElementById('styleName').value;
            const styleDescription = document.getElementById('styleDescription').value;

            if (!styleName || !styleDescription) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                // Create ClassStyles collection if it doesn't exist and add new style
                await db.collection('Studios').doc(studioId).collection('ClassStyles').add({
                    StyleName: styleName,
                    Description: styleDescription,
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Close create modal and reopen classes modal
                closeModal('createStyleModal');
                openModal('activity-log-modal');
                
                // Reset form
                document.getElementById('createStyleForm').reset();
                
                // Refresh class styles table
                loadClassStyles();
                
            } catch (error) {
                console.error('Error saving class style:', error);
                alert('Error saving class style. Please try again.');
            }
        }

        // Function to load class styles
        async function loadClassStyles() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const snapshot = await db.collection('Studios').doc(studioId)
                                      .collection('ClassStyles')
                                      .orderBy('CreatedAt', 'desc')
                                      .get();
                
                const tableBody = document.getElementById('classStylesTableBody');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const style = doc.data();
                    const row = `
                        <tr>
                            <td>${style.StyleName}</td>
                            <td>${style.Description}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editClassStyle('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteClassStyle('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading class styles:', error);
            }
        }

        // Load class styles when the classes tab is shown
        document.getElementById('class-styles-tab').addEventListener('shown.bs.tab', loadClassStyles);

        // Function to edit class style
        async function editClassStyle(styleId) {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios').doc(studioId)
                                   .collection('ClassStyles')
                                   .doc(styleId)
                                   .get();
                
                if (doc.exists) {
                    const style = doc.data();
                    document.getElementById('editStyleId').value = styleId;
                    document.getElementById('editStyleName').value = style.StyleName;
                    document.getElementById('editStyleDescription').value = style.Description;
                    
                    closeModal('activity-log-modal');
                    openModal('editStyleModal');
                }
            } catch (error) {
                console.error('Error loading style for edit:', error);
                alert('Error loading style. Please try again.');
            }
        }

        // Function to update class style
        async function updateClassStyle() {
            const styleId = document.getElementById('editStyleId').value;
            const styleName = document.getElementById('editStyleName').value;
            const styleDescription = document.getElementById('editStyleDescription').value;

            if (!styleName || !styleDescription) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios').doc(studioId)
                        .collection('ClassStyles')
                        .doc(styleId)
                        .update({
                            StyleName: styleName,
                            Description: styleDescription,
                            UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                closeModal('editStyleModal');
                openModal('activity-log-modal');
                loadClassStyles();
                
            } catch (error) {
                console.error('Error updating class style:', error);
                alert('Error updating class style. Please try again.');
            }
        }

        // Function to delete class style
        async function deleteClassStyle(styleId) {
            if (confirm('Are you sure you want to delete this class style?')) {
                try {
                    const studioId = localStorage.getItem('currentStudioId');
                    const db = firebase.firestore();
                    
                    await db.collection('Studios').doc(studioId)
                            .collection('ClassStyles')
                            .doc(styleId)
                            .delete();
                    
                    loadClassStyles();
                    
                } catch (error) {
                    console.error('Error deleting class style:', error);
                    alert('Error deleting class style. Please try again.');
                }
            }
        }
    </script>

    <script>
        // Function to format timestamp to date string
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Function to open create season modal
        function openCreateSeasonModal() {
            closeModal('activity-log-modal');
            openModal('createSeasonModal');
        }

        // Function to save season
        async function saveSeason() {
            const seasonName = document.getElementById('seasonName').value;
            const startDate = document.getElementById('seasonStartDate').value;
            const endDate = document.getElementById('seasonEndDate').value;
            const description = document.getElementById('seasonDescription').value;

            if (!seasonName || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios').doc(studioId).collection('Seasons').add({
                    Name: seasonName,
                    StartDate: firebase.firestore.Timestamp.fromDate(new Date(startDate)),
                    EndDate: firebase.firestore.Timestamp.fromDate(new Date(endDate)),
                    Description: description || '',
                    IsActive: true,
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    Fees: []
                });

                closeModal('createSeasonModal');
                openModal('activity-log-modal');
                document.getElementById('createSeasonForm').reset();
                loadSeasons();
                
            } catch (error) {
                console.error('Error saving season:', error);
                alert('Error saving season. Please try again.');
            }
        }

        // Function to load seasons
        async function loadSeasons() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const snapshot = await db.collection('Studios').doc(studioId)
                                      .collection('Seasons')
                                      .orderBy('StartDate', 'desc')
                                      .get();
                
                const tableBody = document.getElementById('seasonsTableBody');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const season = doc.data();
                    const row = `
                        <tr>
                            <td>${season.Name || season.SeasonName}</td>
                            <td>${formatDate(season.StartDate)}</td>
                            <td>${formatDate(season.EndDate)}</td>
                            <td>${season.Description || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editSeason('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSeason('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading seasons:', error);
            }
        }

        // Function to edit season
        async function editSeason(seasonId) {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios').doc(studioId)
                                   .collection('Seasons')
                                   .doc(seasonId)
                                   .get();
                
                if (doc.exists) {
                    const season = doc.data();
                    document.getElementById('editSeasonId').value = seasonId;
                    document.getElementById('editSeasonName').value = season.Name || season.SeasonName;
                    
                    // Format dates for input fields (YYYY-MM-DD)
                    const startDate = season.StartDate.toDate();
                    const endDate = season.EndDate.toDate();
                    
                    document.getElementById('editSeasonStartDate').value = startDate.toISOString().split('T')[0];
                    document.getElementById('editSeasonEndDate').value = endDate.toISOString().split('T')[0];
                    document.getElementById('editSeasonDescription').value = season.Description || '';
                    
                    closeModal('activity-log-modal');
                    openModal('editSeasonModal');
                }
            } catch (error) {
                console.error('Error loading season for edit:', error);
                alert('Error loading season. Please try again.');
            }
        }

        // Function to update season
        async function updateSeason() {
            const seasonId = document.getElementById('editSeasonId').value;
            const seasonName = document.getElementById('editSeasonName').value;
            const startDate = document.getElementById('editSeasonStartDate').value;
            const endDate = document.getElementById('editSeasonEndDate').value;
            const description = document.getElementById('editSeasonDescription').value;

            if (!seasonName || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios').doc(studioId)
                        .collection('Seasons')
                        .doc(seasonId)
                        .update({
                            Name: seasonName,
                            StartDate: firebase.firestore.Timestamp.fromDate(new Date(startDate)),
                            EndDate: firebase.firestore.Timestamp.fromDate(new Date(endDate)),
                            Description: description || '',
                            UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                closeModal('editSeasonModal');
                openModal('activity-log-modal');
                loadSeasons();
                
            } catch (error) {
                console.error('Error updating season:', error);
                alert('Error updating season. Please try again.');
            }
        }

        // Function to delete season
        async function deleteSeason(seasonId) {
            if (confirm('Are you sure you want to delete this season?')) {
                try {
                    const studioId = localStorage.getItem('currentStudioId');
                    const db = firebase.firestore();
                    
                    await db.collection('Studios').doc(studioId)
                            .collection('Seasons')
                            .doc(seasonId)
                            .delete();
                    
                    loadSeasons();
                    
                } catch (error) {
                    console.error('Error deleting season:', error);
                    alert('Error deleting season. Please try again.');
                }
            }
        }

        // Load seasons when the seasons tab is shown
        document.getElementById('seasons-tab').addEventListener('shown.bs.tab', loadSeasons);
    </script>

    <!-- Add this card in the settings-grid div, after the Classes/Seasons card and before the Billing card -->
    <div class="setting-card" data-modal="payment-processing-modal">
        <i class="fas fa-money-check-alt"></i>
        <h3>Payment Processing</h3>
        <p>Configure payment gateways and processing settings</p>
    </div>

    <!-- Update the Payment Processing Modal -->
    <div id="payment-processing-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%; max-height: 95vh;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Payment Processing Settings</h2>
                <button type="button" class="close" onclick="closeModal('payment-processing-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem 1.5rem 0.5rem 1.5rem; overflow-y: auto;">
                <div class="row g-4">
                    <!-- PayArc Configuration -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>PayArc Gateway</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="form-check form-switch mb-4">
                                    <input type="checkbox" class="form-check-input" id="payarcEnabled" role="switch" 
                                        style="width: 3em; height: 1.5em; margin-right: 0.5em;">
                                    <label class="form-check-label" for="payarcEnabled" style="color: #525f7f;">
                                        Enable PayArc Payments
                                    </label>
                                </div>
                                <div class="form-group mb-4">
                                    <label for="payarcMerchantId" class="form-label" style="font-weight: 500; color: #525f7f;">
                                        Merchant ID
                                    </label>
                                    <input type="text" id="payarcMerchantId" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;"
                                        placeholder="Enter PayArc merchant ID">
                                </div>
                                <div class="form-group mb-4">
                                    <label for="payarcApiKey" class="form-label" style="font-weight: 500; color: #525f7f;">
                                        API Key
                                    </label>
                                    <div class="password-container">
                                        <input type="password" id="payarcApiKey" class="form-control" 
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                        <i class="fas fa-eye-slash password-toggle" onclick="toggleApiKeyVisibility()"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Surcharge Settings -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-percentage me-2"></i>Surcharge Settings</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="form-check form-switch mb-4">
                                    <input type="checkbox" class="form-check-input" id="enableSurcharge" role="switch" 
                                        style="width: 3em; height: 1.5em; margin-right: 0.5em;">
                                    <label class="form-check-label" for="enableSurcharge" style="color: #525f7f;">
                                        Enable Surcharge
                                    </label>
                                </div>

                                <div id="surchargeOptions" style="display: none;">
                                    <div class="form-group mb-4">
                                        <label for="surchargeName" class="form-label" style="font-weight: 500; color: #525f7f;">
                                            Surcharge Line Item Name
                                        </label>
                                        <input type="text" id="surchargeName" class="form-control" 
                                            style="border-radius: 0.5rem;"
                                            placeholder="e.g., Credit Card Processing Fee">
                                    </div>

                                    <div class="form-group mb-4">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">
                                            Surcharge Type
                                        </label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="surchargeType" id="typePercentage" value="percentage" checked>
                                            <label class="btn btn-outline-primary" style="--bs-btn-color: var(--primary-color); --bs-btn-border-color: var(--primary-color); --bs-btn-hover-color: #fff; --bs-btn-hover-bg: var(--primary-color); --bs-btn-hover-border-color: var(--primary-color); --bs-btn-active-color: #fff; --bs-btn-active-bg: var(--primary-color); --bs-btn-active-border-color: var(--primary-color);" for="typePercentage">Percentage</label>
                                            
                                            <input type="radio" class="btn-check" name="surchargeType" id="typeAmount" value="amount">
                                            <label class="btn btn-outline-primary" style="--bs-btn-color: var(--primary-color); --bs-btn-border-color: var(--primary-color); --bs-btn-hover-color: #fff; --bs-btn-hover-bg: var(--primary-color); --bs-btn-hover-border-color: var(--primary-color); --bs-btn-active-color: #fff; --bs-btn-active-bg: var(--primary-color); --bs-btn-active-border-color: var(--primary-color);" for="typeAmount">Fixed Amount</label>
                                        </div>
                                    </div>

                                    <div class="form-group mb-4">
                                        <label for="surchargeValue" class="form-label" style="font-weight: 500; color: #525f7f;">
                                            <span id="valueLabel">Percentage</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" id="surchargeValue" class="form-control" 
                                                style="border-radius: 0.5rem 0 0 0.5rem;"
                                                step="0.01">
                                            <span class="input-group-text" id="valueSymbol" 
                                                style="border-radius: 0 0.5rem 0.5rem 0; background: #f8f9fa;">%</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Surcharges must comply with card network rules and local regulations. Please ensure you're following all applicable laws.
                                </div>
                            </div>
                        </div>
                    </div>

                 
                    <!-- Business Information -->
                    <div class="col-12">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Business Information</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <!-- Personal Information Section -->
                                <h6 class="mb-3" style="color: #525f7f;">Personal Information</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">First Name *</label>
                                        <input type="text" id="ownerFirstName" class="form-control" placeholder="First name"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Middle Initial</label>
                                        <input type="text" id="ownerMiddleInitial" class="form-control" placeholder="M.I."
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Last Name *</label>
                                        <input type="text" id="ownerLastName" class="form-control" placeholder="Last name"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Title *</label>
                                        <input type="text" id="ownerTitle" class="form-control" placeholder="e.g., Owner, CEO"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Date of Birth *</label>
                                        <input type="date" id="ownerDob" class="form-control"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">SSN *</label>
                                        <input type="text" id="ownerSsn" class="form-control" placeholder="Social Security Number"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Home Address *</label>
                                        <input type="text" id="ownerAddress" class="form-control" placeholder="Street address"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">City *</label>
                                        <input type="text" id="ownerCity" class="form-control"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">State *</label>
                                        <input type="text" id="ownerState" class="form-control"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">ZIP Code *</label>
                                        <input type="text" id="ownerZip" class="form-control"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                </div>

                                <!-- Business Details Section -->
                                <h6 class="mb-3" style="color: #525f7f;">Business Details</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Business Legal Name *</label>
                                        <input type="text" id="businessName" class="form-control" placeholder="Legal business name"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Business Type *</label>
                                        <select id="businessType" class="form-select"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                            <option value="">Select business type</option>
                                            <option value="sole_proprietorship">Sole Proprietorship</option>
                                            <option value="llc">LLC</option>
                                            <option value="corporation">Corporation</option>
                                            <option value="partnership">Partnership</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Tax ID (EIN) *</label>
                                        <input type="text" id="businessEin" class="form-control" placeholder="XX-XXXXXXX"
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Estimated Monthly Volume *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" id="monthlyVolume" class="form-control" placeholder="0.00"
                                                style="border-radius: 0 0.5rem 0.5rem 0; padding: 0.75rem;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Required Documents Section -->
                                <h6 class="mb-3" style="color: #525f7f;">Required Documents</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Driver's License (Front) *</label>
                                        <div class="document-upload-container">
                                            <div class="upload-box" onclick="document.getElementById('driverLicense').click()" 
                                                style="border: 2px dashed #e0e0e0; border-radius: 0.5rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                                <input type="file" id="driverLicense" class="form-control" accept="image/*,.pdf" style="display: none;">
                                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #3DCED7; margin-bottom: 0.5rem;"></i>
                                                <p style="margin: 0; color: #525f7f;">Click to upload driver's license</p>
                                                <small style="color: #6c757d;">Accepts images and PDF</small>
                                                <div id="driverLicensePreview" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Voided Check *</label>
                                        <div class="document-upload-container">
                                            <div class="upload-box" onclick="document.getElementById('voidedCheck').click()" 
                                                style="border: 2px dashed #e0e0e0; border-radius: 0.5rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                                <input type="file" id="voidedCheck" class="form-control" accept="image/*,.pdf" style="display: none;">
                                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #3DCED7; margin-bottom: 0.5rem;"></i>
                                                <p style="margin: 0; color: #525f7f;">Click to upload voided check or statement</p>
                                                <small style="color: #6c757d;">Accepts images and PDF</small>
                                                <div id="voidedCheckPreview" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Merchant Statement</label>
                                        <div class="document-upload-container">
                                            <div class="upload-box" onclick="document.getElementById('merchantStatement').click()" 
                                                style="border: 2px dashed #e0e0e0; border-radius: 0.5rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                                <input type="file" id="merchantStatement" class="form-control" accept="image/*,.pdf" style="display: none;">
                                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #3DCED7; margin-bottom: 0.5rem;"></i>
                                                <p style="margin: 0; color: #525f7f;">Click to upload statement</p>
                                                <small style="color: #6c757d;">Accepts images and PDF</small>
                                                <div id="merchantStatementPreview" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Other Merchant Documents</label>
                                        <div class="document-upload-container">
                                            <div class="upload-box" onclick="document.getElementById('otherMerchantDocuments').click()" 
                                                style="border: 2px dashed #e0e0e0; border-radius: 0.5rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                                <input type="file" id="otherMerchantDocuments" class="form-control" accept="image/*,.pdf" style="display: none;">
                                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #3DCED7; margin-bottom: 0.5rem;"></i>
                                                <p style="margin: 0; color: #525f7f;">Click to upload other documents</p>
                                                <small style="color: #6c757d;">Accepts images and PDF</small>
                                                <div id="otherMerchantDocumentsPreview" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee; padding: 0.75rem 1.5rem; margin-top: 0.5rem;">
                <button type="button" class="btn btn-secondary" 
                    style="border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="closeModal('payment-processing-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" 
                    style="background: var(--primary-color); border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="savePaymentSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- General Payment Settings Modal -->
    <div id="general-payment-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%; max-height: 95vh;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">General Payment Settings</h2>
                <button type="button" class="close" onclick="closeModal('general-payment-settings-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem 1.5rem 0.5rem 1.5rem; overflow-y: auto;">
                <div class="row g-4">
                    <div class="col-md-12">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>General Settings</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="toggle-container mb-3" style="display: flex; align-items: center; justify-content: space-between;">
                                    <label for="autoPaymentsEnabled" style="color: #525f7f; font-weight: 500; margin: 0;">Enable Automatic Payments</label>
                                    <div class="modern-toggle">
                                        <input type="checkbox" id="autoPaymentsEnabled" class="toggle-input">
                                        <span class="toggle-slider"></span>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="postChargesDay">Post Charges Day</label>
                                    <input type="number" class="form-control" id="postChargesDay" min="1" max="31" value="1">
                                    <small class="form-text text-muted">Day of the month to post charges</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="autoPayBillingDay">AutoPay Billing Day</label>
                                    <input type="number" class="form-control" id="autoPayBillingDay" min="1" max="31" value="5">
                                    <small class="form-text text-muted">Day of the month to process automatic payments</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="paymentRetryDays">Payment Retry Days</label>
                                    <input type="number" class="form-control" id="paymentRetryDays" min="1" max="30" value="3">
                                    <small class="form-text text-muted">Number of days to retry failed payments</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="paymentNotificationEmail">Payment Notification Email</label>
                                    <input type="email" class="form-control" id="paymentNotificationEmail">
                                    <small class="form-text text-muted">Email address to receive payment notifications</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee; padding: 0.75rem 1.5rem; margin-top: 0.5rem;">
                <button type="button" class="btn btn-secondary" 
                    style="border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="closeModal('general-payment-settings-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" 
                    style="background: var(--primary-color); border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="saveGeneralPaymentSettings()">Save Settings</button>
            </div>
        </div>
    </div>


    <script>
        async function savePaymentSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                const storage = firebase.storage();

                // Get existing document URLs
                const existingSettings = await db.collection('Studios').doc(studioId)
                    .collection('PaymentProcessing')
                    .doc('Settings')
                    .get();
                
                const existingDocs = existingSettings.exists ? existingSettings.data().Documents || {} : {};

                // Upload documents if they exist
                const uploadDocument = async (fileElement, path) => {
                    const file = fileElement.files[0];
                    if (file) {
                        // Map the path to the correct folder name
                        const folderMap = {
                            'DriverLicense': 'DriverLicenses',
                            'MerchantStatement': 'MerchantStatements',
                            'OtherDocument': 'OtherMerchantDocuments',
                            'VoidedCheck': 'VoidedChecksOrBankStatements'
                        };
                        const folderName = folderMap[path] || path;
                        const ref = storage.ref(`${studioId}/${folderName}/${file.name}`);
                        await ref.put(file);
                        return await ref.getDownloadURL();
                    }
                    return existingDocs[path] || null; // Return existing URL if no new file
                };

                // Upload new documents
                const [driverLicenseUrl, voidedCheckUrl, merchantStatementUrl, otherDocumentUrl] = await Promise.all([
                    uploadDocument(document.getElementById('driverLicense'), 'DriverLicense'),
                    uploadDocument(document.getElementById('voidedCheck'), 'VoidedCheck'),
                    uploadDocument(document.getElementById('merchantStatement'), 'MerchantStatement'),
                    uploadDocument(document.getElementById('otherMerchantDocuments'), 'OtherDocument')
                ]);

                // Save surcharge settings
                const surchargeSettings = {
                    IsActive: document.getElementById('enableSurcharge').checked,
                    Name: document.getElementById('surchargeName').value,
                    Type: document.querySelector('input[name="surchargeType"]:checked').value,
                    Value: parseFloat(document.getElementById('surchargeValue').value),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const paymentSettings = {
                    BusinessInfo: {
                        BusinessEin: document.getElementById('businessEin').value,
                        BusinessName: document.getElementById('businessName').value,
                        BusinessType: document.getElementById('businessType').value,
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    Documents: {
                        DriverLicense: driverLicenseUrl,
                        MerchantStatement: merchantStatementUrl,
                        OtherDocument: otherDocumentUrl,
                        VoidedCheck: voidedCheckUrl
                    },
                    IsActive: true,
                    MonthlyVolume: document.getElementById('monthlyVolume').value,
                    OwnerAddress: document.getElementById('ownerAddress').value,
                    OwnerCity: document.getElementById('ownerCity').value,
                    OwnerDob: document.getElementById('ownerDob').value,
                    OwnerFirstName: document.getElementById('ownerFirstName').value,
                    OwnerLastName: document.getElementById('ownerLastName').value,
                    OwnerMiddleInitial: document.getElementById('ownerMiddleInitial').value,
                    OwnerSsn: document.getElementById('ownerSsn').value,
                    OwnerState: document.getElementById('ownerState').value,
                    OwnerTitle: document.getElementById('ownerTitle').value,
                    OwnerZip: document.getElementById('ownerZip').value,
                    Payarc: {
                        ApiKey: document.getElementById('payarcApiKey').value,
                        Enabled: document.getElementById('payarcEnabled').checked,
                        MerchantId: document.getElementById('payarcMerchantId').value,
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Save both settings
                await Promise.all([
                    db.collection('Studios').doc(studioId)
                        .collection('Surcharge')
                        .doc('SurchargeSettings')
                        .set(surchargeSettings, { merge: true }),
                    
                    db.collection('Studios').doc(studioId)
                        .collection('PaymentProcessing')
                        .doc('Settings')
                        .set(paymentSettings, { merge: true })
                ]);

                console.log('Payment settings saved successfully.');
                closeModal('payment-processing-modal');
                alert('Payment settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving payment settings:', error);
                alert('Error saving payment settings. Please try again.');
            }
        }
    

        // Update loadPaymentSettings to include new fields
        async function loadPaymentSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                console.log('Loading Payment Processing Settings...');
                const doc = await db.collection('Studios').doc(studioId)
                           .collection('PaymentProcessing')
                           .doc('Settings')
                           .get();

                if (doc.exists) {
                    const Settings = doc.data();
                    console.log('Loaded settings:', Settings);
                    
                    // Load Payarc settings
                    if (Settings.Payarc) {
                        console.log('Loading Payarc settings:', Settings.Payarc);
                        document.getElementById('payarcEnabled').checked = Settings.Payarc.Enabled || false;
                        document.getElementById('payarcMerchantId').value = Settings.Payarc.MerchantId || '';
                        document.getElementById('payarcApiKey').value = Settings.Payarc.ApiKey || '';
                    }
                    
                    // Load Business Info
                    if (Settings.BusinessInfo) {
                        console.log('Loading Business Info:', Settings.BusinessInfo);
                        document.getElementById('businessName').value = Settings.BusinessInfo.BusinessName || '';
                        document.getElementById('businessType').value = Settings.BusinessInfo.BusinessType || '';
                        document.getElementById('businessEin').value = Settings.BusinessInfo.BusinessEin || '';
                    }
                    
                    // Load Personal Information from root level
                    console.log('Loading Personal Information from root level');
                    document.getElementById('ownerFirstName').value = Settings.OwnerFirstName || '';
                    document.getElementById('ownerMiddleInitial').value = Settings.OwnerMiddleInitial || '';
                    document.getElementById('ownerLastName').value = Settings.OwnerLastName || '';
                    document.getElementById('ownerTitle').value = Settings.OwnerTitle || '';
                    document.getElementById('ownerDob').value = Settings.OwnerDob || '';
                    document.getElementById('ownerSsn').value = Settings.OwnerSsn || '';
                    document.getElementById('ownerAddress').value = Settings.OwnerAddress || '';
                    document.getElementById('ownerCity').value = Settings.OwnerCity || '';
                    document.getElementById('ownerState').value = Settings.OwnerState || '';
                    document.getElementById('ownerZip').value = Settings.OwnerZip || '';
                    document.getElementById('monthlyVolume').value = Settings.MonthlyVolume || '';
                    
                    // Load Documents
                    if (Settings.Documents) {
                        console.log('Loading Documents:', Settings.Documents);
                        // Only update document previews if the elements exist
                        const updatePreviewIfExists = (previewId, url) => {
                            const previewElement = document.getElementById(previewId);
                            if (previewElement) {
                                updateDocumentPreview(previewId, url);
                            }
                        };

                        updatePreviewIfExists('driverLicensePreview', Settings.Documents.DriverLicense);
                        updatePreviewIfExists('voidedCheckPreview', Settings.Documents.VoidedCheck);
                        updatePreviewIfExists('merchantStatementPreview', Settings.Documents.MerchantStatement);
                        updatePreviewIfExists('otherMerchantDocumentsPreview', Settings.Documents.OtherDocument);
                    }
                } else {
                    console.log('No payment settings found in database');
                }
            } catch (error) {
                console.error('Error loading payment settings:', error);
                alert('Error loading payment settings. Please try again.');
            }
        }

        // Helper function to update document previews
        function updateDocumentPreview(previewId, url) {
            const previewDiv = document.getElementById(previewId);
            if (!previewDiv) return; // Exit if preview div doesn't exist
            
            const uploadBox = previewDiv.closest('.upload-box');
            if (!uploadBox) return; // Exit if upload box doesn't exist
            
            previewDiv.innerHTML = '';
            
            if (url) {
                uploadBox.classList.add('has-file');
                if (url.toLowerCase().endsWith('.pdf')) {
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = '_blank';
                    link.textContent = 'View PDF';
                    link.className = 'btn btn-sm btn-outline-primary';
                    previewDiv.appendChild(link);
                    
                    // Update the upload icon and text
                    const icon = uploadBox.querySelector('.fa-cloud-upload-alt');
                    if (icon) icon.className = 'fas fa-file-pdf';
                    const text = uploadBox.querySelector('p');
                    if (text) text.textContent = 'PDF Uploaded';
                } else {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'img-thumbnail';
                    previewDiv.appendChild(img);
                    
                    // Update the upload icon and text
                    const icon = uploadBox.querySelector('.fa-cloud-upload-alt');
                    if (icon) icon.className = 'fas fa-image';
                    const text = uploadBox.querySelector('p');
                    if (text) text.textContent = 'Image Uploaded';
                }
            } else {
                uploadBox.classList.remove('has-file');
                // Reset to default icon and text
                const icon = uploadBox.querySelector('i');
                if (icon) icon.className = 'fas fa-cloud-upload-alt';
                const text = uploadBox.querySelector('p');
                if (text) text.textContent = 'Click to upload document';
            }
        }

        // Add event listeners for document uploads
        ['driverLicense', 'voidedCheck', 'merchantStatement', 'otherMerchantDocuments'].forEach(id => {
            document.getElementById(id).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const previewId = id + 'Preview';
                    const uploadBox = document.getElementById(previewId).closest('.upload-box');
                    
                    if (file.type === 'application/pdf') {
                        updateDocumentPreview(previewId, URL.createObjectURL(file));
                    } else if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            updateDocumentPreview(previewId, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        });

        // Function to toggle API key visibility
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('payarcApiKey');
            const toggleIcon = apiKeyInput.nextElementSibling;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            }
        }

        document.querySelector('[data-modal="payment-processing-modal"]').addEventListener('click', loadPaymentSettings);

        async function saveGeneralPaymentSettings() {
    try {
        const studioId = localStorage.getItem('currentStudioId');
        const db = firebase.firestore();
        
        const generalSettings = {
            General: {
                AutoPaymentsEnabled: document.getElementById('autoPaymentsEnabled').checked,
                PaymentRetryDays: parseInt(document.getElementById('paymentRetryDays').value),
                PaymentNotificationEmail: document.getElementById('paymentNotificationEmail').value,
                PostChargesDay: parseInt(document.getElementById('postChargesDay').value),
                AutoPayBillingDay: parseInt(document.getElementById('autoPayBillingDay').value)
            },
            UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('Studios').doc(studioId)
                .collection('PaymentProcessing')
                .doc('Settings')
                .set(generalSettings, { merge: true });

        closeModal('general-payment-settings-modal');
        alert('General payment settings saved successfully!');
        
    } catch (error) {
        console.error('Error saving general payment settings:', error);
        alert('Error saving general payment settings. Please try again.');
    }
}

async function loadGeneralPaymentSettings() {
    try {
        const studioId = localStorage.getItem('currentStudioId');
        const db = firebase.firestore();
        
        const doc = await db.collection('Studios').doc(studioId)
                   .collection('PaymentProcessing')
                   .doc('Settings')
                   .get();

        if (doc.exists) {
            const settings = doc.data();
            
            // General settings
            const enableToggle = document.getElementById('autoPaymentsEnabled');
            
            enableToggle.checked = settings.General?.AutoPaymentsEnabled || false;
            
            document.getElementById('paymentRetryDays').value = settings.General?.PaymentRetryDays || 3;
            document.getElementById('paymentNotificationEmail').value = settings.General?.PaymentNotificationEmail || '';
            document.getElementById('postChargesDay').value = settings.General?.PostChargesDay || 1;
            document.getElementById('autoPayBillingDay').value = settings.General?.AutoPayBillingDay || 5;
        }
    } catch (error) {
        console.error('Error loading general payment settings:', error);
    }
}


// Add event listener for the modal open
document.querySelector('[data-modal="general-payment-settings-modal"]').addEventListener('click', loadGeneralPaymentSettings); </script>

    <!-- Add this card in the settings-grid div, after Profile and before Classes/Seasons -->
    <div class="setting-card" data-modal="studio-settings-modal">
        <i class="fas fa-building"></i>
        <h3>Studio Settings</h3>
        <p>Manage studio information and branding</p>
    </div>

    <!-- Add the Studio Settings Modal -->
    <div id="studio-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Studio Settings</h2>
                <button type="button" class="close" onclick="closeModal('studio-settings-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="row g-4">
                    <!-- Studio Information -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Studio Information</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Studio Name</label>
                                    <input type="text" id="studioName" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                </div>
                                <div class="form-group mb-4">
                                    <label class="form-label" style="font-weight: 500; color: #525f7f;">Industry</label>
                                    <select id="studioIndustry" class="form-control" 
                                        style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                        <option value="Dance">Dance</option>
                                        <option value="Gymnastics">Gymnastics</option>
                                        <option value="Martial Arts">Martial Arts</option>
                                        <option value="Music">Music</option>
                                        <option value="Pilates">Pilates</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Studio Logo -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-image me-2"></i>Studio Logo</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="text-center mb-3">
                                    <img id="studioLogoPreview" src="" alt="Studio Logo" 
                                        style="max-width: 200px; max-height: 200px; border-radius: 0.5rem;">
                                </div>
                                <div class="form-group">
                                    <label for="studioLogo" class="form-label d-block">
                                        <div class="btn btn-outline-primary w-100" style="border-radius: 0.5rem; padding: 0.75rem;">
                                            <i class="fas fa-upload me-2"></i>Upload New Logo
                                        </div>
                                    </label>
                                    <input type="file" id="studioLogo" accept="image/*" style="display: none;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Studio Address -->
                    <div class="col-12">
                        <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-header" style="background: #f8f9fa; color: #525f7f; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem;">
                                <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Studio Address</h5>
                            </div>
                            <div class="card-body" style="padding: 1.5rem;">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Address Line 1</label>
                                        <input type="text" id="studioAddress1" class="form-control" 
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Address Line 2</label>
                                        <input type="text" id="studioAddress2" class="form-control" 
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">City</label>
                                        <input type="text" id="studioCity" class="form-control" 
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">State</label>
                                        <input type="text" id="studioState" class="form-control" 
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="font-weight: 500; color: #525f7f;">ZIP Code</label>
                                        <input type="text" id="studioZip" class="form-control" 
                                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; transition: all 0.3s ease;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-secondary" 
                    style="border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="closeModal('studio-settings-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" 
                    style="background: var(--primary-color); border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="saveStudioSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add this JavaScript for studio settings -->
    <script>
        // Function to load studio settings
        async function loadStudioSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios').doc(studioId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('studioName').value = data.StudioName || '';
                    document.getElementById('studioIndustry').value = data.Industry || 'Other';
                    document.getElementById('studioAddress1').value = data.StudioAddress1 || '';
                    document.getElementById('studioAddress2').value = data.StudioAddress2 || '';
                    document.getElementById('studioCity').value = data.StudioCity || '';
                    document.getElementById('studioState').value = data.StudioState || '';
                    document.getElementById('studioZip').value = data.StudioZip || '';
                    
                    // Load logo preview if it exists
                    const logoPreview = document.getElementById('studioLogoPreview');
                    if (data.LogoUrl) {
                        logoPreview.src = data.LogoUrl;
                    } else {
                        logoPreview.src = '';
                    }
                }
            } catch (error) {
                console.error('Error loading studio settings:', error);
            }
        }

        // Function to save studio settings
        async function saveStudioSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                const storage = firebase.storage();
                
                let logoUrl = document.getElementById('studioLogoPreview').src;
                const logoFile = document.getElementById('studioLogo').files[0];
                
                // Upload new logo if selected
                if (logoFile) {
                    const logoRef = storage.ref(`StudioLogos/${studioId}/${logoFile.name}`);
                    await logoRef.put(logoFile);
                    logoUrl = await logoRef.getDownloadURL();
                }
                
                const studioData = {
                    StudioName: document.getElementById('studioName').value,
                    Industry: document.getElementById('studioIndustry').value,
                    StudioAddress1: document.getElementById('studioAddress1').value,
                    StudioAddress2: document.getElementById('studioAddress2').value || null,
                    StudioCity: document.getElementById('studioCity').value,
                    StudioState: document.getElementById('studioState').value,
                    StudioZip: document.getElementById('studioZip').value,
                    LogoUrl: logoUrl,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('Studios').doc(studioId).update(studioData);
                
                closeModal('studio-settings-modal');
                alert('Studio settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving studio settings:', error);
                alert('Error saving studio settings. Please try again.');
            }
        }

        // Add logo preview functionality
        document.getElementById('studioLogo').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('studioLogoPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Load studio settings when modal is opened
        document.querySelector('[data-modal="studio-settings-modal"]').addEventListener('click', loadStudioSettings);
    </script>

    <!-- Add this JavaScript after the existing scripts -->
    <script>
        // Function to load user profile settings
        async function loadProfileSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const userDocId = localStorage.getItem('userDocId');
                const db = firebase.firestore();
                
                const userDoc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(userDocId)
                    .get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log('Loaded user data:', userData);
                    
                    // Debug logs to check if elements exist
                    console.log('Email element:', document.getElementById('profileEmail'));
                    console.log('Role element:', document.getElementById('profileRole'));
                    
                    // Populate form fields with user data
                    const emailInput = document.getElementById('profileEmail');
                    if (emailInput) emailInput.value = userData.Email || '';
                    
                    const firstNameInput = document.getElementById('firstName');
                    if (firstNameInput) firstNameInput.value = userData.FirstName || '';
                    
                    const lastNameInput = document.getElementById('lastName');
                    if (lastNameInput) lastNameInput.value = userData.LastName || '';
                    
                    const phoneInput = document.getElementById('phoneNumber');
                    if (phoneInput) phoneInput.value = userData.Phone || '';
                    
                    // Handle Role display
                    const roleElement = document.getElementById('profileRole');
                    if (roleElement) {
                        if (userData.Role) {
                            if (Array.isArray(userData.Role)) {
                                roleElement.value = userData.Role.join(' | ');
                            } else {
                                roleElement.value = userData.Role;
                            }
                        } else {
                            roleElement.value = 'No Role Assigned';
                        }
                        
                        // Ensure the role field is read-only
                        roleElement.readOnly = true;
                        roleElement.style.backgroundColor = '#f8f9fa';
                        roleElement.style.cursor = 'default';
                    }
                    
                    const timeZoneSelect = document.getElementById('timeZone');
                    if (timeZoneSelect) timeZoneSelect.value = userData.TimeZone || 'America/New_York';
                    
                    const emailNotifCheckbox = document.getElementById('emailNotifications');
                    if (emailNotifCheckbox) emailNotifCheckbox.checked = userData.EmailNotifications || false;
                    
                    const smsNotifCheckbox = document.getElementById('smsNotifications');
                    if (smsNotifCheckbox) smsNotifCheckbox.checked = userData.SmsNotifications || false;
                }
            } catch (error) {
                console.error('Error loading profile settings:', error);
                alert('Error loading profile settings. Please try again.');
            }
        }

        // Function to save profile settings
        async function saveProfileSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const userDocId = localStorage.getItem('userDocId');
                const db = firebase.firestore();
                
                // Get the current user data first to preserve the Role array
                const userDoc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(userDocId)
                    .get();
                    
                const currentUserData = userDoc.exists ? userDoc.data() : {};
                
                const userData = {
                    FirstName: document.getElementById('firstName').value,
                    LastName: document.getElementById('lastName').value,
                    Email: document.getElementById('profileEmail').value, // Updated ID
                    Phone: document.getElementById('phoneNumber').value,
                    Role: currentUserData.Role, // Preserve the existing Role array
                    TimeZone: document.getElementById('timeZone').value,
                    EmailNotifications: document.getElementById('emailNotifications').checked,
                    SmsNotifications: document.getElementById('smsNotifications').checked,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(userDocId)
                    .update(userData);
                
                closeModal('profile-modal');
                alert('Profile settings saved successfully!');
                
                // Update the displayed user name in the navbar
                const fullName = `${userData.FirstName} ${userData.LastName}`;
                document.getElementById('userName').textContent = fullName;
                
                // Update initials in the avatar
                const initials = `${userData.FirstName[0]}${userData.LastName[0]}`;
                document.querySelector('.initials').textContent = initials;
                
            } catch (error) {
                console.error('Error saving profile settings:', error);
                alert('Error saving profile settings. Please try again.');
            }
        }

        // Load profile settings when modal is opened
        document.querySelector('[data-modal="profile-modal"]').addEventListener('click', loadProfileSettings);
    </script>

    <!-- Add the Billing Modal -->
    <div id="billing-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Billing & Subscription</h2>
                <button type="button" class="close" onclick="closeModal('billing-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Billing Tabs -->
                <ul class="nav nav-tabs mb-4" id="billingTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="subscription-tab" data-bs-toggle="tab" 
                            data-bs-target="#subscription" type="button" role="tab">
                            Subscription Plan
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" 
                            data-bs-target="#history" type="button" role="tab">
                            Billing History
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="payment-info-tab" data-bs-toggle="tab" 
                            data-bs-target="#payment-info" type="button" role="tab">
                            Payment Information
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="billingTabContent">
                    <!-- Subscription Plan Tab -->
                    <div class="tab-pane fade show active" id="subscription" role="tabpanel">
                        <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h3 class="mb-1" style="color: #1F2937; font-weight: 600;">
                                            <span id="currentPlanName">Loading...</span> - 
                                            <span id="currentBillingPeriod">Loading...</span>
                                        </h3>
                                        <p class="text-muted mb-0">Your current subscription plan</p>
                                    </div>
                                    <div id="subscriptionStatus" class="badge">Loading...</div>
                                </div>
                                <div class="d-flex gap-3">
                                    <button onclick="showChangeSubscriptionModal()" class="btn btn-primary btn-subscription">
                                        Change Subscription
                                    </button>
                                    <button id="cancelRestoreBtn" onclick="showCancelSubscriptionModal()" class="btn btn-outline-danger btn-subscription">
                                        Cancel Subscription
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Billing History Tab -->
                    <div class="tab-pane fade" id="history" role="tabpanel">
                        <div class="billing-table">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Invoice</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Mar 1, 2024</td>
                                            <td>Studio Pro Monthly Subscription</td>
                                            <td>$49.99</td>
                                            <td><span class="badge bg-success">Paid</span></td>
                                            <td><a href="#" class="text-primary">Download</a></td>
                                        </tr>
                                        <tr>
                                            <td>Feb 1, 2024</td>
                                            <td>Studio Pro Monthly Subscription</td>
                                            <td>$49.99</td>
                                            <td><span class="badge bg-success">Paid</span></td>
                                            <td><a href="#" class="text-primary">Download</a></td>
                                        </tr>
                                        <tr>
                                            <td>Jan 1, 2024</td>
                                            <td>Studio Pro Monthly Subscription</td>
                                            <td>$49.99</td>
                                            <td><span class="badge bg-success">Paid</span></td>
                                            <td><a href="#" class="text-primary">Download</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information Tab -->
                    <div class="tab-pane fade" id="payment-info" role="tabpanel">
                        <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                            <div class="card-body p-4">
                                <form id="payment-info-form">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Card Holder Name</label>
                                            <input type="text" class="form-control" id="cardHolderName" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Card Number</label>
                                            <input type="text" class="form-control" id="cardNumber" 
                                                placeholder="**** **** **** ****" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Expiration Month</label>
                                            <input type="text" 
                                               class="form-control" 
                                               id="expirationMonth" 
                                               placeholder="MM" 
                                               maxlength="2"
                                               pattern="(0[1-9]|1[0-2])"
                                               title="Please enter a valid month (01-12)"
                                               required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Expiration Year</label>
                                            <select class="form-select" id="expirationYear" required>
                                                <option value="">Year</option>
                                                <!-- Dynamically populate years -->
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" 
                                                placeholder="***" maxlength="4" required>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                Update Payment Information
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modals -->
    <div id="changeSubscriptionModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Change Subscription</h2>
                <button type="button" class="close" onclick="closeModal('changeSubscriptionModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="billing-frequency text-center mb-4">
                    <select id="change-billing-frequency" class="form-select" style="max-width: 200px; margin: 0 auto;">
                        <option value="monthly">Monthly Billing</option>
                        <option value="quarterly">Quarterly Billing</option>
                        <option value="semi-annually">Semi-Annual Billing</option>
                        <option value="annually">Annual Billing</option>
                    </select>
                </div>
                
                <div class="plans-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    <!-- Basic Plan -->
                    <div class="plan card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                        <div class="card-body p-4">
                            <h3 class="plan-name mb-3">Studio Basic</h3>
                            <div class="plan-price mb-3">$39.99<span style="font-size: 1rem;">/month</span></div>
                            <div class="original-price text-muted"></div>
                            <ul class="plan-features">
                                <li>Up to 50 Students</li>
                                <li>Basic Scheduling</li>
                                <li>Payment Processing</li>
                                <li>Email Support</li>
                            </ul>
                            <button onclick="confirmPlanChange('Studio Basic')" class="btn btn-primary w-100">Select Plan</button>
                        </div>
                    </div>

                    <!-- Pro Plan -->
                    <div class="plan card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                        <div class="card-body p-4">
                            <h3 class="plan-name mb-3">Studio Pro</h3>
                            <div class="plan-price mb-3">$69.99<span style="font-size: 1rem;">/month</span></div>
                            <div class="original-price text-muted"></div>
                            <ul class="plan-features">
                                <li>Up to 200 Students</li>
                                <li>Advanced Scheduling</li>
                                <li>Payment Processing</li>
                                <li>Priority Support</li>
                                <li>Custom Branding</li>
                            </ul>
                            <button onclick="confirmPlanChange('Studio Pro')" class="btn btn-primary w-100">Select Plan</button>
                        </div>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="plan card h-100" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                        <div class="card-body p-4">
                            <h3 class="plan-name mb-3">Studio Enterprise</h3>
                            <div class="plan-price mb-3">$99.99<span style="font-size: 1rem;">/month</span></div>
                            <div class="original-price text-muted"></div>
                            <ul class="plan-features">
                                <li>Unlimited Students</li>
                                <li>Advanced Scheduling</li>
                                <li>Payment Processing</li>
                                <li>24/7 Priority Support</li>
                                <li>Custom Branding</li>
                                <li>API Access</li>
                                <li>Advanced Analytics</li>
                            </ul>
                            <button onclick="confirmPlanChange('Studio Enterprise')" class="btn btn-primary w-100">Select Plan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Change Confirmation Modal -->
    <div id="planChangeConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Confirm Plan Change</h2>
                <button type="button" class="close" onclick="closeModal('planChangeConfirmModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p>Are you sure you want to change your subscription to <span id="newPlanName" style="font-weight: 600;"></span>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('planChangeConfirmModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handlePlanChange()">Confirm Change</button>
            </div>
        </div>
    </div>

    <!-- Cancel Subscription Confirmation Modal -->
    <div id="cancelSubscriptionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Cancel Subscription</h2>
                <button type="button" class="close" onclick="closeModal('cancelSubscriptionModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p>Are you sure you want to cancel your <span id="currentPlanNameInCancel" style="font-weight: 600;"></span> Plan?</p>
                <p class="text-muted mt-2">Your account will go into Pending Cancellation and will remain active until your next billing date.</p>
                <p class="text-muted">You will still have full access to your account until then.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('cancelSubscriptionModal')">Keep Subscription</button>
                <button type="button" class="btn btn-danger" onclick="handleCancelSubscription()">Yes, Cancel Subscription</button>
            </div>
        </div>
    </div>

    <!-- Restore Subscription Confirmation Modal -->
    <div id="restoreSubscriptionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Restore Subscription</h2>
                <button type="button" class="close" onclick="closeModal('restoreSubscriptionModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p>Are you sure you want to restore your subscription?</p>
                <p class="text-muted mt-2">Your account will no longer be marked as Pending Cancellation.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('restoreSubscriptionModal')">No, Keep Pending</button>
                <button type="button" class="btn btn-success" onclick="handleRestoreSubscription()">Yes, Restore Subscription</button>
            </div>
        </div>
    </div>

    <!-- Add this JavaScript for billing functionality -->
    <script>
        let selectedNewPlan = '';

        function confirmPlanChange(planName) {
            selectedNewPlan = planName;
            document.getElementById('newPlanName').textContent = planName;
            
            // Get and display the billing period
            const billingFrequencySelect = document.getElementById('change-billing-frequency');
            const billingPeriod = billingFrequencySelect.value.charAt(0).toUpperCase() + 
                                 billingFrequencySelect.value.slice(1);
            
            // Update confirmation message to include billing period
            document.getElementById('newPlanName').textContent = `${planName} (${billingPeriod})`;
            
            closeModal('changeSubscriptionModal');
            openModal('planChangeConfirmModal');
        }

        async function handlePlanChange() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                // Get the selected billing frequency
                const billingFrequencySelect = document.getElementById('change-billing-frequency');
                const billingPeriod = billingFrequencySelect.value.charAt(0).toUpperCase() + 
                                     billingFrequencySelect.value.slice(1); // Capitalize first letter
                
                await db.collection('Studios').doc(studioId).update({
                    SubscriptionPlan: selectedNewPlan,
                    BillingPeriod: billingPeriod,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeModal('planChangeConfirmModal');
                alert('Your subscription has been updated successfully!');
                loadBillingInfo(); // Refresh the billing info display
                openModal('billing-modal'); // Reopen the billing modal to show updates
            } catch (error) {
                console.error('Error changing subscription:', error);
                alert('Error changing subscription. Please try again.');
            }
        }

        // Add the price update function
        function updateChangePlanPrices() {
            const frequency = document.getElementById('change-billing-frequency').value;
            const discounts = {
                'monthly': 1,
                'quarterly': 0.95,
                'semi-annually': 0.90,
                'annually': 0.85
            };
            const discount = discounts[frequency];
            const billingPeriod = {
                'monthly': '/month',
                'quarterly': '/quarter',
                'semi-annually': '/6 months',
                'annually': '/year'
            };

            const plans = [
                { selector: '.plan:nth-child(1)', basePrice: 39.99 },
                { selector: '.plan:nth-child(2)', basePrice: 69.99 },
                { selector: '.plan:nth-child(3)', basePrice: 99.99 }
            ];

            plans.forEach(plan => {
                const planElement = document.querySelector(plan.selector);
                const priceElement = planElement.querySelector('.plan-price');
                const originalPriceElement = planElement.querySelector('.original-price');
                
                const discountedPrice = plan.basePrice * discount;
                const totalPrice = discountedPrice * (
                    frequency === 'monthly' ? 1 : 
                    frequency === 'quarterly' ? 3 : 
                    frequency === 'semi-annually' ? 6 : 12
                );
                
                priceElement.innerHTML = `$${totalPrice.toFixed(2)}<span style="font-size: 1rem;">${billingPeriod[frequency]}</span>`;
                
                if (discount < 1) {
                    const originalTotal = plan.basePrice * (
                        frequency === 'monthly' ? 1 : 
                        frequency === 'quarterly' ? 3 : 
                        frequency === 'semi-annually' ? 6 : 12
                    );
                    originalPriceElement.textContent = `Original: $${originalTotal.toFixed(2)}${billingPeriod[frequency]}`;
                } else {
                    originalPriceElement.textContent = '';
                }
            });
        }

        // Add event listener for billing frequency changes
        document.getElementById('change-billing-frequency').addEventListener('change', updateChangePlanPrices);

        // Update prices when the change subscription modal is opened
        document.querySelector('[onclick="showChangeSubscriptionModal()"]').addEventListener('click', () => {
            setTimeout(updateChangePlanPrices, 100); // Small delay to ensure modal is rendered
        });

        async function loadBillingInfo() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const studioDoc = await db.collection('Studios').doc(studioId).get();
                if (studioDoc.exists) {
                    const studioData = studioDoc.data();
                    
                    // Update plan name and billing period
                    const planNameElement = document.getElementById('currentPlanName');
                    const billingPeriodElement = document.getElementById('currentBillingPeriod');
                    const statusBadge = document.getElementById('subscriptionStatus');
                    
                    if (planNameElement && billingPeriodElement && statusBadge) {
                        planNameElement.textContent = studioData.SubscriptionPlan || 'No Plan';
                        billingPeriodElement.textContent = studioData.BillingPeriod || 'Monthly';
                        
                        // Update the active status badge
                        if (studioData.IsPendingCancellation) {
                            statusBadge.className = 'badge bg-warning';
                            statusBadge.textContent = 'Pending Cancellation';
                            updateCancelRestoreButton(true);
                        } else if (studioData.AccountIsActive) {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = 'Active';
                            updateCancelRestoreButton(false);
                        } else {
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = 'Not Active';
                            updateCancelRestoreButton(false);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading billing info:', error);
                alert('Error loading billing information. Please try again.');
            }
        }

        function showChangeSubscriptionModal() {
            closeModal('billing-modal');
            openModal('changeSubscriptionModal');
        }

        function showCancelSubscriptionModal() {
            closeModal('billing-modal');
            openModal('cancelSubscriptionModal');
        }

        async function handleChangeSubscription() {
            // Implement subscription change logic here
            closeModal('changeSubscriptionModal');
            // Redirect to subscription selection page or show subscription options
            alert('Redirecting to subscription selection...');
        }

        async function handleCancelSubscription() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios').doc(studioId).update({
                    AccountIsActive: true, // Keep account active during pending cancellation
                    IsPendingCancellation: true,
                    CancellationRequestDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeModal('cancelSubscriptionModal');
                
                // Update the UI immediately
                const statusBadge = document.getElementById('subscriptionStatus');
                if (statusBadge) {
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.textContent = 'Pending Cancellation';
                }
                
                // Update the cancel/restore button
                updateCancelRestoreButton(true);
                
                alert('Your subscription has been set to cancel at the end of your billing period. Your account will remain active until then.');
                
                // Reopen the billing modal and refresh the display
                openModal('billing-modal');
                loadBillingInfo();
            } catch (error) {
                console.error('Error cancelling subscription:', error);
                alert('Error cancelling subscription. Please try again.');
            }
        }

        function showRestoreSubscriptionModal() {
            closeModal('billing-modal');
            openModal('restoreSubscriptionModal');
        }

        async function handleRestoreSubscription() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios').doc(studioId).update({
                    IsPendingCancellation: false,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeModal('restoreSubscriptionModal');
                
                // Update the UI immediately
                const statusBadge = document.getElementById('subscriptionStatus');
                if (statusBadge) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Active';
                }
                
                // Update the cancel/restore button
                updateCancelRestoreButton(false);
                
                alert('Your subscription has been restored successfully.');
                
                // Reopen the billing modal and refresh the display
                openModal('billing-modal');
                loadBillingInfo();
            } catch (error) {
                console.error('Error restoring subscription:', error);
                alert('Error restoring subscription. Please try again.');
            }
        }

        function updateCancelRestoreButton(isPendingCancellation) {
            const button = document.getElementById('cancelRestoreBtn');
            if (isPendingCancellation) {
                button.textContent = 'Restore Subscription';
                button.className = 'btn btn-outline-success btn-subscription';
                button.onclick = showRestoreSubscriptionModal;
            } else {
                button.textContent = 'Cancel Subscription';
                button.className = 'btn btn-outline-danger btn-subscription';
                button.onclick = showCancelSubscriptionModal;
            }
        }

        // Load billing info when the billing modal is opened
        document.querySelector('[data-modal="billing-modal"]').addEventListener('click', function() {
            loadBillingInfo();
        });
    </script>

    <!-- Add new Payment Information tab in the billing tabs -->
    <ul class="nav nav-tabs mb-4" id="billingTabs" role="tablist">
        // ... existing tabs ...
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="payment-info-tab" data-bs-toggle="tab" 
                data-bs-target="#payment-info" type="button" role="tab">
                Payment Information
            </button>
        </li>
    </ul>

    <!-- Add Payment Information tab content -->
    <div class="tab-content" id="billingTabContent">
        // ... existing tab panes ...
        
        <!-- Payment Information Tab -->
        <div class="tab-pane fade" id="payment-info" role="tabpanel">
            <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                <div class="card-body p-4">
                    <form id="payment-info-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Card Holder Name</label>
                                <input type="text" class="form-control" id="cardHolderName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" 
                                    placeholder="**** **** **** ****" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Expiration Month</label>
                                <input type="text" 
                                   class="form-control" 
                                   id="expirationMonth" 
                                   placeholder="MM" 
                                   maxlength="2"
                                   pattern="(0[1-9]|1[0-2])"
                                   title="Please enter a valid month (01-12)"
                                   required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Expiration Year</label>
                                <select class="form-select" id="expirationYear" required>
                                    <option value="">Year</option>
                                    <!-- Dynamically populate years -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" 
                                    placeholder="***" maxlength="4" required>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    Update Payment Information
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Team Settings Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Team Management</h2>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-primary me-2" onclick="openAddTeamMemberModal()">
                        <i class="fas fa-plus"></i> Add New Team Member
                    </button>
                    <button type="button" class="close" onclick="closeModal('team-modal')">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div class="team-table-container" style="background: white; border-radius: 1rem; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);">
                    <table id="teamTable" class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Roles</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Team members will be loaded here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadTeamMembers() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const usersSnapshot = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .get();

                const tableBody = document.querySelector('#teamTable tbody');
                tableBody.innerHTML = ''; // Clear existing rows

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const row = document.createElement('tr');
                    row.setAttribute('data-user-id', doc.id);
                    
                    // Format roles as badges
                    const rolesBadges = Array.isArray(userData.Role) 
                        ? userData.Role.map(role => `<span class="role-badge">${role}</span>`).join(' ')
                        : `<span class="role-badge">${userData.Role || 'No Role'}</span>`;

                    row.innerHTML = `
                        <td>${userData.FirstName} ${userData.LastName}</td>
                        <td>${userData.Email}</td>
                        <td>${userData.Phone || 'N/A'}</td>
                        <td>${rolesBadges}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                onclick="editTeamMember('${doc.id}')" 
                                style="margin-right: 0.5rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                onclick="removeTeamMember('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading team members:', error);
                alert('Error loading team members. Please try again.');
            }
        }

        // Add event listener to load team members when the modal is opened
        document.querySelector('[data-modal="team-modal"]').addEventListener('click', function() {
            loadTeamMembers();
        });

        let currentEditUserId = '';

        async function editTeamMember(userId) {
            try {
                currentEditUserId = userId;
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const userDoc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(userId)
                    .get();
                    
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Populate form fields
                    document.getElementById('editFirstName').value = userData.FirstName || '';
                    document.getElementById('editLastName').value = userData.LastName || '';
                    document.getElementById('editEmail').value = userData.Email || '';
                    document.getElementById('editPhone').value = userData.Phone || '';
                    
                    // Reset and set role checkboxes
                    document.querySelectorAll('#editRoles input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = Array.isArray(userData.Role) && userData.Role.includes(checkbox.value);
                    });
                    
                    closeModal('team-modal');
                    openModal('editTeamModal');
                }
            } catch (error) {
                console.error('Error loading team member data:', error);
                alert('Error loading team member data. Please try again.');
            }
        }

        async function saveTeamMember() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                // Get selected roles
                const selectedRoles = Array.from(document.querySelectorAll('#editRoles input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Get the original user data to check if Instructor role is being modified
                const userDoc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(currentEditUserId)
                    .get();
                
                const userData = userDoc.data();
                const hadInstructorRole = Array.isArray(userData.Role) && userData.Role.includes('Instructor');
                const hasInstructorRole = selectedRoles.includes('Instructor');

                // Check if trying to add or remove Instructor role
                if (!hadInstructorRole && hasInstructorRole) {
                    alert('Please use the Instructors Manager to add new instructors. The Instructor role cannot be added here.');
                    return;
                }

                if (hadInstructorRole && !hasInstructorRole) {
                    alert('Please use the Instructors Manager to remove instructors. The Instructor role cannot be removed here.');
                    return;
                }
                
                const updatedUserData = {
                    FirstName: document.getElementById('editFirstName').value,
                    LastName: document.getElementById('editLastName').value,
                    Email: document.getElementById('editEmail').value,
                    Phone: document.getElementById('editPhone').value,
                    Role: selectedRoles,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update User document
                await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(currentEditUserId)
                    .update(updatedUserData);
                     
                closeModal('editTeamModal');
                alert('Team member updated successfully!');
                openModal('team-modal');
                loadTeamMembers(); // Refresh the table
                
            } catch (error) {
                console.error('Error updating team member:', error);
                alert('Error updating team member. Please try again.');
            }
        }

        function removeTeamMember(userId) {
            currentEditUserId = userId;
            
            // Get the user's name for the confirmation message
            try {
                const row = document.querySelector(`tr[data-user-id="${userId}"]`);
                if (row) {
                    const name = row.querySelector('td').textContent;
                    document.getElementById('deleteTeamMemberName').textContent = name;
                } else {
                    document.getElementById('deleteTeamMemberName').textContent = 'this team member';
                }
            } catch (error) {
                console.error('Error getting team member name:', error);
                document.getElementById('deleteTeamMemberName').textContent = 'this team member';
            }
            
            closeModal('team-modal');
            openModal('deleteTeamModal');
        }
        
        async function confirmDeleteTeamMember() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                const auth = firebase.auth();
                
                // Get the user data first to check roles
                const userDoc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(currentEditUserId)
                    .get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Check if user has Instructor role
                    if (Array.isArray(userData.Role) && userData.Role.includes('Instructor')) {
                        alert('Please use the Instructors Manager to remove instructors. Team members with Instructor role cannot be deleted here.');
                        return;
                    }
                    
                    // Delete from Users collection
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Users')
                        .doc(currentEditUserId)
                        .delete();
                    
                    // Delete Firebase Auth user if email exists
                    if (userData.Email) {
                        try {
                            const userRecord = await auth.getUserByEmail(userData.Email);
                            if (userRecord) {
                                await auth.deleteUser(userRecord.uid);
                            }
                        } catch (authError) {
                            console.warn('Could not delete Firebase Auth user:', authError);
                            // Continue with the rest of the deletion process even if auth deletion fails
                        }
                    }
                    
                    closeModal('deleteTeamModal');
                    alert('Team member removed successfully!');
                    openModal('team-modal');
                    loadTeamMembers(); // Refresh the table
                }
            } catch (error) {
                console.error('Error removing team member:', error);
                alert('Error removing team member. Please try again.');
            }
        }

        function openAddTeamMemberModal() {
            closeModal('team-modal');
            openModal('addTeamModal');
        }

        async function saveNewTeamMember() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                // Get form values
                const firstName = document.getElementById('addFirstName').value;
                const lastName = document.getElementById('addLastName').value;
                const email = document.getElementById('addEmail').value;
                const phone = document.getElementById('addPhone').value;
                
                // Get selected roles
                const roles = [];
                document.querySelectorAll('#addRoles input[type="checkbox"]:checked').forEach(checkbox => {
                    roles.push(checkbox.value);
                });

                // Check if trying to add Instructor role
                if (roles.includes('Instructor')) {
                    alert('Please use the Instructors Manager to add new instructors. The Instructor role cannot be added here.');
                    return;
                }

                // Create Firebase Authentication user
                const auth = firebase.auth();
                const userCredential = await auth.createUserWithEmailAndPassword(email, 'defaultPassword123');
                const firebaseUserId = userCredential.user.uid;

                // Send password reset email
                await auth.sendPasswordResetEmail(email);

                // Create new user document in Firestore
                await db.collection('Studios')
                    .doc(studioId)
                    .collection('Users')
                    .doc(firebaseUserId)
                    .set({
                        FirstName: firstName,
                        LastName: lastName,
                        Email: email,
                        Phone: phone,
                        Role: roles,
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                // Close modal and refresh team list
                closeModal('addTeamModal');
                alert('Team member added successfully! A password reset email has been sent to their email address.');
                openModal('team-modal');
                loadTeamMembers();
                
                // Reset form
                document.getElementById('addTeamForm').reset();
                
            } catch (error) {
                console.error('Error adding team member:', error);
                alert('Error adding team member. Please try again.');
            }
        }

        // Function to open create tag modal
        function openCreateTagModal() {
            document.getElementById('tagName').value = '';
            closeModal('tags-modal');
            openModal('create-tag-modal');
        }

        // Function to save tag
        async function saveTag() {
            try {
                const tagName = document.getElementById('tagName').value.trim();
                if (!tagName) {
                    alert('Please enter a tag name');
                    return;
                }

                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios').doc(studioId).collection('Tags').add({
                    Name: tagName,
                    CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal('create-tag-modal');
                openModal('tags-modal');
                loadTags(); // Refresh the tags list
            } catch (error) {
                console.error('Error saving tag:', error);
                alert('Error saving tag. Please try again.');
            }
        }

        // Function to load tags
        async function loadTags() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const tagsSnapshot = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Tags')
                    .orderBy('CreatedAt', 'desc')
                    .get();
                
                const tagsTableBody = document.getElementById('tagsTableBody');
                if (tagsSnapshot.empty) {
                    tagsTableBody.innerHTML = '<tr><td colspan="3" class="text-center">No tags found</td></tr>';
                    return;
                }

                tagsTableBody.innerHTML = tagsSnapshot.docs.map(doc => {
                    const tag = doc.data();
                    return `
                        <tr>
                            <td>${tag.Name}</td>
                            <td>${tag.CreatedAt ? new Date(tag.CreatedAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteTag('${doc.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading tags:', error);
                alert('Error loading tags. Please try again.');
            }
        }

        // Function to delete tag
        async function deleteTag(tagId) {
            if (!confirm('Are you sure you want to delete this tag?')) {
                return;
            }

            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios')
                    .doc(studioId)
                    .collection('Tags')
                    .doc(tagId)
                    .delete();

                loadTags(); // Refresh the tags list
            } catch (error) {
                console.error('Error deleting tag:', error);
                alert('Error deleting tag. Please try again.');
            }
        }

        // Add event listener for tags modal
        document.addEventListener('DOMContentLoaded', function() {
            const tagsModal = document.getElementById('tags-modal');
            if (tagsModal) {
                tagsModal.addEventListener('show', function() {
                    console.log('Tags management opened');
                    loadTags();
                });
            }
        });

    </script>
<!-- Add Team Member Modal -->
<div id="addTeamModal" class="modal">
    <div class="modal-content" style="max-width: 600px; width: 90%;">
        <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
            <h2 class="modal-title">Add New Team Member</h2>
            <button type="button" class="close" onclick="closeModal('addTeamModal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <form id="addTeamForm">
                <div class="form-group mb-3">
                    <label class="form-label">First Name</label>
                    <input type="text" id="addFirstName" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Last Name</label>
                    <input type="text" id="addLastName" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="addEmail" class="form-control" required>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Phone</label>
                    <input type="tel" id="addPhone" class="form-control">
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Roles</label>
                    <div id="addRoles" class="d-flex flex-wrap gap-2">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addRoleOwner" value="Owner">
                            <label class="form-check-label">Owner</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addRoleDirector" value="Director">
                            <label class="form-check-label">Director</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addRoleAdmin" value="Admin">
                            <label class="form-check-label">Admin</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addRoleStaff" value="Staff">
                            <label class="form-check-label">Staff</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addRoleInstructor" value="Instructor" disabled>
                            <label class="form-check-label">Instructor</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addTeamModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveNewTeamMember()">Add Team Member</button>
        </div>
    </div>
</div>

    <!-- Team Member Edit Modal -->
    <div id="editTeamModal" class="modal">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Edit Team Member</h2>
                <button type="button" class="close" onclick="closeModal('editTeamModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="editTeamForm">
                                <div class="form-group mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" id="editFirstName" class="form-control">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" id="editLastName" class="form-control">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="editEmail" class="form-control">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="editPhone" class="form-control">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Roles</label>
                        <div id="editRoles" class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="roleOwner" value="Owner">
                                <label class="form-check-label">Owner</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="roleDirector" value="Director">
                                <label class="form-check-label">Director</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="roleAdmin" value="Admin">
                                <label class="form-check-label">Admin</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="roleStaff" value="Staff">
                                <label class="form-check-label">Staff</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="roleInstructor" value="Instructor" disabled>
                                <label class="form-check-label">Instructor</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editTeamModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTeamMember()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteTeamModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Delete Team Member</h2>
                <button type="button" class="close" onclick="closeModal('deleteTeamModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p>Are you sure you want to remove <span id="deleteTeamMemberName" style="font-weight: 600;"></span>?</p>
                <p class="text-muted mt-2">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteTeamModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTeamMember()">Delete Team Member</button>
            </div>
        </div>
    </div>

    <!-- Add Language Coming Soon Modal -->
    <div id="language-coming-soon-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Multiple Languages</h2>
                <button type="button" class="close" onclick="closeModal('language-coming-soon-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 2rem; text-align: center;">
                <i class="fas fa-language" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                <h3 style="color: #525f7f; margin-bottom: 1rem;">Coming Soon!</h3>
                <p style="color: #666;">Multiple language support will be available in a future update.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" 
                    style="background: var(--primary-color); border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem;" 
                    onclick="closeModal('language-coming-soon-modal')">Got it!</button>
            </div>
        </div>
    </div>

    

    <!-- Add Skills Management Modal -->
    <div id="skills-management-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Skills Management</h2>
                <button type="button" class="close" onclick="closeModal('skills-management-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Add Skill Button -->
                <div class="mb-4">
                    <button class="btn btn-primary" onclick="openCreateSkillModal()">
                        <i class="fas fa-plus me-2"></i>Add New Skill
                    </button>
                </div>

                <!-- Skills Table -->
                <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Skill Name</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="skillsTableBody">
                                <!-- Skills will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Skill Modal -->
    <div id="create-skill-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title" id="skillModalTitle">Add New Skill</h2>
                <button type="button" class="close" onclick="closeModal('create-skill-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="skillForm">
                    <div class="mb-3">
                        <label for="skillName" class="form-label">Skill Name</label>
                        <input type="text" class="form-control" id="skillName" required>
                    </div>
                    <div class="mb-3">
                        <label for="skillDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="skillDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('create-skill-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSkill()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Skill Confirmation Modal -->
    <div id="delete-skill-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Delete Skill</h2>
                <button type="button" class="close" onclick="closeModal('delete-skill-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; text-align: center;">
                <p>Are you sure you want to delete the skill "<span id="deleteSkillName"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('delete-skill-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteSkill()">Delete</button>
            </div>
        </div>
    </div>

 

    <!-- Tags Management Modal -->
    <div id="tags-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Tags Management</h2>
                <button type="button" class="close" onclick="closeModal('tags-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Add Tag Button -->
                <div class="mb-4">
                    <button class="btn btn-primary" onclick="openCreateTagModal()">
                        <i class="fas fa-plus me-2"></i>Add New Tag
                    </button>
                </div>

                <!-- Tags Table -->
                <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tag Name</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tagsTableBody">
                                <!-- Tags will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Tag Modal -->
    <div id="create-tag-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Add New Tag</h2>
                <button type="button" class="close" onclick="closeModal('create-tag-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="tagForm">
                    <div class="mb-3">
                        <label for="tagName" class="form-label">Tag Name</label>
                        <input type="text" class="form-control" id="tagName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('create-tag-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTag()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Tag Confirmation Modal -->
    <div id="delete-tag-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Delete Tag</h2>
                <button type="button" class="close" onclick="closeModal('delete-tag-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; text-align: center;">
                <p>Are you sure you want to delete the tag "<span id="deleteTagName"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('delete-tag-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteTag()">Delete</button>
            </div>
        </div>
    </div>




    <!-- Add Appearance Modal -->
    <div id="appearance-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Appearance Settings</h2>
                <button type="button" class="close" onclick="closeModal('appearance-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="color-settings">
                    <!-- Primary Color -->
                    <div class="color-setting-group" style="margin-bottom: 2rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #525f7f; font-weight: 500;">
                            Primary Color
                        </label>
                        <div class="color-preview-container" style="display: flex; align-items: center; gap: 1rem;">
                            <div id="primaryColorCircle" 
                                 style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: transform 0.2s ease;"
                                 onclick="document.getElementById('primaryColorPicker').click()">
                            </div>
                            <input type="color" 
                                   id="primaryColorPicker" 
                                   style="opacity: 0; position: absolute; pointer-events: none;"
                                   onchange="updateColorPreview('primary')">
                            <span id="primaryColorHex" style="color: #666; font-family: monospace;"></span>
                        </div>
                    </div>

                    <!-- Secondary Color -->
                    <div class="color-setting-group" style="margin-bottom: 2rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #525f7f; font-weight: 500;">
                            Secondary Color
                        </label>
                        <div class="color-preview-container" style="display: flex; align-items: center; gap: 1rem;">
                            <div id="secondaryColorCircle" 
                                 style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: transform 0.2s ease;"
                                 onclick="document.getElementById('secondaryColorPicker').click()">
                            </div>
                            <input type="color" 
                                   id="secondaryColorPicker" 
                                   style="opacity: 0; position: absolute; pointer-events: none;"
                                   onchange="updateColorPreview('secondary')">
                            <span id="secondaryColorHex" style="color: #666; font-family: monospace;"></span>
                        </div>
                    </div>

                    <!-- Reset Colors Button -->
                    <button onclick="resetToDefaultColors()" 
                            class="btn btn-outline-secondary w-100" 
                            style="margin-top: 1rem; border-radius: 0.5rem; padding: 0.75rem;">
                        Reset to Default Colors
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('appearance-modal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="saveAppearanceSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add this JavaScript for appearance functionality -->
    <script>
        // Default colors
        const DEFAULT_COLORS = {
            primary: '#3DCED7',
            secondary: '#3A506B'
        };

        // Function to load current colors
        async function loadAppearanceSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios').doc(studioId).get();
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Set color pickers and previews
                    const primaryColor = data.PrimaryColor || DEFAULT_COLORS.primary;
                    const secondaryColor = data.SecondaryColor || DEFAULT_COLORS.secondary;
                    
                    document.getElementById('primaryColorPicker').value = primaryColor;
                    document.getElementById('secondaryColorPicker').value = secondaryColor;
                    
                    updateColorPreview('primary');
                    updateColorPreview('secondary');
                }
            } catch (error) {
                console.error('Error loading appearance settings:', error);
            }
        }

        // Function to update color preview
        function updateColorPreview(type) {
            const picker = document.getElementById(`${type}ColorPicker`);
            const circle = document.getElementById(`${type}ColorCircle`);
            const hex = document.getElementById(`${type}ColorHex`);
            
            circle.style.backgroundColor = picker.value;
            hex.textContent = picker.value.toUpperCase();
            
            // Add hover effect
            circle.onmouseover = () => circle.style.transform = 'scale(1.1)';
            circle.onmouseout = () => circle.style.transform = 'scale(1)';
        }

        // Function to reset colors to default
        function resetToDefaultColors() {
            document.getElementById('primaryColorPicker').value = DEFAULT_COLORS.primary;
            document.getElementById('secondaryColorPicker').value = DEFAULT_COLORS.secondary;
            
            updateColorPreview('primary');
            updateColorPreview('secondary');
        }

        // Function to save appearance settings
        async function saveAppearanceSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const primaryColor = document.getElementById('primaryColorPicker').value;
                const secondaryColor = document.getElementById('secondaryColorPicker').value;
                
                await db.collection('Studios').doc(studioId).update({
                    PrimaryColor: primaryColor,
                    SecondaryColor: secondaryColor,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update CSS variables
                document.documentElement.style.setProperty('--primary-color', primaryColor);
                document.documentElement.style.setProperty('--primary-hover', adjustColor(primaryColor, -10));
                document.documentElement.style.setProperty('--secondary-color', secondaryColor);
                
                closeModal('appearance-modal');
                alert('Appearance settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving appearance settings:', error);
                alert('Error saving appearance settings. Please try again.');
            }
        }

        // Add event listener to load colors when modal is opened
        document.querySelector('[data-modal="appearance-modal"]').addEventListener('click', loadAppearanceSettings);
    </script>

    <!-- Update the Policies Modal -->
    <div id="policies-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Policies Settings</h2>
                <button type="button" class="close" onclick="closeModal('policies-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Add Policy Button -->
                <div class="mb-4">
                    <button class="btn btn-primary" onclick="openCreatePolicyModal()">
                        <i class="fas fa-plus me-2"></i>Add New Policy
                    </button>
                </div>

                <!-- Policies Table -->
                <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="policiesTableBody">
                                <!-- Policies will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Policy Modal -->
    <div id="policy-form-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" id="policyModalTitle">Add New Policy</h2>
                <button type="button" class="close" onclick="closeModal('policy-form-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group mb-4">
                    <label for="policyTitle" class="form-label" style="font-weight: 600; color: #525f7f; font-size: 1.1rem;">
                        Title
                    </label>
                    <input type="text" id="policyTitle" class="form-control" style="font-size: 1rem;">
                </div>
                <div class="modal-form-group">
                    <label for="policyContent" class="form-label" style="font-weight: 600; color: #525f7f; font-size: 1.1rem;">
                        Content
                    </label>
                    <textarea id="policyContent" class="form-control" rows="12" 
                        style="font-size: 1rem; line-height: 1.5; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('policy-form-modal')">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="savePolicy()">Save Policy</button>
            </div>
        </div>
    </div>

    <!-- Delete Policy Confirmation Modal -->
    <div id="deletePolicyModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Delete Policy</h2>
                <button type="button" class="close" onclick="closeModal('deletePolicyModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p>Are you sure you want to delete <span id="deletePolicyName" style="font-weight: 600;"></span>?</p>
                <p class="text-muted mt-2">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deletePolicyModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeletePolicy()">Delete Policy</button>
            </div>
        </div>
    </div>

    <!-- Update the JavaScript for policies functionality -->
    <script>
        let currentPolicyId = null;
        let policyToDelete = null;

        // Function to load policies
        async function loadPolicies() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const snapshot = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Policies')
                    .orderBy('UpdatedAt', 'desc')
                    .get();
 
                const tableBody = document.getElementById('policiesTableBody');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const policy = doc.data();
                    const updatedAt = policy.UpdatedAt ? policy.UpdatedAt.toDate().toLocaleDateString() : 'Never';
                    const row = `
                        <tr>
                            <td>${policy.Title}</td>
                            <td>${updatedAt}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editPolicy('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePolicy('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
             } catch (error) {
                console.error('Error loading policy:', error);
                alert('Error loading policy. Please try again.');
            }
        }

        function openCreatePolicyModal() {
            currentPolicyId = null;
            document.getElementById('policyModalTitle').textContent = 'Add New Policy';
            document.getElementById('policyTitle').value = '';
            document.getElementById('policyContent').value = '';
            closeModal('policies-modal');
            openModal('policy-form-modal');
        }

        async function editPolicy(policyId) {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Policies')
                    .doc(policyId)
                    .get();
                
                if (doc.exists) {
                    const policy = doc.data();
                    currentPolicyId = policyId;
                    document.getElementById('policyModalTitle').textContent = 'Edit Policy';
                    document.getElementById('policyTitle').value = policy.Title;
                    document.getElementById('policyContent').value = policy.Content;
                    
                    closeModal('policies-modal');
                    openModal('policy-form-modal');
                }
            } catch (error) {
                console.error('Error loading policy:', error);
                alert('Error loading policy. Please try again.');
            }
        }

        // Function to save policy
        async function savePolicy() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const policyData = {
                    Title: document.getElementById('policyTitle').value,
                    Content: document.getElementById('policyContent').value,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (currentPolicyId) {
                    // Update existing policy
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Policies')
                        .doc(currentPolicyId)
                        .update(policyData);
                } else {
                    // Create new policy
                    policyData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Policies')
                        .add(policyData);
                }

                alert('Policy saved successfully!');
                closeModal('policy-form-modal');
                openModal('policies-modal');
                loadPolicies();
            } catch (error) {
                console.error('Error saving policy:', error);
                alert('Error saving policy. Please try again.');
            }
        }

        function deletePolicy(policyId) {
            try {
                const row = document.querySelector(`button[onclick="deletePolicy('${policyId}')"]`).closest('tr');
                const policyName = row.querySelector('td').textContent;
                document.getElementById('deletePolicyName').textContent = policyName;
                policyToDelete = policyId;
                closeModal('policies-modal');
                openModal('deletePolicyModal');
            } catch (error) {
                console.error('Error preparing policy deletion:', error);
                document.getElementById('deletePolicyName').textContent = 'this policy';
            }
        }

        async function confirmDeletePolicy() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios')
                    .doc(studioId)
                    .collection('Policies')
                    .doc(policyToDelete)
                    .delete();
                
                closeModal('deletePolicyModal');
                openModal('policies-modal');
                loadPolicies();
                alert('Policy deleted successfully!');
            } catch (error) {
                console.error('Error deleting policy:', error);
                alert('Error deleting policy. Please try again.');
            }
        }

        // Add event listener to load policies when modal is opened
        document.querySelector('[data-modal="policies-modal"]').addEventListener('click', loadPolicies);
    </script>

    <!-- Add script to populate expiration years -->
    <script>
        function populateExpirationYears() {
            const yearSelect = document.getElementById('expirationYear');
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 10; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            }
        }

        // Call this when the document loads
        document.addEventListener('DOMContentLoaded', populateExpirationYears);

        // Add form submission handler
        document.getElementById('payment-info-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // Payment information update logic will be implemented later
            alert('Payment information update functionality coming soon!');
        });
    </script>

    <!-- Add this card in the settings-grid div, after Policies -->
    <div class="setting-card" data-modal="studio-rooms-modal">
        <i class="fas fa-door-open"></i>
        <h3>Studio Rooms</h3>
        <p>Manage your studio rooms and locations</p>
    </div>

    <!-- Add the Studio Rooms Modal -->
    <div id="studio-rooms-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Studio Rooms</h2>
                <button type="button" class="close" onclick="closeModal('studio-rooms-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Add Room Button -->
                <div class="mb-4">
                    <button class="btn btn-primary" onclick="openCreateRoomModal()">
                        <i class="fas fa-plus me-2"></i>Add New Room
                    </button>
                </div>

                <!-- Rooms Table -->
                <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Room Name</th>
                                    <th>Color</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody">
                                <!-- Rooms will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Room Modal -->
    <div id="room-form-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title" id="roomModalTitle">Add New Room</h2>
                <button type="button" class="close" onclick="closeModal('room-form-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="roomForm">
                    <input type="hidden" id="roomId">
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Room Name</label>
                        <input type="text" id="roomName" class="form-control" required
                            style="border-radius: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500; color: #525f7f;">Room Color</label>
                        <input type="color" id="roomColor" class="form-control form-control-color" required
                            style="height: 42px; border-radius: 0.5rem; border: 1px solid #e0e0e0;">
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('room-form-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRoom()">Save Room</button>
            </div>
        </div>
    </div>

    <!-- Add this card in the settings-grid div, after Policies -->
    <div class="setting-card" data-modal="skills-management-modal">
        <i class="fas fa-brain"></i>
        <h3>Skills Management</h3>
        <p>Manage your studio skills</p>
    </div>

    <!-- INSERT_YOUR_REWRITE_HERE -->
    <div class="setting-card" onclick="window.location.href='import.html?studio=' + getStudioNameForUrl(localStorage.getItem('currentStudioData')?.StudioName || '')">
        <i class="fas fa-file-import"></i>
        <h3>Import Data</h3>
        <p>Import data from other systems</p>
    </div>

    <!-- Add this card in the settings-grid div, after Policies -->
    <div class="setting-card" data-modal="Function-Logs-modal">
        <i class="fas fa-file-alt"></i>
        <h3>Function Logs</h3>
        <p>View all System Function Logs</p>
    </div>

    <!-- Add this JavaScript for studio rooms functionality -->
    <script>
        let currentRoomId = null;

        // Function to load studio rooms
        async function loadStudioRooms() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const snapshot = await db.collection('Studios')
                    .doc(studioId)
                    .collection('StudioRooms')
                    .orderBy('CreatedAt', 'desc')
                    .get();
                
                const tableBody = document.getElementById('roomsTableBody');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const room = doc.data();
                    const row = `
                        <tr>
                            <td>${room.Name}</td>
                            <td>
                                <div style="width: 25px; height: 25px; border-radius: 5px; background-color: ${room.Color}"></div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editRoom('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRoom('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading studio rooms:', error);
                alert('Error loading studio rooms. Please try again.');
            }
        }

        // Function to open create room modal
        function openCreateRoomModal() {
            currentRoomId = null;
            document.getElementById('roomModalTitle').textContent = 'Add New Room';
            document.getElementById('roomForm').reset();
            document.getElementById('roomColor').value = '#50C89F'; // Default color
            closeModal('studio-rooms-modal');
            openModal('room-form-modal');
        }

        // Function to edit room
        async function editRoom(roomId) {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('StudioRooms')
                    .doc(roomId)
                    .get();
                
                if (doc.exists) {
                    const room = doc.data();
                    currentRoomId = roomId;
                    document.getElementById('roomModalTitle').textContent = 'Edit Room';
                    document.getElementById('roomName').value = room.Name;
                    document.getElementById('roomColor').value = room.Color;
                    
                    closeModal('studio-rooms-modal');
                    openModal('room-form-modal');
                }
            } catch (error) {
                console.error('Error loading room:', error);
                alert('Error loading room. Please try again.');
            }
        }

        // Function to save room
        async function saveRoom() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const roomData = {
                    Name: document.getElementById('roomName').value,
                    Color: document.getElementById('roomColor').value,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (!currentRoomId) {
                    // Creating new room
                    roomData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    roomData.IsActive = Boolean(true);  // Explicitly cast to boolean
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('StudioRooms')
                        .add(roomData);
                } else {
                    // Updating existing room
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('StudioRooms')
                        .doc(currentRoomId)
                        .update(roomData);
                }

                closeModal('room-form-modal');
                openModal('studio-rooms-modal');
                loadStudioRooms();
                alert('Room saved successfully!');
            } catch (error) {
                console.error('Error saving room:', error);
                alert('Error saving room. Please try again.');
            }
        }

        let roomToDelete = null;
        
        function deleteRoom(roomId) {
            try {
                const row = document.querySelector(`button[onclick="deleteRoom('${roomId}')"]`).closest('tr');
                const roomName = row.querySelector('td').textContent;
                document.getElementById('deleteRoomName').textContent = roomName;
                roomToDelete = roomId;
                closeModal('studio-rooms-modal');
                openModal('deleteRoomModal');
            } catch (error) {
                console.error('Error preparing room deletion:', error);
                document.getElementById('deleteRoomName').textContent = 'this room';
            }
        }
        
        async function confirmDeleteRoom() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios')
                    .doc(studioId)
                    .collection('StudioRooms')
                    .doc(roomToDelete)
                    .delete();
                
                closeModal('deleteRoomModal');
                openModal('studio-rooms-modal');
                loadStudioRooms();
                alert('Room deleted successfully!');
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room. Please try again.');
            }
        }

        // Add event listener to load rooms when modal is opened
        document.querySelector('[data-modal="studio-rooms-modal"]').addEventListener('click', loadStudioRooms);
    </script>

    <!-- Add Delete Room Confirmation Modal -->
    <div id="deleteRoomModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
                <h2 class="modal-title">Delete Room</h2>
                <button type="button" class="close" onclick="closeModal('deleteRoomModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p>Are you sure you want to delete <span id="deleteRoomName" style="font-weight: 600;"></span>?</p>
                <p class="text-muted mt-2">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteRoomModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteRoom()">Delete Room</button>
            </div>
        </div>
    </div>

    <!-- Update the JavaScript functions for surcharge settings -->
    <script>
        // Add event listeners for the surcharge type radio buttons
        document.querySelectorAll('input[name="surchargeType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const valueLabel = document.getElementById('valueLabel');
                const valueSymbol = document.getElementById('valueSymbol');
                const valueInput = document.getElementById('surchargeValue');
                
                if (this.value === 'percentage') {
                    valueLabel.textContent = 'Percentage';
                    valueSymbol.textContent = '%';
                    valueInput.step = '0.01';
                    valueInput.max = '100';
                } else {
                    valueLabel.textContent = 'Amount';
                    valueSymbol.textContent = '$';
                    valueInput.step = '0.01';
                    valueInput.max = '';
                }
            });
        });

        // Add event listener for enable/disable toggle
        document.getElementById('enableSurcharge').addEventListener('change', function() {
            const surchargeOptions = document.getElementById('surchargeOptions');
            surchargeOptions.style.display = this.checked ? 'block' : 'none';
        });

        async function saveSurchargeSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const isEnabled = document.getElementById('enableSurcharge').checked;
                
                const surchargeSettings = {
                    IsActive: isEnabled,
                    Name: document.getElementById('surchargeName').value,
                    Type: document.querySelector('input[name="surchargeType"]:checked').value,
                    Value: parseFloat(document.getElementById('surchargeValue').value),
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Create Surcharge collection and settings document if they don't exist
                await db.collection('Studios').doc(studioId)
                        .collection('Surcharge')
                        .doc('SurchargeSettings')
                        .set(surchargeSettings, { merge: true });

                closeModal('surcharge-settings-modal');
                alert('Surcharge settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving surcharge settings:', error);
                alert('Error saving surcharge settings. Please try again.');
            }
        }

        async function loadSurchargeSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                console.log('Loading Surcharge Settings...');
                const surchargeDoc = await db.collection('Studios').doc(studioId)
                                    .collection('Surcharge')
                                    .doc('SurchargeSettings')
                                    .get();

                if (surchargeDoc.exists) {
                    const surchargeSettings = surchargeDoc.data();
                    console.log('Found Surcharge Settings:', {
                        IsActive: surchargeSettings.IsActive,
                        Name: surchargeSettings.Name,
                        Type: surchargeSettings.Type,
                        Value: surchargeSettings.Value
                    });
                    
                    const enableToggle = document.getElementById('enableSurcharge');
                    const surchargeOptions = document.getElementById('surchargeOptions');
                    
                    enableToggle.checked = surchargeSettings.IsActive || false;
                    surchargeOptions.style.display = surchargeSettings.IsActive ? 'block' : 'none';
                    
                    document.getElementById('surchargeName').value = surchargeSettings.Name || '';
                    const surchargeType = surchargeSettings.Type || '';
                    if (surchargeType) {
                        document.querySelector(`input[name="surchargeType"][value="${surchargeType}"]`).checked = true;
                        // Trigger the change event to update the UI
                        document.querySelector(`input[name="surchargeType"][value="${surchargeType}"]`).dispatchEvent(new Event('change'));
                    }
                    document.getElementById('surchargeValue').value = surchargeSettings.Value || '';
                } else {
                    console.log('No Surcharge Settings found');
                }
            } catch (error) {
                console.error('Error loading surcharge settings:', error);
            }
        }

        // Load surcharge settings when the modal is opened
        document.querySelector('[data-modal="surcharge-settings-modal"]').addEventListener('click', loadSurchargeSettings);
    </script>

    <script>
        // Populate the Post Charges Day dropdown
        const postChargesDaySelect = document.getElementById('postChargesDay');
        for (let i = 1; i <= 28; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            postChargesDaySelect.appendChild(option);
        }

        // Populate the AutoPay Billing Day dropdown
        const autoPayBillingDaySelect = document.getElementById('autoPayBillingDay');
        for (let i = 1; i <= 28; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            autoPayBillingDaySelect.appendChild(option);
        }

        // Load settings and update message
        async function loadPaymentSettings() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios').doc(studioId)
                           .collection('PaymentProcessing')
                           .doc('Settings')
                           .get();

                if (doc.exists) {
                    const settings = doc.data();
                    
                    // Load Post Charges Day
                    const postChargesDay = settings.General?.PostChargesDay;
                    if (postChargesDay) {
                        postChargesDaySelect.value = postChargesDay;
                    }

                    // Load AutoPay Billing Day
                    const billingDay = settings.General?.AutoPayBillingDay;
                    if (billingDay) {
                        autoPayBillingDaySelect.value = billingDay;
                    }
                }
            } catch (error) {
                console.error('Error loading payment settings:', error);
            }
        }

        // Call loadPaymentSettings on page load
        document.addEventListener('DOMContentLoaded', loadPaymentSettings);
    </script>

    <script>
        let currentSkillId = null;
        let skillToDelete = null;

        // Function to load skills
        async function loadSkills() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const snapshot = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Skills')
                    .orderBy('CreatedAt', 'desc')
                    .get();
                
                const tableBody = document.getElementById('skillsTableBody');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const skill = doc.data();
                    const row = `
                        <tr>
                            <td>${skill.Name}</td>
                            <td>${skill.Description || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editSkill('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSkill('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading skills:', error);
                alert('Error loading skills. Please try again.');
            }
        }

        // Function to open create skill modal
        function openCreateSkillModal() {
            currentSkillId = null;
            document.getElementById('skillModalTitle').textContent = 'Add New Skill';
            document.getElementById('skillName').value = '';
            document.getElementById('skillDescription').value = '';
            openModal('create-skill-modal');
        }

        // Function to edit skill
        async function editSkill(skillId) {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const doc = await db.collection('Studios')
                    .doc(studioId)
                    .collection('Skills')
                    .doc(skillId)
                    .get();
                
                if (doc.exists) {
                    const skill = doc.data();
                    currentSkillId = skillId;
                    document.getElementById('skillModalTitle').textContent = 'Edit Skill';
                    document.getElementById('skillName').value = skill.Name;
                    document.getElementById('skillDescription').value = skill.Description || '';
                    openModal('create-skill-modal');
                }
            } catch (error) {
                console.error('Error loading skill:', error);
                alert('Error loading skill. Please try again.');
            }
        }

        // Function to save skill
        async function saveSkill() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                const skillData = {
                    Name: document.getElementById('skillName').value,
                    Description: document.getElementById('skillDescription').value,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (!currentSkillId) {
                    skillData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Skills')
                        .add(skillData);
                } else {
                    await db.collection('Studios')
                        .doc(studioId)
                        .collection('Skills')
                        .doc(currentSkillId)
                        .update(skillData);
                }

                closeModal('create-skill-modal');
                loadSkills();
                alert('Skill saved successfully!');
            } catch (error) {
                console.error('Error saving skill:', error);
                alert('Error saving skill. Please try again.');
            }
        }

        // Function to delete skill
        function deleteSkill(skillId) {
            try {
                const row = document.querySelector(`button[onclick="deleteSkill('${skillId}')"]`).closest('tr');
                const skillName = row.querySelector('td').textContent;
                document.getElementById('deleteSkillName').textContent = skillName;
                skillToDelete = skillId;
                closeModal('skills-management-modal');
                openModal('delete-skill-modal');
            } catch (error) {
                console.error('Error preparing skill deletion:', error);
                document.getElementById('deleteSkillName').textContent = 'this skill';
            }
        }

        // Function to confirm skill deletion
        async function confirmDeleteSkill() {
            try {
                const studioId = localStorage.getItem('currentStudioId');
                const db = firebase.firestore();
                
                await db.collection('Studios')
                    .doc(studioId)
                    .collection('Skills')
                    .doc(skillToDelete)
                    .delete();
                
                closeModal('delete-skill-modal');
                openModal('skills-management-modal');
                loadSkills();
                alert('Skill deleted successfully!');
            } catch (error) {
                console.error('Error deleting skill:', error);
                alert('Error deleting skill. Please try again.');
            }
        }

        // Add event listener to load skills when modal is opened
        document.querySelector('[data-modal="skills-management-modal"]').addEventListener('click', loadSkills);
    </script>

    <!-- Initialize payment processing modal -->
    <script>
        document.getElementById('payment-processing-modal').addEventListener('show.bs.modal', function () {
            loadSurchargeSettings();
            // Load other payment settings here...
        });
    </script>

    <script>
        // Function to open payment processing modal
        function openPaymentProcessingModal() {
            const modal = document.getElementById('payment-processing-modal');
            modal.style.display = 'block';
            
            // Load all settings
            Promise.all([
                loadSurchargeSettings(),
                loadPaymentSettings()
            ]).catch(error => {
                console.error('Error loading settings:', error);
            });
        }

        // Function to close payment processing modal
        function closePaymentProcessingModal() {
            const modal = document.getElementById('payment-processing-modal');
            modal.style.display = 'none';
        }

        // Add event listener for the payment processing modal button
        document.querySelector('[data-modal="payment-processing-modal"]').addEventListener('click', openPaymentProcessingModal);

        // Also add event listener for the modal show event
        document.getElementById('payment-processing-modal').addEventListener('show.bs.modal', function () {
            Promise.all([
                loadSurchargeSettings(),
                loadPaymentSettings()
            ]).catch(error => {
                console.error('Error loading settings:', error);
            });
        });
    </script>

    <!-- Function Logs Modal -->
    <div id="function-logs-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0; padding: 1.5rem;">
                <h2 class="modal-title" style="font-size: 1.5rem; font-weight: 600;">Function Logs</h2>
                <button type="button" class="close" onclick="closeModal('function-logs-modal')" style="background: none; border: none; font-size: 1.5rem; color: #525f7f;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Filters -->
                <div class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label" style="color: #525f7f; font-weight: 500;">Type</label>
                            <select class="form-select" id="logTypeFilter" onchange="filterLogs()" style="border-radius: 8px; border: 1px solid #e0e0e0; padding: 0.5rem;">
                                <option value="">All Types</option>
                                <option value="Import">Imports</option>
                                <option value="Payment">Payments</option>
                                <option value="Payment">Card Updates</option>
                                <option value="Payment">Post Charges</option>
                                <option value="Calculation">Calculations</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="color: #525f7f; font-weight: 500;">Subtype</label>
                            <select class="form-select" id="logSubTypeFilter" onchange="filterLogs()" style="border-radius: 8px; border: 1px solid #e0e0e0; padding: 0.5rem;">
                                <option value="">All Subtypes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Logs Table -->
                <div class="card" style="border: none; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08); border-radius: 1rem;">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th style="color: #525f7f; font-weight: 500;">Timestamp</th>
                                        <th style="color: #525f7f; font-weight: 500;">Type</th>
                                        <th style="color: #525f7f; font-weight: 500;">SubType</th>
                                        <th style="color: #525f7f; font-weight: 500;">Status</th>
                                        <th style="color: #525f7f; font-weight: 500;">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="functionLogsTableBody">
                                    <!-- Logs will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal (moved outside) -->
    <div id="log-details-modal" class="modal" style="z-index: 1051;">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0; padding: 1.5rem;">
                <h2 class="modal-title" style="font-size: 1.5rem; font-weight: 600;">Log Details</h2>
                <button type="button" class="close" onclick="closeModal('log-details-modal')" style="background: none; border: none; font-size: 1.5rem; color: #525f7f;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="logDetailsContent"></div>
            </div>
        </div>
    </div>



    <script>
        // Function Logs Management
        let functionLogs = [];
        let filteredLogs = [];

        // Add showError function
        function showError(message) {
            // You can customize this to show a toast or alert
            alert(message);
        }

        async function loadFunctionLogs() {
            try {
                const studioId = getCurrentStudioId();
                
                const logsSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('FunctionLogs')
                    .orderBy('StartedAt', 'desc')
                    .get();

                functionLogs = logsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                filteredLogs = [...functionLogs];
                updateLogsTable();
                updateSubTypeFilter();
            } catch (error) {
                console.error('Error loading function logs:', error);
                showError('Failed to load function logs');
            }
        }

        // Helper function to get current studio ID
        function getCurrentStudioId() {
            // This should return the current studio ID
            // You might need to adjust this based on how you store the current studio
            return localStorage.getItem('currentStudioId') || 
                   document.getElementById('studioId').value || 
                   'default-studio-id';
        }

        function updateLogsTable() {
            const tbody = document.getElementById('functionLogsTableBody');
            tbody.innerHTML = '';

            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(log.StartedAt)}</td>
                    <td>${log.Type}</td>
                    <td>${log.SubType || '-'}</td>
                    <td>${log.Details?.errorCount > 0 ? '<span class="text-danger">Error</span>' : '<span class="text-success">Success</span>'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="ShowLogDetails('${log.id}')" style="background-color: #3DCED7; color: white; border: none;">
                            View Details
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSubTypeFilter() {
            const typeFilter = document.getElementById('logTypeFilter').value;
            const subTypeSelect = document.getElementById('logSubTypeFilter');
            subTypeSelect.innerHTML = '<option value="">All Subtypes</option>';

            const subtypes = new Set();
            functionLogs
                .filter(log => !typeFilter || log.Type === typeFilter)
                .forEach(log => {
                    if (log.SubType) subtypes.add(log.SubType);
                });

            subtypes.forEach(subtype => {
                const option = document.createElement('option');
                option.value = subtype;
                option.textContent = subtype;
                subTypeSelect.appendChild(option);
            });
        }

        function filterLogs() {
            const typeFilter = document.getElementById('logTypeFilter').value;
            const subTypeFilter = document.getElementById('logSubTypeFilter').value;

            filteredLogs = functionLogs.filter(log => {
                const typeMatch = !typeFilter || log.Type === typeFilter;
                const subTypeMatch = !subTypeFilter || log.SubType === subTypeFilter;
                return typeMatch && subTypeMatch;
            });
            updateLogsTable();
        }

        function ShowLogDetails(logId) {
            const log = functionLogs.find(l => l.id === logId);
            if (!log) return;

            const detailsContent = document.getElementById('logDetailsContent');
            detailsContent.innerHTML = `
                <div class="mb-3">
                    <h4>Summary</h4>
                    <p><strong>Type:</strong> ${log.Type}</p>
                    <p><strong>SubType:</strong> ${log.SubType || '-'}</p>
                    <p><strong>Started:</strong> ${FormatDate(log.StartedAt)}</p>
                    <p><strong>Completed:</strong> ${FormatDate(log.CompletedAt)}</p>
                    <p><strong>Status:</strong> ${log.Details?.ErrorCount > 0 ? 'Error' : 'Success'}</p>
                </div>
                <div class="mb-3">
                    <h4>Details</h4>
                    <p><strong>File:</strong> ${log.Details?.FileName || '-'}</p>
                    <p><strong>Total Rows:</strong> ${log.Details?.TotalRows || '-'}</p>
                    <p><strong>Success Count:</strong> ${log.Details?.SuccessCount || '-'}</p>
                    <p><strong>Error Count:</strong> ${log.Details?.ErrorCount || '-'}</p>
                </div>
                <div>
                    <h4>Log Messages</h4>
                    <div class="log-messages" style="max-height: 300px; overflow-y: auto;">
                        ${(log.Details?.Logs || []).map(log => `
                            <div class="mb-2 ${log.type === 'error' ? 'text-danger' : ''}">
                                <small>${FormatDate(log.timestamp)}</small>
                                <p class="mb-0">${log.message}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            openModal('log-details-modal');
        }

        function FormatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadFunctionLogs();
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('settingsSearch');
            const settingCards = document.querySelectorAll('.setting-card');

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();

                settingCards.forEach(card => {
                    const title = card.querySelector('h3').textContent.toLowerCase();
                    const description = card.querySelector('p').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            });
        });
    </script>

<script>
    // Video search functionality
    document.addEventListener('DOMContentLoaded', function() {
        const videoSearch = document.getElementById('videoSearch');
        const videoItems = document.querySelectorAll('.video-item');

        // Add focus styles
        videoSearch.addEventListener('focus', function() {
            this.style.borderColor = 'var(--primary-color)';
            this.style.boxShadow = '0 0 0 3px rgba(61, 206, 215, 0.1)';
        });

        videoSearch.addEventListener('blur', function() {
            this.style.borderColor = '#e0e0e0';
            this.style.boxShadow = 'none';
        });

        // Search functionality
        videoSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            videoItems.forEach(item => {
                const title = item.querySelector('h3').textContent.toLowerCase();
                const shouldShow = title.includes(searchTerm);
                
                // Add smooth transition
                item.style.transition = 'all 0.3s ease';
                
                if (shouldShow) {
                    item.style.display = 'block';
                    item.style.opacity = '1';
                    item.style.transform = 'scale(1)';
                } else {
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.95)';
                    // Hide after animation
                    setTimeout(() => {
                        item.style.display = 'none';
                    }, 300);
                }
            });

            // Show "no results" message if needed
            const visibleItems = Array.from(videoItems).filter(item => 
                item.style.display !== 'none'
            );

            let noResultsMsg = document.getElementById('noResultsMessage');
            if (visibleItems.length === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.style.textAlign = 'center';
                    noResultsMsg.style.padding = '2rem';
                    noResultsMsg.style.color = '#666';
                    noResultsMsg.innerHTML = `
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; color: #ccc;"></i>
                        <p>No videos found matching "${searchTerm}"</p>
                    `;
                    document.querySelector('.video-grid').appendChild(noResultsMsg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        });

        // Clear search when modal is closed
        document.querySelector('[data-modal="videos-modal"]').addEventListener('click', function() {
            videoSearch.value = '';
            videoItems.forEach(item => {
                item.style.display = 'block';
                item.style.opacity = '1';
                item.style.transform = 'scale(1)';
            });
            const noResultsMsg = document.getElementById('noResultsMessage');
            if (noResultsMsg) {
                noResultsMsg.remove();
            }
        });
    });
</script>

<!-- Add Videos Modal -->
<div id="videos-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
        <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
            <h2 class="modal-title">Studio Sync Tutorial Videos</h2>
            <button type="button" class="close" onclick="closeModal('videos-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <div class="search-container" style="position: relative; margin-bottom: 2rem;">
                <input type="text" 
                       id="videoSearch" 
                       placeholder="Search videos..." 
                       style="width: 100%; 
                              padding: 1rem 1rem 1rem 3rem; 
                              border: 2px solid #e0e0e0; 
                              border-radius: 10px; 
                              font-size: 1rem; 
                              transition: all 0.3s ease;
                              background-color: #fff;">
                <i class="fas fa-search" 
                   style="position: absolute; 
                          left: 1rem; 
                          top: 50%; 
                          transform: translateY(-50%); 
                          color: #666;"></i>
            </div>
            <div class="video-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div class="video-item" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #525f7f; margin-bottom: 1rem;">Getting Started</h3>
                    <iframe width="100%" height="200" src="https://www.youtube.com/embed/your-video-id-1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 4px;"></iframe>
                </div>
                <div class="video-item" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #525f7f; margin-bottom: 1rem;">Managing Classes</h3>
                    <iframe width="100%" height="200" src="https://www.youtube.com/embed/your-video-id-2" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 4px;"></iframe>
                </div>
                <div class="video-item" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #525f7f; margin-bottom: 1rem;">Advanced Techniques</h3>
                    <iframe width="100%" height="200" src="https://www.youtube.com/embed/your-video-id-3" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 4px;"></iframe>
                </div>
                <div class="video-item" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #525f7f; margin-bottom: 1rem;">Studio Setup</h3>
                    <iframe width="100%" height="200" src="https://www.youtube.com/embed/your-video-id-4" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 4px;"></iframe>
                </div>
                <div class="video-item" style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #525f7f; margin-bottom: 1rem;">Troubleshooting</h3>
                    <iframe width="100%" height="200" src="https://www.youtube.com/embed/your-video-id-5" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 4px;"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Support Modal -->
<div id="support-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
        <div class="modal-header" style="background-color: #f8f9fa; color: #525f7f; border-radius: 15px 15px 0 0;">
            <h2 class="modal-title">Studio Sync Support</h2>
            <button type="button" class="close" onclick="closeModal('support-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <div class="support-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <div class="support-item" style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px; transition: transform 0.3s ease;">
                    <i class="fas fa-envelope" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <h3 style="color: #525f7f; margin: 1rem 0;">Email Support</h3>
                    <p style="color: #666;">support@studiosyncdance.com</p>
                </div>
                <div class="support-item" style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px; transition: transform 0.3s ease;">
                    <i class="fas fa-phone" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <h3 style="color: #525f7f; margin: 1rem 0;">Phone Support</h3>
                    <p style="color: #666;">+1 801-616-6985</p>
                </div>
            </div>
        </div>
    </div>
</div>


</body>
</html>