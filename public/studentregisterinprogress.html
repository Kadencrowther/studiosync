<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Student Registration for Dance Studio" data-dynamic="true">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Student Registration - Dance Studio" data-dynamic="true">
    <meta property="og:description" content="Register for dance classes" data-dynamic="true">
    <meta property="og:image" content="/assets/ssdancer.svg" data-dynamic="true">
    <meta property="og:url" content="" data-dynamic="true">
    <meta property="og:site_name" content="Studio Sync">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" href="assets/ssdancer.svg" type="image/svg+xml">
    <title>Student Registration - Dance Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script>
        // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDRSW3u6gJSs98Z2Mkp5DYSC__ibDXXHAE",
            authDomain: "studiosync-af73d.firebaseapp.com",
            projectId: "studiosync-af73d",
            storageBucket: "studiosync-af73d.appspot.com",
            messagingSenderId: "172555302276",
            appId: "1:172555302276:web:55b661f9849441e2de59d1",
            measurementId: "G-EK7EFQGMSG"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    <style>
        :root {
            --primary-color: #3DCED7;
            --primary-hover: #36b8c0;  /* Darker shade of primary */
            --secondary-color: #3A506B;
            --secondary-hover: #324660;  /* Darker shade of secondary */
            --background-color: #F5F5F5;
            --text-color: #333333;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: var(--background-color);
            font-family: 'Arial', sans-serif;
            padding: 40px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 40px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            color: var(--text-color);
        }

        h2 {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        /* Update the logo-container style */
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 60px; /* Increased from 40px */
        }

        .logo-container img {
            max-width: 400px;
            max-height: 300px;
            width: auto;
            height: auto;
        }

        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 14px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        button {
            width: 48%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        .note {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #888888;
        }

        .students-list {
            margin-top: 30px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .student-card {
            display: flex;
            gap: 15px;
            align-items: start;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        .add-student-btn {
            width: 100%;
            margin-top: 20px;
        }

        .no-students {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        select[multiple] {
            height: 120px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
            padding-left: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            margin-right: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
        }

        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .checkbox-item input[type="checkbox"]:checked::before {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 16px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            animation: checkmark 0.3s ease-in-out;
        }

        @keyframes checkmark {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
        }

        .payment-summary {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .total-amount {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: right;
            font-size: 1.2em;
        }

        .card-details {
            display: flex;
            gap: 20px;
        }

        .expiry-date, .cvv {
            flex: 1;
        }

        #cardNumber {
            letter-spacing: 1px;
        }

        .checkbox-container {
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
            margin: 5px 0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        .note {
            margin-left: 24px;
        }

        .waiver-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .waiver-section {
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .electronic-signature {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .waiver-acceptance {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
        }

        .waiver-acceptance .checkbox-item {
            margin: 15px 0;
        }

        .step {
            display: none;
            width: 100%;
        }

        .step.active {
            display: block;
        }

        .waiver-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #ffffff;
        }

        /* Ensure proper layering */
        .container {
            position: relative;
            overflow: hidden;
        }

        .signature-display {
            margin-top: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease;
        }

        .signature-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        .signature-main {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            color: #000080; /* Dark blue ink color */
            line-height: 1.4;
            display: block; /* Make sure it's displayed */
        }

        .signature-text, .signature-date {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            color: #000080;
            display: block;
            line-height: 1.2;
        }

        .signature-text {
            font-size: 2.8em;
            margin-bottom: 5px;
        }

        .signature-date {
            font-size: 2em;
            margin-bottom: 12px;
        }

        .signature-details {
            font-family: Arial, sans-serif;
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .signature-timestamp, .signature-ip {
            padding: 1px 0;
        }

        .signature-loading {
            color: #666;
            font-style: italic;
            padding: 10px 0;
        }

        /* Add to the existing style section in the head */
        .signature-text {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            font-size: 2em;
            color: #000066;  /* Changed back to dark blue */
            padding: 15px 0;
            margin-top: 10px;
            border-bottom: 1px solid #ccc;
            display: none; /* Hidden by default */
        }

        .signature-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .waiver-student-name {
            padding: 5px 0;
            font-size: 1.1em;
        }

        /* Update the progress steps styles */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 90%;
            box-sizing: border-box;
            overflow-x: auto; /* Allow horizontal scroll on very small screens */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            min-width: 60px; /* Ensure minimum width on small screens */
        }

        .step-indicator:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 2px;
            background-color: #e0e0e0;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
            @media (max-width: 768px) {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            @media (max-width: 480px) {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
        }

        .step-label {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            white-space: nowrap;
            @media (max-width: 768px) {
                font-size: 0.8em;
            }
            @media (max-width: 480px) {
                font-size: 0.7em;
            }
        }

        .step-indicator.active .step-circle {
            background-color: var(--primary-color);
            color: white;
        }

        .step-indicator.completed .step-circle {
            background-color: var(--primary-color); /* Changed from secondary to primary color */
            color: white;
        }

        .step-indicator.active .step-label {
            color: var(--primary-color);
            font-weight: bold;
        }

        .modal {
            display: none;  /* Start hidden */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Add a new class for when the modal is visible */
        .modal.show {
            display: flex !important;  /* Only show when this class is added */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 90%; /* Increase from 600px */
            width: 90%;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            margin: 0 auto;    /* Center horizontally */
        }

        /* Add smooth scrollbar styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Adjust the edit form spacing */
        .edit-student-form {
            margin-top: 20px;
            padding-right: 10px; /* Add space for scrollbar */
        }

        .edit-student-form > * {
            margin-bottom: 15px; /* Consistent spacing between elements */
        }

        .close {
            position: absolute;
            right: 25px;
            top: 25px;
            color: var(--text-color);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--primary-color);
        }

        .edit-student-form {
            margin-top: 30px;
        }

        .edit-student-form h2 {
            color: var(--secondary-color);
            margin-bottom: 30px;
        }

        .modal .button-container {
            margin-top: 40px;
        }

        .modal button {
            background-color: var(--primary-color);
            transition: background-color 0.3s ease;
        }

        .modal button:hover {
            background-color: var(--primary-hover);
        }

        .modal button:first-child {
            background-color: #e0e0e0;
            color: var(--text-color);
        }

        .modal button:first-child:hover {
            background-color: #d0d0d0;
        }

        .modal input,
        .modal select,
        .modal textarea {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            transition: border-color 0.3s ease;
        }

        .modal input:focus,
        .modal select:focus,
        .modal textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .modal .checkbox-group {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Update the step h2 style */
        .step h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            margin: -40px -40px 30px -40px;
            border-radius: 0;
            text-align: left;
            position: relative;
            top: 20px;
        }

        /* Add media queries for mobile header padding */
        @media (max-width: 768px) {
            .step h2 {
                padding: 15px 40px;  /* Increase left padding on mobile */
                margin: -20px -20px 30px -20px;  /* Adjust margins for mobile container padding */
            }
        }

        @media (max-width: 480px) {
            .step h2 {
                padding: 12px 30px;  /* Slightly less padding on very small screens */
                font-size: 1.4em;  /* Slightly smaller font size */
            }
        }

        .required-star {
            color: #ff0000 !important;  /* Red color that can't be changed */
            margin-left: 3px;
        }

        .emergency-contact-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .emergency-contact-inputs {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .emergency-contact-inputs input {
            flex: 1;
        }

        .add-emergency-contact {
            width: 40px !important;
            height: 40px;
            border-radius: 50% !important;
            padding: 0 !important;
            font-size: 24px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4CAF50 !important; /* Soft green color */
        }

        .add-emergency-contact:hover {
            background-color: #45a049 !important; /* Slightly darker green for hover */
        }

        .remove-emergency-contact {
            width: 40px !important;
            height: 40px;
            border-radius: 50% !important;
            padding: 0 !important;
            font-size: 18px !important;
            background-color: #ff4444 !important;
        }

        .step-description {
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        /* Update the textarea styling to match other inputs */
        textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 14px;
            font-family: 'Arial', sans-serif; /* Match the font family of other inputs */
            resize: vertical; /* Allow vertical resizing only */
            min-height: 80px; /* Set minimum height */
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .menu-container {
            position: absolute;
            top: 28px;
            left: 28px;
            z-index: 100;
        }

        .menu-bars {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 28px;
            cursor: pointer;
            padding: 10px 14px;
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .menu-bars:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: scale(1.1);
            color: var(--primary-color);
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            min-width: 150px;
            z-index: 1000;
        }

        .menu-dropdown a {
            display: block;
            padding: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .menu-dropdown a:hover {
            background-color: #f5f5f5;
        }

        .menu-container:hover .menu-dropdown {
            display: block;
        }

        /* Update the step h2 style to accommodate the menu */
        .step h2 {
            position: relative;
            padding-left: 30px;
        }

        .waiver-content h3 {
            color: var(--secondary-color);
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .waiver-text {
            margin-bottom: 30px;
        }

        .waiver-text p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .photo-upload {
            margin: 10px 0;
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            background-color: #f8f8f8;
        }

        .photo-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
        }

        /* Add these styles */
        .photo-preview {
            position: relative;
        }

        .remove-photo {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .student-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            transition: transform 0.2s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .students-list {
            margin-top: 30px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .student-card-content {
            display: flex;
            gap: 15px;
            align-items: start;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }

        .student-info {
            flex-grow: 1;
            line-height: 1.6;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        .student-class-registration {
            margin-top: 20px;
        }

        .student-registration-card {
            display: flex;
            gap: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .student-details {
            flex: 1;
        }

        .student-classes {
            flex: 1;
            padding-left: 20px;
            border-left: 1px solid #e0e0e0;
        }

        .register-classes-btn {
            width: auto !important;
            padding: 8px 16px !important;
            margin-top: 10px;
        }

        .class-selection {
            display: none;
            margin-top: 15px;
        }

        .class-selection.show {
            display: block;
        }

        .selected-classes {
            margin-top: 10px;
        }

        .selected-class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 0.9em;
        }

        .remove-class {
            margin-left: 5px;
            cursor: pointer;
        }

        .registered-students {
            margin-bottom: 30px;
        }

        .student-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-info h4 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
        }

        .selected-classes {
            margin-top: 10px;
        }

        .class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
        }

        .register-button {
            padding: 8px 16px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .register-button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-2px);
        }

        .class-selection-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .class-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        /* Update the class grid and card styles */
        .class-grid {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Default for larger screens */
            gap: 20px;
            align-content: start;
        }

        /* Add media queries for smaller screens */
        @media (max-width: 1024px) {
            .class-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                padding: 15px;
            }

            .class-card {
                padding: 15px;
                margin: 5px;
            }

            .class-card h4 {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .class-details p {
                font-size: 0.9em;
                margin: 4px 0;
            }
        }

        @media (max-width: 768px) {
            .class-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
                padding: 10px;
            }

            .class-card {
                padding: 12px;
                margin: 3px;
            }

            .class-details p {
                font-size: 0.85em;
                margin: 3px 0;
            }
        }

        @media (max-width: 480px) {
            .class-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 8px;
                padding: 8px;
            }

            .class-card {
                padding: 10px;
                margin: 2px;
            }

            .class-card h4 {
                font-size: 0.95em;
                margin-bottom: 6px;
            }

            .class-details p {
                font-size: 0.8em;
                margin: 2px 0;
            }

            /* Simplify information shown on very small screens */
            .class-details p:not(:first-child):not(:nth-child(2)) {
                display: none;
            }

            .class-card.unavailable::after {
                font-size: 0.8em;
                padding: 3px 6px;
            }
        }

        .class-card {
            padding: 20px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .class-card.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .class-card h4 {
            margin: 0 0 15px 0;
            color: inherit;
            font-size: 1.2em;
        }

        .class-details {
            font-size: 0.9em;
        }

        .class-details p {
            margin: 8px 0;
            line-height: 1.4;
        }

        .class-details strong {
            font-weight: 600;
        }

        .registered-students {
            margin-bottom: 30px;
        }

        .student-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-info h4 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
        }

        .selected-classes {
            margin-top: 10px;
        }

        .class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
        }

        .register-button {
            width: auto;
            padding: 8px 16px;
            margin: 0 0 0 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .register-button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-3px); /* More dramatic movement */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Added shadow for dramatic effect */
        }

        /* Update the student card styles in the classes step */
        .student-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
        }

        .student-photo {
            width: 50px;  /* Reduced from 80px */
            height: 50px; /* Reduced from 80px */
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }

        .student-details {
            flex-grow: 1;
        }

        .student-details h4 {
            margin: 0 0 5px 0;
        }

        .student-summary {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .student-summary-header {
            margin-bottom: 15px;
        }

        .student-summary-header h4 {
            margin: 0;
            color: var(--secondary-color);
        }

        .student-summary-classes {
            margin-bottom: 15px;
        }

        .class-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #e0e0e0;
        }

        .student-summary-fees {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .fee-item.total {
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 10px;
        }

        .final-summary {
            background: white;
            color: var(--text-color);
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            color: var(--text-color);
        }

        .fee-item.grand-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-color);
        }

        /* Add these styles in the style section */
        .registration-summary-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .students-summary {
            padding: 0;
        }

        .student-summary-row {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .student-name-classes {
            flex: 1;
        }

        .student-name-classes h4 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
        }

        .classes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .class-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .student-charges {
            min-width: 200px;
            text-align: right;
        }

        .charge-item {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .student-total {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .total-summary {
            background: var(--primary-color);
            color: white;
            padding: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .grand-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255,255,255,0.2);
            font-size: 1.2em;
        }

        /* Update the payment form styles */
        .payment-form {
            margin-top: 30px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .payment-form h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        /* Add these styles for validation indicators */
        .input-error {
            border-color: #ff4444 !important;
            background-color: #fff8f8;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.85em;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Add a red asterisk for required fields */
        .required-star {
            color: #ff4444;
            margin-left: 3px;
        }

        /* Add visual feedback on input focus */
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(61, 206, 215, 0.2);
        }

        input.input-error:focus, select.input-error:focus, textarea.input-error:focus {
            border-color: #ff4444;
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2);
        }

        /* Add loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }

        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color, #3DCED7);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2em;
            color: var(--secondary-color, #3A506B);
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add padding to container on mobile */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .progress-steps {
                padding: 15px 10px;
                margin-bottom: 20px;
            }
        }

        /* Additional mobile optimizations */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .progress-steps {
                padding: 10px 5px;
                margin-bottom: 15px;
            }
            
            .step-indicator:not(:last-child)::after {
                top: 12px;
            }
        }

        /* Add some CSS for the class cards */
        .class-card {
            padding: 15px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .class-card.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .class-card h4 {
            margin: 0 0 10px 0;
            color: inherit;
        }
        
        .class-details {
            font-size: 0.9em;
        }
        
        .class-details p {
            margin: 5px 0;
        }

        /* Add to your existing styles */
        #successModal .modal-content {
            max-width: 600px;
            padding: 40px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #successModal h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            position: relative;
        }

        #successModal h2:after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background: var(--primary-color);
            margin: 15px auto;
        }

        .registration-summary-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .registration-summary-section h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item span:first-child {
            color: #666;
            font-weight: 500;
        }

        .summary-item span:last-child {
            color: #333;
            font-weight: 600;
        }

        #successModal .button-container {
            text-align: center;
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #successModal button {
            background: var(--primary-color);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;  /* Override any previous width settings */
        }

        #successModal button:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .student-summary .summary-item:last-child {
            margin-bottom: 0;
        }

        .student-summary h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        .powered-by {
            margin-top: 40px;
            margin-bottom: 20px;
            color: #666;
            font-size: 1.1em;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .powered-by img {
            width: 70px;
            height: auto;
            margin-bottom: 5px;
        }

        /* Password input group */
        .input-group {
            position: relative;
            margin-bottom: 15px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 65%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            padding: 5px;
            z-index: 2;
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            #successModal .modal-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            #successModal button {
                padding: 12px 30px;
            }
        }
        
        @media (max-width: 320px) {
            #successModal h2 {
                font-size: 1.5em;
            }
        }

        /* Add to the existing style section */
        .fees-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .fees-section h5 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1em;
        }

        .class-fees {
            margin: 10px 0;
            padding-left: 15px;
        }

        .class-fees h6 {
            color: var(--secondary-color);
            margin: 5px 0;
            font-size: 0.9em;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .fee-item.total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            font-size: 1.1em;
        }

        .fee-item.grand-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.2);
            font-size: 1.3em;
        }

        .final-summary {
            background: white;
            color: var(--text-color);
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .students-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-new-student-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            width: auto !important;
            margin: 0 !important;
        }

        .add-new-student-btn:hover {
            background-color: var(--primary-hover);
        }

        .add-new-student-btn i {
            font-size: 14px;
        }

       

        /* Add these styles to the existing style section */
        
            .loading-modal {
                text-align: center;
                padding: 40px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .loading-modal h3 {
                color: var(--secondary-color);
                margin: 20px 0 10px;
            }

            .loading-modal p {
                color: #666;
                margin: 10px 0;
            }

            .loading-modal .loading-spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid var(--primary-color);
                border-radius: 50%;
                margin: 0 auto;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

        /* Add styles for unavailable classes */
        .class-card.unavailable {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .class-card.unavailable::after {
            content: 'Age Restricted';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Add these styles for the improved filters */
        .class-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .filter-group select:hover {
            border-color: var(--primary-color);
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(61, 206, 215, 0.1);
        }

        .search-group {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-group input {
            width: 100%;
            padding: 12px;
            padding-left: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .search-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(61, 206, 215, 0.1);
        }

        .search-group i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        @media (max-width: 768px) {
            .filter-group, .search-group {
                min-width: 100%;
            }
        }

        /* Responsive button styles for steps 2 and 3 */
        @media (max-width: 768px) {
            .student-actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .student-actions button {
                padding: 8px;
                font-size: 0.9em;
                width: 100%;
            }

            .student-actions i {
                margin-right: 4px;
                font-size: 0.9em;
            }

            .student-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .student-info {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .student-photo {
                width: 40px;
                height: 40px;
            }

            .student-details h4 {
                font-size: 1em;
            }

            .student-details p {
                font-size: 0.9em;
            }
        }

        /* Additional mobile optimizations */
        @media (max-width: 480px) {
            .filter-group {
                min-width: 100%;
            }

            .student-actions button {
                padding: 6px;
                font-size: 0.85em;
            }

            .student-details h4 {
                font-size: 0.95em;
            }

            .student-details p {
                font-size: 0.85em;
            }
        }

        /* Update the student card responsive styles */
        @media (max-width: 768px) {
            .student-card {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
            }

            .student-info {
                width: 100%;
                display: flex;
                align-items: flex-start;
                gap: 10px;
            }

            .student-photo {
                width: 50px;
                height: 50px;
                flex-shrink: 0;
            }

            .student-details {
                flex-grow: 1;
            }

            .student-actions {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .student-actions button {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }

            .student-actions button i {
                font-size: 0.9em;
            }

            /* Make all buttons same style */
            .edit-button, .delete-button, .register-button {
                margin: 0;
                border-radius: 8px;
            }
        }

        /* Additional optimizations for very small screens */
        @media (max-width: 480px) {
            .student-card {
                padding: 12px;
                gap: 12px;
            }

            .student-photo {
                width: 40px;
                height: 40px;
            }

            .student-details h4 {
                font-size: 0.95em;
                margin-bottom: 4px;
            }

            .student-details p {
                font-size: 0.85em;
            }

            .student-actions button {
                padding: 8px;
                font-size: 0.85em;
            }
        }

        /* Add to your existing styles */
        .policy-section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .policy-title {
            color: var(--secondary-color);
            font-size: 1.4em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .policy-content {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
        }

        .policy-content p {
            margin-bottom: 15px;
        }

        .policy-content p:last-child {
            margin-bottom: 0;
        }

        .policy-type {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }

        .policies-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 15px;
        }

        /* Add smooth scrollbar styling */
        .policies-container::-webkit-scrollbar {
            width: 8px;
        }

        .policies-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .policies-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .policies-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }

        /* Add to your existing styles */
        .class-item.preselected {
            border: 2px solid var(--primary-color);
            background-color: rgba(61, 206, 215, 0.1);
        }

        .class-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .class-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .class-item.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .class-item.preselected {
            border: 2px solid var(--primary-color);
            background-color: rgba(61, 206, 215, 0.1);
        }

        .no-classes-message {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .class-schedule {
            color: #666;
            margin: 5px 0;
        }

        .class-time {
            color: #666;
            font-weight: bold;
        }

        .class-description {
            font-size: 0.9em;
            margin-top: 10px;
            color: #666;
        }

        /* Update class grid styles */
        .modal-class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .class-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }

        .class-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Update selected and preselected states */
        .class-card.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .class-card.preselected:not(.selected) {
            border-color: var(--primary-color);
            background-color: #fff;
            color: inherit;
        }

        /* Update text colors for selected state */
        .class-card.selected .class-details p,
        .class-card.selected .class-details p strong,
        .class-card.selected h4 {
            color: white;
        }

        .class-card.selected h4 {
            border-bottom-color: white;
        }

        /* Keep normal colors for preselected but not selected */
        .class-card.preselected:not(.selected) .class-details p,
        .class-card.preselected:not(.selected) .class-details p strong,
        .class-card.preselected:not(.selected) h4 {
            color: inherit;
        }

        .class-card.preselected:not(.selected) h4 {
            border-bottom-color: var(--primary-color);
        }

        .class-card h4 {
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
        }

        .class-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .class-details p {
            margin: 0;
            font-size: 0.95em;
            color: #666;
        }

        .class-details p strong {
            color: var(--secondary-color);
        }

        /* Add these styles to make the spots indicator responsive */
        .spots-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }

        .spots-text-medium, .spots-text-small {
            display: none;
        }

        /* Medium screens (tablets) */
        @media (max-width: 768px) {
            .spots-text-full {
                display: none;
            }
            .spots-text-medium {
                display: inline;
            }
            .spots-indicator {
                font-size: 0.75em;
                padding: 3px 6px;
            }
        }

        /* Small screens (phones) */
        @media (max-width: 480px) {
            .spots-text-medium {
                display: none;
            }
            .spots-text-small {
                display: inline;
            }
            .spots-indicator {
                font-size: 0.7em;
                padding: 2px 5px;
                top: 10px;
                right: 10px;
            }
        }

        .spots-available {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .spots-limited {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .spots-full {
            background-color: #ffebee;
            color: #c62828;
        }

        .class-card.selected, .class-card.preselected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .class-card.selected .class-details p, 
        .class-card.preselected .class-details p,
        .class-card.selected .class-details p strong,
        .class-card.preselected .class-details p strong {
            color: white;
        }

        .class-card.selected h4,
        .class-card.preselected h4 {
            color: white;
            border-bottom-color: white;
        }

        .class-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        .search-group {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-group i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .search-group input {
            width: 100%;
            padding: 8px 8px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }

        /* Update or add these styles */
        .registration-summary-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .student-summary-row {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: transform 0.2s ease;
        }

        .student-summary-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .student-name-classes {
            flex-grow: 1;
        }

        .student-name-classes h4 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
            font-size: 1.2em;
        }

        .classes-list {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
        }

        .student-fees {
            text-align: right;
            min-width: 150px;
        }

        .student-fees p {
            margin: 5px 0;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .total-summary {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .fee-item.total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .fee-item.total:last-child {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .student-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: transform 0.2s ease;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .student-info {
            flex-grow: 1;
        }

        .student-details h4 {
            margin: 0 0 8px 0;
            color: var(--secondary-color);
            font-size: 1.2em;
        }

        .student-details p {
            margin: 0 0 10px 0;
            color: #666;
        }

        .selected-classes {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .class-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 2px;
            transition: background-color 0.2s ease;
        }

        .class-tag:hover {
            background-color: var(--primary-hover);
        }

        .student-fees {
            text-align: right;
            min-width: 200px;
            padding-left: 20px;
        }

        .fee-amount {
            margin: 5px 0;
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 1.1em;
        }

        .total-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .fee-item.total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 1.1em;
        }

        .fee-item.total strong {
            color: var(--secondary-color);
        }

        .fee-item.grand-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 1.3em;
        }

        .fee-item.grand-total strong {
            color: var(--primary-color);
        }

        .registration-summary-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* Add these media queries for mobile responsiveness */
        @media (max-width: 768px) {
            .progress-steps {
                padding: 15px 10px;
                gap: 10px;  /* Add some gap between step indicators */
            }

            .step-indicator:not(:last-child)::after {
                display: none;  /* Remove the connecting lines on mobile */
            }

            .step-circle {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .step-label {
                font-size: 0.75em;
            }
        }

        @media (max-width: 480px) {
            .progress-steps {
                padding: 10px 5px;
                gap: 8px;  /* Slightly reduce gap on very small screens */
            }

            .step-circle {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }

            .step-label {
                font-size: 0.7em;
            }
        }

        /* Enhanced Register/Modify Classes Button */
        .register-button {
            width: 100%; /* Make button full width */
            padding: 14px 20px; /* Increase padding for larger size */
            font-size: 18px; /* Larger font */
            font-weight: 600; /* Slightly bolder */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease; /* Smooth transition for all properties */
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .register-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-3px) scale(1.03); /* Move up and slight scale */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Larger shadow on hover */
            letter-spacing: 0.5px; /* Subtle letter spacing for dramatic effect */
        }

        .register-button:active {
            transform: translateY(1px); /* Press effect */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Smaller shadow when pressed */
        }

        /* Update the register-button styling to use secondary color with more dramatic hover */
        .register-button {
            width: auto;
            padding: 8px 16px;
            margin: 0 0 0 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .register-button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-3px); /* More dramatic movement */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Added shadow for dramatic effect */
        }
        
        /* Hide register button on step 2 */
        #step2 .register-button {
            display: none;
        }
        
        /* Additional style for modify classes button */
        .modify-classes-button {
            background-color: var(--secondary-color);
            color: white;
            transition: all 0.3s ease;
        }
        
        .modify-classes-button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Modern styling for class cards in registration summary */
        .student-summary {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }

        .student-summary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .student-summary h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .class-item {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: all 0.2s ease;
        }

        .class-item:hover {
            background: #f0f8ff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .class-details {
            flex: 1;
        }

        .class-name {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .class-schedule {
            color: #666;
            font-size: 0.9em;
        }

        .class-tuition {
            color: #555;
            font-weight: 600;
            margin-left: 10px;
            background: none;
            padding: 0;
        }

        .selected-classes-summary {
            margin-top: 15px;
        }

        .fees-section {
            margin-top: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            padding: 12px 15px;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .fee-item:last-child {
            border-bottom: none;
        }

        .fee-item.total {
            border-top: 2px solid #eee;
            margin-top: 10px;
            padding-top: 12px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .fee-item.total span:last-child {
            color: #333;
            font-size: 1.2em;
        }

        /* Add styling for student total row */
        .student-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.3em;
            color: #333;
            margin-top: 20px;
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }

        .student-total .amount {
            color: #333;
        }

        /* Add the CSS for the spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Spinner styling */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        button:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        /* Promo code styles */
        .promo-code-section {
            margin: 15px 0;
            border-top: 1px dashed #eee;
            padding-top: 15px;
        }

        .promo-code-toggle {
            color: #666;
        }

        .promo-code-toggle:hover {
            color: var(--secondary-color);
        }

        .promo-code-toggle.active i {
            transform: rotate(180deg);
        }

        .promo-code-toggle i {
            transition: transform 0.3s ease;
        }

        .promo-code-form {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin-top: 0;
        }

        .promo-code-form.show {
            max-height: 100px;
            opacity: 1;
            margin-top: 10px;
        }

        .promo-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 5px;
        }

        .promo-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .promo-input-group button {
            background: rgba(255,255,255,0.9);
            color: var(--secondary-color);
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .promo-input-group button:hover {
            background: white;
        }

        .promo-input-group button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #promoMessage {
            font-size: 0.85em;
            margin-top: 5px;
        }

        .promo-error {
            color: #ff4444;
        }

        .promo-success {
            color: #4CAF50;
        }

        .fee-item.promo-discount {
            color: #4CAF50;
            font-style: italic;
        }

        /* Ensure the spinner works in the promo button */
        .promo-input-group .spinner {
            width: 14px;
            height: 14px;
            border-width: 2px;
            margin-right: 5px;
        }
 </style>

    

</head>
<body>
    <!-- Add loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Registration...</div>
    </div>

    <!-- Move the progress-steps div outside and above the container -->
    <div class="progress-steps">
        <div class="step-indicator" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Contact Info</div>
        </div>
        <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Students</div>
        </div>
        <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Classes</div>
        </div>
        <div class="step-indicator" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-label">Agreement</div>
        </div>
        <div class="step-indicator" data-step="5">
            <div class="step-circle">5</div>
            <div class="step-label">Payment</div>
        </div>
    </div>
    <div class="container">
        <div class="menu-container">
            <button class="menu-bars">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="menu-dropdown">
                <a href="#" id="studioLoginLink">Login</a>
            </div>
        </div>
        <div class="logo-container">
            <img alt="Studio Logo" id="studioLogo" style="display: none;">
        </div>
        <form id="contactForm">
            <!-- Step 1: Contact Information -->
            <div class="step active" id="step1">
                <h2>
                      Contact Information
                </h2>
                <p class="step-description"><strong>Please enter the contact info for who will be covering the charges.</strong> If the student is a minor, please enter the guardian's contact info.</p>
                <label for="firstName">First Name <span class="required-star">*</span></label>
                <input type="text" id="firstName" name="firstName" required>

                <label for="lastName">Last Name <span class="required-star">*</span></label>
                <input type="text" id="lastName" name="lastName" required>

                <label for="address1">Address 1 <span class="required-star">*</span></label>
                <input type="text" id="address1" name="address1" required>

                <label for="address2">Address 2</label>
                <input type="text" id="address2" name="address2">

                <label for="city">City <span class="required-star">*</span></label>
                <input type="text" id="city" name="city" required>

                <label for="state">State <span class="required-star">*</span></label>
                <select id="state" name="state" required>
                    <option value="UT" selected>UT</option>
                </select>

                <label for="zip">ZIP <span class="required-star">*</span></label>
                <input type="text" id="zip" name="zip" required>

                <label for="phone">Phone Number <span class="required-star">*</span></label>
                <input type="tel" id="phone" name="phone" placeholder="(123) 456-7890" required>

                <label for="email">Email <span class="required-star">*</span></label>
                <input type="email" id="email" name="email" placeholder="e.g., myname@gmail.com" required autocomplete="username">

                <div class="checkbox-container">
                    <label class="checkbox-item">
                        <input type="checkbox" id="emailNotifications" name="emailNotifications" checked>
                        Yes, send me emails related to my account payments, class confirmations, class reminders, cancelled classes, etc.
                    </label>
                    <p class="note">See our privacy policy for how we safeguard your information.</p>
                </div>

                <h3>Set Your Password</h3>
                <!-- Password input group -->
                <div class="input-group">
                    <label for="password">Create Password <span class="required-star">*</span></label>
                    <input type="password" id="password" name="password" required autocomplete="new-password">
                    <i class="fas fa-eye password-toggle" id="passwordToggle"></i>
                </div>

                <p class="note">Password must include at least one upper case letter, one lower case letter, one number, one special character, and be at least 8 characters long.</p>

                <!-- Confirm Password input group -->
                <div class="input-group">
                    <label for="confirmPassword">Confirm Password <span class="required-star">*</span></label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required autocomplete="new-password">
                    <i class="fas fa-eye password-toggle" id="confirmPasswordToggle"></i>
                </div>

                <label for="referralSource">How did you hear about us?</label>
                <select id="referralSource" name="referralSource">
                    <option value="" disabled selected>Select an option</option>
                    <option value="friend">Friend</option>
                    <option value="social">Social Media</option>
                    <option value="sign">Location/Sign</option>
                    <option value="web">Web</option>
                    <option value="web">Advertisement</option>
                    <option value="other">Other</option>
                </select>

                <label for="referralName">If referred, who can we thank for referring you?</label>
                <input type="text" id="referralName" name="referralName" placeholder="Enter name of person who referred you">

                <label for="moreDetails">Additional Details</label>
                <textarea id="moreDetails" name="moreDetails" rows="3"></textarea>

                <h3>Emergency Contact Information <span class="required-star">*</span></h3>
                <div id="emergencyContacts">
                    <div class="emergency-contact-row">
                        <div class="emergency-contact-inputs">
                            <input type="text" placeholder="Contact Name *" class="emergency-name" required>
                            <input type="tel" placeholder="Contact Phone *" class="emergency-phone" required>
                        </div>
                        <button type="button" class="add-emergency-contact" onclick="addEmergencyContact()">+</button>
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="cancelRegistration()">Cancel</button>
                    <button type="button" onclick="goToStep2()">Next</button>
                </div>
            </div>

            <!-- Step 2: Student Information -->
            <div class="step" id="step2" style="display: none;">
                <h2>Student Information</h2>
                <div class="add-student-form">
                    <label for="studentFirstName">Student's First Name <span class="required-star">*</span></label>
                    <input type="text" id="studentFirstName" name="studentFirstName" required tabindex="0">

                    <label for="studentLastName">Student's Last Name <span class="required-star">*</span></label>
                    <input type="text" id="studentLastName" name="studentLastName" required tabindex="0">

                    <label for="studentBirthday">Birthday <span class="required-star">*</span></label>
                    <input type="date" id="studentBirthday" name="studentBirthday" required tabindex="0">

                    <label for="studentGender">Gender <span class="required-star">*</span></label>
                    <select id="studentGender" name="studentGender" required tabindex="0">
                        <option value="" disabled selected>Select Gender</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="other">Other</option>
                        <option value="prefer-not">Prefer not to say</option>
                    </select>

                    <label for="medicalInfo">Any medical information we should know</label>
                    <textarea id="medicalInfo" name="medicalInfo" rows="3" placeholder="Enter any medical conditions, allergies, or other important health information"></textarea>

                    <label for="skillLevel">Skill Level <span class="required-star">*</span></label>
                    <select id="skillLevel" name="skillLevel" required tabindex="0">
                        <option value="" disabled selected>Select Skill Level</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                        <option value="other">Other</option>
                    </select>

                    <label for="studentPhoto">Student Photo</label>
                    <div class="photo-upload">
                        <input type="file" id="studentPhoto" name="studentPhoto" accept="image/*" class="photo-input">
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>

                    <button type="button" class="add-student-btn">Save Student</button>
                </div>

                <div class="students-list">
                    <div class="students-list-header">
                        <h3>Added Students</h3>
                        <button type="button" class="add-new-student-btn" style="display: none;">
                            <i class="fas fa-plus"></i> Add New Student
                        </button>
                    </div>
                    <div id="studentsList"></div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="goToStep1()">Back</button>
                    <button type="button" onclick="goToStep3()">Next</button>
                </div>
            </div>

            <!-- Step 3: Class Selection -->
            <div class="step" id="step3" style="display: none;">
                <h2>Register for Classes</h2>
                
                <!-- Students Section -->
                <div class="registered-students">
                    <h3>Students</h3>
                    <div id="studentClassList">
                        <!-- Students will be listed here -->
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="goToStep2()">Back</button>
                    <button type="button" onclick="goToStep4()">Next</button>
                </div>
            </div>

            <!-- Add Class Selection Modal -->
            <div id="classSelectionModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeClassModal()">&times;</span>
                    <h2 id="classSelectionStudentName"></h2>
                    
                    <!-- Update the filters section in the class selection modal -->
                    <div class="class-filters">
                        <div class="search-group">
                            <i class="fas fa-search"></i>
                            <input type="text" id="classSearch" placeholder="Search classes..." onkeyup="filterModalClasses()">
                        </div>
                        <div class="filter-group">
                            <select id="modalClassTypeFilter" onchange="filterModalClasses()">
                                <option value="all">All Class Types</option>
                                <option value="Recreational">Recreational</option>
                                <option value="Team">Team</option>
                                <option value="Solo">Solo/Duet/Trio</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="modalLevelFilter" onchange="filterModalClasses()">
                                <option value="all">All Levels</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="modalStyleFilter" onchange="filterModalClasses()">
                                <option value="all">All Styles</option>
                                <option value="ballet">Ballet</option>
                                <option value="jazz">Jazz</option>
                                <option value="tap">Tap</option>
                                <option value="contemporary">Contemporary</option>
                                <option value="hiphop">Hip Hop</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="modalDayFilter" onchange="filterModalClasses()">
                                <option value="all">All Days</option>
                                <option value="mon">Monday</option>
                                <option value="tue">Tuesday</option>
                                <option value="wed">Wednesday</option>
                                <option value="thu">Thursday</option>
                                <option value="fri">Friday</option>
                                <option value="sat">Saturday</option>
                                <option value="sun">Sunday</option>
                            </select>
                        </div>
                    </div>

                    <div id="modalClassGrid" class="class-grid"></div>

                    <div class="button-container">
                        <button type="button" onclick="closeClassModal()">Cancel</button>
                        <button type="button" onclick="saveClassSelections()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Waiver & Terms -->
            <div class="step" id="step4" style="display: none;">
                <h2>Student Waiver & Studio Service Agreement</h2>
                
                <div class="waiver-container">
                    <div class="student-list-summary">
                        <h3>Students to be Registered:</h3>
                        <div id="waiverStudentList"></div>
                    </div>

                    <div class="waiver-content" id="policiesContent">
                        <!-- Policies will be dynamically inserted here -->
                    </div>

                    <div class="waiver-acceptance">
                        <div id="policyCheckboxes">
                            <!-- Policy checkboxes will be dynamically inserted here -->
                        </div>

                        <label class="checkbox-item">
                            <input type="checkbox" id="electronicSignatureAccept" name="electronicSignatureAccept" required tabindex="0">
                            Yes, I agree to provide my electronic signature as a binding acceptance of all policies
                        </label>

                        <div class="signature-display">
                            <p>Electronic Signature:</p>
                            <div id="generatedSignature" class="signature-text"></div>
                        </div>
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="goToStep3()">Back</button>
                    <button type="button" onclick="goToStep5()">Next</button>
                </div>
            </div>

            <!-- Step 5: Payment Information -->
            <div class="step" id="step5" style="display: none;">
                <h2>Payment Details</h2>
                
                <div class="payment-summary">
                    <h3>Registration Summary</h3>
                    <div id="registrationSummary"></div>
                    <div class="total-amount">
                        <strong>Total Amount: $<span id="totalAmount">0.00</span></strong>
                    </div>
                </div>

                <div class="payment-form">
                    <label for="cardName">Name on Card <span class="required-star">*</span></label>
                    <input type="text" id="cardName" name="cardName" required tabindex="0">

                    <label for="cardNumber">Card Number</label>
                    <input type="text" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" required>

                    <div class="card-details">
                        <div class="expiration">
                            <label for="expiryDate">Expiration (MM/YY)</label>
                            <input type="text" id="expiryDate" name="expiryDate" placeholder="MM/YY" required>
                        </div>
                        <div class="cvc">
                            <label for="cvv">CVC</label>
                            <input type="text" id="cvv" name="cvv" placeholder="123" required>
                        </div>
                    </div>

                    <div class="billing-address">
                        <label class="checkbox-item">
                            <input type="checkbox" id="sameAsContact" name="sameAsContact" checked>
                            Billing address same as contact information
                        </label>
                    </div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="goToStep4()">Back</button>
                    <button type="button" onclick="submitRegistration()">Complete Registration</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Update the edit modal content -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Student</h2>
            <div class="edit-student-form">
                <label for="editStudentFirstName">Student's First Name <span class="required-star">*</span></label>
                <input type="text" id="editStudentFirstName" required>

                <label for="editStudentLastName">Student's Last Name <span class="required-star">*</span></label>
                <input type="text" id="editStudentLastName" required>

                <label for="editStudentBirthday">Birthday <span class="required-star">*</span></label>
                <input type="date" id="editStudentBirthday" required>

                <label for="editStudentGender">Gender</label>
                <select id="editStudentGender">
                    <option value="" disabled>Select Gender</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                    <option value="other">Other</option>
                    <option value="prefer-not">Prefer not to say</option>
                </select>

                <label for="editMedicalInfo">Any medical information we should know</label>
                <textarea id="editMedicalInfo" rows="3" placeholder="Enter any medical conditions, allergies, or other important health information"></textarea>

                <label for="editSkillLevel">Skill Level <span class="required-star">*</span></label>
                <select id="editSkillLevel" required>
                    <option value="" disabled>Select Skill Level</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                    <option value="other">Other</option>
                </select>

                <label for="editStudentPhoto">Student Photo</label>
                <div class="photo-upload">
                    <input type="file" id="editStudentPhoto" accept="image/*" class="photo-input">
                    <div class="photo-preview" id="editPhotoPreview"></div>
                </div>

                <div class="button-container">
                    <button type="button" onclick="closeEditModal()">Cancel</button>
                    <button type="button" onclick="saveEditedStudent()">Save Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <h2>Registration Successful!</h2>
            <div id="registrationSummaryModal">
                <!-- Summary will be inserted here -->
            </div>
            <div class="button-container">
                <button onclick="goToPortalLogin()">Go to Portal Login</button>
            </div>
        </div>
    </div>

    <!-- Add this before the closing body tag, after all your other content -->
    <div class="powered-by">
        <img src="/assets/ssdancerblue.svg" alt="Studio Sync Logo">
        Powered by Studio Sync
    </div>

     <div id="registrationLoadingModal" class="modal">
            <div class="modal-content loading-modal">
                <div class="loading-spinner"></div>
                <h3>Completing Registration...</h3>
                <p>Please wait while we set up your account</p>
            </div>
        </div>

    <script>
        // Add this at the beginning of your script section
        let contactInfo = {
            firstName: '',
            lastName: '',
            address1: '',
            address2: '',
            city: '',
            state: '',
            zip: '',
            phone: '',
            email: '',
            password: ''
        };

        // Initialize Firebase Auth
        const auth = firebase.auth();
        
        let studioId = null;
        let studioData = null;
        let studioPolicies = [];
        let studioClasses = [];

        // Add this to store rate plans data
        let ratePlans = {};

        // Update the fetchRatePlans function
        async function fetchRatePlans() {
            console.log('Fetching rate plans for studio:', studioId);
            try {
                const ratePlansSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('RatePlans')
                    // Removed the .where('Status', '==', 'Active') filter
                    .get();

                ratePlans = {}; // Reset the rate plans object
                
                ratePlansSnapshot.forEach(doc => {
                    console.log('Found rate plan:', doc.id, doc.data());
                    ratePlans[doc.id] = {
                        id: doc.id,
                        ...doc.data()
                    };
                });
                
                console.log('Fetched Rate Plans:', ratePlans);
            } catch (error) {
                console.error('Error fetching rate plans:', error);
                throw error;
            }
        }

        // Function to get studio info from URL
        function getStudioFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const studioParam = urlParams.get('studio');
            
            if (!studioParam) return null;
            
            // Split by = and get the second element (the ID after the studio name)
            const parts = studioParam.split('=');
            if (parts.length >= 2) {
                return parts[1]; // This will get H5YvK3FeNcTMmniUrshF
            }
            
            return null;
        }

        // Function to fetch studio policies
        async function fetchStudioPolicies() {
            console.log('Fetching policies for studio ID:', studioId); // Debug log
            
            try {
                const policiesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Policies')
                    .where('IsActive', '==', true)
                    .get();

                console.log('Policies snapshot:', policiesSnapshot); // Debug log

                const policies = [];
                policiesSnapshot.forEach(doc => {
                    const policyData = doc.data();
                    console.log('Policy document:', doc.id, policyData); // Debug log
                    
                    policies.push({
                        Id: doc.id,
                        ...policyData
                    });
                });

                console.log('Processed policies:', policies); // Debug log
                return policies;
            } catch (error) {
                console.error('Error fetching policies:', error);
                return [];
            }
        }

        // Add this function to fetch classes properly
        async function fetchStudioClasses() {
            try {
                // Make sure we're using the correct studioId
                if (!window.studioId) {
                    console.error('No studio ID available');
                    return;
                }
                
                console.log('Fetching classes for studio ID:', window.studioId);
                const db = firebase.firestore();
                
                // Remove the where() clause to fetch ALL documents in the Classes subcollection
                const classesSnapshot = await db.collection('Studios')
                    .doc(window.studioId)
                    .collection('Classes')
                    .get();

                console.log(`Retrieved ${classesSnapshot.size} total class documents`);

                if (classesSnapshot.empty) {
                    console.log('No classes found for studio');
                    studioClasses = [];
                    return;
                }

                // Map all classes (we'll filter later if needed)
                studioClasses = classesSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        Id: doc.id,
                        ClassName: data.ClassName || '',
                        Days: data.Days || [],
                        StartTime: data.StartTime || '',
                        EndTime: data.EndTime || '',
                        RatePlanId: data.RatePlanId || '',
                        Duration: data.Duration || 0,
                        SeasonId: data.SeasonId || '',
                        ClassType: data.ClassType || '',
                        MaxSize: data.MaxSize || 0,
                        MinAge: data.MinAge || 0,
                        MaxAge: data.MaxAge || 0,
                        Description: data.Description || '',
                        EnforceAgeLimit: data.EnforceAgeLimit || false,
                        Students: data.Students || [],
                        ClassStyleId: data.ClassStyleId || '',
                        IsActive: data.IsActive !== false,  // Still use this logic for the property
                        // Add newly required fields
                        PaymentType: data.PaymentType || 'Both',
                        Fee: data.Fee || [],
                        ClassNotes: data.ClassNotes || '',
                        InstructorId: data.InstructorId || '',
                        Instructors: data.Instructors || [],
                        RoomId: data.RoomId || '',
                        CreatedAt: data.CreatedAt,
                        UpdatedAt: data.UpdatedAt
                    };
                });

                // Log all class IDs for debugging
                console.log('All fetched class IDs:', studioClasses.map(c => ({id: c.Id, name: c.ClassName})));

                // Process Fee details for each class
                studioClasses.forEach(classData => {
                    // Handle fee processing for BOTH 'Both' and 'ClassFee' payment types
                    if ((classData.PaymentType === 'Both' || classData.PaymentType === 'ClassFee') && 
                        classData.Fee && classData.Fee.length > 0) {
                        // Extract fee details from the first fee entry (assuming it's the primary one)
                        const primaryFee = classData.Fee[0];
                        if (primaryFee) {
                            classData.FeeAmount = primaryFee.FeeAmount;
                            classData.FeeType = primaryFee.FeeType;
                            
                            // Handle different fee types with their specific frequency fields
                            if (primaryFee.FeeType === 'Recurring') {
                                classData.RecurringFrequency = primaryFee.RecurringFrequency;
                                classData.RecurringDuration = primaryFee.RecurringDuration;
                            } else if (primaryFee.FeeType === 'BrokenUp') {
                                classData.BrokenUpFrequency = primaryFee.BrokenUpFrequency;
                            }
                            
                            console.log(`Class "${classData.ClassName}" has ${classData.FeeType} fee of $${classData.FeeAmount} (PaymentType: ${classData.PaymentType})`);
                        }
                    } else if (classData.PaymentType === 'RatePlan') {
                        // For RatePlan payment type, no Fee array is expected
                        console.log(`Class "${classData.ClassName}" uses RatePlan: ${classData.RatePlanId}`);
                    } else if (classData.Fee && classData.Fee.length === 0) {
                        // Log classes that should have fees but don't
                        console.log(`Warning: Class "${classData.ClassName}" has PaymentType "${classData.PaymentType}" but no fee data`);
                    }
                });

                // Sort classes by name
                studioClasses.sort((a, b) => a.ClassName.localeCompare(b.ClassName));

                console.log('Fetched all classes with full data:', studioClasses.length);

                // If you still want to filter out inactive classes for display purposes,
                // you could do it here instead of in the query
                // const activeClasses = studioClasses.filter(c => c.IsActive);
                // console.log(`${activeClasses.length} of ${studioClasses.length} classes are active`);

                // After loading all classes, check for preselected class
                const preselectedClassId = localStorage.getItem('preselectedClassId');
                if (preselectedClassId) {
                    const classExists = studioClasses.some(c => c.Id === preselectedClassId);
                    if (!classExists) {
                        console.error('Preselected class not found:', preselectedClassId);
                        localStorage.removeItem('preselectedClassId');
                    } else {
                        console.log('Found preselected class:', preselectedClassId);
                    }
                }

            } catch (error) {
                console.error('Error fetching studio classes:', error);
                console.error('Error details:', error.stack);
                studioClasses = [];
            }
        }

        // Add these new functions
        let seasons = {};

        async function fetchSeasons() {
            try {
                console.log('Fetching seasons from Seasons subcollection...');
                const seasonsSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Seasons')  // Make sure we're using the Seasons subcollection
                    .get();

                seasonsSnapshot.docs.forEach(doc => {
                    const seasonData = doc.data();
                    console.log(`Found season with ID ${doc.id}:`, {
                        name: seasonData.Name,
                        fees: seasonData.Fees,
                        dates: {
                            start: seasonData.StartDate,
                            end: seasonData.EndDate
                        }
                    });
                    
                    seasons[doc.id] = {
                        ...seasonData,
                        id: doc.id
                    };
                });

                console.log('All fetched seasons:', seasons);
            } catch (error) {
                console.error('Error fetching seasons:', error);
            }
        }

        async function fetchFees(feeIds) {
            if (!feeIds || !Array.isArray(feeIds) || feeIds.length === 0) {
                console.log('No Fee IDs provided to fetch');
                return [];
            }

            console.log('Fetching Fees for IDs:', feeIds);
            const fees = [];
            
            for (const feeId of feeIds) {
                try {
                    const feeDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Fees')
                        .doc(feeId)
                        .get();
                    
                    if (feeDoc.exists) {
                        const feeData = feeDoc.data();
                        // Only include active fees
                        if (feeData.IsActive !== false) {
                            console.log(`Found active Fee ${feeId}:`, {
                                Name: feeData.Name,
                                Amount: feeData.Amount,
                                Type: feeData.Type,
                                Status: feeData.Status,
                                AssociationType: feeData.AssociationType,
                                AssociationName: feeData.AssociationName,
                                TimingType: feeData.TimingType,
                                LastUpdated: feeData.LastUpdated
                            });
                            
                            fees.push({
                                id: feeId,
                                ...feeData
                            });
                        } else {
                            console.log(`Fee ${feeId} is inactive, skipping`);
                        }
                    } else {
                        console.log(`No Fee found for ID: ${feeId}`);
                    }
                } catch (error) {
                    console.error(`Error fetching Fee ${feeId}:`, error);
                }
            }
            
            console.log('All fetched active Fees:', fees.map(fee => ({
                Name: fee.Name,
                Amount: fee.Amount,
                Type: fee.Type,
                Status: fee.Status
            })));
            
            return fees;
        }

        // Update the fetchStudioData function
        async function fetchStudioData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const studioParam = urlParams.get('studio');
                
                if (!studioParam) {
                    console.error('No studio parameter found in URL');
                    return;
                }

                // Split the parameter to extract studio name, ID, and optional class ID
                const paramParts = studioParam.split('=');
                const studioName = decodeURIComponent(paramParts[0]);
                const studioId = paramParts[1];
                const classId = paramParts[2]; // This will be undefined if not present

                // Store class ID if present for later use
                if (classId) {
                    localStorage.setItem('preselectedClassId', classId);
                } else {
                    localStorage.removeItem('preselectedClassId');
                }

                // Since we have the studioId, let's use it directly instead of querying by name
                const db = firebase.firestore();
                const studioDoc = await db.collection('Studios').doc(studioId).get();

                if (!studioDoc.exists) {
                    console.error('No studio found with ID:', studioId);
                    return;
                }

                const data = studioDoc.data();
                studioData = {
                    StudioName: data.StudioName,
                    PrimaryColor: data.PrimaryColor,
                    SecondaryColor: data.SecondaryColor,
                    LogoUrl: data.LogoUrl
                };

                // Store the studioId for later use
                window.studioId = studioId;

                // Enhanced studio logging
                console.log('=== Studio Registration Details ===');
                console.log('Studio ID:', studioId);
                console.log('Studio Name:', studioData.StudioName);
                console.log('Primary Color:', studioData.PrimaryColor);
                console.log('Secondary Color:', studioData.SecondaryColor);
                console.log('Logo URL:', studioData.LogoUrl);
                console.log('Class ID (if any):', classId);
                console.log('Registration Time:', new Date().toISOString());
                console.log('Registration URL:', window.location.href);
                console.log('================================');

                // Update login URL
                if (studioData.StudioName && studioId) {
                    const loginLink = document.getElementById('studioLoginLink');
                    loginLink.href = `/portallogin/${encodeURIComponent(studioData.StudioName)}/${studioId}`;
                }

                // Clear any existing logo
                const logoImg = document.getElementById('studioLogo');
                logoImg.style.display = 'none';
                logoImg.src = '';

                // Apply studio branding
                await customizeForm(
                    studioData.LogoUrl,
                    studioData.PrimaryColor || '#3DCED7',
                    studioData.SecondaryColor || '#3A506B',
                    '#F5F5F5'
                );

                // Update page title and meta tags
                document.title = `Student Registration - ${studioData.StudioName}`;
                
                // Update meta tags
                document.querySelectorAll('meta[data-dynamic="true"]').forEach(meta => {
                    if (meta.getAttribute('property') === 'og:title') {
                        meta.content = `Student Registration - ${studioData.StudioName}`;
                    }
                });

                // Update and show logo if available
                if (studioData.LogoUrl) {
                    logoImg.src = studioData.LogoUrl;
                    logoImg.alt = `${studioData.StudioName} Logo`;
                    
                    await new Promise((resolve) => {
                        if (logoImg.complete) {
                            logoImg.style.display = 'block';
                            resolve();
                        } else {
                            logoImg.onload = () => {
                                logoImg.style.display = 'block';
                                resolve();
                            };
                            logoImg.onerror = () => {
                                logoImg.style.display = 'none';
                                resolve();
                            };
                        }
                    });
                }

                // Add this check before fetching classes
                if (!studioId) {
                    throw new Error('No studio ID available for fetching classes');
                }

                // Load additional data
                await Promise.all([
                    fetchStudioClasses(),
                    fetchRatePlans(),
                    initializePolicies()
                ]);

                // Hide loading overlay after everything is loaded
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('fade-out');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);

            } catch (error) {
                console.error('Error in fetchStudioData:', error);
                console.error('Stack trace:', error.stack);
                
                // Make sure to hide the loading overlay even if there's an error
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('fade-out');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        // Update the customizeForm function
        async function customizeForm(logoUrl, primaryColor, secondaryColor, backgroundColor) {
            // Set the logo
            const logoImg = document.getElementById('studioLogo');
            if (logoUrl) {
                logoImg.src = logoUrl;
                logoImg.style.display = 'block';
            } else {
                logoImg.style.display = 'none';
            }
            
            // Set main colors with fallbacks
            document.documentElement.style.setProperty('--primary-color', primaryColor || '#3DCED7');
            document.documentElement.style.setProperty('--secondary-color', secondaryColor || '#3A506B');
            document.documentElement.style.setProperty('--background-color', backgroundColor || '#F5F5F5');
            
            // Calculate and set hover colors (10% darker)
            const primaryHover = adjustColor(primaryColor || '#3DCED7', -10);
            const secondaryHover = adjustColor(secondaryColor || '#3A506B', -10);
            
            document.documentElement.style.setProperty('--primary-hover', primaryHover);
            document.documentElement.style.setProperty('--secondary-hover', secondaryHover);

            return Promise.resolve();
        }

        // Add this helper function to calculate darker shades
        function adjustColor(color, percent) {
            let R = parseInt(color.substring(1,3), 16);
            let G = parseInt(color.substring(3,5), 16);
            let B = parseInt(color.substring(5,7), 16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            R = Math.max(0, R);
            G = Math.max(0, G);
            B = Math.max(0, B);

            const RR = ((R.toString(16).length === 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length === 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length === 1) ? "0" + B.toString(16) : B.toString(16));

            return "#" + RR + GG + BB;
        }

        // Example customization call
        customizeForm('assets/steps.svg', '#3DCED7', '#3A506B', '#F5F5F5');

        // Add these helper functions
        function showError(element, message) {
            element.classList.add('input-error');
            
            // Create or update error message
            let errorDiv = element.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                element.parentNode.insertBefore(errorDiv, element.nextSibling);
            }
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function clearValidationErrors() {
            // Remove all error classes and messages
            document.querySelectorAll('.input-error').forEach(element => {
                element.classList.remove('input-error');
            });
            document.querySelectorAll('.error-message').forEach(element => {
                element.classList.remove('show');
            });
        }

        // Add input event listeners to clear errors when user starts typing
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('input', function() {
                this.classList.remove('input-error');
                const errorMessage = this.nextElementSibling;
                if (errorMessage && errorMessage.classList.contains('error-message')) {
                    errorMessage.classList.remove('show');
                }
            });
        });

        function goToStep1() {
            hideAllSteps();
            document.getElementById('step1').style.display = 'block';
        }

        function cancelRegistration() {
            if (confirm('Are you sure you want to cancel the registration?')) {
                window.location.href = 'home.html'; // Redirect to the home page or other relevant page
            }
        }

        document.getElementById('contactForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get the signature
            const signature = document.getElementById('generatedSignature').textContent;
            
            // Create an object with all the form data including the signature
            const formData = {
                contactInfo: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    // ... other contact fields
                },
                students: students,
                waiver: {
                    termsAccepted: document.getElementById('termsAccept').checked,
                    electronicSignature: signature,
                    signatureDate: new Date().toISOString()
                },
                payment: {
                    cardName: document.getElementById('cardName').value,
                    // ... other payment fields (you might want to handle these securely)
                }
            };

            // Here you would send formData to your backend
            console.log('Form submitted with data:', formData);
            alert('Registration complete! Thank you for registering your student.');
        });

        let students = [];

        function calculateAge(birthday) {
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Add this function to validate student data
        function validateStudent(student) {
            const errors = [];
            
            const requiredFields = [
                { field: 'firstName', label: 'First Name', element: 'studentFirstName' },
                { field: 'lastName', label: 'Last Name', element: 'studentLastName' },
                { field: 'birthday', label: 'Birthday', element: 'studentBirthday' },
                { field: 'skillLevel', label: 'Skill Level', element: 'skillLevel' }
            ];
            
            requiredFields.forEach(({ field, label, element }) => {
                if (!student[field]?.trim()) {
                    errors.push(label);
                    const inputElement = document.getElementById(element);
                    if (inputElement) {
                        inputElement.focus();
                    }
                }
            });
            
            return errors;
        }

        // Update the addStudent function with validation
        function addStudent() {
            clearValidationErrors();
            
            const studentData = {
                firstName: document.getElementById('studentFirstName').value.trim(),
                lastName: document.getElementById('studentLastName').value.trim(),
                birthday: document.getElementById('studentBirthday').value,
                gender: document.getElementById('studentGender').value,
                medicalInfo: document.getElementById('medicalInfo').value.trim(),
                skillLevel: document.getElementById('skillLevel').value,
                photoUrl: document.getElementById('photoPreview').style.backgroundImage.replace(/^url\(['"](.+)['"]\)$/, '$1') || '',
                classes: [] // Initialize empty classes array
            };

            const errors = validateStudent(studentData);
            
            if (errors.length > 0) {
                errors.forEach(field => {
                    const element = document.getElementById('student' + field.replace(/\s+/g, ''));
                    if (element) {
                        showError(element, `${field} is required`);
                    }
                });
                return;
            }

            // Calculate age before adding to students array
            studentData.age = calculateAge(studentData.birthday);
            
            students.push(studentData);
            console.log('Student info stored:', studentData);
            storeFormData(); // Store in session storage
            updateStudentsList();
            clearStudentForm();
        }

        function clearStudentForm() {
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentBirthday').value = '';
            document.getElementById('studentGender').selectedIndex = 0;
            document.getElementById('medicalInfo').value = '';
            document.getElementById('skillLevel').selectedIndex = 0;
            document.getElementById('photoPreview').style.backgroundImage = '';
            document.getElementById('studentPhoto').value = '';
            document.querySelectorAll('input[name="danceClass"]')
                .forEach(checkbox => checkbox.checked = false);
        }

        // First, add a variable to track the current step
        let currentStep = 1;

        // Update the updateStudentsList function
        function updateStudentsList() {
            const listContainer = document.getElementById('studentsList');
            const addNewButton = document.querySelector('.add-new-student-btn');
            
            // Always show the Add New Student button if we're on step 2
            if (currentStep === 2) {
                addNewButton.style.display = 'flex';
            }
            
            if (students.length === 0) {
                listContainer.innerHTML = '<div class="no-students">No students added yet</div>';
            } else {
                listContainer.innerHTML = students.map((student, index) => `
                    <div class="student-card">
                        <div class="student-info">
                            ${student.photoUrl ? 
                                `<div class="student-photo" style="background-image: url('${student.photoUrl}')"></div>` 
                                : '<div class="student-photo"></div>'}
                            <div class="student-details">
                                <h4>${student.firstName} ${student.lastName}</h4>
                                <p>Age: ${student.age} | Level: ${student.skillLevel}</p>
                                ${student.classes && student.classes.length > 0 ? `
                                    <div class="selected-classes">
                                        ${student.classes.map(classObj => 
                                            `<span class="class-tag">${classObj.ClassName}</span>`
                                        ).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="student-actions">
                            <button class="edit-button" onclick="editStudent(${index})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="delete-button" onclick="deleteStudent(${index})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            ${currentStep !== 2 ? `
                                <button class="register-button" onclick="showClassModal(${index})">
                                    Register for Classes
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        function editStudent(index) {
            currentEditIndex = index;
            const student = students[index];
            const modal = document.getElementById('editStudentModal');
            
            // Fill the form with student data
            document.getElementById('editStudentFirstName').value = student.firstName;
            document.getElementById('editStudentLastName').value = student.lastName;
            document.getElementById('editStudentBirthday').value = student.birthday;
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editMedicalInfo').value = student.medicalInfo || '';
            document.getElementById('editSkillLevel').value = student.skillLevel;
            
            // Set photo preview if exists
            const editPhotoPreview = document.getElementById('editPhotoPreview');
            if (student.photoUrl) {
                editPhotoPreview.style.backgroundImage = `url('${student.photoUrl}')`;
                editPhotoPreview.innerHTML = `<div class="remove-photo" onclick="removePhoto('editPhotoPreview')">Ã—</div>`;
            } else {
                editPhotoPreview.style.backgroundImage = '';
                editPhotoPreview.innerHTML = '';
            }

            modal.classList.add('show');
        }

        function closeEditModal() {
            const modal = document.getElementById('editStudentModal');
            modal.classList.remove('show');  // Remove the show class
            currentEditIndex = -1;
        }

        function saveEditedStudent() {
            if (currentEditIndex === -1) return;

            const firstName = document.getElementById('editStudentFirstName').value;
            const lastName = document.getElementById('editStudentLastName').value;
            const birthday = document.getElementById('editStudentBirthday').value;
            const gender = document.getElementById('editStudentGender').value;
            const medicalInfo = document.getElementById('editMedicalInfo').value;
            const skillLevel = document.getElementById('editSkillLevel').value;
            const photoPreview = document.getElementById('editPhotoPreview').style.backgroundImage;
            const photoUrl = photoPreview ? photoPreview.slice(5, -2) : '';

            if (!firstName || !lastName || !birthday || !skillLevel) {
                alert('Please fill in all required fields');
                return;
            }

            // Update the student data
            students[currentEditIndex] = {
                firstName,
                lastName,
                birthday,
                age: calculateAge(birthday),
                gender,
                medicalInfo,
                skillLevel,
                photoUrl
            };

            updateStudentsList();
            closeEditModal();
        }

        // Add photo preview functionality for edit modal
        document.getElementById('editStudentPhoto').addEventListener('change', function(e) {
            updatePhotoPreview('editPhotoPreview', e.target.files[0]);
        });

        // Add event listener for the close button
        document.querySelector('.close').addEventListener('click', closeEditModal);

        // Close modal if clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editStudentModal');
            if (event.target === modal) {
                closeEditModal();
            }
        });

        function deleteStudent(index) {
            if (confirm('Are you sure you want to remove this student?')) {
                students.splice(index, 1);
                updateStudentsList();
            }
        }

        // Update the goToStep3 function with better validation
        function goToStep3() {
            clearValidationErrors();

            if (students.length === 0) {
                alert('Please add at least one student before proceeding');
                return false;
            }

            let hasErrors = false;
            students.forEach((student, index) => {
                const errors = validateStudent(student);
                if (errors.length > 0) {
                    hasErrors = true;
                    const studentCard = document.querySelector(`[data-student-index="${index}"]`);
                    if (studentCard) {
                        showError(studentCard, `Please complete all required fields for ${student.firstName || 'this student'}: ${errors.join(', ')}`);
                    }
                }
            });

            if (hasErrors) {
                return false;
            }

            hideAllSteps();
            document.getElementById('step3').style.display = 'block';
            updateProgressSteps(3);
            updateStudentClassList();
            return true;
        }

        // Update the goToStep4 function to be async
        async function goToStep4() {
            // Validate class selections first
            const studentsList = document.getElementById('studentClassList').children;
            for (let student of studentsList) {
                const selectedClasses = student.querySelector('.selected-classes');
                if (!selectedClasses || selectedClasses.children.length === 0) {
                    const studentName = student.querySelector('.student-details h3').textContent;
                    alert(`Please select at least one class for ${studentName} before proceeding`);
                    return;
                }
            }

            try {
                // Fetch and display policies
                const policies = await fetchStudioPolicies();
                console.log('Fetched policies in goToStep4:', policies); // Debug log
                
                if (!policies || policies.length === 0) {
                    console.warn('No policies found or policies array is empty');
                }
                
                updatePoliciesContent(policies);
                
                // Continue with step navigation
                hideAllSteps();
                document.getElementById('step4').style.display = 'block';
                updateProgressSteps(4);
                updateWaiverStudentList();
            } catch (error) {
                console.error('Error loading policies:', error);
                alert('Error loading policies. Please try again.');
            }
        }

        function goToStep5() {
            // Check if all policy checkboxes are checked
            const policyCheckboxes = document.querySelectorAll('#policyCheckboxes input[type="checkbox"]');
            const allPoliciesAccepted = Array.from(policyCheckboxes).every(checkbox => checkbox.checked);
            
            if (!allPoliciesAccepted || !document.getElementById('electronicSignatureAccept').checked) {
                alert('Please accept all policies and provide electronic signature consent');
                return;
            }
            
            hideAllSteps();
            document.getElementById('step5').style.display = 'block';
            updateProgressSteps(5);
            updateRegistrationSummary();
        }

        function hasSelectedClasses() {
            const selectedClasses = document.querySelectorAll('input[name="danceClass"]:checked');
            return selectedClasses.length > 0;
        }

        function updateWaiverStudentList() {
            const waiverListContainer = document.getElementById('waiverStudentList');
            if (students.length === 0) {
                waiverListContainer.innerHTML = '<div class="no-students">No students added</div>';
                return;
            }

            waiverListContainer.innerHTML = students.map(student => 
                `<div class="waiver-student-name">${student.firstName} ${student.lastName}</div>`
            ).join('');
        }


// Add this function to fetch all studio discounts
async function fetchStudioDiscounts() {
    try {
        console.log('Fetching studio discounts...');
        const discountsSnapshot = await firebase.firestore()
            .collection('Studios')
            .doc(studioId)
            .collection('Discounts')
            .where('IsActive', '==', true)
            .get();
        
        if (discountsSnapshot.empty) {
            console.log('No active discounts found');
            return [];
        }
        
        const discounts = discountsSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        console.log(`Found ${discounts.length} active discounts:`, discounts);
        return discounts;
    } catch (error) {
        console.error('Error fetching discounts:', error);
        return [];
    }
}

// Add this variable to track applied promo codes
window.appliedPromoCodes = [];

// Add this function to calculate applicable discounts
function calculateStudentDiscounts(student, allDiscounts, appliedPromoCodes = []) {
    // Initialize discounts object if not exists
    if (!student.discounts) student.discounts = { total: 0 };
    
    let totalDiscount = 0;
    const appliedDiscounts = [];
    
    // Process discounts for each class the student is registered for
    student.classes?.forEach(classObj => {
        // Class-specific discounts
        const classDiscounts = allDiscounts.filter(discount => 
            discount.AssociationType === 'Class' && 
            discount.AssociationItemId === classObj.Id
        );
        
        // Season-specific discounts
        const seasonDiscounts = classObj.SeasonId ? allDiscounts.filter(discount => 
            discount.AssociationType === 'Season' && 
            discount.AssociationItemId === classObj.SeasonId
        ) : [];
        
        // Calculate class tuition for percentage discounts
        const classTuition = classObj.FeeAmount || 0;
        
        // Apply class discounts
        classDiscounts.forEach(discount => {
            let discountAmount = 0;
            
            if (discount.DiscountType === 'Percentage') {
                discountAmount = (classTuition * discount.Amount) / 100;
            } else { // Fixed amount
                discountAmount = discount.Amount;
            }
            
            totalDiscount += discountAmount;
            appliedDiscounts.push({
                name: discount.Name,
                type: 'Class',
                className: classObj.ClassName,
                amount: discountAmount,
                originalDiscount: discount
            });
            
            console.log(`Applied class discount: ${discount.Name} - $${discountAmount.toFixed(2)} to ${classObj.ClassName}`);
        });
        
        // Apply season discounts
        seasonDiscounts.forEach(discount => {
            let discountAmount = 0;
            
            if (discount.DiscountType === 'Percentage') {
                discountAmount = (classTuition * discount.Amount) / 100;
            } else { // Fixed amount
                discountAmount = discount.Amount;
            }
            
            totalDiscount += discountAmount;
            appliedDiscounts.push({
                name: discount.Name,
                type: 'Season',
                className: classObj.ClassName,
                amount: discountAmount,
                originalDiscount: discount
            });
            
            console.log(`Applied season discount: ${discount.Name} - $${discountAmount.toFixed(2)} to ${classObj.ClassName}`);
        });
    });
    
    // Process promo code discounts
    if (appliedPromoCodes.length > 0) {
        // Get promo code discounts
        const promoDiscounts = allDiscounts.filter(discount => 
            discount.AssociationType === 'Code' && 
            appliedPromoCodes.includes(discount.DiscountCode)
        );
        
        // Calculate total student tuition for percentage discounts
        const studentTuition = calculateRatePlanTuition(student) + getStudentClassFees(student);
        
        promoDiscounts.forEach(discount => {
            let discountAmount = 0;
            
            if (discount.DiscountType === 'Percentage') {
                discountAmount = (studentTuition * discount.Amount) / 100;
            } else { // Fixed amount
                discountAmount = discount.Amount;
            }
            
            totalDiscount += discountAmount;
            appliedDiscounts.push({
                name: discount.Name,
                type: 'PromoCode',
                code: discount.DiscountCode,
                amount: discountAmount,
                originalDiscount: discount
            });
            
            console.log(`Applied promo code discount: ${discount.Name} - $${discountAmount.toFixed(2)}`);
        });
    }
    
    // Store applied discounts and total
    student.discounts.items = appliedDiscounts;
    student.discounts.total = totalDiscount;
    
    console.log(`Total discounts for ${student.firstName} ${student.lastName}: $${totalDiscount.toFixed(2)}`);
    return totalDiscount;

    
}

// After your calculateStudentDiscounts function and before getAllRelevantFees function

// Add promo code toggle functionality
function initializePromoCodeSection() {
    const toggleEl = document.querySelector('.promo-code-toggle');
    const formEl = document.querySelector('.promo-code-form');
    
    if (toggleEl && formEl) {
        toggleEl.addEventListener('click', function() {
            formEl.classList.toggle('show');
            const icon = this.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
        });
    }
    
    // Add event listener for the apply button
    const applyBtn = document.getElementById('applyPromoButton');
    if (applyBtn) {
        applyBtn.addEventListener('click', applyPromoCode);
    }
    
    // Add event listener for Enter key
    const promoInput = document.getElementById('promoCodeInput');
    if (promoInput) {
        promoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyPromoCode();
                e.preventDefault();
            }
        });
    }
}

// Add this function to handle applying promo codes
async function applyPromoCode() {
    const promoInput = document.getElementById('promoCodeInput');
    const messageEl = document.getElementById('promoMessage');
    const promoCode = promoInput.value.trim().toUpperCase();
    
    // Clear previous messages
    messageEl.textContent = '';
    messageEl.className = '';
    
    if (!promoCode) {
        messageEl.textContent = 'Please enter a promo code';
        messageEl.classList.add('error');
        return;
    }
    
    // Check if already applied
    if (window.appliedPromoCodes.includes(promoCode)) {
        messageEl.textContent = 'This promo code has already been applied';
        messageEl.classList.add('error');
        return;
    }
    
    try {
        // Fetch all discounts to see if the code exists
        const discounts = await fetchStudioDiscounts();
        const validPromoCode = discounts.find(d => 
            d.AssociationType === 'Code' && 
            d.DiscountCode && 
            d.DiscountCode.toUpperCase() === promoCode
        );
        
        if (!validPromoCode) {
            messageEl.textContent = 'Invalid promo code';
            messageEl.classList.add('error');
            return;
        }
        
        // Add to applied promo codes
        window.appliedPromoCodes.push(promoCode);
        
        // Clear input
        promoInput.value = '';
        
        // Show success message
        messageEl.textContent = `Promo code "${promoCode}" applied successfully!`;
        messageEl.classList.add('success');
        
        // Update registration summary with the new discount
        await updateRegistrationSummary();
        
    } catch (error) {
        console.error('Error applying promo code:', error);
        messageEl.textContent = 'Error applying promo code. Please try again.';
        messageEl.classList.add('error');
    }
}


        // Add this function to fetch all relevant fees
async function getAllRelevantFees(students) {
    try {
        // Get all class IDs and season IDs from the students' classes
        const relevantIds = new Set();
        students.forEach(student => {
            if (student.classes) {
                student.classes.forEach(classObj => {
                    relevantIds.add(classObj.Id);
                    if (classObj.SeasonId) {
                        relevantIds.add(classObj.SeasonId);
                    }
                });
            }
        });

        // If no relevant IDs, return empty array
        if (relevantIds.size === 0) {
            return [];
        }

        // Query Firestore for fees
        const feesRef = firebase.firestore()
            .collection('Studios')
            .doc(studioId)
            .collection('Fees');
            
        const feesSnapshot = await feesRef
            .where('IsActive', '==', true)
            .where('AssociationItemId', 'in', Array.from(relevantIds))
            .get();

        // Map the fees data
        const fees = feesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        console.log('Fetched fees:', fees);
        return fees;

    } catch (error) {
        console.error('Error fetching fees:', error);
        return [];
    }
}

        
     // Replace the existing updateRegistrationSummary function
async function updateRegistrationSummary() {
    const summaryContainer = document.getElementById('registrationSummary');
    if (!summaryContainer) return;

    // Fetch relevant fees first
    const relevantFees = await getAllRelevantFees(students);
    console.log('Using these relevant fees for registration calculations:', relevantFees);

    let summaryHTML = '';
    
    // Calculate the complete student totals including all fees
    const studentTotals = students.map(student => calculateStudentTotal(student, relevantFees));
    // Sum up all student totals for the actual total
    const actualTotalAmount = studentTotals.reduce((sum, total) => sum + total, 0);
    console.log('Calculated student totals:', studentTotals);
    console.log('Actual total amount (including all fees):', actualTotalAmount);

    students.forEach(student => {
        // Calculate age if not already set
        let studentAge = student.age;
        if (!studentAge && student.birthday) {
            studentAge = calculateAge(student.birthday);
        }
        
        // Create student section
        summaryHTML += `
            <div class="student-summary">
                <h3>${student.firstName} ${student.lastName}</h3>
                <p>Age: ${studentAge || 'N/A'} | Level: ${student.skillLevel || 'N/A'}</p>
                <div class="selected-classes-summary">
        `;

        // Add each class with day, time, and tuition information
        if (student.classes && student.classes.length > 0) {
            student.classes.forEach(classObj => {
                // Format the days
                let classDays = '';
                if (Array.isArray(classObj.Days)) {
                    classDays = classObj.Days.map(day => formatDayName(day)).join(', ');
                } else if (typeof classObj.Days === 'string') {
                    classDays = formatDayName(classObj.Days);
                }

                // Calculate individual class tuition (if available)
                let classTuition = "â€”";
                if (classObj.RatePlanId && ratePlans[classObj.RatePlanId]) {
                    const hours = classObj.Duration / 60;
                    const firstRate = ratePlans[classObj.RatePlanId].HourRates[0];
                    if (firstRate) {
                        classTuition = `$${firstRate.Rate / student.classes.length}`;
                    }
                }

                summaryHTML += `
                    <div class="class-item">
                        <div class="class-details">
                            <div class="class-name">${classObj.ClassName}</div>
                            <div class="class-schedule">
                                ${classDays} (${formatTime(classObj.StartTime)} - ${formatTime(classObj.EndTime)})
                            </div>
                        </div>
                        <div class="class-tuition">
                            ${classTuition}
                        </div>
                    </div>
                `;
            });

            // Add fees section
            summaryHTML += `
                <div class="fees-section">
                    <div class="fee-item">
                        <span>Tuition Rate:</span>
                        <span>$${(calculateRatePlanTuition(student)).toFixed(2)}</span>
                    </div>`;

            // Add class fees as a separate line item if they exist
            if (getStudentClassFees(student) > 0) {
                summaryHTML += `
                    <div class="fee-item">
                        <span>Class Fees:</span>
                        <span>$${getStudentClassFees(student).toFixed(2)}</span>
                    </div>`;
            }

            // Add the relevant fees we fetched
            if (relevantFees && relevantFees.length > 0) {
                relevantFees.forEach(fee => {
                    // Only show fee if it's associated with one of the student's classes
                    const isRelevantForStudent = student.classes.some(cls => 
                        fee.AssociationItemId === cls.Id || 
                        (cls.SeasonId && fee.AssociationItemId === cls.SeasonId)
                    );

                    if (isRelevantForStudent) {
                        summaryHTML += `
                            <div class="fee-item">
                                <span>${fee.Name}:</span>
                                ${fee.FeeType === 'Recurring' ? 
                                    `<span>(${fee.Frequency} for ${fee.Duration} months)</span>` : 
                                    fee.FeeType === 'BrokenUp' ? 
                                    `<span>(${fee.BrokenUpCount} payments)</span>` : 
                                    ''}
                                <span>$${parseFloat(fee.Amount).toFixed(2)}</span>
                            </div>`;
                    }
                });
            }

            summaryHTML += `
                </div>
                <div class="student-total">
                    <span>Student Total:</span>
                    <span class="amount">$${calculateStudentTotal(student, relevantFees).toFixed(2)}</span>
                </div>
            `;
        } else {
            summaryHTML += `<p>No classes selected</p>`;
        }

        summaryHTML += `
                </div>
            </div>
        `;
    });
    // Calculate surcharge if available
    let surchargeAmount = 0;
    let surchargeHTML = '';
    
    try {
        const surchargeRef = await firebase.firestore()
            .collection('Studios')
            .doc(studioId)
            .collection('Surcharge')
            .doc('SurchargeSettings')
            .get();
        
        if (surchargeRef.exists) {
            const surchargeData = surchargeRef.data();
            
            // Store the surcharge data globally
            window.surchargeData = {
                IsActive: surchargeData.IsActive,
                Type: surchargeData.Type,
                Amount: surchargeData.Value,  // Map Value to Amount for consistency
                Minimum: surchargeData.Minimum,
                Maximum: surchargeData.Maximum
            };
            
            if (surchargeData.IsActive) {
                if (surchargeData.Type === 'percentage') {
                    surchargeAmount = actualTotalAmount * (surchargeData.Value / 100);
                } else if (surchargeData.Type === 'amount') {
                    surchargeAmount = parseFloat(surchargeData.Value);
                }
                
                // Store the calculated amount globally
                window.surchargeAmount = surchargeAmount;
                
                surchargeHTML = `
                    <div class="fee-item surcharge-fee">
                        <span>${surchargeData.Name || 'Processing Fee'}:</span>
                        <span>$${surchargeAmount.toFixed(2)}</span>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error fetching surcharge data:', error);
    }

    // Apply StudentFamilyMax limits
    const { familyTotal: adjustedTotalTuition } = 
        applyStudentFamilyMaxLimits(studentTotals, actualTotalAmount);
    
    // Add surcharge to the total
    const grandTotal = adjustedTotalTuition + surchargeAmount;

    // Add the surcharge summary section
    summaryHTML += `
        <div class="final-summary">
            <div class="fee-item">
                <span>Subtotal:</span>
                <span>$${adjustedTotalTuition.toFixed(2)}</span>
            </div>
            ${surchargeHTML}
            <div class="promo-code-section">
                <div class="promo-code-toggle">
                    <span>Have a promo code?</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="promo-code-form">
                    <div class="promo-input-group">
                        <input type="text" id="promoCodeInput" placeholder="Enter promo code">
                        <button id="applyPromoButton" type="button">Apply</button>
                    </div>
                    <div id="promoMessage"></div>
                </div>
            </div>
            <div class="fee-item promo-discount" id="promoDiscountRow" style="display: none;">
                <span>Discount:</span>
                <span id="promoDiscountAmount">-$0.00</span>
            </div>
            <div class="fee-item grand-total">
                <span>Total:</span>
                <span id="grandTotalWithPromo">$${grandTotal.toFixed(2)}</span>
            </div>
        </div>
    `;

    // Update the container
    summaryContainer.innerHTML = summaryHTML;

    // Initialize promo code section
    initializePromoCodeSection();
    
    
    // Update the total amount display
    document.getElementById('totalAmount').textContent = grandTotal.toFixed(2);
    
    // Set up promo code toggle functionality
    setTimeout(() => {
        const promoToggle = document.querySelector('.promo-code-toggle');
        const promoForm = document.querySelector('.promo-code-form');
        const applyButton = document.getElementById('applyPromoButton');
        const promoInput = document.getElementById('promoCodeInput');
        const promoMessage = document.getElementById('promoMessage');
        const promoDiscountRow = document.getElementById('promoDiscountRow');
        const promoDiscountAmount = document.getElementById('promoDiscountAmount');
        const grandTotalWithPromo = document.getElementById('grandTotalWithPromo');
        
        // Store the original total for calculations
        let currentGrandTotal = grandTotal;
        let appliedDiscount = 0;
        
        if (promoToggle) {
            promoToggle.addEventListener('click', () => {
                promoForm.classList.toggle('show');
                promoToggle.classList.toggle('active');
            });
        }
        
        if (applyButton) {
            applyButton.addEventListener('click', async () => {
                const promoCode = promoInput.value.trim();
                if (!promoCode) {
                    promoMessage.textContent = "Please enter a promo code";
                    promoMessage.className = "promo-error";
                    return;
                }
                
                // Show loading state
                applyButton.disabled = true;
                applyButton.innerHTML = '<span class="spinner"></span> Applying...';
                
                try {
                    // Check if promo code exists in Firestore
                    const promoRef = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('PromoCodes')
                        .doc(promoCode)
                        .get();
                        
                    if (promoRef.exists) {
                        const promoData = promoRef.data();
                        
                        // Check if promo code is active
                        if (promoData.isActive) {
                            // Calculate discount
                            let discountAmount = 0;
                            
                            if (promoData.type === 'percentage') {
                                discountAmount = currentGrandTotal * (promoData.value / 100);
                            } else if (promoData.type === 'fixed') {
                                discountAmount = Math.min(parseFloat(promoData.value), currentGrandTotal);
                            }
                            
                            // Apply discount
                            appliedDiscount = discountAmount;
                            const newTotal = grandTotal - discountAmount;
                            
                            // Update UI
                            promoDiscountAmount.textContent = `-$${discountAmount.toFixed(2)}`;
                            promoDiscountRow.style.display = 'flex';
                            grandTotalWithPromo.textContent = `$${newTotal.toFixed(2)}`;
                            document.getElementById('totalAmount').textContent = newTotal.toFixed(2);
                            
                            promoMessage.textContent = "Promo code applied successfully!";
                            promoMessage.className = "promo-success";
                            
                            // Disable input and button after successful application
                            promoInput.disabled = true;
                            applyButton.textContent = "Applied";
                            applyButton.disabled = true;
                            
                        } else {
                            promoMessage.textContent = "This promo code has expired";
                            promoMessage.className = "promo-error";
                        }
                    } else {
                        promoMessage.textContent = "Invalid promo code";
                        promoMessage.className = "promo-error";
                    }
                } catch (error) {
                    console.error("Error applying promo code:", error);
                    promoMessage.textContent = "Error applying promo code";
                    promoMessage.className = "promo-error";
                } finally {
                    // Reset button state
                    applyButton.disabled = false;
                    applyButton.textContent = "Apply";
                }
            });
        }
    }, 100);
}

        // Add this helper function to calculate student total including relevant fees
        function calculateStudentTotal(student, relevantFees) {
            let total = calculateRatePlanTuition(student) + getStudentClassFees(student);
            
            // Add relevant fees
            if (relevantFees && relevantFees.length > 0) {
                relevantFees.forEach(fee => {
                    const isRelevantForStudent = student.classes.some(cls => 
                        fee.AssociationItemId === cls.Id || 
                        (cls.SeasonId && fee.AssociationItemId === cls.SeasonId)
                    );

                    if (isRelevantForStudent) {
                        if (fee.FeeType === 'OneTime') {
                            total += parseFloat(fee.Amount);
                        } else if (fee.FeeType === 'Recurring') {
                            // Only add a single month's fee amount, not the total for all months
                            total += parseFloat(fee.Amount);
                        } else if (fee.FeeType === 'BrokenUp') {
                            // Use total broken up amount instead of single payment
                            total += parseFloat(fee.BrokenUpAmount);
                        }
                    }
                });
            }
            
            return total;
        }

        // Helper function to format day abbreviations to full names
        function formatDayName(dayAbbr) {
            if (!dayAbbr) return '';
            
            const dayMap = {
                'mon': 'Monday',
                'tue': 'Tuesday',
                'wed': 'Wednesday',
                'thu': 'Thursday',
                'thur': 'Thursday',
                'thurs': 'Thursday',
                'fri': 'Friday',
                'sat': 'Saturday',
                'sun': 'Sunday'
            };
            
            // Try to match the abbreviation regardless of case
            const lowerDay = dayAbbr.toLowerCase();
            return dayMap[lowerDay] || dayAbbr; // Return original if no match found
        }

        // Helper function to calculate just the rate plan portion of tuition
        function calculateRatePlanTuition(student) {
            if (!student.classes || student.classes.length === 0) {
                return 0;
            }
            
            // Group classes by rate plan
            const hoursByRatePlan = {};
            const classesByRatePlan = {};
            
            student.classes.forEach(classInfo => {
                const hours = classInfo.Duration / 60; // Convert minutes to hours
                const ratePlanId = classInfo.RatePlanId;
                
                if (!hoursByRatePlan[ratePlanId]) {
                    hoursByRatePlan[ratePlanId] = 0;
                    classesByRatePlan[ratePlanId] = [];
                }
                
                hoursByRatePlan[ratePlanId] += hours;
                classesByRatePlan[ratePlanId].push(classInfo);
            });

            // Calculate cost for each rate plan
            let tuitionFromRatePlans = 0;
            
            Object.entries(hoursByRatePlan).forEach(([ratePlanId, totalHours]) => {
                const ratePlan = ratePlans[ratePlanId];
                if (ratePlan) {
                    const cost = calculateRatePlanCost(ratePlan, totalHours);
                    tuitionFromRatePlans += cost;
                }
            });
            
            return tuitionFromRatePlans;
        }

        // Helper function to calculate just the class fees portion
        function getStudentClassFees(student) {
            if (!student.classes || student.classes.length === 0) {
                return 0;
            }
            
            let classFees = 0;
            
            student.classes.forEach(classInfo => {
                // Check both camel case and Pascal case versions of the fields
                const feeAmount = classInfo.FeeAmount || classInfo.feeAmount;
                const feeType = classInfo.FeeType || classInfo.feeType;
                
                // Calculate class fees if present
                if (feeAmount && feeType) {
                    switch (feeType) {
                        case 'OneTime':
                        case 'BrokenUP':
                        case 'Recurring':
                            classFees += Number(feeAmount);
                            break;
                    }
                }
            });
            
            return classFees;
        }

        // Add this helper function to convert military time to AM/PM
        function formatTime(militaryTime) {
            if (!militaryTime) return '';
            
            const [hours, minutes] = militaryTime.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const standardHour = hour % 12 || 12;
            
            return `${standardHour}:${minutes} ${ampm}`;
        }

         // Helper function to apply StudentFamilyMax limits
        function applyStudentFamilyMaxLimits(studentTuitions, familyTotal) {
            console.log('StudentFamilyMax check: Starting limit verification');
            
            if (!studentFamilyMax) {
                console.log('StudentFamilyMax check: No limits configured, skipping');
                return { studentTuitions, familyTotal };
            }
            
            const studentMax = studentFamilyMax.StudentMax || 0;
            const familyMax = studentFamilyMax.FamilyMax || 0;
            
            console.log(`StudentFamilyMax check: Limits configured - Student: $${studentMax}, Family: $${familyMax}`);
            
            // Calculate tuition from rate plans only for each student
            const ratePlanTuitions = {};
            let totalRatePlanTuition = 0;
            
            students.forEach((student, index) => {
                // Only use the rate plan portion of tuition
                const tuitionFromRatePlans = calculateRatePlanTuition(student);
                ratePlanTuitions[index] = tuitionFromRatePlans;
                totalRatePlanTuition += tuitionFromRatePlans;
                
                console.log(`StudentFamilyMax check: Student ${index} rate plan tuition: $${tuitionFromRatePlans}`);
            });
            
            // Apply student-level max if configured
            if (studentMax > 0) {
                const adjustedRatePlanTuitions = {};
                
                Object.entries(ratePlanTuitions).forEach(([studentId, tuition]) => {
                    if (tuition > studentMax) {
                        console.log(`StudentFamilyMax check: Student ${studentId} tuition ($${tuition}) exceeds max ($${studentMax}), capping at max`);
                        adjustedRatePlanTuitions[studentId] = studentMax;
                    } else {
                        console.log(`StudentFamilyMax check: Student ${studentId} tuition ($${tuition}) is under max ($${studentMax})`);
                        adjustedRatePlanTuitions[studentId] = tuition;
                    }
                });
                
                // Recalculate family total after applying student caps
                let adjustedFamilyRatePlanTotal = Object.values(adjustedRatePlanTuitions).reduce((sum, tuition) => sum + tuition, 0);
                
                // Apply family-level max if configured
                if (familyMax > 0 && adjustedFamilyRatePlanTotal > familyMax) {
                    console.log(`StudentFamilyMax check: Family total rate plan tuition ($${adjustedFamilyRatePlanTotal}) exceeds max ($${familyMax}), capping at max`);
                    adjustedFamilyRatePlanTotal = familyMax;
                } else if (familyMax > 0) {
                    console.log(`StudentFamilyMax check: Family total rate plan tuition ($${adjustedFamilyRatePlanTotal}) is under max ($${familyMax})`);
                }
                
                // Calculate the difference between original and adjusted tuition
                const tuitionReduction = totalRatePlanTuition - adjustedFamilyRatePlanTotal;
                console.log(`StudentFamilyMax check: Tuition reduction from caps: $${tuitionReduction}`);
                
                // Apply the reduction to the total tuition (including fees)
                const adjustedTotalTuition = Math.max(0, familyTotal - tuitionReduction);
                
                return { 
                    studentTuitions: ratePlanTuitions, // Return original student tuitions for reference
                    familyTotal: adjustedTotalTuition  // Return adjusted total with reduction applied
                };
            } 
            // Only apply family-level max if student max not configured
            else if (familyMax > 0 && totalRatePlanTuition > familyMax) {
                console.log(`StudentFamilyMax check: Family total rate plan tuition ($${totalRatePlanTuition}) exceeds max ($${familyMax}), capping at max`);
                
                // Calculate the difference between original and adjusted tuition
                const tuitionReduction = totalRatePlanTuition - familyMax;
                console.log(`StudentFamilyMax check: Tuition reduction from family cap: $${tuitionReduction}`);
                
                // Apply the reduction to the total tuition (including fees)
                const adjustedTotalTuition = Math.max(0, familyTotal - tuitionReduction);
                
                return { 
                    studentTuitions: ratePlanTuitions, 
                    familyTotal: adjustedTotalTuition 
                };
            } else if (familyMax > 0) {
                console.log(`StudentFamilyMax check: Family total rate plan tuition ($${totalRatePlanTuition}) is under max ($${familyMax})`);
            }
            
            return { studentTuitions: ratePlanTuitions, familyTotal: familyTotal };
        }

        // Add these helper functions
        function getEmergencyContacts() {
            const contacts = [];
            document.querySelectorAll('.emergency-contact-row').forEach(row => {
                const nameInput = row.querySelector('.emergency-name');
                const phoneInput = row.querySelector('.emergency-phone');
                if (nameInput && nameInput.value.trim() && phoneInput && phoneInput.value.trim()) {
                    contacts.push({
                        Name: nameInput.value.trim(),
                        Phone: phoneInput.value.trim()
                    });
                }
            });
            return contacts;
        }

        // Add this HTML for the success modal
        function showSuccessModal(familyId) {
            const modal = document.getElementById('successModal');
            const summaryDiv = document.getElementById('registrationSummaryModal');
            
            let summaryHTML = `
                <div class="registration-summary-section">
                    <h3>Family Information</h3>
                    <div class="summary-item">
                        <span>Parent Name:</span>
                        <span>${contactInfo.firstName} ${contactInfo.lastName}</span>
                    </div>
                    <div class="summary-item">
                        <span>Email:</span>
                        <span>${contactInfo.email}</span>
                    </div>
                    <div class="summary-item">
                        <span>Phone:</span>
                        <span>${contactInfo.phone}</span>
                    </div>
                </div>

                <div class="registration-summary-section">
                    <h3>Registered Students</h3>
                    ${students.map(student => {
                        // Format classes properly using ClassName
                        const classNames = student.classes?.map(c => c.ClassName).filter(Boolean).join(', ') || 'None';
                        
                        return `
                            <div class="student-summary">
                                <div class="summary-item">
                                    <span>Student Name:</span>
                                    <span>${student.firstName} ${student.lastName}</span>
                                </div>
                                <div class="summary-item">
                                    <span>Age:</span>
                                    <span>${student.age}</span>
                                </div>
                                <div class="summary-item">
                                    <span>Level:</span>
                                    <span>${student.skillLevel}</span>
                                </div>
                                <div class="summary-item">
                                    <span>Classes:</span>
                                    <span>${classNames}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            summaryDiv.innerHTML = summaryHTML;
            modal.classList.add('show');
        }

        function goToPortalLogin() {
            window.location.href = `/portallogin/${encodeURIComponent(studioData.StudioName)}/${studioId}`;
        }
        // Add this new function to fetch class styles
        async function fetchClassStyles() {
            try {
                console.log('Fetching class styles from ClassStyles subcollection...');
                const classStylesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(window.studioId)
                    .collection('ClassStyles')
                    .get();

                const styles = classStylesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    StyleName: doc.data().StyleName || '',
                    Description: doc.data().Description || ''
                }));

                console.log('Fetched class styles:', styles);
                return styles;
            } catch (error) {
                console.error('Error fetching class styles:', error);
                return [];
            }
        }

        // Add this function to fetch a single class style by ID
        async function fetchClassStyle(styleId) {
            if (!styleId) return null;
            
            try {
                const styleDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('ClassStyles')
                    .doc(styleId)
                    .get();

                if (styleDoc.exists) {
                    return {
                        id: styleDoc.id,
                        ...styleDoc.data()
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching class style:', error);
                return null;
            }
        }

        // Update the populateModalClassGrid function to show more class details
        async function populateModalClassGrid() {
            const classGrid = document.getElementById('modalClassGrid');
            const styleFilter = document.getElementById('modalStyleFilter');
            if (!classGrid) return;
            
            try {
                // If we haven't fetched classes yet, fetch them
                if (!studioClasses || studioClasses.length === 0) {
                    await fetchClasses();
                }

                // Fetch all class styles
                const classStyles = await fetchClassStyles();
                
                // Populate style filter dropdown
                styleFilter.innerHTML = '<option value="all">All Styles</option>';
                classStyles.forEach(style => {
                    styleFilter.innerHTML += `<option value="${style.id}">${style.StyleName}</option>`;
                });
                
                // Clear existing content
                classGrid.innerHTML = '';
                
                // Current student's selected classes
                const currentStudentClasses = students[currentStudentIndex].classes || [];
                
                // Get all classes from the database and create cards
                for (const classData of studioClasses) {
                    // First, check if the class is appropriate for the student's age
                    const student = students[currentStudentIndex];
                    const studentAge = calculateAge(student.birthday);
                    const isAgeAppropriate = !classData.EnforceAgeLimit || 
                        (studentAge >= classData.MinAge && studentAge <= classData.MaxAge);
                    
                    // Skip classes that aren't age appropriate
                    if (!isAgeAppropriate) continue;
                    
                    // Check if this class is already selected
                    const isSelected = currentStudentClasses.some(c => c.Id === classData.Id);
                    
                    // Format days for display
                    let formattedDays = '';
                    if (Array.isArray(classData.Days)) {
                        formattedDays = classData.Days.map(day => formatDayName(day)).join(', ');
                    } else if (typeof classData.Days === 'string') {
                        formattedDays = formatDayName(classData.Days);
                    }

                    // Get class style name - check both StyleId and ClassStyleId fields
                    let styleName = 'N/A';
                    const styleId = classData.ClassStyleId || classData.StyleId;
                    if (styleId) {
                        const style = classStyles.find(s => s.id === styleId);
                        if (style) {
                            styleName = style.StyleName || 'N/A';
                        }
                    }
                    
                    // Create a card for this class
                    const card = document.createElement('div');
                    card.className = `class-card ${isSelected ? 'selected' : ''}`;
                    card.dataset.classId = classData.Id;
                    card.dataset.classType = classData.ClassType || 'Recreational';
                    card.dataset.level = classData.Level || '';
                    card.dataset.style = styleId || '';
                    
                    // Improved handling of days data attribute
                    if (Array.isArray(classData.Days) && classData.Days.length > 0) {
                        // Store the raw day values (mon, tue, wed, etc.)
                        card.dataset.days = classData.Days.join(',');
                    } else if (typeof classData.Days === 'string') {
                        card.dataset.days = classData.Days;
                    } else {
                        card.dataset.days = '';
                    }
                    
                    card.innerHTML = `
                        <h4>${classData.ClassName}</h4>
                        <div class="class-details">
                            <p><strong>Days:</strong> ${formattedDays}</p>
                            <p><strong>Time:</strong> ${formatTime(classData.StartTime)} - ${formatTime(classData.EndTime)}</p>
                            <p><strong>Duration:</strong> ${classData.Duration} minutes</p>
                            <p><strong>Type:</strong> ${classData.ClassType || 'Standard'}</p>
                            <p><strong>Style:</strong> ${styleName}</p>
                            <p><strong>Students:</strong> ${Array.isArray(classData.Students) ? classData.Students.length : 0}${classData.MaxSize ? ' / ' + classData.MaxSize : ''}</p>
                            ${getAvailableSpotsHTML(classData)}
                        </div>
                    `;
                    
                    card.addEventListener('click', () => {
                        toggleModalClass(classData.Id);
                    });
                    
                    classGrid.appendChild(card);
                }
                
            } catch (error) {
                console.error('Error populating class grid:', error);
                classGrid.innerHTML = '<div class="error-message">Error loading classes. Please try again.</div>';
            }
        }

        // Helper function to format time
        function formatTime(time) {
            if (!time) return '';
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Add the filter function
        function filterModalClasses() {
            const searchTerm = document.getElementById('classSearch').value.toLowerCase();
            const typeFilter = document.getElementById('modalClassTypeFilter').value;
            const levelFilter = document.getElementById('modalLevelFilter').value;
            const styleFilter = document.getElementById('modalStyleFilter').value;
            const dayFilter = document.getElementById('modalDayFilter').value;

            document.querySelectorAll('.class-card').forEach(card => {
                const classType = card.getAttribute('data-class-type') || '';
                const classLevel = card.getAttribute('data-level') || '';
                const classStyle = card.getAttribute('data-style') || '';
                const classDays = card.getAttribute('data-days') || '';
                const className = card.querySelector('h4')?.textContent.toLowerCase() || '';

                const matchesSearch = className.includes(searchTerm);
                const matchesType = typeFilter === 'all' || classType === typeFilter;
                const matchesLevel = levelFilter === 'all' || classLevel === levelFilter;
                const matchesStyle = styleFilter === 'all' || classStyle === styleFilter;
                
                // Fix the day matching logic
                const matchesDay = dayFilter === 'all' || 
                                  classDays.split(',').some(day => day.trim() === dayFilter);

                card.style.display = 
                    matchesSearch && matchesType && matchesLevel && matchesStyle && matchesDay ? 'block' : 'none';
            });
        }

        // Add event listener for real-time search
        document.getElementById('classSearch').addEventListener('input', function(e) {
            // Debounce the search to improve performance
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                filterModalClasses();
            }, 300);
        });

        // Add card number formatting
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value;
        });

        // Add expiry date formatting
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0,2) + '/' + value.slice(2);
            }
            e.target.value = value;
        });

        // Initialize the empty students list
        updateStudentsList();

        // Add this function to generate the signature
        async function generateSignature() {
            // Check if we have stored contact info
            if (!contactInfo.firstName || !contactInfo.lastName) {
                alert('Error: Could not find contact information. Please complete Step 1 first.');
                return null;
            }

            const fullName = `${contactInfo.firstName} ${contactInfo.lastName}`;
            const timestamp = new Date().toLocaleString();
            const ip = await getIPAddress();
            
            return {
                name: fullName,
                timestamp: timestamp,
                ip: ip
            };
        }

        // Add this function to check if contact info exists
        function hasContactInfo() {
            return contactInfo.firstName && contactInfo.lastName;
        }

        // Update the electronic signature event listener
        document.getElementById('electronicSignatureAccept').addEventListener('change', async function(e) {
            const signatureDisplay = document.getElementById('generatedSignature').closest('.signature-display');
            
            if (e.target.checked) {
                if (!contactInfo.firstName || !contactInfo.lastName) {
                    alert('Error: Could not find contact information from Step 1');
                    e.target.checked = false;
                    return;
                }

                signatureDisplay.innerHTML = '<div class="signature-loading">Generating signature...</div>';
                
                try {
                    const ip = await getIPAddress();
                    const date = new Date();
                    const formattedDate = date.toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric'
                    });
                    
                    const formattedTime = date.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    const fullName = `${contactInfo.firstName} ${contactInfo.lastName}`;
                    console.log('Generating signature for:', fullName);
                    
                    // Store signature data in a hidden input for later retrieval
                    const signatureData = {
                        SignatureText: fullName,
                        SignatureDate: formattedDate,
                        SignatureTime: formattedTime,
                        SignatureIp: ip,
                        SignatureTimestamp: date.toISOString()
                    };
                    
                    console.log('Signature data:', signatureData);
                    
                    // Create hidden input to store signature data
                    const signatureInput = document.createElement('input');
                    signatureInput.type = 'hidden';
                    signatureInput.id = 'signatureData';
                    signatureInput.value = JSON.stringify(signatureData);
                    document.getElementById('contactForm').appendChild(signatureInput);
                    
                    // Update signature display with cursive font styling and prominent name
                    signatureDisplay.innerHTML = `
                        <p>Electronic Signature:</p>
                        <div class="signature-main" id="generatedSignature">
                            <div class="signature-name">${fullName}</div>
                            <div class="signature-date-time">
                                <span class="signature-date">${formattedDate}</span>
                                <span class="signature-time">${formattedTime}</span>
                            </div>
                            <div class="signature-details">
                                <div class="signature-ip">IP Address: ${ip}</div>
                            </div>
                        </div>
                    `;
                    
                    signatureDisplay.classList.add('show');
                    
                } catch (error) {
                    console.error('Error generating signature:', error);
                    alert('There was an error generating the signature. Please try again.');
                    e.target.checked = false;
                }
            } else {
                signatureDisplay.classList.remove('show');
                // Remove stored signature data
                const signatureInput = document.getElementById('signatureData');
                if (signatureInput) {
                    signatureInput.remove();
                }
            }
        });

        function hideAllSteps() {
            document.querySelectorAll('.step').forEach(step => {
                step.style.display = 'none';
            });
        }

       

        // Add this JavaScript function to update the progress indicator
        function updateProgressSteps(currentStep) {
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index + 1 < currentStep) {
                    indicator.classList.add('completed');
                    indicator.classList.remove('active');
                } else if (index + 1 === currentStep) {
                    indicator.classList.add('active');
                    indicator.classList.remove('completed');
                } else {
                    indicator.classList.remove('completed', 'active');
                }
            });
        }

        // Update the existing navigation functions to include progress updates
        function goToStep1() {
            currentStep = 1;
            hideAllSteps();
            document.getElementById('step1').style.display = 'block';
            updateProgressSteps(1);
        }

        // Replace the existing goToStep2 function with this one
        function goToStep2() {
            // Reset all error states
            clearValidationErrors();

            let hasErrors = false;

            // Required fields validation
            const requiredFields = [
                { id: 'firstName', message: 'Please enter your first name' },
                { id: 'lastName', message: 'Please enter your last name' },
                { id: 'address1', message: 'Please enter your address' },
                { id: 'city', message: 'Please enter your city' },
                { id: 'state', message: 'Please select your state' },
                { id: 'zip', message: 'Please enter your ZIP code' },
                { id: 'phone', message: 'Please enter your phone number' },
                { id: 'email', message: 'Please enter your email address' },
                { id: 'password', message: 'Please enter a password' },
                { id: 'confirmPassword', message: 'Please confirm your password' }
            ];

            // Check each required field
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = element.value.trim();
                
                if (!value) {
                    showError(element, field.message);
                    hasErrors = true;
                }
            });

            // Specific format validations
            const validations = {
                phone: {
                    pattern: /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/,
                    message: 'Please enter a valid phone number (e.g., (123) 456-7890)'
                },
                email: {
                    pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    message: 'Please enter a valid email address'
                },
                zip: {
                    pattern: /^\d{5}(-\d{4})?$/,
                    message: 'Please enter a valid ZIP code (e.g., 12345 or 12345-6789)'
                }
            };

            // Check format validations
            Object.entries(validations).forEach(([fieldId, validation]) => {
                const element = document.getElementById(fieldId);
                const value = element.value.trim();
                
                if (value && !validation.pattern.test(value)) {
                    showError(element, validation.message);
                    hasErrors = true;
                }
            });

            // Password validation
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password) {
                const passwordRequirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[@$!%*?&]/.test(password)
                };

                if (!Object.values(passwordRequirements).every(Boolean)) {
                    showError(document.getElementById('password'), 
                        'Password must contain at least 8 characters, one uppercase letter, one lowercase letter, one number, and one special character');
                    hasErrors = true;
                }

                if (password !== confirmPassword) {
                    showError(document.getElementById('confirmPassword'), 'Passwords do not match');
                    hasErrors = true;
                }
            }

            // Emergency contact validation
            const emergencyContacts = document.querySelectorAll('.emergency-contact-row');
            let hasValidEmergencyContact = false;

            emergencyContacts.forEach(contact => {
                const nameInput = contact.querySelector('.emergency-name');
                const phoneInput = contact.querySelector('.emergency-phone');
                
                if (nameInput.value.trim() && phoneInput.value.trim()) {
                    hasValidEmergencyContact = true;
                }
            });

            if (!hasValidEmergencyContact) {
                const firstEmergencyContact = emergencyContacts[0];
                showError(firstEmergencyContact.querySelector('.emergency-name'), 
                    'Please provide at least one emergency contact');
                showError(firstEmergencyContact.querySelector('.emergency-phone'), 
                    'Please provide a valid phone number');
                hasErrors = true;
            }

            if (hasErrors) {
                // Scroll to the first error
                const firstError = document.querySelector('.input-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }

            // If validation passes, store the contact info
            contactInfo = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                address1: document.getElementById('address1').value.trim(),
                address2: document.getElementById('address2').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value,
                zip: document.getElementById('zip').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: password
            };

            // Log to verify storage
            console.log('Contact info stored:', contactInfo);

            // Optionally store in sessionStorage for persistence
            sessionStorage.setItem('contactInfo', JSON.stringify(contactInfo));

            // Proceed to step 2
            hideAllSteps();
            document.getElementById('step2').style.display = 'block';
            currentStep = 2; // Make sure to set current step
            updateProgressSteps(2);
            
            // Show the Add New Student button
            const addNewButton = document.querySelector('.add-new-student-btn');
            addNewButton.style.display = 'flex';
            
            return true;
        }

        // Add these helper functions
        function showError(element, message) {
            element.classList.add('input-error');
            
            // Create or update error message
            let errorDiv = element.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                element.parentNode.insertBefore(errorDiv, element.nextSibling);
            }
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

         // Update the goToStep3 function with better validation
         function goToStep3() {
            clearValidationErrors();

            if (students.length === 0) {
                alert('Please add at least one student before proceeding');
                return false;
            }

            let hasErrors = false;
            students.forEach((student, index) => {
                const errors = validateStudent(student);
                if (errors.length > 0) {
                    hasErrors = true;
                    const studentCard = document.querySelector(`[data-student-index="${index}"]`);
                    if (studentCard) {
                        showError(studentCard, `Please complete all required fields for ${student.firstName || 'this student'}: ${errors.join(', ')}`);
                    }
                }
            });

            if (hasErrors) {
                return false;
            }

            hideAllSteps();
            document.getElementById('step3').style.display = 'block';
            updateProgressSteps(3);
            updateStudentClassList();
            return true;
        }

        function goToStep4() {
            // Get all registered students
            const studentsList = document.getElementById('studentClassList').children;
            
            // Check if each student has at least one class
            for (let student of studentsList) {
                const selectedClasses = student.querySelector('.selected-classes');
                if (!selectedClasses || selectedClasses.children.length === 0) {
                    const studentName = student.querySelector('.student-details h3').textContent;
                    alert(`Please select at least one class for ${studentName} before proceeding`);
                    return;
                }
            }

            hideAllSteps();
            document.getElementById('step4').style.display = 'block';
            updateProgressSteps(4);
            updateWaiverStudentList();
        }

        function goToStep5() {
            if (!document.getElementById('termsAccept').checked || 
                !document.getElementById('electronicSignatureAccept').checked) {
                alert('Please accept the terms and conditions and provide electronic signature consent');
                return;
            }
            hideAllSteps();
            document.getElementById('step5').style.display = 'block';
            updateProgressSteps(5);
            updateRegistrationSummary();
        }

        // Initialize the progress indicator
        updateProgressSteps(1);

        function addEmergencyContact() {
            const container = document.getElementById('emergencyContacts');
            const newRow = document.createElement('div');
            newRow.className = 'emergency-contact-row';
            newRow.innerHTML = `
                <div class="emergency-contact-inputs">
                    <input type="text" placeholder="Contact Name *" class="emergency-name" required>
                    <input type="tel" placeholder="Contact Phone *" class="emergency-phone" required>
                </div>
                <button type="button" class="add-emergency-contact" onclick="removeEmergencyContact(this)">Ã—</button>
            `;
            container.appendChild(newRow);
        }

        function removeEmergencyContact(button) {
            button.closest('.emergency-contact-row').remove();
        }

        // Add click event listener to prevent form submission when clicking menu
        document.querySelectorAll('.menu-bars').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        document.getElementById('studentPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').style.backgroundImage = `url(${e.target.result})`;
                }
                reader.readAsDataURL(file);
            }
        });

        // Update the photo preview HTML structure
        function updatePhotoPreview(previewId, file) {
            const preview = document.getElementById(previewId);
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.innerHTML = `<div class="remove-photo" onclick="removePhoto('${previewId}')">Ã—</div>`;
                }
                reader.readAsDataURL(file);
            } else {
                preview.style.backgroundImage = '';
                preview.innerHTML = '';
            }
        }

        function removePhoto(previewId) {
            const preview = document.getElementById(previewId);
            preview.style.backgroundImage = '';
            preview.innerHTML = '';
            
            // Clear the file input
            const fileInput = previewId === 'photoPreview' ? 
                document.getElementById('studentPhoto') : 
                document.getElementById('editStudentPhoto');
            fileInput.value = '';
        }

        // Update the event listeners
        document.getElementById('studentPhoto').addEventListener('change', function(e) {
            updatePhotoPreview('photoPreview', e.target.files[0]);
        });

        document.getElementById('editStudentPhoto').addEventListener('change', function(e) {
            updatePhotoPreview('editPhotoPreview', e.target.files[0]);
        });

        function updateStudentClassList() {
            const container = document.getElementById('studentClassList');
            if (students.length === 0) {
                container.innerHTML = '<div class="no-students">No students added yet</div>';
                return;
            }

            container.innerHTML = students.map((student, index) => `
                <div class="student-card">
                    <div class="student-info">
                        ${student.photoUrl ? 
                            `<div class="student-photo" style="background-image: url('${student.photoUrl}')"></div>` 
                            : '<div class="student-photo"></div>'}
                        <div class="student-details">
                            <h4>${student.firstName} ${student.lastName}</h4>
                            <p>Age: ${student.age} | Level: ${student.skillLevel}</p>
                            ${student.classes && student.classes.length > 0 ? `
                                <div class="selected-classes">
                                    ${student.classes.map(classObj => 
                                        `<span class="class-tag">${classObj.ClassName}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="register-button" onclick="showClassModal(${index})">
                            ${student.classes && student.classes.length > 0 ? 'Modify Classes' : 'Register for Classes'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update the showClassModal function to be async
        async function showClassModal(studentIndex) {
            currentStudentIndex = studentIndex;
            const student = students[studentIndex];
            const modal = document.getElementById('classSelectionModal');
            
            document.getElementById('classSelectionStudentName').textContent = 
                `Select Classes for ${student.firstName} ${student.lastName}`;
            
            await populateModalClassGrid();

            // Check for preselected class and select it if not already selected
            const preselectedClassId = localStorage.getItem('preselectedClassId');
            if (preselectedClassId && !student.classes?.some(c => c.Id === preselectedClassId)) {
                toggleModalClass(preselectedClassId);
                // Don't remove preselectedClassId here - keep it for other students
            }
            
            modal.classList.add('show');
        }

        function closeClassModal() {
            document.getElementById('classSelectionModal').classList.remove('show');
            currentStudentIndex = -1;
        }

        // Update the toggleModalClass function to handle preselected classes better
        function toggleModalClass(classId) {
            if (!students[currentStudentIndex].classes) {
                students[currentStudentIndex].classes = [];
            }
            
            const selectedClass = studioClasses.find(c => c.Id === classId);
            
            if (!selectedClass) {
                console.error('Class not found:', classId);
                alert('Sorry, this class is no longer available.');
                return;
            }

            const classIndex = students[currentStudentIndex].classes.findIndex(c => c.Id === classId);

            if (classIndex === -1) {
                // Extract fee information from the Fee array if it exists
                let feeAmount, feeType, breakUpDuration, breakUpFrequency, recurringFrequency, recurringDuration;
                
                if (selectedClass.Fee && selectedClass.Fee.length > 0) {
                    const feeInfo = selectedClass.Fee[0]; // Use the first fee in the array
                    feeAmount = feeInfo.FeeAmount;
                    feeType = feeInfo.FeeType;
                    breakUpDuration = feeInfo.BreakUpDuration;
                    breakUpFrequency = feeInfo.BreakUpFrequency;
                    recurringFrequency = feeInfo.RecurringFrequency;
                    recurringDuration = feeInfo.RecurringDuration;
                } else {
                    // Fallback to top-level properties if Fee array doesn't exist
                    feeAmount = selectedClass.FeeAmount;
                    feeType = selectedClass.FeeType;
                    breakUpDuration = selectedClass.BreakUpDuration;
                    breakUpFrequency = selectedClass.BreakUpFrequency;
                    recurringFrequency = selectedClass.RecurringFrequency;
                    recurringDuration = selectedClass.RecurringDuration;
                }
                
                // Add class with extracted fee information
                const classToAdd = {
                    Id: selectedClass.Id,
                    ClassName: selectedClass.ClassName,
                    Days: selectedClass.Days,
                    StartTime: selectedClass.StartTime,
                    EndTime: selectedClass.EndTime,
                    RatePlanId: selectedClass.RatePlanId,
                    Duration: selectedClass.Duration,
                    SeasonId: selectedClass.SeasonId,
                    Fees: selectedClass.Fees,
                    ClassType: selectedClass.ClassType,
                    MaxSize: selectedClass.MaxSize,
                    // Add fee fields from extracted values
                    FeeAmount: feeAmount,
                    FeeType: feeType,
                    RecurringFrequency: recurringFrequency,
                    RecurringDuration: recurringDuration,
                    BreakUpFrequency: breakUpFrequency,
                    BreakUpDuration: breakUpDuration,
                    // Also include the original Fee array for reference
                    Fee: selectedClass.Fee
                };
                
                // Log what we're adding to student's classes
                console.log('Adding class to student with data:', classToAdd);
                
                students[currentStudentIndex].classes.push(classToAdd);
            } else {
                // Remove class (even if it's preselected)
                students[currentStudentIndex].classes.splice(classIndex, 1);
            }
            
            // After updating classes, log what the student has
            console.log('Updated student classes:', students[currentStudentIndex].classes);
            
            calculateStudentTuition(students[currentStudentIndex]);
            populateModalClassGrid();
            updateStudentsList();
        }

        function saveClassSelections() {
            updateStudentClassList();
            closeClassModal();
        }

        // Add this function to get the IP address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error fetching IP:', error);
                return 'IP not available';
            }
        }

        // Add this function to check stored data
        function checkStoredData() {
            // Check contact info
            const hasContactInfo = Object.values(contactInfo).some(value => value !== '');
            if (hasContactInfo) {
                // Populate Step 1 fields with stored data
                Object.keys(contactInfo).forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = contactInfo[field];
                    }
                });
            }

            // Check students
            if (students.length > 0) {
                updateStudentsList();
            }
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchStudioData(); // Fetch and apply studio-specific data
            checkStoredData();
            updateProgressSteps(1);
        });

        // Add this to prevent form submission on enter key
        document.getElementById('contactForm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                return false;
            }
        });

        // Add this function to verify contact info at any point
        function verifyContactInfo() {
            console.log('Current contact info:', contactInfo);
            return contactInfo.firstName && contactInfo.lastName; // returns true if basic info exists
        }

        // Add this function to handle studio-specific login URL
        function updateLoginUrl() {
            if (studioData && studioData.portalId) {
                const loginLink = document.getElementById('studioLoginLink');
                loginLink.href = `/portallogin/${encodeURIComponent(studioData.StudioName)}/${studioData.portalId}`;
            }
        }

        // Function to store form data in session storage
        function storeFormData() {
            sessionStorage.setItem('contactInfo', JSON.stringify(contactInfo));
            sessionStorage.setItem('students', JSON.stringify(students));
        }

        // Function to retrieve stored form data
        function retrieveStoredData() {
            const storedContactInfo = sessionStorage.getItem('contactInfo');
            const storedStudents = sessionStorage.getItem('students');
            
            if (storedContactInfo) {
                contactInfo = JSON.parse(storedContactInfo);
                console.log('Contact info retrieved:', contactInfo);
            }
            
            if (storedStudents) {
                students = JSON.parse(storedStudents);
                console.log('Students info retrieved:', students);
                updateStudentsList();
            }
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            fetchStudioData();
            makeFormControlsFocusable();
            retrieveStoredData();
            updateProgressSteps(1);
        });

        // Update the storeContactInfo function
        function storeContactInfo() {
            // ... existing code ...
            console.log('Contact info stored:', contactInfo);
            storeFormData();
        }

        // Add this just before creating students
        console.log('All students data:', students);
        console.log('Contact info:', contactInfo);
        console.log('Emergency contacts:', getEmergencyContacts());

        // Add this function to update the policies content
        function updatePoliciesContent(policies) {
            const policiesContainer = document.getElementById('policiesContent');
            
            if (!policies || policies.length === 0) {
                policiesContainer.innerHTML = '<p>No policies found.</p>';
                return;
            }
            
            const policiesHTML = policies.map(policy => `
                <div class="policy-section">
                    <h3 class="policy-title">${policy.Title}</h3>
                    <div class="policy-content">
                        ${policy.Content.split('\n').map(paragraph => 
                            paragraph.trim() ? `<p>${paragraph}</p>` : ''
                        ).join('')}
                    </div>
                    <div class="policy-type">
                        Type: ${policy.Type}
                    </div>
                </div>
            `).join('');
            
            policiesContainer.innerHTML = policiesHTML;

            // Create checkboxes for each policy
            createPolicyCheckboxes(policies);
        }
        
        // Call this after fetching policies
        async function initializePolicies() {
            try {
                const policies = await fetchStudioPolicies();
                console.log('Fetched policies:', policies); // Debug log
                updatePoliciesContent(policies);
            } catch (error) {
                console.error('Error initializing policies:', error);
            }
        }

        // Password visibility toggles
        document.getElementById('passwordToggle').addEventListener('click', function() {
            togglePasswordVisibility('password', this);
        });

        document.getElementById('confirmPasswordToggle').addEventListener('click', function() {
            togglePasswordVisibility('confirmPassword', this);
        });

        function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Get studioId first
                studioId = getStudioFromUrl();
                
                if (!studioId) {
                    console.error('No studio ID found');
                    return;
                }

                // Fetch all required data
                await Promise.all([
                    fetchStudioData(),
                    fetchRatePlans(),
                    initializePolicies(),
                    initializeFinancialData() // Add this line
                ]);

                makeFormControlsFocusable();
                retrieveStoredData();
                updateProgressSteps(1);
                
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });

        // Add function to calculate tuition based on rate plans
        function calculateStudentTuition(student) {
            if (!student.classes || student.classes.length === 0) {
                console.log('No classes selected for student:', student.firstName);
                return 0;
            }

            console.log(`\nCalculating tuition for ${student.firstName} ${student.lastName}`);
            console.log('Available Rate Plans:', ratePlans);
            
            // Group classes by rate plan
            const hoursByRatePlan = {};
            const classesByRatePlan = {};
            let classFees = 0; // New variable to track class fees
            
            student.classes.forEach(classInfo => {
                const hours = classInfo.Duration / 60; // Convert minutes to hours
                const ratePlanId = classInfo.RatePlanId;
                
                if (!hoursByRatePlan[ratePlanId]) {
                    hoursByRatePlan[ratePlanId] = 0;
                    classesByRatePlan[ratePlanId] = [];
                }
                
                hoursByRatePlan[ratePlanId] += hours;
                classesByRatePlan[ratePlanId].push(classInfo);
                
                console.log(`\nClass: ${classInfo.ClassName}`);
                console.log(`Time: ${formatTime(classInfo.StartTime)} - ${formatTime(classInfo.EndTime)}`);
                console.log(`Duration: ${classInfo.Duration} minutes (${hours} hours)`);
                console.log(`Rate Plan ID: ${ratePlanId}`);
                
                // Check for fee information in the Fee array first
                let feeAmount, feeType, breakUpDuration, breakUpFrequency, recurringFrequency, recurringDuration;
                
                if (classInfo.Fee && classInfo.Fee.length > 0) {
                    const feeInfo = classInfo.Fee[0]; // Use the first fee in the array
                    feeAmount = feeInfo.FeeAmount;
                    feeType = feeInfo.FeeType;
                    breakUpDuration = feeInfo.BreakUpDuration;
                    breakUpFrequency = feeInfo.BreakUpFrequency;
                    recurringFrequency = feeInfo.RecurringFrequency;
                    recurringDuration = feeInfo.RecurringDuration;
                    
                    console.log('Found fee information in Fee array:', feeInfo);
                } else {
                    // Fallback to top-level properties
                    feeAmount = classInfo.FeeAmount || classInfo.feeAmount;
                    feeType = classInfo.FeeType || classInfo.feeType;
                    breakUpDuration = classInfo.BreakUpDuration || classInfo.breakUpDuration;
                    breakUpFrequency = classInfo.BreakUpFrequency || classInfo.breakUpFrequency;
                    recurringFrequency = classInfo.RecurringFrequency;
                    recurringDuration = classInfo.RecurringDuration;
                }
                
                // Log the class info to see all available properties
                console.log('Class info for fee calculation:', JSON.stringify(classInfo));
                
                // Calculate class fees if present
                if (feeAmount && feeType) {
                    console.log(`Fee Type: ${feeType}, Amount: $${feeAmount}`);
                    
                    switch (feeType) {
                        case 'OneTime':
                            classFees += Number(feeAmount);
                            console.log(`Adding one-time fee: $${feeAmount}`);
                            break;
                        case 'BrokenUp':
                            console.log(`BrokenUp Fee - Frequency: ${breakUpFrequency}, Duration: ${breakUpDuration}`);
                            if (breakUpDuration) {
                                const brokenUpAmount = Number(feeAmount) / breakUpDuration;
                                classFees += brokenUpAmount;
                                console.log(`Adding broken-up fee: $${brokenUpAmount.toFixed(2)} (${feeAmount} / ${breakUpDuration} payments)`);
                            } else {
                                console.warn(`BrokenUp fee found but no BreakUpDuration specified for class ${classInfo.ClassName}`);
                            }
                            break;
                        case 'Recurring':
                            classFees += Number(feeAmount);
                            console.log(`Adding recurring fee: $${feeAmount}, Frequency: ${recurringFrequency}, Duration: ${recurringDuration}`);
                            break;
                        default:
                            console.log(`Unknown fee type: ${feeType}, not adding to total`);
                    }
                } else {
                    console.log('No fee information found for class:', classInfo.ClassName);
                }
            });

            // Calculate cost for each rate plan
            let tuitionFromRatePlans = 0;
            
            Object.entries(hoursByRatePlan).forEach(([ratePlanId, totalHours]) => {
                const ratePlan = ratePlans[ratePlanId];
                if (ratePlan) {
                    console.log(`\nCalculating for Rate Plan "${ratePlan.Name}"`);
                    console.log(`Total Hours: ${totalHours}`);
                    console.log('Available Rates:', ratePlan.HourRates);
                    
                    const cost = calculateRatePlanCost(ratePlan, totalHours);
                    tuitionFromRatePlans += cost;
                    
                    console.log(`Cost for this rate plan: $${cost}`);
                } else {
                    console.warn(`Rate plan ${ratePlanId} not found`);
                }
            });

            // Combine tuition from rate plans and class fees
            const totalTuition = tuitionFromRatePlans + classFees;
            
            console.log(`\nTuition from Rate Plans: $${tuitionFromRatePlans}`);
            console.log(`Class Fees: $${classFees}`);
            console.log(`Total Tuition: $${totalTuition}`);
            
            return totalTuition;
        }

        // Update calculateRatePlanCost function
        function calculateRatePlanCost(ratePlan, totalHours) {
            console.log('\nCalculating rate plan cost:');
            console.log('Rate Plan:', ratePlan.Name);
            console.log('Total Hours:', totalHours);

            if (!ratePlan?.HourRates?.length) {
                console.warn('Invalid rate plan or missing HourRates');
                return 0;
            }

            // Sort rates by hours in ascending order
            const sortedRates = [...ratePlan.HourRates].sort((a, b) => a.Hours - b.Hours);
            
            // Check if total hours meets minimum threshold
            if (totalHours < sortedRates[0].Hours) {
                console.log(`Hours (${totalHours}) are below minimum threshold of ${sortedRates[0].Hours} hours. No charge for this rate plan.`);
                return 0;
            }
            
            // Find the appropriate rate for the total hours
            let selectedRate = sortedRates[0];
            
            for (let i = 0; i < sortedRates.length; i++) {
                if (totalHours >= sortedRates[i].Hours) {
                    selectedRate = sortedRates[i];
                } else {
                    break;
                }
            }

            console.log('Selected Rate:', selectedRate);
            console.log(`Using rate: $${selectedRate.Rate} for ${totalHours} hours`);

            return selectedRate.Rate;
        }

        // Add this helper function to convert military time to AM/PM
        function formatTime(militaryTime) {
            if (!militaryTime) return '';
            
            const [hours, minutes] = militaryTime.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const standardHour = hour % 12 || 12;
            
            return `${standardHour}:${minutes} ${ampm}`;
        }

        async function fetchSeasonWithFees(seasonId) {
            console.log(`Fetching season document for ID: ${seasonId}`);
            
            try {
                const seasonDoc = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Seasons')
                    .doc(seasonId)
                    .get();

                if (seasonDoc.exists) {
                    const seasonData = seasonDoc.data();
                    console.log(`Found season document:`, {
                        Name: seasonData.Name,
                        StartDate: seasonData.StartDate,
                        EndDate: seasonData.EndDate,
                        Fees: seasonData.Fees,
                        LastUpdated: seasonData.LastUpdated
                    });
                    
                    // Get the Fees array using correct Pascal case
                    if (seasonData.Fees && seasonData.Fees.length > 0) {
                        console.log(`Season has Fee IDs:`, seasonData.Fees);
                        
                        // Fetch each fee document
                        const fees = await fetchFees(seasonData.Fees);
                        console.log(`Retrieved Fees for Season "${seasonData.Name}":`, fees);
                        
                        return {
                            ...seasonData,
                            id: seasonId,
                            fetchedFees: fees
                        };
                    }
                } else {
                    console.log(`No Season found with ID: ${seasonId}`);
                }
            } catch (error) {
                console.error(`Error fetching Season ${seasonId}:`, error);
            }
            
            return null;
        }

        async function fetchFees(feeIds) {
            if (!feeIds || !Array.isArray(feeIds) || feeIds.length === 0) {
                console.log('No Fee IDs provided to fetch');
                return [];
            }

            console.log('Fetching Fees for IDs:', feeIds);
            const fees = [];
            
            for (const feeId of feeIds) {
                try {
                    const feeDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Fees')
                        .doc(feeId)
                        .get();
                    
                    if (feeDoc.exists) {
                        const feeData = feeDoc.data();
                        // Only include active fees
                        if (feeData.IsActive !== false) {
                            console.log(`Found active Fee ${feeId}:`, {
                                Name: feeData.Name,
                                Amount: feeData.Amount,
                                Type: feeData.Type,
                                Status: feeData.Status,
                                AssociationType: feeData.AssociationType,
                                AssociationName: feeData.AssociationName,
                                TimingType: feeData.TimingType,
                                LastUpdated: feeData.LastUpdated
                            });
                            
                            fees.push({
                                id: feeId,
                                ...feeData
                            });
                        } else {
                            console.log(`Fee ${feeId} is inactive, skipping`);
                        }
                    } else {
                        console.log(`No Fee found for ID: ${feeId}`);
                    }
                } catch (error) {
                    console.error(`Error fetching Fee ${feeId}:`, error);
                }
            }
            
            console.log('All fetched active Fees:', fees.map(fee => ({
                Name: fee.Name,
                Amount: fee.Amount,
                Type: fee.Type,
                Status: fee.Status
            })));
            
            return fees;
        }

        let isStudentFormVisible = true; // Add this state variable

        function toggleStudentForm() {
            const form = document.querySelector('.add-student-form');
            const addButton = document.querySelector('.add-student-btn');
            const addNewButton = document.querySelector('.add-new-student-btn');
            
            if (isStudentFormVisible) {
                form.style.display = 'none';
                addButton.textContent = 'Add Student';
                addNewButton.style.display = 'flex'; // Show the Add New Student button
            } else {
                form.style.display = 'block';
                addButton.textContent = 'Save Student';
                addNewButton.style.display = 'none'; // Hide the Add New Student button
                clearStudentForm();
            }
            
            isStudentFormVisible = !isStudentFormVisible;
        }

        // Update the addStudent function to handle image upload with spinner
        async function addStudent() {
            clearValidationErrors();
            
            // Get the save button and change it to a spinner
            const saveButton = document.querySelector('.add-student-btn');
            const originalButtonText = saveButton.textContent;
            saveButton.innerHTML = '<span class="spinner"></span> Saving...';
            saveButton.disabled = true;
            
            try {
                const studentData = {
                    firstName: document.getElementById('studentFirstName').value.trim(),
                    lastName: document.getElementById('studentLastName').value.trim(),
                    birthday: document.getElementById('studentBirthday').value,
                    gender: document.getElementById('studentGender').value,
                    medicalInfo: document.getElementById('medicalInfo').value.trim(),
                    skillLevel: document.getElementById('skillLevel').value,
                    classes: [] // Initialize empty classes array
                };

                const errors = validateStudent(studentData);
                
                if (errors.length > 0) {
                    errors.forEach(field => {
                        const element = document.getElementById('student' + field.replace(/\s+/g, ''));
                        if (element) {
                            showError(element, `${field} is required`);
                        }
                    });
                    // Restore button
                    saveButton.innerHTML = originalButtonText;
                    saveButton.disabled = false;
                    return;
                }

                // Handle photo upload
                const photoInput = document.getElementById('studentPhoto');
                if (photoInput.files.length > 0) {
                    try {
                        const photoUrl = await uploadStudentPhoto(photoInput.files[0], studentData.firstName, studentData.lastName);
                        studentData.photoUrl = photoUrl;
                    } catch (error) {
                        console.error('Error uploading photo:', error);
                        alert('Failed to upload photo. Please try again.');
                        // Restore button
                        saveButton.innerHTML = originalButtonText;
                        saveButton.disabled = false;
                        return;
                    }
                }

                // Calculate age before adding to students array
                studentData.age = calculateAge(studentData.birthday);
                
                students.push(studentData);
                console.log('Student info stored:', studentData);
                storeFormData();
                updateStudentsList();
                toggleStudentForm(); // Hide form after saving
                
                // Restore button
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
            } catch (error) {
                console.error('Error adding student:', error);
                alert('An error occurred while saving the student. Please try again.');
                
                // Restore button
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
            }
        }

        // Add this new function to handle photo upload
        async function uploadStudentPhoto(file, firstName, lastName) {
            // Initialize Firebase Storage
            const storage = firebase.storage();
            
            // Create a unique filename using timestamp and student name
            const timestamp = new Date().getTime();
            const sanitizedName = `${firstName}_${lastName}`.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `${sanitizedName}_${timestamp}`;
            
            // Create a reference to the StudentImages folder
            const storageRef = storage.ref(`StudentImages/${filename}`);
            
            try {
                // Upload the file
                const snapshot = await storageRef.put(file);
                
                // Get the download URL
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('Photo uploaded successfully:', downloadURL);
                return downloadURL;
            } catch (error) {
                console.error('Error uploading photo:', error);
                throw error;
            }
        }

        // Update the clearStudentForm function
        function clearStudentForm() {
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentBirthday').value = '';
            document.getElementById('studentGender').selectedIndex = 0;
            document.getElementById('medicalInfo').value = '';
            document.getElementById('skillLevel').selectedIndex = 0;
            document.getElementById('studentPhoto').value = '';
            document.getElementById('photoPreview').style.backgroundImage = '';
            document.getElementById('photoPreview').innerHTML = '';
        }

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Initialize the add student button
            const addStudentBtn = document.querySelector('.add-student-btn');
            const addNewStudentBtn = document.querySelector('.add-new-student-btn');
            addStudentBtn.textContent = 'Save Student';
            
            // Add click handlers
            addStudentBtn.addEventListener('click', function() {
                if (isStudentFormVisible) {
                    addStudent();
                }
            });

            addNewStudentBtn.addEventListener('click', function() {
                toggleStudentForm();
            });
        });

        function createPolicyCheckboxes(policies) {
            const checkboxContainer = document.getElementById('policyCheckboxes');
            checkboxContainer.innerHTML = ''; // Clear existing checkboxes

            policies.forEach(policy => {
                const checkboxWrapper = document.createElement('label');
                checkboxWrapper.className = 'checkbox-item';
                
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" 
                           id="policy_${policy.Id}" 
                           name="policy_${policy.Id}" 
                           required 
                           tabindex="0">
                    I have read and agree to the ${policy.Title} document
                `;
                
                checkboxContainer.appendChild(checkboxWrapper);
            });

            // Keep the electronic signature acceptance checkbox
            // The existing HTML for this will remain unchanged
        }

        // Update the existing goToStep4 function to include this
        function goToStep4() {
            hideAllSteps();
            document.getElementById('step4').style.display = 'block';
            updateProgressSteps(4);
            updateWaiverStudentList();
            updatePoliciesContent(); // This will now handle both policy display and checkbox creation
        }

        // Update the validation in goToStep5
        function goToStep5() {
            // Check if all policy checkboxes are checked
            const policyCheckboxes = document.querySelectorAll('#policyCheckboxes input[type="checkbox"]');
            const allPoliciesAccepted = Array.from(policyCheckboxes).every(checkbox => checkbox.checked);
            
            if (!allPoliciesAccepted || !document.getElementById('electronicSignatureAccept').checked) {
                alert('Please accept all policies and provide electronic signature consent');
                return;
            }
            
            hideAllSteps();
            document.getElementById('step5').style.display = 'block';
            updateProgressSteps(5);
            updateRegistrationSummary();
        }

        // Add these styles to make the signature name more prominent
        const styles = `
        .signature-name {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            font-size: 2.5em;
            color: #000080;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .signature-date-time {
            font-family: 'Brush Script MT', 'Brush Script Std', cursive;
            font-size: 1.8em;
            color: #000080;
            margin-bottom: 15px;
        }

        .signature-details {
            font-family: Arial, sans-serif;
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        `;

        // Add the styles to the document
        const styleSheet = document.createElement('style');
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);

        // Add this function near your other utility functions
        function makeFormControlsFocusable() {
            const formControls = document.querySelectorAll('input, select, textarea, button');
            formControls.forEach(control => {
                if (!control.hasAttribute('tabindex')) {
                    control.setAttribute('tabindex', '0');
                }
            });
        }

        // Add this function to fetch and display policies
        async function updatePoliciesContent() {
            try {
                const db = firebase.firestore();
                const policiesRef = db.collection('Studios').doc(studioId).collection('Policies');
                const policiesSnapshot = await policiesRef.get();
                
                const policiesContainer = document.getElementById('policiesContent');
                const policies = [];
                
                // Clear existing content
                policiesContainer.innerHTML = '';
                
                if (policiesSnapshot.empty) {
                    policiesContainer.innerHTML = '<p>No policies found for this studio.</p>';
                    return;
                }
                
                policiesSnapshot.forEach(doc => {
                    const policy = {
                        Id: doc.id,
                        Title: doc.data().Title || 'Untitled Policy',
                        Content: doc.data().Content || 'No content provided.',
                        Type: doc.data().Type || 'General',
                        IsActive: doc.data().IsActive !== false // Default to true if not specified
                    };
                    
                    // Only show active policies
                    if (policy.IsActive) {
                        policies.push(policy);
                        
                        // Create policy section in content
                        const policyEl = document.createElement('div');
                        policyEl.className = 'waiver-section';
                        policyEl.innerHTML = `
                            <h3 class="policy-title">${policy.Title}</h3>
                            <div class="policy-content">${policy.Content.replace(/\n/g, '<br>')}</div>
                        `;
                        
                        policiesContainer.appendChild(policyEl);
                    }
                });
                
                // Create checkboxes for policy acceptance
                createPolicyCheckboxes(policies);
                
            } catch (error) {
                console.error('Error loading policies:', error);
                document.getElementById('policiesContent').innerHTML = 
                    '<p>Error loading policies. Please refresh the page and try again.</p>';
            }
        }

        // Add these functions to fetch and log financial documents
        async function fetchAndLogFees() {
            try {
                const feesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Fees')
                    .get();
                
                if (feesSnapshot.empty) {
                    console.log('âœ… No Fees documents found');
                    return [];
                }
                
                const fees = feesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('âœ… Fees documents:', fees);
                return fees;
            } catch (error) {
                console.error('Error fetching Fees:', error);
                return [];
            }
        }

        async function fetchAndLogDiscounts() {
            try {
                const discountsSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Discounts')
                    .get();
                
                if (discountsSnapshot.empty) {
                    console.log('âœ… No Discounts documents found');
                    return [];
                }
                
                const discounts = discountsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log('âœ… Discounts documents:', discounts);
                return discounts;
            } catch (error) {
                console.error('Error fetching Discounts:', error);
                return [];
            }
        }

        async function fetchAndLogRatePlansDetailed() {
            try {
                const ratePlansSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('RatePlans')
                    .get();
                
                if (ratePlansSnapshot.empty) {
                    console.log('âœ… No RatePlans documents found');
                    return {};
                }
                
                const ratePlansDetailed = {};
                ratePlansSnapshot.forEach(doc => {
                    ratePlansDetailed[doc.id] = {
                        id: doc.id,
                        ...doc.data()
                    };
                });
                
                console.log('âœ… RatePlans documents:', ratePlansDetailed);
                return ratePlansDetailed;
            } catch (error) {
                console.error('Error fetching RatePlans:', error);
                return {};
            }
        }

        // Declare studentFamilyMax at the global scope
        let studentFamilyMax = null;

        // Update the fetchAndLogStudentFamilyMax function to store the result
        async function fetchAndLogStudentFamilyMax() {
            try {
                // Try to fetch from StudentFamilyMax collection rather than a document with that ID
                const studentFamilyMaxSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('StudentFamilyMax')
                    .where('IsActive', '==', true)
                    .limit(1)
                    .get();
                
                if (studentFamilyMaxSnapshot.empty) {
                    console.log('âœ… No StudentFamilyMax documents found');
                    return null;
                }
                
                const doc = studentFamilyMaxSnapshot.docs[0];
                const data = {
                    id: doc.id,
                    ...doc.data()
                };
                console.log('âœ… StudentFamilyMax document:', data);
                
                // Store the result in the global variable
                studentFamilyMax = data;
                
                return data;
            } catch (error) {
                console.error('Error fetching StudentFamilyMax:', error);
                return null;
            }
        }

        async function fetchAndLogSurcharge() {
            try {
                // Correct path: Studios > studioId > Surcharge > SurchargeSettings
                const surchargeRef = firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Surcharge')  // Changed from 'Settings'
                    .doc('SurchargeSettings');
                
                const doc = await surchargeRef.get();
                
                if (!doc.exists) {
                    console.log('âœ… No SurchargeSettings document found in Surcharge collection');
                    return null;
                }
                
                const data = {
                    id: doc.id,
                    ...doc.data()
                };
                console.log('âœ… SurchargeSettings document:', data);
                return data;
            } catch (error) {
                console.error('Error fetching SurchargeSettings:', error);
                return null;
            }
        }

        // Update the initialization function to include these fetches
        async function initializeFinancialData() {
            try {
                console.log('Initializing financial data...');
                
                // Fetch all financial data in parallel
                await Promise.all([
                    fetchAndLogFees(),
                    fetchAndLogDiscounts(),
                    fetchAndLogRatePlansDetailed(),
                    fetchAndLogStudentFamilyMax(),
                    fetchAndLogSurcharge()
                ]);
                
                console.log('âœ… All financial data initialized successfully');
            } catch (error) {
                console.error('Error initializing financial data:', error);
            }
        }

        // Update the createPolicyCheckboxes function to load from local storage
        function createPolicyCheckboxes(policies) {
            const checkboxContainer = document.getElementById('policyCheckboxes');
            checkboxContainer.innerHTML = ''; // Clear existing checkboxes
            
            // Load accepted policies from localStorage
            let acceptedPolicies = [];
            const storedPolicies = localStorage.getItem('acceptedPolicies');
            if (storedPolicies) {
                try {
                    acceptedPolicies = JSON.parse(storedPolicies);
                } catch (e) {
                    console.error('Error parsing stored policies:', e);
                }
            }
            
            policies.forEach(policy => {
                const checkboxWrapper = document.createElement('label');
                checkboxWrapper.className = 'checkbox-item';
                
                // Check if this policy was previously accepted
                const isPolicyAccepted = acceptedPolicies.includes(policy.Id);
                
                checkboxWrapper.innerHTML = `
                    <input type="checkbox" 
                           id="policy_${policy.Id}" 
                           name="policy_${policy.Id}" 
                           required 
                           tabindex="0"
                           ${isPolicyAccepted ? 'checked' : ''}>
                    I have read and agree to the ${policy.Title} document
                `;
                
                checkboxContainer.appendChild(checkboxWrapper);
            });
            
            // Also load the electronic signature checkbox state
            const signatureAccepted = localStorage.getItem('electronicSignatureAccept') === 'true';
            const signatureCheckbox = document.getElementById('electronicSignatureAccept');
            if (signatureCheckbox) {
                signatureCheckbox.checked = signatureAccepted;
            }
            
            // If policies were previously accepted, show the signature
            if (signatureAccepted) {
                updateSignatureDisplay();
            }
        }

        // Add a function to store policy acceptance
        function storePolicyAcceptance() {
            const policyCheckboxes = document.querySelectorAll('#policyCheckboxes input[type="checkbox"]');
            const acceptedPolicies = [];
            
            policyCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    // Extract policy ID from the checkbox ID (format: policy_POLICY_ID)
                    const policyId = checkbox.id.replace('policy_', '');
                    acceptedPolicies.push(policyId);
                }
            });
            
            // Store in localStorage
            localStorage.setItem('acceptedPolicies', JSON.stringify(acceptedPolicies));
            
            // Also store electronic signature acceptance
            const signatureAccepted = document.getElementById('electronicSignatureAccept').checked;
            localStorage.setItem('electronicSignatureAccept', signatureAccepted);
        }

        // Update the goToStep5 function to store accepted policies
        function goToStep5() {
            // Check if all policy checkboxes are checked
            const policyCheckboxes = document.querySelectorAll('#policyCheckboxes input[type="checkbox"]');
            const allPoliciesAccepted = Array.from(policyCheckboxes).every(checkbox => checkbox.checked);
            
            if (!allPoliciesAccepted || !document.getElementById('electronicSignatureAccept').checked) {
                alert('Please accept all policies and provide electronic signature consent');
                return;
            }
            
            // Store policy acceptance before proceeding
            storePolicyAcceptance();
            
            // Store signature information
            if (!localStorage.getItem('signatureName')) {
                const contactInfo = JSON.parse(localStorage.getItem('contactInfo') || '{}');
                const signatureName = `${contactInfo.firstName || ''} ${contactInfo.lastName || ''}`.trim();
                const signatureDate = new Date().toLocaleDateString();
                const signatureTime = new Date().toLocaleTimeString();
                
                localStorage.setItem('signatureName', signatureName);
                localStorage.setItem('signatureDate', signatureDate);
                localStorage.setItem('signatureTime', signatureTime);
            }
            
            hideAllSteps();
            document.getElementById('step5').style.display = 'block';
            updateProgressSteps(5);
            updateRegistrationSummary();
        }

        // Add function to update signature display
        function updateSignatureDisplay() {
            const signatureElement = document.getElementById('generatedSignature');
            if (!signatureElement) return;
            
            // Get stored signature data or use contact info
            let signatureName = localStorage.getItem('signatureName');
            let signatureDate = localStorage.getItem('signatureDate');
            let signatureTime = localStorage.getItem('signatureTime');
            
            if (!signatureName) {
                const contactInfo = JSON.parse(localStorage.getItem('contactInfo') || '{}');
                signatureName = `${contactInfo.firstName || ''} ${contactInfo.lastName || ''}`.trim();
                signatureDate = new Date().toLocaleDateString();
                signatureTime = new Date().toLocaleTimeString();
            }
            
            // Create signature display
            const signatureDisplay = document.querySelector('.signature-display');
            if (signatureDisplay) {
                signatureDisplay.classList.add('show');
            }
            
            signatureElement.innerHTML = `
                <div class="signature-text">${signatureName}</div>
                <div class="signature-date">${signatureDate}</div>
                <div class="signature-time">${signatureTime}</div>
                <div class="signature-details">
                    <div class="signature-timestamp">Electronically signed on ${signatureDate} at ${signatureTime}</div>
                    <div class="signature-ip">IP Address: <span id="ipAddress">Loading...</span></div>
                </div>
            `;
            
            // Get IP Address for signature
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ipAddress').textContent = data.ip;
                    localStorage.setItem('signatureIP', data.ip);
                })
                .catch(error => {
                    console.error('Error fetching IP:', error);
                    document.getElementById('ipAddress').textContent = 'Not available';
                });
        }


// ... existing code ...

// Add this function to calculate processing fee
function calculateProcessingFee(subtotal) {
    // Check if surcharge data exists in the global scope
    if (!window.surchargeData) {
        console.log('No surcharge data found');
        return 0;
    }

    const surcharge = window.surchargeData;
    
    if (!surcharge.IsActive) {
        console.log('Surcharge is not active');
        return 0;
    }

    let fee = 0;
    
    if (surcharge.Type === 'Percentage') {
        fee = subtotal * (surcharge.Amount / 100);
        console.log(`Calculated percentage surcharge: ${surcharge.Amount}% of $${subtotal} = $${fee.toFixed(2)}`);
    } else if (surcharge.Type === 'Fixed') {
        fee = surcharge.Amount;
        console.log(`Using fixed surcharge amount: $${fee.toFixed(2)}`);
    }

    // Apply minimum/maximum if defined
    if (surcharge.Minimum && fee < surcharge.Minimum) {
        fee = surcharge.Minimum;
        console.log(`Applied minimum surcharge: $${fee.toFixed(2)}`);
    } else if (surcharge.Maximum && fee > surcharge.Maximum) {
        fee = surcharge.Maximum;
        console.log(`Applied maximum surcharge: $${fee.toFixed(2)}`);
    }

    return parseFloat(fee.toFixed(2));
}
        // Update the submitRegistration function to include policy acceptance
        async function submitRegistration() {
            try {
                // Show the loading modal
                const loadingModal = document.getElementById('registrationLoadingModal');
                loadingModal.classList.add('show');

                console.log('Starting registration submission...');
                
                // Calculate the complete student totals including all fees
                const relevantFees = await getAllRelevantFees(students);
                const studentTotals = students.map(student => calculateStudentTotal(student, relevantFees));
                
                // Calculate final total
                const actualTotalAmount = studentTotals.reduce((sum, total) => sum + total, 0);
                const totalBalance = actualTotalAmount + (window.surchargeAmount || 0);
                console.log('Final Total Amount:', totalBalance.toFixed(2));

                // Create a combined student names string for multiple students
                let studentNamesString = '';
                if (students.length === 1) {
                    studentNamesString = `${students[0].firstName} ${students[0].lastName}`;
                } else if (students.length === 2) {
                    studentNamesString = `${students[0].firstName} ${students[0].lastName} and ${students[1].firstName} ${students[1].lastName}`;
                } else if (students.length > 2) {
                    const lastStudent = students[students.length - 1];
                    const otherStudents = students.slice(0, students.length - 1);
                    const otherStudentNames = otherStudents.map(s => `${s.firstName} ${s.lastName}`).join(', ');
                    studentNamesString = `${otherStudentNames}, and ${lastStudent.firstName} ${lastStudent.lastName}`;
                }

                // Get all accepted policies
                const acceptedPolicies = Array.from(document.querySelectorAll('#policyCheckboxes input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.id.replace('policy_', ''));
                
                // Get signature data
                const signatureData = JSON.parse(document.getElementById('signatureData').value);
                
                // Create Firebase user
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(
                    contactInfo.email,
                    contactInfo.password
                );
                const uid = userCredential.user.uid;
                console.log('Created user account:', uid);

                // Create Family document with proper Pascal case for fields
                const familyRef = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Families')
                    .add({
                        UserId: uid,
                        FirstName: contactInfo.firstName,
                        LastName: contactInfo.lastName,
                        Email: contactInfo.email,
                        Phone: contactInfo.phone,
                        Address1: contactInfo.address1,
                        Address2: contactInfo.address2 || '',
                        City: contactInfo.city,
                        State: contactInfo.state,
                        ZipCode: contactInfo.zip,
                        Students: [],
                        HowDidYouHearAboutUs: contactInfo.referralSource || '',
                        ReferredBy: contactInfo.referredBy || '',
                        AdditionalDetails: contactInfo.additionalDetails || '',
                        EmergencyContacts: getEmergencyContacts(),
                        // Add policy agreements
                        PolicyAgreements: acceptedPolicies.map(policyId => ({
                            PolicyId: policyId,
                            AgreedAt: new Date().toISOString(),
                            SignatureInfo: {
                                SignatureText: signatureData.SignatureText,
                                SignatureDate: signatureData.SignatureDate,
                                SignatureTime: signatureData.SignatureTime,
                                SignatureIp: signatureData.SignatureIp,
                                SignatureTimestamp: signatureData.SignatureTimestamp
                            }
                        })),
                        SignatureInfo: {
                            SignatureText: signatureData.SignatureText,
                            SignatureDate: signatureData.SignatureDate,
                            SignatureTime: signatureData.SignatureTime,
                            SignatureIp: signatureData.SignatureIp,
                            SignatureTimestamp: signatureData.SignatureTimestamp,
                            AgreedToWaiver: true,
                            AgreedToTerms: true,
                            SignedBy: `${contactInfo.firstName} ${contactInfo.lastName}`
                        },
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        // Add Balance and Charges tracking
                        Balance: totalBalance,  // Set the total balance
                        Charges: [{  // Create just ONE charge
                            Type: 'Registration',
                            Amount: totalBalance,
                            Description: `Registration Total for ${studentNamesString}`,
                            ChargeDate: new Date().toISOString(),
                            Status: 'Pending'
                        }]
                    });

                console.log('Family document created with Balance:', totalBalance.toFixed(2));

                // Create Students and update Classes
                const studentPromises = students.map(async student => {
                    console.log(`Processing student: ${student.firstName} ${student.lastName}`);
                    
                    // Create Student document with PhotoURL in Pascal case
                    const studentRef = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Students')
                        .add({
                            FamilyId: familyRef.id,
                            FirstName: student.firstName,
                            LastName: student.lastName,
                            Age: student.age,
                            DateOfBirth: student.birthday,
                            SkillLevel: student.skillLevel,
                            MedicalConditions: student.medicalInfo || '',
                            Classes: student.classes.map(c => c.Id), // Store Class IDs
                            PhotoURL: student.photoUrl || '', // Store the photo URL in Pascal case
                            CreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    console.log(`Created student document: ${studentRef.id}`);
                    if (student.photoUrl) {
                        console.log(`Saved photo URL for ${student.firstName}: ${student.photoUrl}`);
                    }

                    // Update each Class to include this student
                    const classUpdatePromises = student.classes.map(async classObj => {
                        console.log(`Updating class ${classObj.ClassName} (${classObj.Id}) with student ${studentRef.id}`);
                        
                        return firebase.firestore()
                            .collection('Studios')
                            .doc(studioId)
                            .collection('Classes')
                            .doc(classObj.Id)
                            .update({
                                Students: firebase.firestore.FieldValue.arrayUnion(studentRef.id)
                            });
                    });

                    await Promise.all(classUpdatePromises);
                    console.log(`Updated all classes for student ${studentRef.id}`);

                    return {
                        studentId: studentRef.id,
                        studentData: student
                    };
                });

                const createdStudents = await Promise.all(studentPromises);
                console.log('All students created:', createdStudents);

                // Update Family document with Student IDs
                const studentIds = createdStudents.map(student => student.studentId);
                await familyRef.update({
                    Students: studentIds,
                    LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Updated family document with student IDs:', studentIds);

                // Show success message
                showSuccessModal();

                // Hide loading modal after successful registration
                loadingModal.classList.remove('show');

            } catch (error) {
                // Hide loading modal on error
                document.getElementById('registrationLoadingModal').classList.remove('show');
                console.error('Registration error:', error);
                alert(`Registration error: ${error.message}`);
            }
        }

        // Update the fetchClasses function to log the full class data
        async function fetchClasses() {
            try {
                console.log('Fetching classes...');
                const classesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Classes')
                    .where('IsActive', '==', true)
                    .get();
                
                studioClasses = classesSnapshot.docs.map(doc => {
                    const data = {
                        Id: doc.id,
                        ...doc.data()
                    };
                    // Log the complete class data to see if fee fields exist
                    console.log('Class data:', data.ClassName, data);
                    return data;
                });
                
                console.log('All fetched classes:', studioClasses);
                return studioClasses;
            } catch (error) {
                console.error('Error fetching classes:', error);
                return [];
            }
        }

        // Also update toggleModalClass function to log the class data being used
        function toggleModalClass(classId) {
            if (!students[currentStudentIndex].classes) {
                students[currentStudentIndex].classes = [];
            }
            
            const selectedClass = studioClasses.find(c => c.Id === classId);
            
            if (!selectedClass) {
                console.error('Class not found:', classId);
                alert('Sorry, this class is no longer available.');
                return;
            }
            
            // Log the full class data to see the fee information
            console.log('Toggle class - Full class data:', selectedClass);

            const classIndex = students[currentStudentIndex].classes.findIndex(c => c.Id === classId);

            if (classIndex === -1) {
                // Add class
                const classToAdd = {
                    Id: selectedClass.Id,
                    ClassName: selectedClass.ClassName,
                    Days: selectedClass.Days,
                    StartTime: selectedClass.StartTime,
                    EndTime: selectedClass.EndTime,
                    RatePlanId: selectedClass.RatePlanId,
                    Duration: selectedClass.Duration,
                    SeasonId: selectedClass.SeasonId,
                    Fees: selectedClass.Fees,
                    ClassType: selectedClass.ClassType,
                    MaxSize: selectedClass.MaxSize,
                    // Add these fee fields
                    FeeAmount: selectedClass.FeeAmount,
                    FeeType: selectedClass.FeeType,
                    RecurringFrequency: selectedClass.RecurringFrequency,
                    RecurringDuration: selectedClass.RecurringDuration,
                    BreakUpFrequency: selectedClass.BreakUpFrequency,
                    BreakUpDuration: selectedClass.BreakUpDuration
                };
                
                // Log what we're adding to student's classes
                console.log('Adding class to student with data:', classToAdd);
                
                students[currentStudentIndex].classes.push(classToAdd);
            } else {
                // Remove class (even if it's preselected)
                students[currentStudentIndex].classes.splice(classIndex, 1);
            }
            
            // After updating classes, log what the student has
            console.log('Updated student classes:', students[currentStudentIndex].classes);
            
            calculateStudentTuition(students[currentStudentIndex]);
            populateModalClassGrid();
            updateStudentsList();
        }

        // Add this helper function to create the spots available indicator
        function getAvailableSpotsHTML(classData) {
            if (!classData.MaxSize) return '';
            
            // Ensure students is counted correctly from the Students array
            const enrolled = Array.isArray(classData.Students) ? classData.Students.length : 0;
            const available = classData.MaxSize - enrolled;
            
            let spotsClass = '';
            let spotsTextFull = '';
            let spotsTextCompact = '';
            
            if (available <= 0) {
                spotsClass = 'spots-full';
                spotsTextFull = 'Class Full';
                spotsTextCompact = 'Full';
            } else if (available <= 3) {
                spotsClass = 'spots-limited';
                spotsTextFull = `${available} Spot${available === 1 ? '' : 's'} Left`;
                spotsTextCompact = `${available} Spot${available === 1 ? '' : 's'}`;
            } else {
                spotsClass = 'spots-available';
                spotsTextFull = `${available} Spots Available`;
                spotsTextCompact = `${available} Spots`;
            }
            
            return `<div class="spots-indicator ${spotsClass}">
                <span class="spots-text-full">${spotsTextFull}</span>
                <span class="spots-text-medium">${spotsTextCompact}</span>
                <span class="spots-text-small">${available > 0 ? available : 'Full'}</span>
            </div>`;
        }

        // Add room name lookup - call this after cards are created
        async function loadRoomNames() {
            const roomElements = document.querySelectorAll('.room-info');
            if (roomElements.length === 0) return;
            
            // Create a set of unique room IDs
            const roomIds = new Set();
            roomElements.forEach(el => roomIds.add(el.dataset.roomId));
            
            // Fetch room data for all room IDs
            try {
                const db = firebase.firestore();
                const roomsData = {};
                
                // Fetch each room
                for (const roomId of roomIds) {
                    const roomDoc = await db.collection('Studios')
                        .doc(window.studioId)
                        .collection('Rooms')
                        .doc(roomId)
                        .get();
                        
                    if (roomDoc.exists) {
                        roomsData[roomId] = roomDoc.data().RoomName || 'Unnamed Room';
                    } else {
                        roomsData[roomId] = 'Unknown Room';
                    }
                }
                
                // Update all room elements with the room names
                roomElements.forEach(el => {
                    const roomId = el.dataset.roomId;
                    el.textContent = roomsData[roomId] || 'Unknown Room';
                });
                
            } catch (error) {
                console.error('Error loading room names:', error);
                roomElements.forEach(el => {
                    el.textContent = 'Room info unavailable';
                });
            }
        }

        // Make sure to call loadRoomNames() after adding cards to the DOM
    </script>
</body>
</html>

